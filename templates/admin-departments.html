
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Management - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Cache busting -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="../static/img/pmc.jpg" alt="PMC Tech" class="h-10 w-auto rounded-lg">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-gray-900">Department Management</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="admin-dashboard.html" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Department Stats -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-building text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Departments</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalDepartments">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-users text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Faculty</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalFaculty">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-user-tie text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">HODs</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalHods">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-chart-bar text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Avg Faculty/Dept</p>
                        <p class="text-2xl font-bold text-gray-900" id="avgFaculty">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-indigo-100 rounded-lg">
                        <i class="fas fa-money-bill text-indigo-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Avg Salary</p>
                        <p class="text-2xl font-bold text-gray-900" id="avgSalary">₹0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-teal-100 rounded-lg">
                        <i class="fas fa-clock text-teal-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Avg Experience</p>
                        <p class="text-2xl font-bold text-gray-900" id="avgExperience">0 yrs</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Overview Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="departmentsGrid">
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Loading departments...</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseClient = window.supabase.createClient(
            "https://cbhodgwaazmjszkujrti.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
        );

        let departmentData = [];

        // Department image mapping
        const deptImages = {
            'CSE': '../static/img/CSE.PNG',
            'ECE': '../static/img/ECE.PNG',
            'EEE': '../static/img/EEE.PNG',
            'MECH': '../static/img/MECH.PNG',
            'CIVIL': '../static/img/CIVIL.PNG',
            'IT': '../static/img/IT.PNG',
            'AERO': '../static/img/AERO.PNG',
            'CHEM': '../static/img/CHEM.PNG',
            'AIDS': '../static/img/AIDS.PNG',
            'AIML': '../static/img/AIML.PNG',
            'CSBS': '../static/img/CSBS.PNG',
            'MBA': '../static/img/MBA.PNG',
            'MCA': '../static/img/MCA.PNG',
            'MCO': '../static/img/MCO.PNG',
            'S&H': '../static/img/S&H.PNG'
        };

        // Load department data (enhanced for detailed view)
        async function loadDepartments() {
            try {
                console.log('=== DETAILED DEPARTMENT LOADING ===');
                console.log('Loading comprehensive department data...');
                
                // Load complete faculty data with all columns
                console.log('Querying Faculty table with all columns...');
                const { data: faculty, error: facultyError } = await supabaseClient
                    .from('Faculty')
                    .select(`
                        input_id,
                        department,
                        email,
                        "Name",
                        "Username",
                        "Upload Image",
                        "Designation",
                        form1, form2, form3, form4, form5, form6, form7, form8,
                        "EmployeeID",
                        "Salary",
                        "Experience",
                        "Qualification",
                        "SEM_SUBJECT_CLASS",
                        "DETAILS_TABLE",
                        assigned_forms,
                        compliance,
                        ap_scope_details,
                        asp_scope_details,
                        prof_scope_details
                    `);

                console.log('Faculty data loaded:', faculty?.length || 0, 'records');

                // Load complete HOD data with all columns
                console.log('Querying HOD table with all columns...');
                const { data: hods, error: hodError } = await supabaseClient
                    .from('HOD')
                    .select(`
                        input_id,
                        department,
                        email,
                        "Name",
                        "Username",
                        "Upload Image",
                        "Designation",
                        form1, form2, form3, form4, form5, form6, form7, form8,
                        "EmployeeID",
                        "Salary",
                        "Experience",
                        "Qualification",
                        "SEM_SUBJECT_CLASS",
                        "DETAILS_TABLE"
                    `);

                console.log('HOD data loaded:', hods?.length || 0, 'records');

                if (facultyError) {
                    console.error('Faculty Error:', facultyError);
                    showError('Failed to load faculty data: ' + facultyError.message);
                    return;
                }
                if (hodError) {
                    console.error('HOD Error:', hodError);
                    // Continue without HODs if error occurs
                }

                // Process detailed department data
                const deptMap = new Map();
                
                // Process faculty with detailed information
                if (faculty && faculty.length > 0) {
                    faculty.forEach((f) => {
                        const deptName = f.department;
                        if (deptName && deptName.trim() !== '') {
                            if (!deptMap.has(deptName)) {
                                deptMap.set(deptName, {
                                    name: deptName,
                                    faculty: [],
                                    hod: null,
                                    totalFaculty: 0,
                                    designationStats: {},
                                    formAssignments: {
                                        form1: 0, form2: 0, form3: 0, form4: 0,
                                        form5: 0, form6: 0, form7: 0, form8: 0
                                    },
                                    averageSalary: 0,
                                    averageExperience: 0,
                                    qualifications: {},
                                    institutionForms: []
                                });
                            }
                            
                            const dept = deptMap.get(deptName);
                            dept.faculty.push(f);
                            dept.totalFaculty++;
                            
                            // Track designation statistics
                            const designation = f.Designation || 'Unknown';
                            dept.designationStats[designation] = (dept.designationStats[designation] || 0) + 1;
                            
                            // Track form assignments
                            for (let i = 1; i <= 8; i++) {
                                if (f[`form${i}`] && f[`form${i}`].toLowerCase() === 'yes') {
                                    dept.formAssignments[`form${i}`]++;
                                }
                            }
                            
                            // Track qualifications
                            if (f.Qualification) {
                                dept.qualifications[f.Qualification] = (dept.qualifications[f.Qualification] || 0) + 1;
                            }
                            
                            // Track institution forms
                            if (f.assigned_forms) {
                                try {
                                    const assignedForms = JSON.parse(f.assigned_forms);
                                    if (Array.isArray(assignedForms)) {
                                        assignedForms.forEach(form => {
                                            if (!dept.institutionForms.includes(form)) {
                                                dept.institutionForms.push(form);
                                            }
                                        });
                                    }
                                } catch (e) {
                                    console.log('Error parsing assigned_forms for:', f.Name);
                                }
                            }
                        }
                    });
                    
                    // Calculate averages
                    deptMap.forEach(dept => {
                        const salaries = dept.faculty.filter(f => f.Salary && !isNaN(f.Salary)).map(f => parseFloat(f.Salary));
                        const experiences = dept.faculty.filter(f => f.Experience && !isNaN(f.Experience)).map(f => parseFloat(f.Experience));
                        
                        dept.averageSalary = salaries.length > 0 ? salaries.reduce((a, b) => a + b, 0) / salaries.length : 0;
                        dept.averageExperience = experiences.length > 0 ? experiences.reduce((a, b) => a + b, 0) / experiences.length : 0;
                    });
                }

                // Process HODs with detailed information
                if (hods && hods.length > 0) {
                    hods.forEach((h) => {
                        const deptName = h.department;
                        if (deptName && deptMap.has(deptName)) {
                            deptMap.get(deptName).hod = h;
                        }
                    });
                }

                departmentData = Array.from(deptMap.values());
                console.log('Final detailed department data:', departmentData);
                
                if (departmentData.length === 0) {
                    showError('No departments found. Make sure faculty records have department values.');
                    return;
                }
                
                // Update stats and display
                updateDetailedStats();
                displayDetailedDepartments();

            } catch (error) {
                console.error('Error loading detailed departments:', error);
                showError('Failed to load departments: ' + error.message);
            }
        }

        // Update detailed statistics
        function updateDetailedStats() {
            const totalDepts = departmentData.length;
            const totalFac = departmentData.reduce((sum, dept) => sum + dept.totalFaculty, 0);
            const totalHodCount = departmentData.filter(dept => dept.hod).length;
            const avgFac = totalDepts > 0 ? Math.round(totalFac / totalDepts) : 0;

            // Calculate overall averages
            let totalSalary = 0;
            let totalExperience = 0;
            let salaryCount = 0;
            let experienceCount = 0;

            departmentData.forEach(dept => {
                dept.faculty.forEach(f => {
                    if (f.Salary && !isNaN(f.Salary)) {
                        totalSalary += parseFloat(f.Salary);
                        salaryCount++;
                    }
                    if (f.Experience && !isNaN(f.Experience)) {
                        totalExperience += parseFloat(f.Experience);
                        experienceCount++;
                    }
                });
            });

            const avgSalary = salaryCount > 0 ? Math.round(totalSalary / salaryCount) : 0;
            const avgExperience = experienceCount > 0 ? Math.round(totalExperience / experienceCount * 10) / 10 : 0;

            document.getElementById('totalDepartments').textContent = totalDepts;
            document.getElementById('totalFaculty').textContent = totalFac;
            document.getElementById('totalHods').textContent = totalHodCount;
            document.getElementById('avgFaculty').textContent = avgFac;
            document.getElementById('avgSalary').textContent = '₹' + avgSalary.toLocaleString();
            document.getElementById('avgExperience').textContent = avgExperience + ' yrs';
        }

        // Display detailed departments
        function displayDetailedDepartments() {
            const grid = document.getElementById('departmentsGrid');
            
            if (departmentData.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No departments found</p>
                    </div>
                `;
                return;
            }

            const departmentsHtml = departmentData.map(dept => {
                const deptImage = deptImages[dept.name] || '../static/img/default-dept.png';
                const hodName = dept.hod ? dept.hod.Name || 'Unknown' : 'Not Assigned';
                
                // Get designation breakdown
                const designations = Object.entries(dept.designationStats)
                    .map(([designation, count]) => `${designation}: ${count}`)
                    .join(', ') || 'No designations';
                
                // Get form assignment summary
                const totalFormAssignments = Object.values(dept.formAssignments).reduce((sum, count) => sum + count, 0);
                
                // Get qualification breakdown
                const qualifications = Object.entries(dept.qualifications)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([qual, count]) => `${qual}: ${count}`)
                    .join(', ') || 'No qualifications';
                
                return `
                    <div class="bg-white rounded-lg shadow border hover:shadow-lg transition-shadow duration-300">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <img src="${deptImage}" alt="${dept.name}" class="h-12 w-12 rounded-lg object-cover" 
                                     onerror="this.src='../static/img/default-dept.png'">
                                <div class="ml-4 flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">${dept.name}</h3>
                                    <p class="text-sm text-gray-600">${getDeptFullName(dept.name)}</p>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${dept.totalFaculty}</div>
                                    <div class="text-xs text-blue-600">Faculty</div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${totalFormAssignments}</div>
                                    <div class="text-xs text-green-600">Form Assignments</div>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <div class="text-lg font-bold text-purple-600">₹${Math.round(dept.averageSalary).toLocaleString()}</div>
                                    <div class="text-xs text-purple-600">Avg Salary</div>
                                </div>
                                <div class="bg-orange-50 p-3 rounded-lg">
                                    <div class="text-lg font-bold text-orange-600">${Math.round(dept.averageExperience * 10) / 10}y</div>
                                    <div class="text-xs text-orange-600">Avg Experience</div>
                                </div>
                            </div>
                            
                            <!-- Detailed Information -->
                            <div class="space-y-3 text-sm">
                                <div class="flex items-start justify-between">
                                    <span class="text-gray-600 font-medium">
                                        <i class="fas fa-user-tie mr-2 text-yellow-500"></i>HOD
                                    </span>
                                    <span class="font-medium text-gray-900 text-right max-w-32 truncate" title="${hodName}">
                                        ${hodName}
                                    </span>
                                </div>
                                
                                <div class="flex items-start justify-between">
                                    <span class="text-gray-600 font-medium">
                                        <i class="fas fa-graduation-cap mr-2 text-blue-500"></i>Designations
                                    </span>
                                    <span class="text-gray-700 text-right text-xs max-w-32" title="${designations}">
                                        ${designations.length > 30 ? designations.substring(0, 30) + '...' : designations}
                                    </span>
                                </div>
                                
                                <div class="flex items-start justify-between">
                                    <span class="text-gray-600 font-medium">
                                        <i class="fas fa-certificate mr-2 text-green-500"></i>Top Qualifications
                                    </span>
                                    <span class="text-gray-700 text-right text-xs max-w-32" title="${qualifications}">
                                        ${qualifications.length > 25 ? qualifications.substring(0, 25) + '...' : qualifications}
                                    </span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 font-medium">
                                        <i class="fas fa-building mr-2 text-indigo-500"></i>Institution Forms
                                    </span>
                                    <span class="font-medium text-indigo-600">
                                        ${dept.institutionForms.length}
                                    </span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 font-medium">
                                        <i class="fas fa-chart-pie mr-2 text-purple-500"></i>Status
                                    </span>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${dept.hod ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${dept.hod ? 'Complete' : 'No HOD'}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-6 pt-4 border-t border-gray-200 space-y-2">
                                <button onclick="viewDetailedDepartmentInfo('${dept.name}')" 
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                    <i class="fas fa-eye mr-2"></i>View Detailed Analysis
                                </button>
                                <button onclick="exportDepartmentData('${dept.name}')" 
                                        class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors text-sm">
                                    <i class="fas fa-download mr-2"></i>Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = departmentsHtml;
        }

        // Get full department name
        function getDeptFullName(shortName) {
            const fullNames = {
                'CSE': 'Computer Science & Engineering',
                'ECE': 'Electronics & Communication Engineering',
                'EEE': 'Electrical & Electronics Engineering',
                'MECH': 'Mechanical Engineering',
                'CIVIL': 'Civil Engineering',
                'IT': 'Information Technology',
                'AERO': 'Aeronautical Engineering',
                'CHEM': 'Chemical Engineering',
                'AIDS': 'Artificial Intelligence & Data Science',
                'AIML': 'Artificial Intelligence & Machine Learning',
                'CSBS': 'Computer Science & Business Systems',
                'MBA': 'Master of Business Administration',
                'MCA': 'Master of Computer Applications',
                'MCO': 'M.Com',
                'S&H': 'Science & Humanities'
            };
            return fullNames[shortName] || shortName;
        }

        // View detailed department information (enhanced modal)
        function viewDetailedDepartmentInfo(deptName) {
            const dept = departmentData.find(d => d.name === deptName);
            if (!dept) return;

            // Create detailed modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto bg-gray-600 bg-opacity-50';
            
            const formAssignmentsList = Object.entries(dept.formAssignments)
                .filter(([form, count]) => count > 0)
                .map(([form, count]) => `<li class="flex justify-between"><span>${getFormName(form)}</span><span class="font-bold">${count}</span></li>`)
                .join('');
            
            const designationsList = Object.entries(dept.designationStats)
                .map(([designation, count]) => `<li class="flex justify-between"><span>${designation}</span><span class="font-bold">${count}</span></li>`)
                .join('');
                
            const qualificationsList = Object.entries(dept.qualifications)
                .sort(([,a], [,b]) => b - a)
                .map(([qual, count]) => `<li class="flex justify-between"><span>${qual}</span><span class="font-bold">${count}</span></li>`)
                .join('');

            const institutionFormsList = dept.institutionForms.length > 0 ? 
                dept.institutionForms.map(form => `<li class="text-sm text-gray-600">• ${form}</li>`).join('') : 
                '<li class="text-sm text-gray-500">No institution forms assigned</li>';

            const facultyList = dept.faculty.slice(0, 10).map(f => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-sm">${f.Name || 'Unknown'}</td>
                    <td class="px-3 py-2 text-sm">${f.Designation || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${f.Experience || 'N/A'}y</td>
                    <td class="px-3 py-2 text-sm">₹${f.Salary ? parseFloat(f.Salary).toLocaleString() : 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${f.Qualification || 'N/A'}</td>
                </tr>
            `).join('');

            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white mb-10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">${dept.name} - Detailed Analysis</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Overview Stats -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">Department Overview</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>Full Name:</span><span class="font-medium">${getDeptFullName(dept.name)}</span></div>
                                <div class="flex justify-between"><span>Total Faculty:</span><span class="font-bold text-blue-600">${dept.totalFaculty}</span></div>
                                <div class="flex justify-between"><span>HOD:</span><span class="font-medium">${dept.hod ? dept.hod.Name : 'Not Assigned'}</span></div>
                                <div class="flex justify-between"><span>Average Salary:</span><span class="font-medium">₹${Math.round(dept.averageSalary).toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>Average Experience:</span><span class="font-medium">${Math.round(dept.averageExperience * 10) / 10} years</span></div>
                                <div class="flex justify-between"><span>Institution Forms:</span><span class="font-medium">${dept.institutionForms.length}</span></div>
                            </div>
                        </div>
                        
                        <!-- Form Assignments -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-blue-800">Form Assignments</h4>
                            <ul class="space-y-1 text-sm">
                                ${formAssignmentsList || '<li class="text-gray-500">No form assignments</li>'}
                            </ul>
                        </div>
                        
                        <!-- Designations -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-green-800">Designation Breakdown</h4>
                            <ul class="space-y-1 text-sm">
                                ${designationsList || '<li class="text-gray-500">No designations</li>'}
                            </ul>
                        </div>
                        
                        <!-- Qualifications -->
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3 text-purple-800">Qualifications</h4>
                            <ul class="space-y-1 text-sm">
                                ${qualificationsList || '<li class="text-gray-500">No qualifications</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Institution Forms -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-3 text-gray-800">Institution Forms Assigned</h4>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <ul class="space-y-1">
                                ${institutionFormsList}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Faculty Table -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-3 text-gray-800">Faculty Members (Top 10)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Experience</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Salary</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qualification</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${facultyList || '<tr><td colspan="5" class="text-center py-4 text-gray-500">No faculty data</td></tr>'}
                                    ${dept.faculty.length > 10 ? `<tr><td colspan="5" class="text-center py-2 text-gray-400 text-sm">... and ${dept.faculty.length - 10} more faculty members</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4 justify-end">
                        <button onclick="exportDepartmentData('${dept.name}')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Export Full Report
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Get form name by form ID
        function getFormName(formId) {
            const formNames = {
                'form1': 'Students Performance in Training & Placement',
                'form2': 'Class Advisor',
                'form3': 'Faculty Information & Contribution',
                'form4': 'Course Outcome & Program Outcome (Exam Cell)',
                'form5': 'Continuous Improvement (Program Member)',
                'form6': 'Teaching & Learning Process (IQAC)',
                'form7': 'Student Support System (Discipline & Extra Curricular)',
                'form8': 'Facilities & Technical Support (Lab Member)'
            };
            return formNames[formId] || formId;
        }

        // Export department data
        function exportDepartmentData(deptName) {
            const dept = departmentData.find(d => d.name === deptName);
            if (!dept) return;

            // Create comprehensive data object
            const exportData = {
                department: {
                    name: dept.name,
                    fullName: getDeptFullName(dept.name),
                    totalFaculty: dept.totalFaculty,
                    averageSalary: dept.averageSalary,
                    averageExperience: dept.averageExperience,
                    hodInfo: dept.hod ? {
                        name: dept.hod.Name,
                        email: dept.hod.email,
                        designation: dept.hod.Designation,
                        employeeId: dept.hod.EmployeeID
                    } : null
                },
                statistics: {
                    designations: dept.designationStats,
                    qualifications: dept.qualifications,
                    formAssignments: dept.formAssignments,
                    institutionForms: dept.institutionForms
                },
                faculty: dept.faculty.map(f => ({
                    name: f.Name,
                    email: f.email,
                    designation: f.Designation,
                    employeeId: f.EmployeeID,
                    salary: f.Salary,
                    experience: f.Experience,
                    qualification: f.Qualification,
                    formAssignments: {
                        form1: f.form1,
                        form2: f.form2,
                        form3: f.form3,
                        form4: f.form4,
                        form5: f.form5,
                        form6: f.form6,
                        form7: f.form7,
                        form8: f.form8
                    },
                    assignedInstitutionForms: f.assigned_forms
                }))
            };

            // Generate CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header information
            csvContent += `Department Report: ${dept.name}\n`;
            csvContent += `Full Name: ${getDeptFullName(dept.name)}\n`;
            csvContent += `Generated: ${new Date().toLocaleString()}\n`;
            csvContent += `Total Faculty: ${dept.totalFaculty}\n`;
            csvContent += `Average Salary: ${Math.round(dept.averageSalary)}\n`;
            csvContent += `Average Experience: ${Math.round(dept.averageExperience * 10) / 10} years\n\n`;
            
            // Faculty data
            csvContent += "Faculty Details:\n";
            csvContent += "Name,Email,Designation,Employee ID,Salary,Experience,Qualification,Form1,Form2,Form3,Form4,Form5,Form6,Form7,Form8\n";
            
            dept.faculty.forEach(f => {
                csvContent += `"${f.Name || ''}","${f.email || ''}","${f.Designation || ''}","${f.EmployeeID || ''}","${f.Salary || ''}","${f.Experience || ''}","${f.Qualification || ''}","${f.form1 || ''}","${f.form2 || ''}","${f.form3 || ''}","${f.form4 || ''}","${f.form5 || ''}","${f.form6 || ''}","${f.form7 || ''}","${f.form8 || ''}"\n`;
            });

            // Create and download file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${dept.name}_Department_Report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            showNotification(`Department report for ${dept.name} exported successfully!`, 'success');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Simple department details view (compatibility function)
        function viewDepartmentDetails(deptName) {
            // Try to find in detailed data first
            const dept = departmentData.find(d => d.name === deptName);
            if (dept) {
                viewDetailedDepartmentInfo(deptName);
                return;
            }

            // Fallback for simple view
            const hodInfo = dept && dept.hod ? 
                `HOD: ${dept.hod.Name || 'Unknown'}\nEmail: ${dept.hod.email || 'N/A'}\nDesignation: ${dept.hod.Designation || 'N/A'}` :
                'HOD: Not Assigned';

            const facultyList = dept ? dept.faculty.slice(0, 5).map(f => f.Name || 'Unknown').join(', ') : 'No faculty data';
            const moreCount = dept && dept.faculty.length > 5 ? `... and ${dept.faculty.length - 5} more` : '';

            alert(`Department: ${deptName}
Full Name: ${getDeptFullName(deptName)}
Total Faculty: ${dept ? dept.totalFaculty : 'Unknown'}

${hodInfo}

Faculty Members: ${facultyList}${moreCount}

Note: For detailed management, use the detailed view.`);
        }

        // Show error message with more details
        function showError(message) {
            console.error('Department loading error:', message);
            document.getElementById('departmentsGrid').innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-600 mb-2">${message}</p>
                    <p class="text-gray-500 text-sm">Check the browser console for more details</p>
                    <button onclick="loadDepartments()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Retry Loading
                    </button>
                </div>
            `;
        }

        // Initialize (with database structure discovery)
        document.addEventListener('DOMContentLoaded', function() {
            // First, let's discover what columns your tables actually have
            discoverTableStructure().then(() => {
                loadDepartments();
            });
        });

        // Discover actual table structure
        async function discoverTableStructure() {
            try {
                console.log('=== DISCOVERING TABLE STRUCTURE ===');
                
                // Get a sample Faculty record to see column names
                const { data: sampleFaculty, error: facultyError } = await supabaseClient
                    .from('Faculty')
                    .select('*')
                    .limit(1);

                if (sampleFaculty && sampleFaculty.length > 0) {
                    console.log('Sample Faculty record:', sampleFaculty[0]);
                    console.log('Faculty columns:', Object.keys(sampleFaculty[0]));
                } else {
                    console.log('No Faculty records found or error:', facultyError);
                }

                // Get a sample HOD record to see column names
                const { data: sampleHOD, error: hodError } = await supabaseClient
                    .from('HOD')
                    .select('*')
                    .limit(1);

                if (sampleHOD && sampleHOD.length > 0) {
                    console.log('Sample HOD record:', sampleHOD[0]);
                    console.log('HOD columns:', Object.keys(sampleHOD[0]));
                } else {
                    console.log('No HOD records found or error:', hodError);
                }

                console.log('=== END STRUCTURE DISCOVERY ===');
            } catch (error) {
                console.error('Error discovering table structure:', error);
            }
        }
    </script>

    <!-- Footer -->
    <footer class="text-center py-4 mt-8">
    <p class="text-sm">
      &copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br>
      <p class="text-xs opacity-80 flex items-center justify-center gap-2">
                        Powered by 
                        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
                            <img src="static\img\zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
                        </a><p class="text-xs opacity-80">A Student driven Software!</p>
    </p>
  </footer>
</body>
</html>
