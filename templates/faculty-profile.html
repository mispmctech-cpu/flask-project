<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../static/javascript/form-modal-mapper.js"></script>
  <script src="../static/javascript/workdone-table.js"></script>
  <!-- Cropper.js for image cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  </head>
  <body class="bg-pmcBg min-h-screen">
    <header class="bg-purple-800 text-white">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 mr-4 rounded shadow bg-white p-1" />
          <nav class="hidden sm:flex gap-6 ml-6 text-sm font-medium items-center">
            <a href="hod.html" class="opacity-90 hover:opacity-100">Back</a>
            <span class="underline decoration-2 underline-offset-4">Faculty Profile</span>
            <button onclick="openNotificationModal()" aria-label="Messages" class="ml-4 focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-white hover:text-orange-400 transition">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3.75h6m-10.125 6.375V6.75A2.25 2.25 0 0 1 5.625 4.5h12.75a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25H6.75l-4.5 4.5z" />
              </svg>
            </button>
            <button onclick="window.location.href='/logout'" aria-label="Logout" class="ml-4 focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-white hover:text-red-400 transition">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6A2.25 2.25 0 0 0 5.25 5.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-6-3h12m0 0l-3-3m3 3l-3 3" />
              </svg>
            </button>
          </nav>
          <!-- Mobile menu button -->
          <button id="menuBtn" class="sm:hidden ml-2 p-2 rounded focus:outline-none focus:ring-2 focus:ring-white" aria-label="Open Menu">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          </button>
        </div>
        <!-- Mobile nav links -->
        <div id="mobileNav" class="sm:hidden hidden px-4 pb-4 w-full">
          <nav class="flex flex-col gap-3 text-base font-medium bg-purple-800 rounded shadow">
            <a href="hod.html" class="opacity-90 hover:opacity-100 py-2">Back</a>
            <span class="underline decoration-2 underline-offset-4 py-2">Faculty Profile</span>
            <button onclick="openNotificationModal()" aria-label="Messages" class="focus:outline-none py-2 text-left">
              <span class="inline-flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-white hover:text-orange-400 transition">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3.75h6m-10.125 6.375V6.75A2.25 2.25 0 0 1 5.625 4.5h12.75a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25H6.75l-4.5 4.5z" />
                </svg>
                Notifications
              </span>
            </button>
            <button onclick="window.location.href='/logout'" aria-label="Logout" class="focus:outline-none py-2 text-left">
              <span class="inline-flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-white hover:text-red-400 transition">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6A2.25 2.25 0 0 0 5.25 5.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-6-3h12m0 0l-3-3m3 3l-3 3" />
                </svg>
                Logout
              </span>
            </button>
          </nav>
        </div>
      </div>
      <script>
        // Toggle mobile nav
        document.addEventListener('DOMContentLoaded', function() {
          const menuBtn = document.getElementById('menuBtn');
          const mobileNav = document.getElementById('mobileNav');
          menuBtn.addEventListener('click', function() {
            mobileNav.classList.toggle('hidden');
          });
        });
      </script>
    </header>
    <main class="max-w-6xl mx-auto px-4 py-8">
      
      <section class="bg-white rounded-xl card-shadow p-6 mb-8">
        <!-- Guidelines and Update Password Buttons -->
        <div class="flex justify-end items-center gap-3 mb-4">
          <a href="../static/img/Guidelines for MIS Software.pdf" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            Guidelines
          </a>
          <button id="updateMobileBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Update Mobile Number</button>
          <button id="updatePasswordBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-semibold">Update Password</button>
        </div>
        <div class="flex flex-col md:flex-row items-start gap-8">
          <div class="flex-shrink-0 text-center w-full md:w-auto">
            <div class="relative inline-block">
              <img
                id="facultyImage"
                class="w-40 h-40 object-cover shadow border-4 border-pmcPurple mx-auto"
                style="border-radius: 16px"
                src=""
                alt="Faculty Image"
              />
              <div class="mt-2 text-center">
                <input type="file" id="facultyImageInput" accept="image/*" class="hidden" />
                <button type="button" id="editImageBtn" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded mt-2">Edit Image</button>
              </div>
            </div>
          </div>
          <div class="flex-1 w-full">
            <form id="facultyEditForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="text-sm font-medium text-gray-600">Employee ID</label>
                <input id="facultyEmployeeID" name="EmployeeID" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-pmcPurple" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Name</label>
                <input id="facultyName" name="Name" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-lg font-bold text-pmcPurple" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Department</label>
                <input id="facultyDepartment" name="department" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-pmcPurple" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Email ID</label>
                <input id="facultyEmail" name="email" type="email" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Mobile Number</label>
                <input id="facultyNumber" name="Number" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Designation</label>
                <input id="facultyDesignation" name="Designation" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-pmcPurpleDark font-semibold" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Username</label>
                <input id="facultyUsername" name="Username" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Salary</label>
                <input id="facultySalary" name="Salary" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600">Experience</label>
                <input id="facultyExperience" name="Experience" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div class="md:col-span-2">
                <label class="text-sm font-medium text-gray-600">Qualification</label>
                <input id="facultyQualification" name="Qualification" type="text" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2 text-gray-600" disabled />
              </div>
              <div class="md:col-span-2 flex gap-4 mt-2">
                <button type="button" id="editProfileBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-semibold hidden">Edit</button>
                <button type="submit" id="saveProfileBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-semibold hidden">Save</button>
                <span id="editStatusMsg" class="ml-4 text-sm"></span>
              </div>
            </form>
          </div>
        </div>
        <!-- SEM, SUBJECT, CLASS Table -->
        <div class="mt-8">
          <label class="text-base font-bold text-gray-700 uppercase tracking-wide block mb-1">SUBJECT ALLOTTED</label>
          <div id="facultySemSubjectClassTable" class="mt-1"></div>
        </div>
        
        <!-- DEPARTMENT PORTFOLIO -->
        <div class="mt-8">
          <h2 class="text-lg font-bold text-pmcPurple mb-2 uppercase">DEPARTMENT PORTFOLIO</h2>
          <table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white">
            <thead class="bg-purple-700">
              <tr class="text-left text-white">
                <th class="p-4 w-16">S.No</th>
                <th class="p-4">Role Name</th>
                <th class="p-4 w-60">Link</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y" id="facultyFormsDept"></tbody>
          </table>
        </div>
        
        <!-- FACULTY SCOPE (Yearly and Monthly) -->
        <div class="mt-8">
          <h2 class="text-lg font-bold text-pmcPurple mb-2 uppercase">FACULTY SCOPE (Yearly and Monthly)</h2>
          <table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white">
            <thead class="bg-purple-700">
              <tr class="text-left text-white">
                <th class="p-4 w-16">S.No</th>
                <th class="p-4">Form Name</th>
                <th class="p-4 w-60">Link</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y" id="facultyFormsCore"></tbody>
          </table>
        </div>
        
        <!-- Institution Forms will be inserted here dynamically -->
        <div id="institutionFormsContainer"></div>
        
        <!-- Faculty Mandatory Scope - Yearly -->
        <div class="mt-8">
          <h2 class="text-2xl font-bold text-purple-700 mb-4">Faculty Mandatory Scope - Yearly</h2>
          <div id="facultyYearlyTableContainer" class="overflow-x-auto"></div>
        </div>
        
        <!-- Faculty Core Scope - Monthly -->
        <div class="mt-8">
          <h2 class="text-2xl font-bold text-green-700 mb-4">Faculty Core Scope - Monthly</h2>
          <div class="mb-4 flex justify-end">
            <button id="toggleCoreScopeRowsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold shadow">Show All Rows</button>
          </div>
          <div id="facultyCoreScopeTableContainer" class="overflow-x-auto"></div>
        </div>
        
      </section>
      <!-- Workdone Section -->
      <section class="card-shadow rounded-xl overflow-hidden">
        <div class="bg-white p-4">
          <h2 class="text-lg font-bold text-pmcPurple mb-4 uppercase">WORKDONE</h2>
          <!-- Search input for workdone -->
          <div class="mb-4">
            <input id="workdoneSearch" type="text" class="p-2 border border-gray-300 rounded-md w-64 focus:outline-none focus:ring-2 focus:ring-purple-700" placeholder="Search by Portfolio or Member" oninput="window._currentWorkdoneTable.filterWorkdoneTable()" />
          </div>
          <div class="overflow-x-auto">
            <table
              class="min-w-full bg-white shadow text-sm border border-gray-300"
            >
              <thead
                class="bg-gradient-to-r from-purple-700 to-purple-500 text-white"
              >
                <tr>
                  <th class="p-3 border-b border-gray-300">Department</th>
                  <th class="p-3 border-b border-gray-300">Portfolio Name</th>
                  <th class="p-3 border-b border-gray-300">Portfolio Member Name</th>
                  <th class="p-3 border-b border-gray-300">Status</th>
                  <th class="p-3 border-b border-gray-300">Submitted At</th>
                  <th class="p-3 border-b border-gray-300">View</th>
                  <th class="p-3 border-b border-gray-300">Delete</th>
                </tr>
              </thead>
              <tbody
                id="facultyWorkdoneTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
          <!-- Pagination Container for Workdone -->
          <div class="flex justify-center items-center mt-4" id="workdonePagination"></div>
          <div
            id="workdoneErrorBox"
            class="hidden mt-4 p-3 rounded bg-red-100 text-red-700 font-semibold"
          ></div>
          <div
            id="workdoneLoadingBox"
            class="mt-4 p-3 rounded bg-blue-100 text-blue-800 font-semibold"
            style="display: none"
          >
            Loading workdone data, please wait...
          </div>
        </div>
      </section>
      <!-- Rejected Workdone Section (moved below Workdone) -->
      <section class="card-shadow rounded-xl overflow-hidden mb-8">
        <div class="bg-white p-4">
          <h2 class="text-lg font-bold text-red-700 mb-4 uppercase">Rejected Workdone</h2>
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-2">
            <input id="rejectedWorkdoneSearch" type="text" class="p-2 border border-gray-300 rounded-md w-64 focus:outline-none focus:ring-2 focus:ring-red-700" placeholder="Search by Portfolio or Member" oninput="filterRejectedWorkdoneTable()" />
            <button onclick="exportTableToExcel('rejectedWorkdoneTable', 'Rejected_Workdone')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 mb-2" title="Export table to Excel">
              Export to Excel
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white shadow-lg text-sm border border-gray-300">
              <thead class="bg-gradient-to-r from-red-700 to-red-500 text-white">
                <tr>
                  <th class="p-3 border-b border-gray-300">Department</th>
                  <th class="p-3 border-b border-gray-300">Portfolio Name</th>
                  <th class="p-3 border-b border-gray-300">Member Name</th>
                  <th class="p-3 border-b border-gray-300">Status</th>
                  <th class="p-3 border-b border-gray-300">Rejected By</th>
                  <th class="p-3 border-b border-gray-300">Rejected At</th>
                  <th class="p-3 border-b border-gray-300">Commands</th>
                  <th class="p-3 border-b border-gray-300">View</th>
                </tr>
              </thead>
              <tbody id="rejectedWorkdoneTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
          <div class="flex justify-center items-center mt-4" id="rejectedWorkdonePagination"></div>
        </div>
      </section>
        </div>
      </section>
    </main>
    <!-- Image Cropper Modal -->
    <div id="imageCropperModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-lg w-full p-6 relative">
        <button onclick="closeCropperModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-xl font-bold mb-4 text-purple-700">Crop Your Image</h3>
        <div class="mb-4">
          <div id="cropperContainer" class="max-h-80 overflow-hidden">
            <img id="cropperImage" class="max-w-full" style="display: none;">
          </div>
        </div>
        <div class="flex gap-4 justify-end">
          <button type="button" onclick="closeCropperModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded font-semibold">Cancel</button>
          <button type="button" onclick="cropAndSaveImage()" class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded font-semibold">Crop & Save</button>
        </div>
      </div>
    </div>

    <!-- Update Password Modal -->
    <div id="updatePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
        <button onclick="closeUpdatePasswordModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-xl font-bold mb-4 text-yellow-700">Update Password</h3>
        <form id="updatePasswordForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Old Password</label>
            <input type="password" id="oldPassword" name="oldPassword" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">New Password</label>
            <input type="password" id="newPassword" name="newPassword" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Re-enter New Password</label>
            <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2" required />
          </div>
          <div id="updatePasswordStatus" class="text-sm mt-2"></div>
          <div class="flex gap-4 mt-2">
            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded font-semibold">Update</button>
            <button type="button" onclick="closeUpdatePasswordModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded font-semibold">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Mobile Number Modal -->
    <div id="updateMobileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
        <button onclick="closeUpdateMobileModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-xl font-bold mb-4 text-green-700">Update Mobile Number</h3>
        <form id="updateMobileForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Current Mobile Number</label>
            <input type="text" id="currentMobile" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-100 px-4 py-2 text-gray-600" disabled />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">New Mobile Number</label>
            <input type="tel" id="newMobile" name="newMobile" pattern="[0-9]{10}" maxlength="10" class="mt-1 block w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2" placeholder="Enter 10-digit mobile number" required />
            <p class="text-xs text-gray-500 mt-1">Please enter a valid 10-digit mobile number</p>
          </div>
          <div id="updateMobileStatus" class="text-sm mt-2"></div>
          <div class="flex gap-4 mt-2">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-semibold">Update</button>
            <button type="button" onclick="closeUpdateMobileModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded font-semibold">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Core Scope Selection Modal (Monthly or Yearly) -->
    <div id="coreScopeSelectionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
        <button onclick="closeCoreScopeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-xl font-bold mb-4 text-purple-700">Select Form Type</h3>
        <p class="text-gray-600 mb-6">Please choose the type of form you want to fill:</p>
        <div class="space-y-3">
          <button id="monthlyFormBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
            Faculty Core Scope(Monthly)
          </button>
          <button id="yearlyFormBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
            Faculty Mandatory Scope(Yearly)
          </button>
        </div>
        <button onclick="closeCoreScopeModal()" class="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded font-semibold">Cancel</button>
      </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script>
      // Hide/unhide salary and sensitive details based on admin setting
      function updateSensitiveDetailsVisibility() {
        const show = localStorage.getItem('showFacultySensitiveDetails') === 'true';
        const salaryField = document.getElementById('facultySalary');
        const salaryLabel = salaryField?.parentElement?.querySelector('label');
        if (salaryField) {
          salaryField.parentElement.style.display = show ? '' : 'none';
        }
        if (salaryLabel && salaryLabel.textContent?.toLowerCase().includes('salary')) {
          salaryLabel.style.display = show ? '' : 'none';
        }
      }
      document.addEventListener('DOMContentLoaded', updateSensitiveDetailsVisibility);
      window.addEventListener('storage', updateSensitiveDetailsVisibility);
      let cropper = null;
      let currentImageFile = null;

      function openCropperModal() {
        document.getElementById('imageCropperModal').classList.remove('hidden');
      }

      function closeCropperModal() {
        document.getElementById('imageCropperModal').classList.add('hidden');
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        document.getElementById('cropperImage').style.display = 'none';
        currentImageFile = null;
      }

      function cropAndSaveImage() {
        if (!cropper) return;
        
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          width: 200,
          height: 200,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        // Convert canvas to blob
        canvas.toBlob(function(blob) {
          // Create a file from the blob
          const fileName = currentImageFile ? currentImageFile.name : 'cropped_image.jpg';
          const croppedFile = new File([blob], fileName, { type: 'image/jpeg' });
          
          // Update the preview image
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('facultyImage').src = e.target.result;
            document.getElementById('saveProfileBtn').classList.remove('hidden');
            document.getElementById('editStatusMsg').textContent = 'Image cropped. Click Save to upload.';
            window._facultyProfileImageFile = croppedFile;
          };
          reader.readAsDataURL(croppedFile);
          
          closeCropperModal();
        }, 'image/jpeg', 0.9);
      }

      // Image edit logic
      document.getElementById('editImageBtn').addEventListener('click', function() {
        document.getElementById('facultyImageInput').click();
      });
      
      document.getElementById('facultyImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          currentImageFile = file;
          const reader = new FileReader();
          reader.onload = function(evt) {
            const img = document.getElementById('cropperImage');
            img.src = evt.target.result;
            img.style.display = 'block';
            
            openCropperModal();
            
            // Initialize cropper
            setTimeout(() => {
              if (cropper) {
                cropper.destroy();
              }
              cropper = new Cropper(img, {
                aspectRatio: 1, // Square crop
                viewMode: 2,
                dragMode: 'move',
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                modal: true,
                background: true,
                responsive: true,
                checkOrientation: false,
                scalable: true,
                zoomable: true,
              });
            }, 100);
          };
          reader.readAsDataURL(file);
        }
      });

      // Rejected Workdone Table Logic
      let rejectedCurrentPage = 1;
      let rejectedRowsPerPage = 10;
      function filterRejectedWorkdoneTable() {
        const search = document.getElementById('rejectedWorkdoneSearch').value.toLowerCase();
        if (!window._allRejectedRows) return;
        if (search.trim() === '') {
          window._filteredRejectedRows = window._allRejectedRows;
        } else {
          window._filteredRejectedRows = window._allRejectedRows.filter(row => {
            const portfolio = (row.portfolio_name || '').toLowerCase();
            const member = (row.portfolio_member_name || '').toLowerCase();
            return portfolio.includes(search) || member.includes(search);
          });
        }
        window._workingRejectedRows = window._filteredRejectedRows || window._allRejectedRows;
        renderRejectedWorkdoneTableWithPagination(1);
      }

      function renderRejectedWorkdoneTableWithPagination(page = 1) {
        if (!window._allRejectedRows || window._allRejectedRows.length === 0) {
          const tbody = document.getElementById('rejectedWorkdoneTable');
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan='8' class='text-center text-gray-400 p-4'>No rejected records found.</td></tr>`;
          }
          return;
        }
        rejectedCurrentPage = page;
        const startIdx = (page - 1) * rejectedRowsPerPage;
        const endIdx = startIdx + rejectedRowsPerPage;
        const pageRows = window._workingRejectedRows.slice(startIdx, endIdx);
        const tbody = document.getElementById('rejectedWorkdoneTable');
        if (!tbody) return;
        let html = "";
        pageRows.forEach((r, idx) => {
          const globalIdx = startIdx + idx;
          let statusText = (r.status || '').toUpperCase();
          let statusClass = '';
          if (statusText === 'PENDING') {
            statusClass = 'text-red-600 font-bold';
          } else if (statusText === 'COMPLETED') {
            statusClass = 'text-green-600 font-bold';
          } else {
            statusClass = 'font-bold';
          }
          const rejectedAt = new Date(r.rejected_at || r.created_at).toLocaleDateString();
          const commands = r.Commands || r.commands || '';
          html += `
          <tr class="hover:bg-red-50 transition border-b border-gray-200" data-rejected-idx="${globalIdx}">
            <td class='p-3 border-r border-gray-200'>${r.department}</td>
            <td class='p-3 border-r border-gray-200'>${r.portfolio_name}</td>
            <td class='p-3 border-r border-gray-200'>${r.portfolio_member_name}</td>
            <td class='p-3 border-r border-gray-200'><span class='${statusClass}'>${statusText}</span></td>
            <td class='p-3 border-r border-gray-200'>${r.rejected_by}</td>
            <td class='p-3 border-r border-gray-200'>${rejectedAt}</td>
            <td class='p-3 border-r border-gray-200'>${commands}</td>
            <td class='p-3 text-center'><button class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded" onclick="viewRejectedRowDetails(${globalIdx})">View</button></td>
          </tr>`;
        });
        tbody.innerHTML = html;
        renderRejectedWorkdonePagination();
      }

      function renderRejectedWorkdonePagination() {
        const container = document.getElementById('rejectedWorkdonePagination');
        if (!container || !window._workingRejectedRows) return;
        const totalRows = window._workingRejectedRows.length;
        const totalPages = Math.ceil(totalRows / rejectedRowsPerPage);
        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }
        let html = `
          <div class="flex items-center space-x-1">
            <button 
              onclick="changeRejectedPage(${rejectedCurrentPage - 1})" 
              ${rejectedCurrentPage === 1 ? 'disabled' : ''} 
              class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 ${rejectedCurrentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
              Previous
            </button>
        `;
        const maxVisiblePages = 5;
        let startPage = Math.max(1, rejectedCurrentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === rejectedCurrentPage;
          html += `
            <button 
              onclick="changeRejectedPage(${i})" 
              class="px-3 py-2 text-sm font-medium ${isActive ? 'text-red-600 bg-red-50 border-red-300' : 'text-gray-500 bg-white border-gray-300 hover:bg-gray-50 hover:text-gray-700'} border">
              ${i}
            </button>
          `;
        }
        html += `
            <button 
              onclick="changeRejectedPage(${rejectedCurrentPage + 1})" 
              ${rejectedCurrentPage === totalPages ? 'disabled' : ''} 
              class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 ${rejectedCurrentPage === totalPages ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
              Next
            </button>
          </div>
          <div class="text-sm text-gray-700 ml-4">
            Showing ${Math.min((rejectedCurrentPage - 1) * rejectedRowsPerPage + 1, totalRows)} to ${Math.min(rejectedCurrentPage * rejectedRowsPerPage, totalRows)} of ${totalRows} entries
          </div>
        `;
        container.innerHTML = html;
      }

      function changeRejectedPage(page) {
        if (!window._workingRejectedRows) return;
        const totalPages = Math.ceil(window._workingRejectedRows.length / rejectedRowsPerPage);
        if (page < 1 || page > totalPages) return;
        renderRejectedWorkdoneTableWithPagination(page);
      }

      async function loadRejectedWorkdone() {
        try {
          const { data, error } = await supabaseClient
            .from('hod-workdone_reject')
            .select('*')
            .eq('department', window._facultyProfileOriginal.department)
            .order('rejected_at', { ascending: false });
          if (error) {
            document.getElementById('rejectedWorkdoneTable').innerHTML = `<tr><td colspan='8' class='text-center text-red-500 p-4'>Failed to load rejected workdone: ${error.message}</td></tr>`;
            return;
          }
          // Filter by faculty name (case-insensitive, trimmed)
          const facultyName = (window._facultyProfileOriginal.Name || '').toString().trim().toLowerCase();
          const filteredRows = (data || []).filter(row => {
            const rowName = (row.portfolio_member_name || '').toString().trim().toLowerCase();
            return rowName === facultyName;
          });
          // Deduplicate by input_id
          const uniqueRows = [];
          const seenInputIds = new Set();
          if (filteredRows.length > 0) {
            for (const row of filteredRows) {
              if (row.input_id && !seenInputIds.has(row.input_id)) {
                uniqueRows.push(row);
                seenInputIds.add(row.input_id);
              } else if (!row.input_id) {
                const key = `${row.department}_${row.portfolio_name}_${row.portfolio_member_name}_${row.rejected_at}`;
                if (!seenInputIds.has(key)) {
                  uniqueRows.push(row);
                  seenInputIds.add(key);
                }
              }
            }
          }
          window._allRejectedRows = uniqueRows;
          window._filteredRejectedRows = uniqueRows;
          window._workingRejectedRows = uniqueRows;
          renderRejectedWorkdoneTableWithPagination(1);
        } catch (err) {
          document.getElementById('rejectedWorkdoneTable').innerHTML = `<tr><td colspan='8' class='text-center text-red-500 p-4'>Error loading rejected workdone: ${err.message}</td></tr>`;
        }
      }

      // Export to Excel for rejected table
      function exportTableToExcel(tbodyId, filenamePrefix) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        const table = tbody.closest('table');
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
        if (rows.length === 0) {
          alert('No data to export!');
          return;
        }
        let headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
        if (headers.length > 2) {
          headers = headers.slice(0, -2);
        }
        const data = [headers];
        rows.forEach(row => {
          const tds = Array.from(row.querySelectorAll('td'));
          let cells = tds.slice(0, tds.length - 2).map(td => td.innerText.trim());
          data.push(cells);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, filenamePrefix);
        XLSX.writeFile(wb, `${filenamePrefix}.xlsx`);
      }

      // View modal for rejected workdone
      function viewRejectedRowDetails(idx) {
        if (!window._workingRejectedRows || !window._workingRejectedRows[idx]) {
          alert('Error: Rejected record not found');
          return;
        }
        const rejectedRow = window._workingRejectedRows[idx];
        const modal = document.getElementById('viewModal');
        const modalContent = document.getElementById('viewModalContent');
        if (modalContent && modal) {
          modalContent.innerHTML = `<div class=\"p-4 text-center\">Loading rejected record details...</div>`;
          modal.classList.remove('hidden');
        }
        setTimeout(() => {
          if (modalContent) {
            modalContent.innerHTML = `
              <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded">
                <h4 class="font-bold text-red-800">‚ùå Rejected Record</h4>
                <p class="text-sm text-red-600">Rejected by: ${rejectedRow.rejected_by} on ${new Date(rejectedRow.rejected_at).toLocaleString()}</p>
                <p class="text-sm text-gray-500">Source: ${rejectedRow.table_name || 'N/A'} (input_id: ${rejectedRow.input_id || 'N/A'})</p>
              </div>
              <div class="text-left text-sm">
                <p><strong>Portfolio:</strong> ${rejectedRow.portfolio_name}</p>
                <p><strong>Member:</strong> ${rejectedRow.portfolio_member_name}</p>
                <p><strong>Department:</strong> ${rejectedRow.department}</p>
                <p><strong>Status:</strong> ${rejectedRow.status}</p>
                <p><strong>Table:</strong> ${rejectedRow.table_name}</p>
                <p><strong>Input ID:</strong> ${rejectedRow.input_id || 'N/A'}</p>
                <p><strong>Rejected By:</strong> ${rejectedRow.rejected_by}</p>
                <p><strong>Rejected At:</strong> ${new Date(rejectedRow.rejected_at).toLocaleString()}</p>
                <p><strong>Commands:</strong> ${rejectedRow.Commands || rejectedRow.commands || ''}</p>
              </div>
            `;
          }
        }, 500);
      }

      // Load rejected workdone after profile is loaded
      window.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          if (window._facultyProfileOriginal && window._facultyProfileOriginal.Name) {
            loadRejectedWorkdone();
          }
        }, 1000);
      });
      // Update Password Modal Logic
      document.getElementById('updatePasswordBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to update your password?')) {
          document.getElementById('updatePasswordModal').classList.remove('hidden');
        }
      });
      function closeUpdatePasswordModal() {
        document.getElementById('updatePasswordModal').classList.add('hidden');
        document.getElementById('updatePasswordForm').reset();
        document.getElementById('updatePasswordStatus').textContent = '';
      }
      document.getElementById('updatePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('facultyEmail').value;
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const statusBox = document.getElementById('updatePasswordStatus');
        statusBox.textContent = '';
        if (!email) {
          statusBox.textContent = 'Email not found.';
          return;
        }
        if (newPassword !== confirmNewPassword) {
          statusBox.textContent = 'New passwords do not match.';
          return;
        }
        statusBox.textContent = 'Verifying old password...';
        // Fetch faculty row by email
        const { data, error } = await supabaseClient
          .from('Faculty')
          .select('password')
          .eq('email', email)
          .single();
        if (error || !data) {
          statusBox.textContent = 'User not found.';
          return;
        }
        // NOTE: This is plain text check. For production, use hashed passwords!
        if (data.password !== oldPassword) {
          statusBox.textContent = 'Old password is incorrect.';
          return;
        }
        statusBox.textContent = 'Updating password...';
        // Update password
        const { error: updateError } = await supabaseClient
          .from('Faculty')
          .update({ password: newPassword })
          .eq('email', email);
        if (updateError) {
          statusBox.textContent = 'Password update failed: ' + (updateError.message || updateError);
        } else {
          statusBox.textContent = 'Password updated successfully!';
          setTimeout(closeUpdatePasswordModal, 1500);
        }
      });

      // Update Mobile Number Modal Logic
      document.getElementById('updateMobileBtn').addEventListener('click', function() {
        const currentNumber = document.getElementById('facultyNumber').value || 'Not set';
        document.getElementById('currentMobile').value = currentNumber;
        document.getElementById('updateMobileModal').classList.remove('hidden');
      });
      
      function closeUpdateMobileModal() {
        document.getElementById('updateMobileModal').classList.add('hidden');
        document.getElementById('updateMobileForm').reset();
        document.getElementById('updateMobileStatus').textContent = '';
      }
      
      document.getElementById('updateMobileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('facultyEmail').value;
        const newMobile = document.getElementById('newMobile').value;
        const statusBox = document.getElementById('updateMobileStatus');
        
        statusBox.textContent = '';
        
        if (!email) {
          statusBox.textContent = 'Email not found.';
          statusBox.className = 'text-sm mt-2 text-red-600';
          return;
        }
        
        // Validate mobile number format (10 digits)
        if (!/^[0-9]{10}$/.test(newMobile)) {
          statusBox.textContent = 'Please enter a valid 10-digit mobile number.';
          statusBox.className = 'text-sm mt-2 text-red-600';
          return;
        }
        
        statusBox.textContent = 'Updating mobile number...';
        statusBox.className = 'text-sm mt-2 text-blue-600';
        
        // Update mobile number
        const { error: updateError } = await supabaseClient
          .from('Faculty')
          .update({ Number: newMobile })
          .eq('email', email);
        
        if (updateError) {
          statusBox.textContent = 'Mobile number update failed: ' + (updateError.message || updateError);
          statusBox.className = 'text-sm mt-2 text-red-600';
        } else {
          statusBox.textContent = 'Mobile number updated successfully!';
          statusBox.className = 'text-sm mt-2 text-green-600';
          
          // Update the displayed number
          document.getElementById('facultyNumber').value = newMobile;
          window._facultyProfileOriginal.Number = newMobile;
          
          setTimeout(closeUpdateMobileModal, 1500);
        }
      });
    </script>
    <script>
      // Image edit logic - REMOVED (moved above)
      // Get email from query param
      function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }
      const email = getQueryParam("email");
      const supabaseClient = window.supabase.createClient(
        "https://cbhodgwaazmjszkujrti.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
      );
      async function loadFacultyProfile() {
        if (!email) {
          document.body.innerHTML = '<div class="text-center mt-20 text-red-500">No faculty selected.</div>';
          return;
        }
        const { data, error } = await supabaseClient
          .from("Faculty")
          .select("*")
          .eq("email", email)
          .single();
        if (error || !data) {
          document.body.innerHTML = '<div class="text-center mt-20 text-red-500">Faculty not found.</div>';
          return;
        }
        document.getElementById("facultyImage").src = data["Upload Image"] || "https://img.freepik.com/free-vector/blue-circle-with-white-user_78370-4707.jpg?semt=ais_hybrid&w=740&q=80";
        document.getElementById("facultyEmployeeID").value = data["EmployeeID"] || "";
        document.getElementById("facultyName").value = data["Name"] || "";
        document.getElementById("facultyDesignation").value = data["Designation"] || "";
        document.getElementById("facultyDepartment").value = data["department"] || "";
        document.getElementById("facultyEmail").value = data["email"] || "";
        document.getElementById("facultyNumber").value = data["Number"] || "";
        document.getElementById("facultyUsername").value = data["Username"] || "";
        document.getElementById("facultySalary").value = data["Salary"] || "";
        document.getElementById("facultyExperience").value = data["Experience"] || "";
        document.getElementById("facultyQualification").value = data["Qualification"] || "";
        // Store original data for change detection
        window._facultyProfileOriginal = {
          EmployeeID: data["EmployeeID"] || "",
          Name: data["Name"] || "",
          department: data["department"] || "",
          email: data["email"] || "",
          Number: data["Number"] || "",
          Designation: data["Designation"] || "",
          Username: data["Username"] || "",
          Salary: data["Salary"] || "",
          Experience: data["Experience"] || "",
          Qualification: data["Qualification"] || ""
        };
        // Reset form state
        setEditMode(false);

        // --- Begin: Faculty Mandatory Scope - Yearly Table ---
        async function loadFacultyYearlyTable() {
          const facultyName = data["Name"] || "";
          const department = data["department"] || "";
          const designation = (data["Designation"] || "").toUpperCase();
          
          // Normalize designation
          let desig = '';
          if (designation === 'AP' || designation === 'ASSISTANT PROFESSOR') desig = 'AP';
          else if (designation === 'ASP' || designation === 'ASSOCIATE PROFESSOR') desig = 'ASP';
          else if (designation === 'PROF' || designation === 'PROFESSOR') desig = 'Prof';
          else {
            document.getElementById('facultyYearlyTableContainer').innerHTML = '<div class="text-gray-400 p-4">No yearly scope data available for this designation.</div>';
            return;
          }
          
          // Particulars for each designation
          const particularsMap = {
            AP: [
              'Present at Conference',
              'Guide student research and final year projects',
              'Attend FDPs / Workshop / Seminars',
              'NPTEL/ MOOC Certifications',
              'Facilitate Industry-Institutte interaction through Guest lectures, Internship',
              'Engage in extention activities and social outrich programs',
              'Membership in professional body'
            ],
            ASP: [
              'Publish in peer-reviewed journals',
              'Apply for research grants',
              'Guide student research and final year projects',
              'Organise FDPs / Workshop / Seminars',
              'NPTEL/ MOOC Certifications',
              'Facilitate Industry-Institutte interaction through Guest lectures, Internship',
              'Engage in consultancy',
              'Membership in professional body'
            ],
            Prof: [
              'Publish in peer-reviewed journals',
              'Apply for research grants',
              'Guide student research and final year projects',
              'Organise FDPs / Workshop / Seminars',
              'NPTEL/ MOOC Certifications',
              'Facilitate MOU',
              'Engage in consultancy',
              'Membership in professional body'
            ]
          };
          
          const particulars = particularsMap[desig];
          const tableName = desig === 'Prof' ? 'Prof(Yearly)' : `${desig}(Yearly)`;
          
          // All months
          const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
          
          // Fetch ALL form data for this faculty (all months)
          // Prof(Yearly) uses created_at, others use submitted_at
          const orderColumn = desig === 'Prof' ? 'created_at' : 'submitted_at';
          const { data: allFormData, error } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq('Department', department)
            .order(orderColumn, { ascending: false });
          
          if (error) {
            console.error('Error fetching yearly data:', error);
            document.getElementById('facultyYearlyTableContainer').innerHTML = `<div class="text-red-600 p-4">Error loading data: ${error.message || error}</div>`;
            return;
          }
          
          // Find matching rows for this faculty
          const facNamesLower = [facultyName, data['Portfolio Member Name'], data.email]
            .filter(Boolean)
            .map(n => n.toString().trim().toLowerCase());
          
          const matchingRows = (allFormData || []).filter(row => {
            const rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
            return facNamesLower.includes(rowName);
          });
          
          // Group by month and get latest for each month
          const monthDataMap = {};
          months.forEach(month => {
            const monthRows = matchingRows.filter(r => r.Month === month);
            if (monthRows.length > 0) {
              monthDataMap[month] = monthRows[0]; // Latest row for this month
            }
          });
          
          // Build table HTML - Vertical particulars, Horizontal months
          let html = '<div style="overflow-x:auto; max-height:600px; overflow-y:auto; border:1px solid #9ca3af; border-radius:8px;">';
          html += '<table class="w-full text-sm bg-white" style="border-collapse:collapse; min-width:1400px;">';
          html += '<thead class="bg-purple-100 text-purple-700" style="position:sticky; top:0; z-index:10;">';
          html += '<tr>';
          html += '<th class="px-3 py-2 border border-gray-400" style="background:#EDE9FE; position:sticky; left:0; z-index:20;">Particulars</th>';
          
          // Add month columns
          for (const month of months) {
            html += `<th class="px-3 py-2 border border-gray-400" style="background:#EDE9FE;">${month}</th>`;
          }
          html += '</tr></thead>';
          html += '<tbody>';
          
          // Add row for each particular
          for (let i = 0; i < particulars.length; i++) {
            const particularIndex = i + 1;
            html += '<tr class="hover:bg-gray-50">';
            html += `<td class="px-3 py-2 border border-gray-400 font-semibold" style="position:sticky; left:0; background:white; z-index:5;">${particularIndex}. ${particulars[i]}</td>`;
            
            // Add status for each month
            for (const month of months) {
              const monthData = monthDataMap[month];
              let statusVal = '<span class="text-red-600 font-bold">‚úó</span>'; // Default to wrong mark
              
              if (monthData) {
                const status = monthData[`Status_${particularIndex}`];
                if (status) {
                  const statusLower = status.toString().trim().toLowerCase();
                  if (statusLower === 'completed') {
                    statusVal = '<span class="text-green-600 font-bold">‚úì</span>';
                  } else if (statusLower === 'not applicable') {
                    statusVal = '<span class="text-gray-400">N/A</span>';
                  } else {
                    // For "in progress", "yet to be completed", "not started", or any other value
                    statusVal = '<span class="text-red-600 font-bold">‚úó</span>';
                  }
                } else {
                  // Null or empty status
                  statusVal = '<span class="text-red-600 font-bold">‚úó</span>';
                }
              }
              
              html += `<td class="px-3 py-2 border border-gray-400 text-center">${statusVal}</td>`;
            }
            html += '</tr>';
          }
          
          // Add percentage row at the bottom
          html += '<tr class="bg-purple-50 font-bold">';
          html += '<td class="px-3 py-2 border border-gray-400" style="position:sticky; left:0; background:#F3E8FF; z-index:5;">Percentage</td>';
          
          for (const month of months) {
            const monthData = monthDataMap[month];
            let percentage = 0;
            
            if (monthData) {
              let completedCount = 0;
              let applicableCount = 0; // Count only applicable fields (exclude N/A)
              
              for (let i = 1; i <= particulars.length; i++) {
                const status = monthData[`Status_${i}`];
                const statusLower = status ? status.toString().trim().toLowerCase() : '';
                
                // Exclude "Not Applicable" from calculation
                if (statusLower === 'not applicable') {
                  continue; // Skip this field
                }
                
                // Count this field as applicable
                applicableCount++;
                
                // Count as completed if status is "completed"
                if (statusLower === 'completed') {
                  completedCount++;
                }
              }
              
              percentage = applicableCount > 0 ? Math.round((completedCount / applicableCount) * 100) : 0;
            }
            
            const percentColor = percentage === 100 ? 'text-green-600' : percentage >= 50 ? 'text-orange-600' : 'text-red-600';
            html += `<td class="px-3 py-2 border border-gray-400 text-center ${percentColor}">${percentage}%</td>`;
          }
          
          html += '</tr>';
          
          // Add N/A count row
          html += '<tr class="bg-gray-100 font-semibold">';
          html += '<td class="px-3 py-2 border border-gray-400" style="position:sticky; left:0; background:#F3F4F6; z-index:5;">Number of N/A</td>';
          
          for (const month of months) {
            const monthData = monthDataMap[month];
            let naCount = 0;
            
            if (monthData) {
              for (let i = 1; i <= particulars.length; i++) {
                const status = monthData[`Status_${i}`];
                const statusLower = status ? status.toString().trim().toLowerCase() : '';
                
                if (statusLower === 'not applicable') {
                  naCount++;
                }
              }
            }
            
            html += `<td class="px-3 py-2 border border-gray-400 text-center text-gray-600">${naCount}</td>`;
          }
          
          html += '</tr>';
          html += '</tbody></table></div>';
          
          document.getElementById('facultyYearlyTableContainer').innerHTML = html;
        }
        
        loadFacultyYearlyTable();
        // --- End: Faculty Mandatory Scope - Yearly Table ---
        
        // --- Begin: Faculty Core Scope - Monthly Table ---
        let showAllCoreScopeRows = false;
        
        document.getElementById('toggleCoreScopeRowsBtn').addEventListener('click', () => {
          showAllCoreScopeRows = !showAllCoreScopeRows;
          const btn = document.getElementById('toggleCoreScopeRowsBtn');
          btn.textContent = showAllCoreScopeRows ? 'Hide Rows' : 'Show All Rows';
          loadFacultyCoreScopeTable();
        });
        
        async function loadFacultyCoreScopeTable() {
          const container = document.getElementById('facultyCoreScopeTableContainer');
          container.innerHTML = '<p class="text-gray-400 text-center py-4">Loading...</p>';
          
          const facultyName = data["Name"] || "";
          const department = data["department"] || "";
          const designation = (data["Designation"] || "").toUpperCase();
          
          // Fetch ALL Core_scope data for this department (all months)
          const { data: allData, error } = await supabaseClient
            .from('Core_scope')
            .select('*')
            .eq('Department', department)
            .order('submitted_at', { ascending: false });
          
          if (error) {
            console.error('Error fetching Core Scope data:', error);
            container.innerHTML = `<div class="text-red-600 p-4">Error loading data: ${error.message || error}</div>`;
            return;
          }
          
          if (!allData || allData.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-center">No Core Scope data available.</p>`;
            return;
          }
          
          // Find matching rows for this faculty
          const facNamesLower = [facultyName, data['Portfolio Member Name'], data.email]
            .filter(Boolean)
            .map(n => n.toString().trim().toLowerCase());
          
          const matchingRows = (allData || []).filter(row => {
            const rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
            return facNamesLower.includes(rowName);
          });
          
          // Group by month and get latest row per month
          const monthData = {};
          const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
          
          months.forEach(m => monthData[m] = null);
          
          matchingRows.forEach(row => {
            const month = row.Month;
            if (month && months.includes(month)) {
              if (!monthData[month]) monthData[month] = row;
            }
          });
          
          // Core Scope particulars (15 items)
          const particulars = [
            'Teaching & Curriculum Delivery',
            'Learning Process',
            'Assessment & Evaluation',
            'Innovation & Best Practices',
            'Student Support, Feedback & Analysis',
            'Student Progression',
            'Result / Outcome',
            'Research, Projects & Consultancy',
            'Teachers / Staff Training',
            'Academic / Outcome Support',
            'Professional Activities',
            'Institutional Responsibilities / Administrative Activities',
            'Co-Curricular & Extra-Curricular Activities',
            'Technical Services & Maintenance',
            'Community Engagement'
          ];
          
          // Build month-wise matrix table
          let html = '<div class="overflow-x-auto">';
          html += '<table class="w-full border border-gray-700 text-left text-xs">';
          html += '<thead><tr class="bg-gray-800 text-white">';
          html += '<th class="px-2 py-2 border border-gray-700 sticky left-0 bg-gray-800 z-10">Particulars</th>';
          
          months.forEach(month => {
            html += `<th class="px-2 py-2 border border-gray-700 text-center">${month}</th>`;
          });
          
          html += '</tr></thead>';
          html += '<tbody>';
          
          // Render particular rows (hidden by default)
          particulars.forEach((particular, idx) => {
            const rowDisplay = showAllCoreScopeRows ? '' : 'display:none;';
            html += `<tr class="hover:bg-gray-100 particular-row" style="${rowDisplay}">`;
            html += `<td class="px-2 py-2 border border-gray-700 font-semibold sticky left-0 bg-white z-5">${particular}</td>`;
            
            months.forEach(month => {
              const row = monthData[month];
              let statusVal = '-';
              
              if (row) {
                const statusKey = `Status_${idx + 1}`;
                const status = row[statusKey];
                const statusLower = (status + '').toLowerCase().trim();
                
                if (statusLower === 'completed') {
                  statusVal = '<span class="text-green-600 font-bold">‚úì</span>';
                } else if (statusLower === 'in progress') {
                  statusVal = '<span class="text-orange-600 font-bold">‚úó</span>';
                } else if (statusLower === 'yet to be completed') {
                  statusVal = '<span class="text-red-600 font-bold">‚úó</span>';
                } else if (statusLower === 'not applicable') {
                  statusVal = '<span class="text-gray-400">N/A</span>';
                } else {
                  statusVal = '<span class="text-red-600 font-bold">‚úó</span>';
                }
              }
              
              html += `<td class="px-2 py-2 border border-gray-700 text-center">${statusVal}</td>`;
            });
            
            html += '</tr>';
          });
          
          // Calculate and render percentage row (always visible)
          html += '<tr class="bg-blue-100 font-bold">';
          html += '<td class="px-2 py-2 border border-gray-700 sticky left-0 bg-blue-100 z-5">Percentage</td>';
          
          months.forEach(month => {
            const row = monthData[month];
            let percentage = 0;
            
            if (row) {
              let completedCount = 0;
              let notApplicableCount = 0;
              const totalCount = particulars.length;
              
              for (let i = 1; i <= particulars.length; i++) {
                const status = row[`Status_${i}`];
                const statusLower = (status + '').toLowerCase().trim();
                
                if (statusLower === 'not applicable') {
                  notApplicableCount++;
                } else if (statusLower === 'completed') {
                  completedCount++;
                }
              }
              
              const applicableCount = totalCount - notApplicableCount;
              percentage = applicableCount > 0 ? Math.round((completedCount / applicableCount) * 100) : 0;
            }
            
            html += `<td class="px-2 py-2 border border-gray-700 text-center">${percentage}%</td>`;
          });
          
          html += '</tr>';
          
          // Add N/A count row (always visible)
          html += '<tr class="bg-gray-100 font-semibold">';
          html += '<td class="px-2 py-2 border border-gray-700 sticky left-0 bg-gray-100 z-5">Number of N/A</td>';
          
          months.forEach(month => {
            const row = monthData[month];
            let naCount = 0;
            
            if (row) {
              for (let i = 1; i <= particulars.length; i++) {
                const status = row[`Status_${i}`];
                const statusLower = (status + '').toLowerCase().trim();
                
                if (statusLower === 'not applicable') {
                  naCount++;
                }
              }
            }
            
            html += `<td class="px-2 py-2 border border-gray-700 text-center text-gray-600">${naCount}</td>`;
          });
          
          html += '</tr>';
          html += '</tbody></table>';
          html += '</div>';
          
          container.innerHTML = html;
        }
        
        loadFacultyCoreScopeTable();
        // --- End: Faculty Core Scope - Monthly Table ---

        // --- Begin: Faculty Portfolio Status Table (AP/ASP/Prof) ---
        async function renderFacultyPortfolioStatusTable() {
          const name = data["Name"] || "";
          const department = data["department"] || "";
          const designation = (data["Designation"] || "").toUpperCase();
          let tableName = null;
          let scopes = [];
          if (designation === "AP") {
            tableName = "AP";
            scopes = [
              "1. Research Publications", "2. Research Projects", "3. Patents", "4. FDP/Workshops", "5. Awards", "6. Consultancy", "7. Memberships", "8. Resource Person", "9. Reviewer/Editor", "10. Others"
            ];
          } else if (designation === "ASP") {
            tableName = "ASP";
            scopes = [
              "1. Research Publications", "2. Research Projects", "3. Patents", "4. FDP/Workshops", "5. Awards", "6. Consultancy", "7. Memberships", "8. Resource Person", "9. Reviewer/Editor", "10. Others"
            ];
          } else if (designation === "PROF" || designation === "PROFESSOR") {
            tableName = "Prof";
            scopes = [
              "1. Research Publications", "2. Research Projects", "3. Patents", "4. FDP/Workshops", "5. Awards", "6. Consultancy", "7. Memberships", "8. Resource Person", "9. Reviewer/Editor", "10. Others"
            ];
          }
          if (!tableName) {
            document.getElementById("facultyPortfolioStatusTable").innerHTML = '<div class="text-gray-400">No portfolio status available for this designation.</div>';
            return;
          }
          // Fetch the most recent submission for this faculty (match Portfolio Member Name)
          const { data: portfolioRows, error } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq('Portfolio Member Name', name)
            .eq('Department', department)
            .order('submitted_at', { ascending: false })
            .limit(1);
          if (error || !portfolioRows || portfolioRows.length === 0) {
            document.getElementById("facultyPortfolioStatusTable").innerHTML = '<div class="text-gray-400">No recent portfolio submission found.</div>';
            return;
          }
          const row = portfolioRows[0];
          let html = '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-blue-100 text-blue-700"><tr><th class="px-2 py-1 border border-gray-400">Scope</th><th class="px-2 py-1 border border-gray-400">Status</th></tr></thead><tbody>';
          for (const scope of scopes) {
            let status = row[scope] || '-';
            let statusDisplay = '';
            if (typeof status === 'string') status = status.trim();
            if (status === '-' || status === '' || status == null) {
              statusDisplay = '<span class="text-red-600 font-semibold">Pending</span>';
            } else if (status.toLowerCase() === 'not applicable') {
              statusDisplay = '<span class="text-gray-400">Not Applicable</span>';
            } else {
              statusDisplay = '<span class="text-green-700 font-semibold">Completed</span>';
            }
            html += `<tr><td class="px-2 py-1 border border-gray-400">${scope}</td><td class="px-2 py-1 border border-gray-400">${statusDisplay}</td></tr>`;
          }
          html += '</tbody></table>';
          document.getElementById("facultyPortfolioStatusTable").innerHTML = html;
        }
        renderFacultyPortfolioStatusTable();
        // --- End: Faculty Portfolio Status Table ---

        // Assigned Institution Forms Section (with Open Form button)
        let assignedFormsArr = [];
        try {
          assignedFormsArr = data["assigned_forms"] ? JSON.parse(data["assigned_forms"]) : [];
        } catch (e) {}
        // Map form names to HTML file links (keep in sync with principal-select-faculty.html)
        const formNameToFile = {
          'Director ‚Äì Students welfare & Admission': 'institution-form1.html',
          'Head - HR': 'institution-form2.html',
          'Principal': 'institution-form3.html',
          'Dean - IQAC': 'institution-form4.html',
          'Director - Academics': 'institution-form5.html',
          'Controller of Examinations': 'institution-form6.html',
          'Executive Dean ‚Äì International Affairs': 'institution-form7.html',
          'Head - Placements': 'institution-form8.html',
          'Placement officer': 'institution-form9.html',
          'Head ‚Äì Training': 'institution-form10.html',
          'Training officer': 'institution-form11.html',
          'Head - RISE': 'institution-form12.html',
          'IT Infra ‚Äì Coordinator': 'institution-form13.html',
          'Website ‚Äì Coordinator': 'institution-form14.html',
          'ERP Coordinator': 'institution-form15.html',
          'Public Relations officer': 'institution-form16.html',
          'Logistics Coordinator': 'institution-form17.html',
        };
        let assignedFormsHtml = '';
        if (Array.isArray(assignedFormsArr) && assignedFormsArr.length > 0) {
          assignedFormsHtml = `<div class="mt-8">
            <label class="text-base font-bold text-gray-700 uppercase tracking-wide block mb-1">Institution Forms</label>
            <table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white">
              <thead class='bg-purple-700 text-white'>
                <tr><th class="px-4 py-2">Form Name</th><th class="px-4 py-2">Faculty Name</th><th class="px-4 py-2">Open</th></tr>
              </thead>
              <tbody>
                ${assignedFormsArr.map(f => {
                  const file = formNameToFile[f] || '#';
                  const formId = file.replace('.html', '');
                  return `<tr><td class="px-4 py-2">${f}</td><td class="px-4 py-2">${data['Name'] || ''}</td><td class="px-4 py-2"><button onclick="openForm('${file}', '${data['department']}', '${f}', '${data['Name']}')" class="inline-flex items-center gap-2 rounded-full bg-purple-700 text-white px-4 py-2 text-xs font-medium hover:bg-purple-800 transition">Open Form</button></td></tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
        } else {
          assignedFormsHtml = '<div class="mt-8"><label class="text-base font-bold text-gray-700 uppercase tracking-wide block mb-1">Institution Forms</label><div class="text-gray-400">No forms assigned.</div></div>';
        }
        // Insert into the institution forms container
        const institutionFormsContainer = document.getElementById('institutionFormsContainer');
        if (institutionFormsContainer) {
          institutionFormsContainer.innerHTML = assignedFormsHtml;
        }

        // SEM, SUBJECT, CLASS Table
        let semSubjectClassArr = [];
        try {
          semSubjectClassArr = data["SEM_SUBJECT_CLASS"]
            ? JSON.parse(data["SEM_SUBJECT_CLASS"])
            : [];
        } catch (e) {}
        let semTableHtml = "";
      // Edit/Save logic for profile
      function setEditMode(editable) {
        const form = document.getElementById('facultyEditForm');
        Array.from(form.elements).forEach(el => {
          if (el.tagName === 'INPUT') {
            el.disabled = !editable;
          }
        });
        document.getElementById('editProfileBtn').style.display = editable ? 'none' : '';
        document.getElementById('saveProfileBtn').classList.toggle('hidden', !editable);
        document.getElementById('editStatusMsg').textContent = '';
      }
      document.getElementById('editProfileBtn').addEventListener('click', function() {
        setEditMode(true);
      });
      document.getElementById('facultyEditForm').addEventListener('input', function() {
        // Show save button if any field changed
        const orig = window._facultyProfileOriginal;
        let changed = false;
        for (const key in orig) {
          const el = document.getElementsByName(key)[0];
          if (el && el.value !== orig[key]) {
            changed = true;
            break;
          }
        }
        document.getElementById('saveProfileBtn').classList.toggle('hidden', !changed);
      });
      document.getElementById('facultyEditForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const updateData = {};
        const orig = window._facultyProfileOriginal;
        let changed = false;
        for (const key in orig) {
          const el = form.elements[key];
          if (el && el.value !== orig[key]) {
            updateData[key] = el.value;
            changed = true;
          }
        }
        // Handle image upload if changed
        let imageUrl = null;
        if (window._facultyProfileImageFile) {
          document.getElementById('editStatusMsg').textContent = 'Uploading image...';
          const file = window._facultyProfileImageFile;
          const fileExt = file.name.split('.').pop();
          const fileName = `faculty_${orig.email.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.${fileExt}`;
          const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('faculty-images').upload(fileName, file, { upsert: true });
          if (uploadError) {
            document.getElementById('editStatusMsg').textContent = 'Image upload failed: ' + (uploadError.message || uploadError);
            document.getElementById('saveProfileBtn').disabled = false;
            return;
          }
          // Get public URL
          const { data: publicUrlData } = supabaseClient.storage.from('faculty-images').getPublicUrl(fileName);
          imageUrl = publicUrlData.publicUrl;
          updateData['Upload Image'] = imageUrl;
          changed = true;
        }
        if (!changed) {
          setEditMode(false);
          return;
        }
        document.getElementById('saveProfileBtn').disabled = true;
        document.getElementById('editStatusMsg').textContent = 'Saving...';
        // Update Faculty table by email
        const { error } = await supabaseClient
          .from('Faculty')
          .update(updateData)
          .eq('email', orig.email);
        if (error) {
          document.getElementById('editStatusMsg').textContent = 'Update failed: ' + (error.message || error);
          document.getElementById('saveProfileBtn').disabled = false;
        } else {
          document.getElementById('editStatusMsg').textContent = 'Profile updated successfully!';
          // Update original data
          for (const key in updateData) {
            orig[key] = updateData[key];
          }
          if (imageUrl) {
            document.getElementById('facultyImage').src = imageUrl;
            window._facultyProfileImageFile = null;
          }
          setEditMode(false);
        }
      });
        if (
          Array.isArray(semSubjectClassArr) &&
          semSubjectClassArr.length > 0
        ) {
          semTableHtml =
            `<div class="overflow-x-auto"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white">
          <thead class='bg-purple-700 text-white'>
            <tr><th class="px-4 py-2">SEM</th><th class="px-4 py-2">SUBJECT</th><th class="px-4 py-2">CLASS</th></tr>
          </thead>
          <tbody>` +
            semSubjectClassArr
              .map(
                (row, idx) =>
                  `<tr class="${
                    idx % 2 === 0 ? "bg-gray-50" : "bg-white"
                  }"><td class="px-2 py-2">${
                    row.sem || ""
                  }</td><td class="px-2 py-2">${
                    row.subject || ""
                  }</td><td class="px-2 py-2">${row.class || ""}</td></tr>`
              )
              .join("") +
            `</tbody></table></div>`;
        } else {
          semTableHtml = '<div class="text-gray-400">No data</div>';
        }
        document.getElementById("facultySemSubjectClassTable").innerHTML =
          semTableHtml;
        // Forms assigned: show only 'yes' as table rows with real names and links
        const formNames = [
          "Students Performance in Training & Placement Member",
          "Class Advisor",
          "Faculty Information & Contribution Member",
          "Course Outcome & Program Outcome Member (Exam Cell)",
          "Continuous Improvement Member (Program Member)",
          "Teaching & Learning Process Member (IQAC)",
          "Student Support System Member (Discipline & Extra Curricular)",
          "Facilities & Technical Support Member (Lab Member)",
        ];
        const formLinks = [
          "faculty-form1.html",
          "faculty-form2.html",
          "faculty-form3.html",
          "faculty-form4.html",
          "faculty-form5.html",
          "faculty-form6.html",
          "faculty-form7.html",
          "faculty-form8.html",
        ];
        let formsHtmlDept = "";
        let formsHtmlCore = "";
        let countDept = 1;
        let countCore = 1;
        for (let i = 1; i <= 8; i++) {
          if (data[`form${i}`] && data[`form${i}`].toLowerCase() === "yes") {
            // Compose portfolio name with frequency for auto-fill
            let portfolioName = formNames[i - 1];
            let frequency = '';
            if (formLinks[i - 1].includes('form1')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form2')) frequency = ' (Daily)';
            if (formLinks[i - 1].includes('form3')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form4')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form5')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form6')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form7')) frequency = ' (Weekly)';
            if (formLinks[i - 1].includes('form8')) frequency = ' (Weekly)';
            let fullPortfolio = portfolioName + frequency;
            formsHtmlDept += `<tr><td class="p-4 align-top">${countDept}</td><td class="p-4 align-top">${portfolioName}</td><td class="p-4 align-top"><button onclick="openForm('${formLinks[i - 1]}', '${data['department']}', '${fullPortfolio}', '${data['Name']}')" class="inline-flex items-center gap-2 rounded-full bg-purple-700 text-white px-4 py-2 text-xs font-medium hover:bg-purple-800 transition">Open Form</button></td></tr>`;
            countDept++;
          }
        }
        // Add the 9th form based on Designation
        let designation = (data["Designation"] || "")
          .toString()
          .trim()
          .toUpperCase();
        let ninthFormName = "";
        let ninthFormLink = "";
        if (designation === "AP") {
          ninthFormName = "AP Core Scope Form";
          ninthFormLink = "form-ap.html";
        } else if (designation === "ASP") {
          ninthFormName = "ASP Core Scope Form";
          ninthFormLink = "form-asp.html";
        } else if (designation === "PROF" || designation === "PROFESSOR") {
          ninthFormName = "Professor Core Scope Form";
          ninthFormLink = "form-prof.html";
        }
        if (ninthFormName && ninthFormLink) {
          formsHtmlCore += `<tr><td class="px-4 py-2">1</td><td class="px-4 py-2">${ninthFormName}</td><td class="px-4 py-2"><button onclick="openCoreScopeModal('${ninthFormLink}', '${data['department']}', '${ninthFormName}', '${data['Name']}', '${designation}')" class="inline-flex items-center gap-2 rounded-full bg-purple-700 text-white px-4 py-2 text-xs font-medium hover:bg-purple-800 transition">Open Form</button></td></tr>`;
        }
        document.getElementById("facultyFormsDept").innerHTML =
          formsHtmlDept ||
          '<tr><td colspan="3" class="text-gray-400 text-center p-4">No roles assigned.</td></tr>';
        document.getElementById("facultyFormsCore").innerHTML =
          formsHtmlCore ||
          '<tr><td colspan="3" class="text-gray-400 text-center p-4">No core scope form assigned.</td></tr>';
      
      // Core Scope Modal Functions
      let _coreScopeFormData = {};
      
      window.openCoreScopeModal = function(yearlyFormUrl, department, portfolio, memberName, designation) {
        // Store data for later use
        _coreScopeFormData = {
          yearlyFormUrl: yearlyFormUrl,
          department: department,
          portfolio: portfolio,
          memberName: memberName,
          designation: designation
        };
        
        // Show modal
        document.getElementById('coreScopeSelectionModal').classList.remove('hidden');
      };
      
      window.closeCoreScopeModal = function() {
        document.getElementById('coreScopeSelectionModal').classList.add('hidden');
        _coreScopeFormData = {};
      };
      
      // Monthly Form Button Handler
      document.getElementById('monthlyFormBtn').addEventListener('click', function() {
        // For monthly, always use faculty-core-scope.html regardless of designation
        openForm('faculty-core-scope.html', _coreScopeFormData.department, 'Faculty Core Scope (Monthly)', _coreScopeFormData.memberName, _coreScopeFormData.designation);
        closeCoreScopeModal();
      });
      
      // Yearly Form Button Handler
      document.getElementById('yearlyFormBtn').addEventListener('click', function() {
        // For yearly, use the designation-specific form
        openForm(_coreScopeFormData.yearlyFormUrl, _coreScopeFormData.department, _coreScopeFormData.portfolio, _coreScopeFormData.memberName, _coreScopeFormData.designation);
        closeCoreScopeModal();
      });
      
      // Auto-fetch Open Form logic with form status check
      window.openForm = async function(formUrl, department, portfolio, memberName, designation) {
        try {
          // Extract form identifier from URL
          let formId = formUrl.replace('.html', '');
          
          // Check form status from formstatus table
          const { data: formStatus, error } = await supabaseClient
            .from('formstatus')
            .select('is_open, form_title')
            .eq('form_name', formId)
            .single();

          if (error) {
            console.warn('Could not check form status:', error);
            // If we can't check status, allow form to open (fallback)
            localStorage.setItem('selectedDepartment', department);
            localStorage.setItem('selectedPortfolio', portfolio);
            localStorage.setItem('selectedMemberName', memberName);
            if (designation) localStorage.setItem('selectedDesignation', designation);
            window.location.href = formUrl;
            return;
          }

          // Check if form is open
          if (formStatus && formStatus.is_open === false) {
            // Show closed message
            showFormClosedModal(formStatus.form_title || formId);
            return;
          }

          // Form is open, proceed normally
          localStorage.setItem('selectedDepartment', department);
          localStorage.setItem('selectedPortfolio', portfolio);
          localStorage.setItem('selectedMemberName', memberName);
          if (designation) localStorage.setItem('selectedDesignation', designation);
          window.location.href = formUrl;

        } catch (error) {
          console.error('Error checking form status:', error);
          // Fallback: allow form to open
          localStorage.setItem('selectedDepartment', department);
          localStorage.setItem('selectedPortfolio', portfolio);
          localStorage.setItem('selectedMemberName', memberName);
          if (designation) localStorage.setItem('selectedDesignation', designation);
          window.location.href = formUrl;
        }
      }

      // Show form closed modal
      function showFormClosedModal(formTitle) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
            <div class="text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-lock text-red-600 text-xl"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Form Closed</h3>
              <p class="text-sm text-gray-500 mb-6">
                The form "<strong>${formTitle}</strong>" is currently closed and not accepting submissions.
                <br><br>
                Please contact the administrator for more information.
              </p>
              <button onclick="this.closest('.fixed').remove()" 
                      class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium">
                OK
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
        // Load Workdone Section using centralized JS
        const workdoneTable = new WorkdoneTable(supabaseClient);
        workdoneTable.initWorkdoneSection(data["Name"], data["Designation"]);
      }

      loadFacultyProfile();
      // After profile loads, cache faculty name for notifications
      document.addEventListener('DOMContentLoaded', function() {
        var nameInput = document.getElementById('facultyName');
        if (nameInput && nameInput.value) {
          localStorage.setItem('pmc_faculty_name', nameInput.value);
        }
      });
    </script>

    <!-- View Modal for Workdone Details -->
    <div id="viewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <div id="viewModalContent"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4 mt-8">
    <p class="text-sm">
      &copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br>
      <p class="text-xs opacity-80 flex items-center justify-center gap-2">
                        Powered by 
                        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
                            <img src="../static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
                        </a><p class="text-xs opacity-80">A Student driven Software!</p>
    </p>
  </footer>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="/static/javascript/supabase-notifications.js"></script>
</body>
  <!-- Supabase Notification Modal -->
  <div id="messagingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
      <button onclick="document.getElementById('messagingModal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-pmcPurple text-2xl font-bold">&times;</button>
      <h2 class="text-xl font-bold text-pmcPurple mb-4 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a2.25 2.25 0 01-4.07 0M21 19.5a1.5 1.5 0 01-1.5-1.5V11a7.5 7.5 0 10-15 0v7a1.5 1.5 0 01-1.5 1.5h18z" />
        </svg>
        Notifications
      </h2>
      <div id="notificationList" class="h-48 overflow-y-auto border rounded p-2 mb-4 bg-gray-50"></div>
      <div class="flex gap-2">
        <input id="messageInput" type="text" class="flex-1 border border-pmcPurple rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pmcPurple text-black" placeholder="Type a notification..." onkeydown="if(event.key==='Enter'){postNotification()}" />
        <button onclick="postNotification()" class="bg-purple-800 hover:bg-green-900 text-white px-4 py-2 rounded font-semibold">Send</button>
      </div>
    </div>
  </div>
</body>
</html>
        
