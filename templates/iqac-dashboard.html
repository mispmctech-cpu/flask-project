<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IQAC Dashboard - Faculty Core Scope Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-pmcBg min-h-screen">
  <header class="bg-purple-700 text-white w-full">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 rounded shadow bg-white p-1" />
        <span class="ml-4 text-xl font-bold">IQAC Dashboard</span>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Export Scope Modal -->
    <div id="exportScopeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button onclick="closeExportScopeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-lg font-bold mb-4 text-purple-700">Export Dashboard Table</h3>
        <p class="mb-4 text-gray-700">Select export scope:</p>
        <div class="flex flex-col gap-3">
          <button id="exportCurrentDeptBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Current Department</button>
          <button id="exportAllDeptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">All Departments</button>
        </div>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-purple-700 mb-6">Faculty Core Scope Compliance Table</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="departmentFilter" class="font-medium text-purple-700 mr-2">Filter by Department:</label>
      <select id="departmentFilter" class="p-2 border rounded"></select>
      <label for="designationFilter" class="font-medium text-purple-700 mr-2">Filter by Designation:</label>
      <select id="designationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <button id="exportDashboardTableBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export dashboard table to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Dashboard Table
      </button>
    </div>
    <div id="dashboardTableContainer" class="overflow-x-auto"></div>
    <!-- Department Portfolios Table -->
    <div id="departmentPortfoliosStickyHeader" class="flex flex-wrap gap-4 items-center mb-4 bg-white z-20" style="position:sticky; top:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
      <label for="portfolioDepartmentFilter" class="font-medium text-orange-700 mr-2">Filter by Department:</label>
      <select id="portfolioDepartmentFilter" class="p-2 border rounded"></select>
      <label for="portfolioStatusFilter" class="font-medium text-orange-700 mr-2">Show:</label>
      <select id="portfolioStatusFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="Completed">Completed </option>
        <option value="Pending">Pending </option>
      </select>
      <button id="exportDepartmentPortfoliosBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export department portfolios to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Portfolios Table
      </button>
    </div>
    <div id="departmentPortfoliosContainer" class="overflow-x-auto mt-2"></div>
    <!-- Modal for viewing original form -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>
  </main>
  <script src="/static/javascript/form-modal-mapper.js"></script>
<script>
// Export Scope Modal logic
function openExportScopeModal() {
  document.getElementById('exportScopeModal').classList.remove('hidden');
}
function closeExportScopeModal() {
  document.getElementById('exportScopeModal').classList.add('hidden');
}
// Export table to Excel utility
function exportTableToExcelById(tableId, filenamePrefix) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const data = [headers];
  // Special handling for Department Portfolios table
  if (tableId === 'portfoliosTableExport') {
    rows.forEach(row => {
      const cells = [];
      Array.from(row.querySelectorAll('td')).forEach((td, idx) => {
        // For portfolio columns, faculty names may have tick/cross SVGs
        if (idx === 0) {
          // Department column, just text
          cells.push(td.innerText.trim());
        } else {
          // Portfolio columns: may have multiple faculty names
          const divs = td.querySelectorAll('div');
          if (divs.length === 0) {
            cells.push('-');
          } else {
            let names = [];
            divs.forEach(div => {
              let name = '';
              // Check for tick/cross SVG
              if (div.querySelector('svg.h-6.w-6.text-green-500')) {
                // Tick
                name = div.textContent.replace(/\s+/g, ' ').trim() + ' (C)';
              } else if (div.querySelector('svg.h-6.w-6.text-red-500')) {
                // Cross
                name = div.textContent.replace(/\s+/g, ' ').trim() + ' (N)';
              } else {
                name = div.textContent.replace(/\s+/g, ' ').trim();
              }
              names.push(name);
            });
            cells.push(names.join(', '));
          }
        }
      });
      data.push(cells);
    });
  } else {
    // Default: just text
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.trim());
      data.push(cells);
    });
  }
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, filenamePrefix);
  XLSX.writeFile(wb, `${filenamePrefix}.xlsx`);
}

// Attach export button listeners after tables are rendered
function attachExportButtons() {
  setTimeout(() => {
    const dashboardTable = document.querySelector('#dashboardTableContainer table');
    if (dashboardTable) {
      document.getElementById('exportDashboardTableBtn').onclick = () => {
        openExportScopeModal();
      };
      dashboardTable.id = dashboardTable.id || 'dashboardTableExport';
      // Attach modal button logic
      setTimeout(() => {
        const currentBtn = document.getElementById('exportCurrentDeptBtn');
        const allBtn = document.getElementById('exportAllDeptBtn');
        if (currentBtn && allBtn) {
          currentBtn.onclick = () => {
            closeExportScopeModal();
            exportTableToExcelById(dashboardTable.id || 'dashboardTableExport', 'IQAC_Dashboard_' + selectedDepartment);
          };
          allBtn.onclick = async () => {
            closeExportScopeModal();
            // Export all departments: fetch all from ap_compliance, asp_compliance, prof_compliance
            const apRes = await supabaseClient.from('ap_compliance').select('*');
            const aspRes = await supabaseClient.from('asp_compliance').select('*');
            const profRes = await supabaseClient.from('prof_compliance').select('*');
            const allData = [
              { label: 'AP', data: apRes.data || [] },
              { label: 'ASP', data: aspRes.data || [] },
              { label: 'Prof', data: profRes.data || [] }
            ];
            const wb = XLSX.utils.book_new();
            allData.forEach(({ label, data }) => {
              if (data.length === 0) return;
              // Get all unique keys for columns
              const keys = Array.from(new Set(data.flatMap(row => Object.keys(row))));
              const sheetData = [keys];
              data.forEach(row => {
                sheetData.push(keys.map(k => row[k] || ''));
              });
              const ws = XLSX.utils.aoa_to_sheet(sheetData);
              XLSX.utils.book_append_sheet(wb, ws, label);
            });
            XLSX.writeFile(wb, 'IQAC_Dashboard_All_Departments.xlsx');
          };
        }
      }, 600);
    }
    document.getElementById('exportDepartmentPortfoliosBtn').onclick = async () => {
      // Fetch all faculty data for all departments
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        alert('Failed to load department portfolios for export.');
        return;
      }
      // Get all unique departments
      const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      const portfolioHeaders = [
        "1. Training & Placement",
        "2. Class Advisor",
        "3. Info & Contribution",
        "4. Outcome & Exam Cell",
        "5. Continuous Improvement",
        "6. T&L Process (IQAC)",
        "7. Student Support",
        "8. Facilities & Lab"
      ];
      const headers = ["Department", ...portfolioHeaders];
      const weeklyFormTables = [
        'form1-Weekly',
        'form2-weekly',
        'form3-Weekly',
        'form4-Weekly',
        'form5-weekly',
        'form6_weekly',
        'form7-Weekly',
        'form8-weekly'
      ];
      // Fetch all weekly form data for all portfolios
      const weeklyData = [];
      for (let i = 0; i < weeklyFormTables.length; i++) {
        const { data: wdata } = await supabaseClient
          .from(weeklyFormTables[i])
          .select('*');
        weeklyData.push(wdata || []);
      }
      const exportRows = [];
      for (const dept of departments) {
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        const row = [dept];
        for (let i = 1; i <= 8; i++) {
          const formKey = `form${i}`;
          const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
          if (assignedList.length > 0) {
            let names = [];
            for (const fac of assignedList) {
              const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
              // Check weekly form completion for tick/cross (any submission, not just current week)
              let filled = false;
              const wdata = weeklyData[i-1];
              if (wdata && wdata.length > 0) {
                filled = wdata.some(row => {
                  const rowName = row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                  return rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase();
                });
              }
              names.push(facultyName + (filled ? ' (C)' : ' (N)'));
            }
            row.push(names.join(', '));
          } else {
            row.push('-');
          }
        }
        exportRows.push(row);
      }
      const ws = XLSX.utils.aoa_to_sheet([headers, ...exportRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Portfolios');
      XLSX.writeFile(wb, 'IQAC_Portfolios_All_Departments.xlsx');
    };
  }, 500);
}
  // Fetch and render department portfolios table (IQAC)
    async function loadDepartmentPortfoliosIQAC() {
      // Fetch all faculty
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-red-500">Failed to load department portfolios.</div>';
        return;
      }
      // Get all unique departments
      const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      // Setup department filter dropdown
      const deptFilter = document.getElementById('portfolioDepartmentFilter');
      if (!deptFilter.dataset.initialized) {
        deptFilter.innerHTML = '<option value="All">All Departments</option>' + departments.map(d => `<option value="${d}">${d}</option>`).join('');
        deptFilter.dataset.initialized = 'true';
      }
      // Setup status filter dropdown
      const statusFilter = document.getElementById('portfolioStatusFilter');
      // Get selected filter values (re-read each time for correct filtering)
      const selectedDept = deptFilter.options[deptFilter.selectedIndex]?.value || 'All';
      const selectedStatus = statusFilter.options[statusFilter.selectedIndex]?.value || 'All';

  let html = '';
  html += '<div style="position:sticky; top:0; z-index:30; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.04);">';
  html += '<h3 class="text-xl font-bold text-orange-500 mb-2">Department Portfolios</h3>';
  // Removed duplicate controls under Department Portfolios heading
  html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px;">';
  html += '<thead class="bg-orange-100 text-orange-700">';
  html += '<tr style="position:sticky; top:56px; background:#FEF3C7; z-index:20;">';
  html += '<th class="px-1 py-1 border border-gray-400" style="width:90px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">Department</th>';
  const portfolioHeaders = [
    "1. Training & Placement",
    "2. Class Advisor",
    "3. Info & Contribution",
    "4. Outcome & Exam Cell",
    "5. Continuous Improvement",
    "6. T&L Process (IQAC)",
    "7. Student Support",
    "8. Facilities & Lab"
  ];
  for (let i = 0; i < portfolioHeaders.length; i++) html += `<th class="px-1 py-1 border border-gray-400" style="width:120px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">${portfolioHeaders[i]}</th>`;
  html += '</tr></thead></table>';
  html += '</div>';
  html += '<div style="overflow-x:auto; max-height:500px; overflow-y:auto;">';
  html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px; margin-top:-1px;">';
  html += '<tbody>';
      for (const dept of departments) {
        if (selectedDept !== 'All' && dept !== selectedDept) continue;
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        html += `<tr>`;
        html += `<td class="px-1 py-1 font-semibold text-purple-700 border border-gray-400" style="word-break:break-word;">${dept}</td>`;
        for (let i = 1; i <= 8; i++) {
          const formKey = `form${i}`;
          const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
          if (assignedList.length > 0) {
            html += `<td class="px-1 py-1 border border-gray-400" style="word-break:break-word;">`;
            for (const fac of assignedList) {
              const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
              html += `<div class="flex items-center gap-1" style="font-size:11px;"><span id="portfolio-status-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${i}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}" class="inline-block"></span>${facultyName}</div>`;
            }
            html += `</td>`;
          } else {
            html += `<td class="px-1 py-1 border border-gray-400">-</td>`;
          }
        }
        html += '</tr>';
      }
  html += '</tbody></table></div>';
  document.getElementById('departmentPortfoliosContainer').innerHTML = html;

      // Only use the specified weekly form tables
      const weeklyFormTables = [
        'form1-Weekly',
        'form2-weekly',
        'form3-Weekly',
        'form4-Weekly',
        'form5-weekly',
        'form6_weekly',
        'form7-Weekly',
        'form8-weekly'
      ];
      for (const dept of departments) {
        if (selectedDept !== 'All' && dept !== selectedDept) continue;
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        for (let i = 1; i <= 8; i++) {
          const formKey = `form${i}`;
          const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
          for (const fac of assignedList) {
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
            const statusSpanId = `portfolio-status-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${i}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            // Async check for weekly form completion ONLY in specified tables
              (async () => {
                const tableName = weeklyFormTables[i-1];
                const { data: formData, error } = await supabaseClient
                  .from(tableName)
                  .select('*')
                  .eq('Department', dept);
                let filled = false;
                if (!error && formData && formData.length > 0) {
                  // Check if any entry matches faculty name (no week filter)
                  filled = formData.some(row => {
                    const rowName = row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                    return rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase();
                  });
                }
                const statusSpan = document.getElementById(statusSpanId);
                if (statusSpan) {
                  // Filter by status
                  if (selectedStatus === 'Completed' && !filled) {
                    statusSpan.parentElement.style.display = 'none';
                    return;
                  }
                  if (selectedStatus === 'Pending' && filled) {
                    statusSpan.parentElement.style.display = 'none';
                    return;
                  }
                  statusSpan.innerHTML = filled
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                }
              })();
          }
        }
      }

      // Add filter event listeners
      deptFilter.onchange = statusFilter.onchange = () => loadDepartmentPortfoliosIQAC();
    }
  </script>
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cbhodgwaazmjszkujrti.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    let allDepartments = [];
    let selectedDepartment = '';
    async function loadDepartments() {
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('department');
      if (error || !data) return;
      const depts = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      allDepartments = depts;
      const select = document.getElementById('departmentFilter');
      select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
      selectedDepartment = depts[0] || '';
      select.value = selectedDepartment;
      select.addEventListener('change', () => {
        selectedDepartment = select.value;
        loadDashboardTable();
      });
    }
    async function loadDashboardTable() {
      if (!selectedDepartment) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', selectedDepartment);
      if (error || !data || data.length === 0) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      renderDashboardTable(data);
    }
    function renderDashboardTable(facultyList) {
  // ...existing code...
  // After rendering dashboard table, render department portfolios table
  loadDepartmentPortfoliosIQAC();
  attachExportButtons();
      const designationFilter = document.getElementById('designationFilter').value;
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      const particularsMap = {
        AP: [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body'
        ],
        ASP: [
          'Research Publications',
          'Innovations',
          'Extension Activities',
          'Faculty Development',
          'Student Mentoring',
          'Curriculum Development',
          'Other Contributions',
          'Leadership Roles'
        ],
        Prof: [
          'Research Publications',
          'Innovations',
          'Extension Activities',
          'Faculty Development',
          'Student Mentoring',
          'Curriculum Development',
          'Other Contributions',
          'Leadership Roles'
        ]
      };
      (async function renderDashboardAsync() {
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('ap_compliance').select('*').eq('department', selectedDepartment),
          supabaseClient.from('asp_compliance').select('*').eq('department', selectedDepartment),
          supabaseClient.from('prof_compliance').select('*').eq('department', selectedDepartment)
        ]);
        function getLatestRows(data) {
          const latest = {};
          data.forEach(row => {
            const email = row.faculty_email;
            if (!latest[email] || row.id > latest[email].id) {
              latest[email] = row;
            }
          });
          return Object.values(latest);
        }
        const apDataLatest = getLatestRows(apRes.data || []);
        const aspDataLatest = getLatestRows(aspRes.data || []);
        const profDataLatest = getLatestRows(profRes.data || []);
        for (const key of ['AP', 'ASP', 'Prof']) {
          if (designationFilter !== 'All' && designationFilter !== key) continue;
          const group = groups[key];
          if (group.length === 0) continue;
          html += `<h3 class="text-xl font-semibold text-purple-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
          const particulars = particularsMap[key];
          html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-purple-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
          particulars.forEach(particular => {
            html += `<th class="px-4 py-2">${particular}</th>`;
          });
          html += `</tr></thead><tbody>`;
          for (const fac of group) {
            html += `<tr><td class="px-2 py-2 font-medium text-purple-700 cursor-pointer underline" onclick="viewFacultyForm('${fac.email}','${key}','${fac.Name ? fac.Name.replace(/'/g, "\'") : ''}')">${fac.Name || ''}</td>`;
            let complianceRow = null;
            if (key === 'AP') complianceRow = apDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'ASP') complianceRow = aspDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'Prof') complianceRow = profDataLatest.find(r => r.faculty_email === fac.email);
            for (let i = 0; i < particulars.length; i++) {
              let compliance = complianceRow ? complianceRow[`compliance_${i+1}`] : null;
              let complianceClass = '';
              let display = '-';
              if (compliance) {
                const val = compliance.trim().toLowerCase();
                if (val === 'yes' || val === 'completed') {
                  complianceClass = 'text-green-600 font-bold';
                  display = 'Completed';
                } else if (val === 'no' || val === 'incomplete') {
                  complianceClass = 'text-red-600 font-bold';
                  display = 'Incomplete';
                } else {
                  complianceClass = 'text-gray-500';
                  display = val;
                }
              } else {
                complianceClass = 'text-gray-500';
              }
              html += `<td class="px-2 py-2 ${complianceClass}">${display}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }
        document.getElementById('dashboardTableContainer').innerHTML = html || '<div class="text-gray-500">No compliance data found.</div>';
      })();
    }
    document.getElementById('designationFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    function closeViewFormModal() {
      document.getElementById('viewFormModal').classList.add('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '';
      document.getElementById('viewFormModalTitle').textContent = 'Faculty Form Details';
    }
    async function viewFacultyForm(email, designation, facultyName) {
      document.getElementById('viewFormModal').classList.remove('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      if (designation === 'AP') tableName = 'AP';
      else if (designation === 'ASP') tableName = 'ASP';
      else if (designation === 'Prof') tableName = 'Prof';
      else {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq('Department', selectedDepartment);
      if (error || !data || data.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const nameTrimmed = (facultyName || '').toString().trim().toLowerCase();
      let filtered = data.filter(row => {
        let rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        return rowName === nameTrimmed;
      });
      if (filtered.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">No form data found for this faculty name.</div>';
        return;
      }
      filtered.sort((a, b) => (b.id || 0) - (a.id || 0));
      const row = filtered[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-purple-700">Department:</div>
        <div class="mb-2">${row['Department'] || row['Department:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          // Check if it's a valid URL or file path
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-purple-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-purple-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-purple-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewFormModalContent').innerHTML = html;
      document.getElementById('viewFormModalTitle').textContent = `${designation} Form Details`;
    }
    loadDepartments().then(loadDashboardTable);
  </script>
  <footer class="text-center py-4 mt-8">
    <p class="text-gray-400 text-sm"> © All Rights Reserved <a href="https://pmctech.org" target="_blank" class="text-gray-400 hover:text-gray-600 underline">PMC TECH</a>, IV CSE 2022-2026.<br/> 
    </p>
  </footer>
</body>
</html>
