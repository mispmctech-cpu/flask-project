<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IQAC Dashboard - Faculty Core Scope Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-pmcBg min-h-screen">
  <header class="bg-purple-700 text-white w-full">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 rounded shadow bg-white p-1" />
        <span class="ml-4 text-xl font-bold">IQAC Dashboard</span>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8">
  <!-- Export Scope Modal -->
    <div id="exportScopeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button onclick="closeExportScopeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-lg font-bold mb-4 text-purple-700">Export Dashboard Table</h3>
        <p class="mb-4 text-gray-700">Select export scope:</p>
        <div class="flex flex-col gap-3">
          <button id="exportCurrentDeptBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Current Department</button>
          <button id="exportAllDeptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">All Departments</button>
        </div>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-purple-700 mb-6">Faculty Core Scope Compliance Table</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="departmentFilter" class="font-medium text-purple-700 mr-2">Filter by Department:</label>
      <select id="departmentFilter" class="p-2 border rounded"></select>
      <label for="designationFilter" class="font-medium text-purple-700 mr-2">Filter by Designation:</label>
      <select id="designationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <button id="exportDashboardTableBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export dashboard table to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Dashboard Table
      </button>
    </div>
    <div id="dashboardTableContainer" class="overflow-x-auto"></div>

    <!-- NEW: Faculty Status Table from AP, ASP, Prof tables -->
    <h2 class="text-2xl font-bold text-blue-700 mt-12 mb-6">Faculty Portfolio Status Table</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="statusDepartmentFilter" class="font-medium text-blue-700 mr-2">Filter by Department:</label>
      <select id="statusDepartmentFilter" class="p-2 border rounded"></select>
      <label for="statusDesignationFilter" class="font-medium text-blue-700 mr-2">Filter by Designation:</label>
      <select id="statusDesignationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <button id="exportStatusTableBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export status table to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Status Table
      </button>
    </div>
    <!-- Export Modal for Status Table -->
    <div id="exportStatusModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button onclick="closeExportStatusModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-lg font-bold mb-4 text-blue-700">Export Status Table</h3>
        <p class="mb-4 text-gray-700">Select export scope:</p>
        <div class="flex flex-col gap-3">
          <button id="exportStatusCurrentDeptBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Current Department</button>
          <button id="exportStatusAllDeptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">All Departments</button>
        </div>
      </div>
    </div>


    <div id="facultyStatusTableContainer" class="overflow-x-auto"></div>
    <!-- Department Portfolios Table -->
    <div id="departmentPortfoliosStickyHeader" class="flex flex-wrap gap-4 items-center mb-4 bg-white z-20" style="position:sticky; top:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
      <label for="portfolioDepartmentFilter" class="font-medium text-orange-700 mr-2">Filter by Department:</label>
      <select id="portfolioDepartmentFilter" class="p-2 border rounded"></select>
      <label for="portfolioFrequencyFilter" class="font-medium text-orange-700 mr-2">Frequency:</label>
      <select id="portfolioFrequencyFilter" class="p-2 border rounded">
  <option value="Weekly">Weekly (Current Week)</option>
  <option value="Monthly">Monthly</option>
  <option value="OnceIn3Months">Once in 3 Months</option>
  <option value="OnceIn2Months">Once in 2 Months</option>
  <option value="OnceIn15Days">Once in 15 Days</option>
  <option value="Semester">Once in a Semester</option>
  <option value="Year">Once in a Year</option>
  <option value="All">All</option>
      </select>
      <div id="weeklyDateFilters" class="flex gap-2 items-center" style="display: none;">
        <label for="weekStartDate" class="font-medium text-orange-700">Week Start:</label>
        <input type="date" id="weekStartDate" class="p-2 border rounded text-sm">
        <label for="weekEndDate" class="font-medium text-orange-700">Week End:</label>
        <input type="date" id="weekEndDate" class="p-2 border rounded text-sm">
        <button id="applyWeekFilter" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm">Apply</button>
        <button id="resetToCurrentWeek" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">Current Week</button>
      </div>
      <label for="portfolioStatusFilter" class="font-medium text-orange-700 mr-2">Show:</label>
      <select id="portfolioStatusFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="Completed">Completed </option>
        <option value="Pending">Pending </option>
      </select>
      <button id="exportDepartmentPortfoliosBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export department portfolios to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Portfolios Table
      </button>
    </div>
    <div id="departmentPortfoliosContainer" class="overflow-x-auto mt-2"></div>
    <!-- Modal for viewing original form -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>

    <!-- Modal for viewing AP/ASP/Prof form details from status table -->
    <div id="viewStatusFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewStatusFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewStatusFormModalTitle" class="text-xl font-bold mb-4 text-blue-700">Faculty Portfolio Form Details</h3>
        <div id="viewStatusFormModalContent"></div>
      </div>
    </div>
  </main>
  <script src="/static/javascript/form-modal-mapper.js"></script>
<script>
// Export Status Table Modal logic
function openExportStatusModal() {
  document.getElementById('exportStatusModal').classList.remove('hidden');
}
function closeExportStatusModal() {
  document.getElementById('exportStatusModal').classList.add('hidden');
}
// Export Status Table to Excel utility
function exportStatusTableToExcel(scope) {
  // scope: 'current' or 'all'
  // Show loading overlay
  let loadingDiv = document.createElement('div');
  loadingDiv.id = 'exportLoadingOverlay';
  loadingDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
  loadingDiv.innerHTML = `<div style="background:white;padding:32px 48px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;gap:16px;">
    <svg class='animate-spin' style='height:48px;width:48px;color:#2563eb;' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'>
      <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
      <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z'></path>
    </svg>
    <div style='font-size:18px;color:#2563eb;font-weight:600;'>Exporting, please wait...</div>
  </div>`;
  document.body.appendChild(loadingDiv);
  if (scope === 'current') {
    // Export only currently visible table
    const container = document.getElementById('facultyStatusTableContainer');
    if (!container) return;
    let tables = Array.from(container.querySelectorAll('table'));
    if (tables.length === 0) return;
    let data = [];
    let headers = [];
    tables = [tables[0]];
    tables.forEach((table, tIdx) => {
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      if (!thead || !tbody) return;
      const ths = Array.from(thead.querySelectorAll('th'));
      const tableHeaders = ths.map(th => th.innerText.trim());
      if (tIdx === 0) headers = tableHeaders;
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const row = Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
        data.push(row);
      });
    });
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'StatusTable');
    XLSX.writeFile(wb, `FacultyStatusTable_CurrentDepartment.xlsx`);
    return;
  }
  // Export all departments side by side
  // 1. Fetch all departments
  supabaseClient.from('Faculty').select('department').then(async ({ data, error }) => {
    if (error || !data) return;
    const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
    if (departments.length === 0) return;
    // 2. For each department, render the status table HTML and parse it
    let allTables = [];
    for (let dept of departments) {
      // Simulate the logic of loadFacultyStatusTable for each department
      // Fetch all faculty for the department
      const { data: facultyList, error: facErr } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', dept);
      if (facErr || !facultyList || facultyList.length === 0) continue;
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      for (const key of ['AP', 'ASP', 'Prof']) {
        const group = groups[key];
        if (group.length === 0) continue;
        // Table header
        let scopes = [];
        let generalIdx = [];
        if (key === 'AP') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Present at conferences.',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Attend FDP/ workshops/ seminar.',
            'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
            'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,12,13,14,20,21,22];
        } else if (key === 'ASP') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Publish in peer-reviewed journals',
            'Research and Development: Apply for research grants',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Organize FDP/ workshops/ seminar.',
            'Professional Development: NPTEL/MOOC and certifications.',
            'Professional Development: Memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
            'Community and Industry Engagement: Engage in consultancy',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Memberships in professional bodies.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
        } else if (key === 'Prof') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Publish in peer-reviewed journals',
            'Research and Development: Apply for research grants',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Organize FDP/ workshops/ seminar.',
            'Professional Development: NPTEL/MOOC and certifications.',
            'Professional Development: Memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate MoUs',
            'Community and Industry Engagement: Engage in consultancy',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Memberships in professional bodies.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
        }
        // Build table data
        let tableHeaders = ['Department', 'Faculty Name'];
        for (let idx of generalIdx) {
          let desc = scopes[idx-1] ? scopes[idx-1].trim() : '';
          if (key === 'AP' && idx === 22) {
            desc = scopes[21] || 'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.';
          }
          tableHeaders.push(desc ? desc : 'Status ' + idx);
        }
        let tableRows = [];
        for (const fac of group) {
          let tableName = '';
          let nameField = '';
          let deptField = '';
          if (key === 'AP') {
            tableName = 'AP';
            nameField = 'Portfolio Member Name';
            deptField = 'Department';
          } else if (key === 'ASP') {
            tableName = 'ASP';
            nameField = 'Portfolio Member Name';
            deptField = '"Department:"';
          } else if (key === 'Prof') {
            tableName = 'Prof';
            nameField = 'Portfolio Member Name';
            deptField = '"Department:"';
          }
          // Fetch latest row for this faculty in this dept
          let { data: rows, error: rowErr } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq(deptField, dept)
            .order('input_id', { ascending: false });
          // Debug: log how many rows fetched for this dept/designation
          if (!window._exportStatusDebug) window._exportStatusDebug = [];
          window._exportStatusDebug.push({ dept, designation: key, fetchedRows: rows ? rows.length : 0 });
          // Robust faculty name matching for ASP/Prof (and all designations)
          let facNamesToTry = [];
          if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
          if (fac.Name) facNamesToTry.push(fac.Name);
          if (fac.email) facNamesToTry.push(fac.email);
          // Remove duplicates, normalize
          facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
          let row = null;
          if (rows && rows.length > 0) {
            for (let r of rows) {
              // Try all possible name fields, normalize
              let possibleRowNames = [
                r['Portfolio Member Name'],
                r['Portfolio Member Name:'],
                r['Portfolio Memeber Name'],
                r['faculty_name'],
                r['Faculty Name'],
                r['Name'],
                r['email']
              ].map(x => (x || '').toString().trim().toLowerCase()).filter(Boolean);
              // Also normalize department field for matching
              let rowDept = (r['Department:'] || r['Department'] || '').toString().trim().toLowerCase();
              let matchDept = (dept || '').toString().trim().toLowerCase();
              if (rowDept === matchDept && facNamesToTry.some(n => possibleRowNames.includes(n))) {
                row = r;
                break;
              }
            }
          }
          // Calculate percentage for this faculty
          let percentage = 0;
          if (row) {
            let completedCount = 0;
            let applicableCount = 0;
            for (let idx of generalIdx) {
              let statusVal = row ? (row[`Status_${idx}`] || row[`Status_${idx}`] || '-') : '-';
              const val = (statusVal || '').toString().trim().toLowerCase();
              if (val === 'not applicable' || val === 'na') continue;
              applicableCount += 1;
              if (val === 'completed' || val === 'completed and updated') {
                completedCount += 1;
              }
            }
            if (applicableCount > 0) {
              percentage = Math.round((completedCount / applicableCount) * 100);
            } else {
              percentage = 0;
            }
          }
          // Add percentage in brackets to faculty name
          let facultyDisplayName = (fac.Name || fac['Portfolio Member Name'] || fac.email || '') + ` (${percentage}%)`;
          let rowArr = [dept, facultyDisplayName];
          for (let idx of generalIdx) {
            let statusVal = row ? (row[`Status_${idx}`] || row[`Status_${idx}`] || '-') : '-';
            let display = '-';
            if (statusVal && typeof statusVal === 'string') {
              const val = statusVal.trim().toLowerCase();
              if (val === 'completed') display = 'Completed';
              else if (val === 'in progress') display = 'In Progress';
              else if (val === 'not started') display = 'Not Started';
              else if (val === 'not applicable' || val === 'na') display = 'N/A';
              else if (val === 'no' || val === 'incomplete') display = 'Incomplete';
              else display = statusVal;
            }
            rowArr.push(display);
          }
          tableRows.push(rowArr);
        }
        allTables.push({
          dept,
          designation: key,
          headers: tableHeaders,
          rows: tableRows
        });
      }
    }
    // 3. Combine all tables stacked vertically (one long table)
    // Use a single set of headers: Department, Designation, Faculty Name, ...status columns...
    let allRows = [];
    let headersSet = false;
    let headers = [];
    for (const t of allTables) {
      // t.headers: [Department, Faculty Name, ...]
      // Add Designation column after Department
      let localHeaders = t.headers.slice();
      if (!headersSet) {
        headers = localHeaders.slice(0,1).concat(['Designation'], localHeaders.slice(1));
        headersSet = true;
      }
      for (const row of t.rows) {
        // Insert designation after department
        let newRow = row.slice(0,1).concat([t.designation], row.slice(1));
        allRows.push(newRow);
      }
    }
    const ws = XLSX.utils.aoa_to_sheet([headers, ...allRows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'StatusTable');
  XLSX.writeFile(wb, `FacultyStatusTable_AllDepartments.xlsx`);
  // Remove loading overlay
  const overlay = document.getElementById('exportLoadingOverlay');
  if (overlay) overlay.remove();
    // Remove loading overlay on error/exit
    const overlay2 = document.getElementById('exportLoadingOverlay');
    if (overlay2) overlay2.remove();
  });
}
// Attach export button listeners for status table
setTimeout(() => {
  const exportBtn = document.getElementById('exportStatusTableBtn');
  if (exportBtn) {
    exportBtn.onclick = () => openExportStatusModal();
    setTimeout(() => {
      const currentBtn = document.getElementById('exportStatusCurrentDeptBtn');
      const allBtn = document.getElementById('exportStatusAllDeptBtn');
      if (currentBtn && allBtn) {
        currentBtn.onclick = () => {
          closeExportStatusModal();
          exportStatusTableToExcel('current');
        };
        allBtn.onclick = () => {
          closeExportStatusModal();
          exportStatusTableToExcel('all');
        };
      }
    }, 600);
  }
}, 800);
</script>
<script>
// Export Scope Modal logic
function openExportScopeModal() {
  document.getElementById('exportScopeModal').classList.remove('hidden');
}
function closeExportScopeModal() {
  document.getElementById('exportScopeModal').classList.add('hidden');
}
// Export table to Excel utility
function exportTableToExcelById(tableId, filenamePrefix) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const data = [headers];
  // Special handling for Department Portfolios table
  if (tableId === 'portfoliosTableExport') {
    rows.forEach(row => {
      const cells = [];
      Array.from(row.querySelectorAll('td')).forEach((td, idx) => {
        // For portfolio columns, faculty names may have tick/cross SVGs
        if (idx === 0) {
          // Department column, just text
          cells.push(td.innerText.trim());
        } else {
          // Portfolio columns: may have multiple faculty names
          const divs = td.querySelectorAll('div');
          if (divs.length === 0) {
            cells.push('-');
          } else {
            let names = [];
            divs.forEach(div => {
              let name = '';
              // Check for tick/cross SVG
              if (div.querySelector('svg.h-6.w-6.text-green-500')) {
                // Tick
                name = div.textContent.replace(/\s+/g, ' ').trim() + ' (C)';
              } else if (div.querySelector('svg.h-6.w-6.text-red-500')) {
                // Cross
                name = div.textContent.replace(/\s+/g, ' ').trim() + ' (N)';
              } else {
                name = div.textContent.replace(/\s+/g, ' ').trim();
              }
              names.push(name);
            });
            cells.push(names.join(', '));
          }
        }
      });
      data.push(cells);
    });
  } else {
    // Default: just text
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.trim());
      data.push(cells);
    });
  }
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, filenamePrefix);
  XLSX.writeFile(wb, `${filenamePrefix}.xlsx`);
}

// Attach export button listeners after tables are rendered
function attachExportButtons() {
  setTimeout(() => {
    const dashboardTable = document.querySelector('#dashboardTableContainer table');
    if (dashboardTable) {
      document.getElementById('exportDashboardTableBtn').onclick = () => {
        openExportScopeModal();
      };
      dashboardTable.id = dashboardTable.id || 'dashboardTableExport';
      // Attach modal button logic
      setTimeout(() => {
        const currentBtn = document.getElementById('exportCurrentDeptBtn');
        const allBtn = document.getElementById('exportAllDeptBtn');
        if (currentBtn && allBtn) {
          currentBtn.onclick = () => {
            closeExportScopeModal();
            exportTableToExcelById(dashboardTable.id || 'dashboardTableExport', 'IQAC_Dashboard_' + selectedDepartment);
          };
          allBtn.onclick = async () => {
            closeExportScopeModal();
            // Export all departments: fetch all from ap_compliance, asp_compliance, prof_compliance
            const apRes = await supabaseClient.from('ap_compliance').select('*');
            const aspRes = await supabaseClient.from('asp_compliance').select('*');
            const profRes = await supabaseClient.from('prof_compliance').select('*');
            const allData = [
              { label: 'AP', data: apRes.data || [] },
              { label: 'ASP', data: aspRes.data || [] },
              { label: 'Prof', data: profRes.data || [] }
            ];
            const wb = XLSX.utils.book_new();
            allData.forEach(({ label, data }) => {
              if (data.length === 0) return;
              // Get all unique keys for columns
              const keys = Array.from(new Set(data.flatMap(row => Object.keys(row))));
              const sheetData = [keys];
              data.forEach(row => {
                sheetData.push(keys.map(k => row[k] || ''));
              });
              const ws = XLSX.utils.aoa_to_sheet(sheetData);
              XLSX.utils.book_append_sheet(wb, ws, label);
            });
            XLSX.writeFile(wb, 'IQAC_Dashboard_All_Departments.xlsx');
          };
        }
      }, 600);
    }
    document.getElementById('exportDepartmentPortfoliosBtn').onclick = async () => {
      // Export based on current filter
      const frequencyFilter = document.getElementById('portfolioFrequencyFilter');
      const selectedFrequency = frequencyFilter ? frequencyFilter.value : 'Weekly';
      const statusFilter = document.getElementById('portfolioStatusFilter');
      const selectedStatus = statusFilter ? statusFilter.value : 'All';
      const deptFilter = document.getElementById('portfolioDepartmentFilter');
      const selectedDept = deptFilter ? deptFilter.value : 'All';
      // Fetch all faculty data
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        alert('Failed to load department portfolios for export.');
        return;
      }
      // Get all unique departments
      let departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      if (selectedDept !== 'All') departments = [selectedDept];
      // Get headers and table mapping for selected frequency
      const portfolioHeadersMap = window._iqacPortfolioHeadersMap;
      const headersConfig = portfolioHeadersMap[selectedFrequency] || [];
      const headers = ["Department", ...headersConfig.map(h => h.label)];
      // Fetch all relevant form data for each portfolio column
      const tableMap = window._iqacTableMap;
      const formTableNames = headersConfig.map(h => h.table);
      const formTableData = {};
      for (const tableName of formTableNames) {
        let query = supabaseClient.from(tableName).select('*');
        
        // If frequency is Weekly, filter by date range
        if (selectedFrequency === 'Weekly') {
          const weekStartInput = document.getElementById('weekStartDate');
          const weekEndInput = document.getElementById('weekEndDate');
          
          if (weekStartInput.value && weekEndInput.value) {
            // Use custom date range
            const startDate = new Date(weekStartInput.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(weekEndInput.value);
            endDate.setHours(23, 59, 59, 999);
            
            const startStr = startDate.toISOString();
            const endStr = endDate.toISOString();
            
            query = query
              .gte('submitted_at', startStr)
              .lte('submitted_at', endStr);
          } else {
            // Fallback to current week
            const now = new Date();
            const currentDay = now.getDay();
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
            const monday = new Date(now);
            monday.setDate(now.getDate() + mondayOffset);
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            const startStr = monday.toISOString();
            const endStr = sunday.toISOString();
            
            query = query
              .gte('submitted_at', startStr)
              .lte('submitted_at', endStr);
          }
        }
        
        const { data: tdata } = await query;
        formTableData[tableName] = tdata || [];
      }
      const exportRows = [];
      for (const dept of departments) {
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        const row = [dept];
        for (let hIdx = 0; hIdx < headersConfig.length; hIdx++) {
          const h = headersConfig[hIdx];
          const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
          const tableName = h.table;
          const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
          let names = [];
          for (const fac of assignedList) {
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
            // Robust percentage calculation (same as UI)
            let percentage = 0;
            let filled = false;
            const tdata = formTableData[tableName];
            let bestRow = null;
            if (tdata && tdata.length > 0) {
              // Robust faculty name matching
              const filteredRows = tdata.filter(row => {
                const rowName = row['Portfolio Member Name:'] || row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                return rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase() && (row['Department'] || row['Department:'] || '').toString().trim().toLowerCase() === dept.toString().trim().toLowerCase();
              });
              if (filteredRows.length > 0) {
                filled = true;
                bestRow = filteredRows.sort((a, b) => (b.id || 0) - (a.id || 0))[0];
              }
            }
            if (bestRow) {
              let completedCount = 0;
              let applicableCount = 0;
              const statusKeys = Object.keys(bestRow).filter(k => k.startsWith('Status'));
              for (const key of statusKeys) {
                const val = (bestRow[key] || '').toString().trim().toLowerCase();
                if (val === 'not applicable' || val === 'na') continue;
                applicableCount += 1;
                if (val === 'completed' || val === 'completed and updated') {
                  completedCount += 1;
                }
              }
              if (applicableCount > 0) {
                percentage = Math.round((completedCount / applicableCount) * 100);
              } else {
                percentage = 0;
              }
            } else {
              percentage = 0;
            }
            // Filter by status
            if (selectedStatus === 'Completed' && !filled) continue;
            if (selectedStatus === 'Pending' && filled) continue;
            // Always use brackets for percentage
            names.push(`${facultyName} (${percentage}%)`);
          }
          row.push(names.length > 0 ? names.join(', ') : '-');
        }
        exportRows.push(row);
      }
      const ws = XLSX.utils.aoa_to_sheet([headers, ...exportRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Portfolios');
      XLSX.writeFile(wb, `IQAC_Portfolios_${selectedFrequency}_${selectedDept}.xlsx`);
    };
  }, 500);
}
  // Fetch and render department portfolios table (IQAC)
    async function loadDepartmentPortfoliosIQAC() {
      // Fetch all faculty
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-red-500">Failed to load department portfolios.</div>';
        return;
      }
      // Get all unique departments
      const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      // Setup department filter dropdown
      const deptFilter = document.getElementById('portfolioDepartmentFilter');
      if (!deptFilter.dataset.initialized) {
        deptFilter.innerHTML = '<option value="All">All Departments</option>' + departments.map(d => `<option value="${d}">${d}</option>`).join('');
        deptFilter.dataset.initialized = 'true';
      }
      // Setup status filter dropdown
      const statusFilter = document.getElementById('portfolioStatusFilter');
      // Get selected filter values (re-read each time for correct filtering)
      const selectedDept = deptFilter.options[deptFilter.selectedIndex]?.value || 'All';
      const selectedStatus = statusFilter.options[statusFilter.selectedIndex]?.value || 'All';

  // Frequency filter logic
  const frequencyFilter = document.getElementById('portfolioFrequencyFilter');
  const selectedFrequency = frequencyFilter ? frequencyFilter.value : 'Weekly';
  
  // Show/hide date filters based on frequency
  const weeklyDateFilters = document.getElementById('weeklyDateFilters');
  if (selectedFrequency === 'Weekly') {
    weeklyDateFilters.style.display = 'flex';
    // Set default current week dates if not already set
    const weekStartInput = document.getElementById('weekStartDate');
    const weekEndInput = document.getElementById('weekEndDate');
    if (!weekStartInput.value || !weekEndInput.value) {
      setCurrentWeekDates();
    }
  } else {
    weeklyDateFilters.style.display = 'none';
  }
  // Table mapping for each frequency (declare only once)
  if (!window._iqacTableMap) {
    window._iqacTableMap = {
      Weekly: [
        'form1-Weekly', 'form2-weekly', 'form3-Weekly', 'form4-Weekly', 'form5-weekly', 'form6_weekly', 'form7-Weekly', 'form8-weekly'
      ],
      Monthly: [
        'form2-once in a month', 'form4-once in a month'
      ],
      OnceIn3Months: [
        'form5-Once in a 3 Months', 'form8-once in 3 Months'
      ],
      OnceIn2Months: [
        'form6-once in 2 month', 'form7-Once in 2 Months'
      ],
      OnceIn15Days: [
        'form1-once in 15 days', 'form3- once in 15 days'
      ],
      Semester: [
        'form1-once in a semester', 'form2-once in a semester', 'form3-once in a semester', 'form4-once in a semester', 'form5-once in a semester', 'form6-once in a semester', 'form7-Once in a Semester', 'form8-Once in Semester'
      ],
      Year: [
        'form1-once in a year'
      ],
      All: [
        'form1-Weekly', 'form2-weekly', 'form3-Weekly', 'form4-Weekly', 'form5-weekly', 'form6_weekly', 'form7-Weekly', 'form8-weekly',
        'form2-once in a month', 'form4-once in a month',
        'form5-Once in a 3 Months', 'form8-once in 3 Months',
        'form6-once in 2 month', 'form7-Once in 2 Months',
        'form1-once in 15 days', 'form3- once in 15 days',
        'form1-once in a semester', 'form2-once in a semester', 'form3-once in a semester', 'form4-once in a semester', 'form5-once in a semester', 'form6-once in a semester', 'form7-Once in a Semester', 'form8-Once in Semester',
        'form1-once in a year'
      ]
    };
  }
  const tableMap = window._iqacTableMap;
  // Portfolio headers and their corresponding table for each frequency (declare only once)
  if (!window._iqacPortfolioHeadersMap) {
    window._iqacPortfolioHeadersMap = {
      Weekly: [
        { label: "1. Training & Placement", table: 'form1-Weekly' },
        { label: "2. Class Advisor", table: 'form2-weekly' },
        { label: "3. Info & Contribution", table: 'form3-Weekly' },
        { label: "4. Outcome & Exam Cell", table: 'form4-Weekly' },
        { label: "5. Continuous Improvement", table: 'form5-weekly' },
        { label: "6. T&L Process (IQAC)", table: 'form6_weekly' },
        { label: "7. Student Support", table: 'form7-Weekly' },
        { label: "8. Facilities & Lab", table: 'form8-weekly' }
      ],
      Monthly: [
        { label: "2. Class Advisor", table: 'form2-once in a month' },
        { label: "4. Outcome & Exam Cell", table: 'form4-once in a month' }
      ],
      OnceIn3Months: [
        { label: "5. Continuous Improvement", table: 'form5-Once in a 3 Months' },
        { label: "8. Facilities & Lab", table: 'form8-once in 3 Months' }
      ],
      OnceIn2Months: [
        { label: "6. T&L Process (IQAC)", table: 'form6-once in 2 month' },
        { label: "7. Student Support", table: 'form7-Once in 2 Months' }
      ],
      OnceIn15Days: [
        { label: "1. Training & Placement", table: 'form1-once in 15 days' },
        { label: "3. Info & Contribution", table: 'form3- once in 15 days' }
      ],
      Semester: [
        { label: "1. Training & Placement", table: 'form1-once in a semester' },
        { label: "2. Class Advisor", table: 'form2-once in a semester' },
        { label: "3. Info & Contribution", table: 'form3-once in a semester' },
        { label: "4. Outcome & Exam Cell", table: 'form4-once in a semester' },
        { label: "5. Continuous Improvement", table: 'form5-once in a semester' },
        { label: "6. T&L Process (IQAC)", table: 'form6-once in a semester' },
        { label: "7. Student Support", table: 'form7-Once in a Semester' },
        { label: "8. Facilities & Lab", table: 'form8-Once in Semester' }
      ],
      Year: [
        { label: "1. Training & Placement", table: 'form1-once in a year' }
      ],
      All: [
        { label: "1. Training & Placement", table: 'form1-Weekly' },
        { label: "2. Class Advisor", table: 'form2-weekly' },
        { label: "3. Info & Contribution", table: 'form3-Weekly' },
        { label: "4. Outcome & Exam Cell", table: 'form4-Weekly' },
        { label: "5. Continuous Improvement", table: 'form5-weekly' },
        { label: "6. T&L Process (IQAC)", table: 'form6_weekly' },
        { label: "7. Student Support", table: 'form7-Weekly' },
        { label: "8. Facilities & Lab", table: 'form8-weekly' },
        { label: "2. Class Advisor", table: 'form2-once in a month' },
        { label: "4. Outcome & Exam Cell", table: 'form4-once in a month' },
        { label: "5. Continuous Improvement", table: 'form5-Once in a 3 Months' },
        { label: "8. Facilities & Lab", table: 'form8-once in 3 Months' },
        { label: "6. T&L Process (IQAC)", table: 'form6-once in 2 month' },
        { label: "7. Student Support", table: 'form7-Once in 2 Months' },
        { label: "1. Training & Placement", table: 'form1-once in 15 days' },
        { label: "3. Info & Contribution", table: 'form3- once in 15 days' },
        { label: "1. Training & Placement", table: 'form1-once in a semester' },
        { label: "2. Class Advisor", table: 'form2-once in a semester' },
        { label: "3. Info & Contribution", table: 'form3-once in a semester' },
        { label: "4. Outcome & Exam Cell", table: 'form4-once in a semester' },
        { label: "5. Continuous Improvement", table: 'form5-once in a semester' },
        { label: "6. T&L Process (IQAC)", table: 'form6-once in a semester' },
        { label: "7. Student Support", table: 'form7-Once in a Semester' },
        { label: "8. Facilities & Lab", table: 'form8-Once in Semester' },
        { label: "1. Training & Placement", table: 'form1-once in a year' }
      ]
    };
  }
  const portfolioHeadersMap = window._iqacPortfolioHeadersMap;
  let html = '';
  html += '<div style="position:sticky; top:0; z-index:30; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.04);">';
  html += '<h3 class="text-xl font-bold text-orange-500 mb-2">Department Portfolios</h3>';
  html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px;">';
  html += '<thead class="bg-orange-100 text-orange-700">';
  html += '<tr style="position:sticky; top:56px; background:#FEF3C7; z-index:20;">';
  html += '<th class="px-1 py-1 border border-gray-400" style="width:90px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">Department</th>';
  const headers = portfolioHeadersMap[selectedFrequency] || [];
  for (const h of headers) html += `<th class="px-1 py-1 border border-gray-400" style="width:120px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">${h.label}</th>`;
  html += '</tr></thead></table>';
  html += '</div>';
  html += '<div style="overflow-x:auto; max-height:500px; overflow-y:auto;">';
  html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px; margin-top:-1px;">';
  html += '<tbody>';
  for (const dept of departments) {
    if (selectedDept !== 'All' && dept !== selectedDept) continue;
    const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
    html += `<tr>`;
    html += `<td class="px-1 py-1 font-semibold text-purple-700 border border-gray-400" style="word-break:break-word;">${dept}</td>`;
    for (const h of headers) {
      // Find which form this header maps to
      const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
      html += `<td class="px-1 py-1 border border-gray-400" style="word-break:break-word;">`;
      const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
      if (assignedList.length > 0) {
        for (const fac of assignedList) {
          const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
          // Add a span for tick/cross and percentage (percentage will be filled in as (85%) after name)
          html += `<div class="flex items-center gap-1" style="font-size:11px;">
            <span id="portfolio-status-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}" class="inline-block"></span>
            <span class="inline-block">${facultyName} <span id="portfolio-percent-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}"></span></span>
          </div>`;
        }
      } else {
        html += '-';
      }
      html += `</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  document.getElementById('departmentPortfoliosContainer').innerHTML = html;

      // Async tick/cross logic for assigned faculty
      for (const dept of departments) {
        if (selectedDept !== 'All' && dept !== selectedDept) continue;
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        const headers = portfolioHeadersMap[selectedFrequency] || [];
        for (const h of headers) {
          const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
          const tableName = h.table;
          const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
          for (const fac of assignedList) {
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
            const statusSpanId = `portfolio-status-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const percentSpanId = `portfolio-percent-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            (async () => {
              let filled = false;
              let percentage = 0;
              let query = supabaseClient.from(tableName).select('*').eq('Department', dept);
              // If frequency is Weekly, filter by date range
              if (selectedFrequency === 'Weekly') {
                const weekStartInput = document.getElementById('weekStartDate');
                const weekEndInput = document.getElementById('weekEndDate');
                if (weekStartInput.value && weekEndInput.value) {
                  const startDate = new Date(weekStartInput.value);
                  startDate.setHours(0, 0, 0, 0);
                  const endDate = new Date(weekEndInput.value);
                  endDate.setHours(23, 59, 59, 999);
                  const startStr = startDate.toISOString();
                  const endStr = endDate.toISOString();
                  query = query.gte('submitted_at', startStr).lte('submitted_at', endStr);
                } else {
                  const now = new Date();
                  const currentDay = now.getDay();
                  const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
                  const monday = new Date(now);
                  monday.setDate(now.getDate() + mondayOffset);
                  monday.setHours(0, 0, 0, 0);
                  const sunday = new Date(monday);
                  sunday.setDate(monday.getDate() + 6);
                  sunday.setHours(23, 59, 59, 999);
                  const mondayStr = monday.toISOString();
                  const sundayStr = sunday.toISOString();
                  query = query.gte('submitted_at', mondayStr).lte('submitted_at', sundayStr);
                }
              }
              const { data: formData, error } = await query;
              let bestRow = null;
              if (!error && formData && formData.length > 0) {
                // Robust faculty name matching (as in workdone-table.js)
                const filteredRows = formData.filter(row => {
                  const rowName = row['Portfolio Member Name:'] || row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                  return rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase();
                });
                if (filteredRows.length > 0) {
                  filled = true;
                  // Use the latest row (by id or timestamp)
                  bestRow = filteredRows.sort((a, b) => (b.id || 0) - (a.id || 0))[0];
                }
              }
              // Calculate percentage if bestRow exists, using all keys starting with 'Status'
              if (bestRow) {
                let completedCount = 0;
                let applicableCount = 0;
                // Use all keys starting with 'Status' (case-sensitive, as in workdone-table.js)
                const statusKeys = Object.keys(bestRow).filter(k => k.startsWith('Status'));
                for (const key of statusKeys) {
                  const val = (bestRow[key] || '').toString().trim().toLowerCase();
                  if (val === 'not applicable' || val === 'na') continue;
                  // Treat null, empty, or '-' as applicable (mark=0)
                  applicableCount += 1;
                  if (val === 'completed' || val === 'completed and updated') {
                    completedCount += 1;
                  }
                }
                if (applicableCount > 0) {
                  percentage = Math.round((completedCount / applicableCount) * 100);
                } else {
                  percentage = 0;
                }
              } else {
                percentage = 0;
              }
              // Set tick/cross and percentage
              const statusSpan = document.getElementById(statusSpanId);
              const percentSpan = document.getElementById(percentSpanId);
              if (statusSpan) {
                if (selectedStatus === 'Completed' && !filled) {
                  statusSpan.parentElement.style.display = 'none';
                  return;
                }
                if (selectedStatus === 'Pending' && filled) {
                  statusSpan.parentElement.style.display = 'none';
                  return;
                }
                statusSpan.innerHTML = filled
                  ? `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-6 w-6 text-green-500\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M5 13l4 4L19 7\" /></svg>`
                  : `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-6 w-6 text-red-500\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" /></svg>`;
                if (percentSpan) {
                  percentSpan.innerHTML = `<span class='text-xs font-semibold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}'>(${percentage}%)</span>`;
                }
              }
            })();
          }
        }
      }

      // Add filter event listeners
  deptFilter.onchange = statusFilter.onchange = frequencyFilter.onchange = () => loadDepartmentPortfoliosIQAC();
  
  // Setup date filter event listeners
  if (!document.getElementById('applyWeekFilter').dataset.listenerAdded) {
    document.getElementById('applyWeekFilter').addEventListener('click', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('resetToCurrentWeek').addEventListener('click', () => {
      setCurrentWeekDates();
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('weekStartDate').addEventListener('change', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('weekEndDate').addEventListener('change', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('applyWeekFilter').dataset.listenerAdded = 'true';
  }
    }
    
    // Helper function to set current week dates
    function setCurrentWeekDates() {
      const now = new Date();
      const currentDay = now.getDay();
      const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset);
      
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      
      document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
      document.getElementById('weekEndDate').value = sunday.toISOString().split('T')[0];
    }
  </script>
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cbhodgwaazmjszkujrti.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    // --- NEW: Faculty Status Table from AP, ASP, Prof tables ---
    let allStatusDepartments = [];
    let selectedStatusDepartment = '';
    let selectedStatusDesignation = 'All';
    async function loadStatusDepartments() {
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('department');
      if (error || !data) return;
      const depts = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      allStatusDepartments = depts;
      const select = document.getElementById('statusDepartmentFilter');
      select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
      selectedStatusDepartment = depts[0] || '';
      select.value = selectedStatusDepartment;
      select.addEventListener('change', () => {
        selectedStatusDepartment = select.value;
        loadFacultyStatusTable();
      });
    }
    document.getElementById('statusDesignationFilter').addEventListener('change', () => {
      selectedStatusDesignation = document.getElementById('statusDesignationFilter').value;
      loadFacultyStatusTable();
    });
    async function loadFacultyStatusTable() {
      if (!selectedStatusDepartment) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      // Fetch all faculty for the department
      const { data: facultyList, error: facErr } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', selectedStatusDepartment);
      if (facErr || !facultyList || facultyList.length === 0) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      // Define scope/description arrays for headers
      // Only show General Section columns (not compliance/targeted)
      // AP: complianceRows = [10, 11, 15, 16, 17, 18, 19]
      // ASP/Prof: complianceRows = [10, 11, 12, 16, 17, 18, 19, 23]
      const apScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Present at conferences.',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Attend FDP/ workshops/ seminar.',
        'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.',
  '',
      ];
      const apGeneralIdx = [1,2,3,4,5,6,7,8,9,12,13,14,20,21,22];
      const aspScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const aspGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      const profScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate MoUs',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const profGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      for (const key of ['AP', 'ASP', 'Prof']) {
        if (selectedStatusDesignation !== 'All' && selectedStatusDesignation !== key) continue;
        const group = groups[key];
        if (group.length === 0) continue;
        html += `<h3 class="text-xl font-semibold text-blue-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
        // Table header
        html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-blue-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
        let scopes = [];
        let generalIdx = [];
        if (key === 'AP') { scopes = apScopes; generalIdx = apGeneralIdx; }
        else if (key === 'ASP') { scopes = aspScopes; generalIdx = aspGeneralIdx; }
        else if (key === 'Prof') { scopes = profScopes; generalIdx = profGeneralIdx; }
        for (let idx of generalIdx) {
          // Always include Status 22 (idx==22) even if description is blank, and use correct description from apScopes[21]
          let desc = scopes[idx-1] ? scopes[idx-1].trim() : '';
          if (key === 'AP' && idx === 22) {
            desc = scopes[21] || 'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.';
          }
          html += `<th class="px-4 py-2" title="${desc}">${desc ? desc : 'Status ' + idx}</th>`;
        }
        html += `</tr></thead><tbody>`;
        for (const fac of group) {
          let tableName = '';
          let nameField = '';
          let deptField = '';
          if (key === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
          else if (key === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          else if (key === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          // Fetch latest row for this faculty in this dept
          let { data: rows, error: rowErr } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq(deptField, selectedStatusDepartment)
            .order('input_id', { ascending: false });
          // Robust faculty name matching for ASP (and all designations)
          let facNamesToTry = [];
          if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
          if (fac.Name) facNamesToTry.push(fac.Name);
          if (fac.email) facNamesToTry.push(fac.email);
          facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
          let row = null;
          if (rows && rows.length > 0) {
            for (let r of rows) {
              let rowName = (r['Portfolio Member Name'] || r['Portfolio Member Name:'] || r['Portfolio Memeber Name'] || r['faculty_name'] || r['Faculty Name'] || r['Name'] || r['email'] || '').toString().trim().toLowerCase();
              if (facNamesToTry.includes(rowName)) {
                row = r;
                break;
              }
            }
          }
          // Percentage calculation: completed=1, not applicable/na=skip, any other=0
          let completedCount = 0;
          let applicableCount = 0;
          for (let idx of generalIdx) {
            let statusVal = row ? (row[`Status_${idx}`] || '-') : '-';
            const val = (statusVal || '').trim().toLowerCase();
            if (val === 'not applicable' || val === 'na') continue;
            applicableCount += 1;
            if (val === 'completed') completedCount += 1;
          }
          const percentage = applicableCount > 0 ? Math.round((completedCount / applicableCount) * 100) : 0;
          html += `<tr><td class="px-2 py-2 font-medium text-blue-700 cursor-pointer underline" onclick="viewStatusFacultyForm('${key}','${(fac.Name || '').replace(/'/g, "\'")}', '${selectedStatusDepartment.replace(/'/g, "\'")}')">${fac.Name || fac['Portfolio Member Name'] || fac.email || ''}<div class='text-sm ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'} font-semibold'>${percentage}%</div></td>`;
          for (let idx of generalIdx) {
            let statusVal = row ? (row[`Status_${idx}`] || '-') : '-';
            let display = '-';
            let statusClass = '';
            if (statusVal && typeof statusVal === 'string') {
              const val = statusVal.trim().toLowerCase();
              if (val === 'completed') {
                display = 'Completed';
                statusClass = 'text-green-600 font-semibold';
              } else if (val === 'in progress' || val === 'inprogress' || val === 'underprocess' || val === 'under process') {
                display = statusVal;
                statusClass = 'text-yellow-600 font-semibold';
              } else if (val === 'yet to be completed' || val === 'not started' || val === 'no' || val === 'incomplete') {
                display = statusVal;
                statusClass = 'text-red-600 font-semibold';
              } else if (val === '-' || val === '' || val === null) {
                display = '-';
                statusClass = 'text-gray-500';
              } else {
                display = statusVal;
                statusClass = 'text-blue-600 font-semibold';
              }
            } else {
              display = '-';
              statusClass = 'text-gray-500';
            }
            html += `<td class="px-2 py-2 ${statusClass}">${display}</td>`;
          }
          html += `</tr>`;
        }
        html += `</tbody></table></div>`;
      }
      document.getElementById('facultyStatusTableContainer').innerHTML = html || '<div class="text-gray-500">No status data found.</div>';
    }
    let allDepartments = [];
    let selectedDepartment = '';
    async function loadDepartments() {
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('department');
      if (error || !data) return;
      const depts = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      allDepartments = depts;
      const select = document.getElementById('departmentFilter');
      select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
      selectedDepartment = depts[0] || '';
      select.value = selectedDepartment;
      select.addEventListener('change', () => {
        selectedDepartment = select.value;
        loadDashboardTable();
      });
    }
    // --- END NEW ---
    async function loadDashboardTable() {
      if (!selectedDepartment) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', selectedDepartment);
      if (error || !data || data.length === 0) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      renderDashboardTable(data);
    }
    function renderDashboardTable(facultyList) {
  // ...existing code...
  // After rendering dashboard table, render department portfolios table
  loadDepartmentPortfoliosIQAC();
  attachExportButtons();
      const designationFilter = document.getElementById('designationFilter').value;
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      const particularsMap = {
        AP: [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body'
        ],
        ASP: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in Consultancy.',
          'Membership in professional body'
        ],
        Prof: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate MoU',
          'Engage in Consultancy.',
          'Membership in professional body'
        ]
      };
      (async function renderDashboardAsync() {
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('ap_compliance').select('*').eq('department', selectedDepartment),
          supabaseClient.from('asp_compliance').select('*').eq('department', selectedDepartment),
          supabaseClient.from('prof_compliance').select('*').eq('department', selectedDepartment)
        ]);
        function getBestComplianceRows(data) {
          const facultyData = {};
          
          // Group all rows by faculty email
          data.forEach(row => {
            const email = row.faculty_email;
            if (!facultyData[email]) {
              facultyData[email] = [];
            }
            facultyData[email].push(row);
          });
          
          // For each faculty, create a best-case compliance record
          const result = [];
          Object.keys(facultyData).forEach(email => {
            const rows = facultyData[email];
            
            // Start with the most recent row as base
            rows.sort((a, b) => (b.id || 0) - (a.id || 0));
            const latestRow = { ...rows[0] };
            
            // Check each compliance field and keep "completed" if found in any submission
            for (let i = 1; i <= 20; i++) { // Assuming max 20 compliance fields
              const fieldName = `compliance_${i}`;
              let hasCompleted = false;
              
              // Check all submissions for this faculty
              for (const row of rows) {
                const value = (row[fieldName] || '').toString().trim().toLowerCase();
                if (value === 'yes' || value === 'completed') {
                  hasCompleted = true;
                  break;
                }
              }
              
              // If any submission shows completed, override with completed
              if (hasCompleted) {
                latestRow[fieldName] = 'completed';
              }
              // Otherwise keep the latest row's value
            }
            
            result.push(latestRow);
          });
          
          return result;
        }
        const apDataLatest = getBestComplianceRows(apRes.data || []);
        const aspDataLatest = getBestComplianceRows(aspRes.data || []);
        const profDataLatest = getBestComplianceRows(profRes.data || []);
        for (const key of ['AP', 'ASP', 'Prof']) {
          if (designationFilter !== 'All' && designationFilter !== key) continue;
          const group = groups[key];
          if (group.length === 0) continue;
          html += `<h3 class="text-xl font-semibold text-purple-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
          const particulars = particularsMap[key];
          html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-purple-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
          particulars.forEach(particular => {
            html += `<th class="px-4 py-2">${particular}</th>`;
          });
          html += `</tr></thead><tbody>`;
          for (const fac of group) {
            let complianceRow = null;
            if (key === 'AP') complianceRow = apDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'ASP') complianceRow = aspDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'Prof') complianceRow = profDataLatest.find(r => r.faculty_email === fac.email);
            
            // Calculate percentage (completed=1, others=0, skip not applicable)
            let completedCount = 0;
            let applicableCount = 0;
            for (let i = 0; i < particulars.length; i++) {
              let compliance = complianceRow ? complianceRow[`compliance_${i+1}`] : null;
              const val = (compliance || '').trim().toLowerCase();
              if (val === 'not applicable' || val === 'na') continue;
              // All other values, including '-', are counted as applicable (0 unless completed)
              applicableCount += 1;
              if (val === 'completed') {
                completedCount += 1;
              }
            }
            const percentage = applicableCount > 0 ? Math.round((completedCount / applicableCount) * 100) : 0;
            
            html += `<tr><td class="px-2 py-2">
              <div class="font-medium text-purple-700 cursor-pointer underline" onclick="viewFacultyForm('${fac.email}','${key}','${fac.Name ? fac.Name.replace(/'/g, "\'") : ''}')">${fac.Name || ''}</div>
              <div class="text-sm ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'} font-semibold">${percentage}%</div>
            </td>`;
            
            for (let i = 0; i < particulars.length; i++) {
              let compliance = complianceRow ? complianceRow[`compliance_${i+1}`] : null;
              let complianceClass = '';
              let display = '-';
              if (compliance) {
                const val = compliance.trim().toLowerCase();
                if (val === 'completed') {
                  complianceClass = 'text-green-600 font-bold';
                  display = 'Completed';
                } else if (val === 'in progress' || val === 'inprogress') {
                  complianceClass = 'text-blue-600 font-bold';
                  display = 'In Progress';
                } else if (val === 'not started') {
                  complianceClass = 'text-orange-600 font-bold';
                  display = 'Not Started';
                } else if (val === 'no' || val === 'incomplete') {
                  complianceClass = 'text-red-600 font-bold';
                  display = 'Incomplete';
                } else {
                  complianceClass = 'text-gray-500';
                  display = val;
                }
              } else {
                complianceClass = 'text-gray-500';
              }
              html += `<td class="px-2 py-2 ${complianceClass}">${display}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }
        document.getElementById('dashboardTableContainer').innerHTML = html || '<div class="text-gray-500">No compliance data found.</div>';
      })();
    }
    document.getElementById('designationFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    function closeViewFormModal() {
      document.getElementById('viewFormModal').classList.add('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '';
      document.getElementById('viewFormModalTitle').textContent = 'Faculty Form Details';
    }

    // NEW: Modal for AP/ASP/Prof status table
    function closeViewStatusFormModal() {
      document.getElementById('viewStatusFormModal').classList.add('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '';
      document.getElementById('viewStatusFormModalTitle').textContent = 'Faculty Portfolio Form Details';
    }

    async function viewStatusFacultyForm(designation, facultyName, department) {
      document.getElementById('viewStatusFormModal').classList.remove('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      let nameField = '';
      let deptField = '';
      if (designation === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
      else if (designation === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else if (designation === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq(deptField, department)
        .eq(nameField, facultyName)
        .order('input_id', { ascending: false });
      if (error || !data || data.length === 0) {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const row = data[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-blue-700">Department:</div>
        <div class="mb-2">${row[deptField] || row['Department:'] || row['Department'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      // Use the same section titles as the first table
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-blue-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-blue-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-blue-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewStatusFormModalContent').innerHTML = html;
      document.getElementById('viewStatusFormModalTitle').textContent = `${designation} Portfolio Form Details`;
    }
    async function viewFacultyForm(email, designation, facultyName) {
      document.getElementById('viewFormModal').classList.remove('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      if (designation === 'AP') tableName = 'AP';
      else if (designation === 'ASP') tableName = 'ASP';
      else if (designation === 'Prof') tableName = 'Prof';
      else {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq('Department', selectedDepartment);
      if (error || !data || data.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const nameTrimmed = (facultyName || '').toString().trim().toLowerCase();
      let filtered = data.filter(row => {
        let rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        return rowName === nameTrimmed;
      });
      if (filtered.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">No form data found for this faculty name.</div>';
        return;
      }
      filtered.sort((a, b) => (b.id || 0) - (a.id || 0));
      const row = filtered[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-purple-700">Department:</div>
        <div class="mb-2">${row['Department'] || row['Department:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          // Check if it's a valid URL or file path
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-purple-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-purple-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-purple-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewFormModalContent').innerHTML = html;
      document.getElementById('viewFormModalTitle').textContent = `${designation} Form Details`;
    }
  loadDepartments().then(loadDashboardTable);
  // NEW: Load status table departments and table
  loadStatusDepartments().then(loadFacultyStatusTable);
  </script>
  <footer class="text-center py-4 mt-8">
    <p class="text-gray-400 text-sm"> © All Rights Reserved <a href="https://pmctech.org" target="_blank" class="text-gray-400 hover:text-gray-600 underline">PMC TECH</a>, IV CSE 2022-2026.<br/> 
    </p>
  </footer>
</body>
</html>
