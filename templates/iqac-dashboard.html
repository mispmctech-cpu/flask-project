<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Faculty Core Scope Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-pmcBg min-h-screen">
  <header class="bg-purple-700 text-white w-full">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 rounded shadow bg-white p-1" />
        <span class="ml-4 text-xl font-bold">Dashboard - Faculty Core Scope Compliance</span>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8">
  <!-- Export Scope Modal -->
    <div id="exportScopeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button onclick="closeExportScopeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-lg font-bold mb-4 text-purple-700">Export Dashboard Table</h3>
        <p class="mb-4 text-gray-700">Select export scope:</p>
        <div class="flex flex-col gap-3">
          <button id="exportCurrentDeptBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Current Department</button>
          <button id="exportAllDeptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">All Departments</button>
        </div>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-purple-700 mb-6">Faculty Core Scope - Yearly</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="departmentFilter" class="font-medium text-purple-700 mr-2">Filter by Department:</label>
      <select id="departmentFilter" class="p-2 border rounded"></select>
      <label for="designationFilter" class="font-medium text-purple-700 mr-2">Filter by Designation:</label>
      <select id="designationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <button id="exportDashboardTableBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export dashboard table to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Dashboard Table
      </button>
    </div>
    <div id="dashboardTableContainer" class="overflow-x-auto"></div>

    <!-- NEW: Faculty Status Table from AP, ASP, Prof tables -->
    <h2 class="text-2xl font-bold text-blue-700 mt-12 mb-6">Faculty Core Scope - Monthly</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="statusDepartmentFilter" class="font-medium text-blue-700 mr-2">Filter by Department:</label>
      <select id="statusDepartmentFilter" class="p-2 border rounded"></select>
      <label for="statusDesignationFilter" class="font-medium text-blue-700 mr-2">Filter by Designation:</label>
      <select id="statusDesignationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <button id="exportStatusTableBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export status table to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Status Table
      </button>
    </div>
    <!-- Export Modal for Status Table -->
    <div id="exportStatusModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 relative">
        <button onclick="closeExportStatusModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-lg font-bold mb-4 text-blue-700">Export Status Table</h3>
        <p class="mb-4 text-gray-700">Select export scope:</p>
        <div class="flex flex-col gap-3">
          <button id="exportStatusCurrentDeptBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">Current Department</button>
          <button id="exportStatusAllDeptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">All Departments</button>
        </div>
      </div>
    </div>


    <div id="facultyStatusTableContainer" class="overflow-x-auto"></div>
    <!-- Department Portfolios Table -->
    <div id="departmentPortfoliosStickyHeader" class="flex flex-wrap gap-4 items-center mb-4 bg-white z-20" style="position:sticky; top:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
      <label for="portfolioDepartmentFilter" class="font-medium text-orange-700 mr-2">Filter by Department:</label>
      <select id="portfolioDepartmentFilter" class="p-2 border rounded"></select>
      
      <label for="portfolioMonthFilter" class="font-medium text-orange-700 mr-2">Month:</label>
      <select id="portfolioMonthFilter" class="p-2 border rounded">
        <option value="Current">Current Month</option>
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>
      
      <!-- Hidden frequency filter (now only using monthly tables) -->
      <div style="display: none;">
        <label for="portfolioFrequencyFilter" class="font-medium text-orange-700 mr-2">Frequency:</label>
        <select id="portfolioFrequencyFilter" class="p-2 border rounded">
          <option value="Weekly">Weekly (Current Week)</option>
          <option value="Monthly">Monthly</option>
          <option value="OnceIn3Months">Once in 3 Months</option>
          <option value="OnceIn2Months">Once in 2 Months</option>
          <option value="OnceIn15Days">Once in 15 Days</option>
          <option value="Semester">Once in a Semester</option>
          <option value="Year">Once in a Year</option>
          <option value="All">All</option>
        </select>
      </div>
      <!-- Hidden weekly date filters -->
      <div id="weeklyDateFilters" class="flex gap-2 items-center" style="display: none;">
        <label for="weekStartDate" class="font-medium text-orange-700">Week Start:</label>
        <input type="date" id="weekStartDate" class="p-2 border rounded text-sm">
        <label for="weekEndDate" class="font-medium text-orange-700">Week End:</label>
        <input type="date" id="weekEndDate" class="p-2 border rounded text-sm">
        <button id="applyWeekFilter" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm">Apply</button>
        <button id="resetToCurrentWeek" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">Current Week</button>
      </div>
      <label for="portfolioStatusFilter" class="font-medium text-orange-700 mr-2">Show:</label>
      <select id="portfolioStatusFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="Completed">Completed </option>
        <option value="Pending">Pending </option>
      </select>
      <button id="exportDepartmentPortfoliosBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export department portfolios to Excel">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Export Portfolios Table
      </button>
    </div>
    <div id="departmentPortfoliosContainer" class="overflow-x-auto mt-2"></div>
      
    </div>

    <!-- Modal for viewing Yearly form details from dashboard table -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>

    <!-- Modal for viewing AP/ASP/Prof form details from status table -->
    <div id="viewStatusFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewStatusFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewStatusFormModalTitle" class="text-xl font-bold mb-4 text-blue-700">Faculty Portfolio Form Details</h3>
        <div id="viewStatusFormModalContent"></div>
      </div>
    </div>
  </main>
  <script src="/static/javascript/form-modal-mapper.js"></script>
<script>
// Export Status Table Modal logic
function openExportStatusModal() {
  document.getElementById('exportStatusModal').classList.remove('hidden');
}
function closeExportStatusModal() {
  document.getElementById('exportStatusModal').classList.add('hidden');
}
// Export Status Table to Excel utility
function exportStatusTableToExcel(scope) {
  // scope: 'current' or 'all'
  // Show loading overlay
  let loadingDiv = document.createElement('div');
  loadingDiv.id = 'exportLoadingOverlay';
  loadingDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
  loadingDiv.innerHTML = `<div style="background:white;padding:32px 48px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;gap:16px;">
    <svg class='animate-spin' style='height:48px;width:48px;color:#2563eb;' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'>
      <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
      <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z'></path>
    </svg>
    <div style='font-size:18px;color:#2563eb;font-weight:600;'>Exporting, please wait...</div>
  </div>`;
  document.body.appendChild(loadingDiv);
  if (scope === 'current') {
    // Export only currently visible table
    const container = document.getElementById('facultyStatusTableContainer');
    if (!container) return;
    let tables = Array.from(container.querySelectorAll('table'));
    if (tables.length === 0) return;
    let data = [];
    let headers = [];
    tables = [tables[0]];
    tables.forEach((table, tIdx) => {
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      if (!thead || !tbody) return;
      const ths = Array.from(thead.querySelectorAll('th'));
      const tableHeaders = ths.map(th => th.innerText.trim());
      if (tIdx === 0) headers = tableHeaders;
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const row = Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
        data.push(row);
      });
    });
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'StatusTable');
    XLSX.writeFile(wb, `FacultyStatusTable_CurrentDepartment.xlsx`);
    return;
  }
  // Export all departments side by side
  // 1. Fetch all departments
  supabaseClient.from('Faculty').select('department').then(async ({ data, error }) => {
    if (error || !data) return;
    const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
    if (departments.length === 0) return;
    // 2. For each department, render the status table HTML and parse it
    let allTables = [];
    for (let dept of departments) {
      // Simulate the logic of loadFacultyStatusTable for each department
      // Fetch all faculty for the department
      const { data: facultyList, error: facErr } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', dept);
      if (facErr || !facultyList || facultyList.length === 0) continue;
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      for (const key of ['AP', 'ASP', 'Prof']) {
        const group = groups[key];
        if (group.length === 0) continue;
        // Table header
        let scopes = [];
        let generalIdx = [];
        if (key === 'AP') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Present at conferences.',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Attend FDP/ workshops/ seminar.',
            'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
            'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,12,13,14,20,21,22];
        } else if (key === 'ASP') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Publish in peer-reviewed journals',
            'Research and Development: Apply for research grants',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Organize FDP/ workshops/ seminar.',
            'Professional Development: NPTEL/MOOC and certifications.',
            'Professional Development: Memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
            'Community and Industry Engagement: Engage in consultancy',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Memberships in professional bodies.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
        } else if (key === 'Prof') {
          scopes = [
            'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
            'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
            'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
            'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
            'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
            'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
            'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
            'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
            'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
            'Research and Development: Publish in peer-reviewed journals',
            'Research and Development: Apply for research grants',
            'Research and Development: Guide student research and final-year projects',
            'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
            'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
            'Institutional Development: Serve on academic and administrative committees.',
            'Professional Development: Organize FDP/ workshops/ seminar.',
            'Professional Development: NPTEL/MOOC and certifications.',
            'Professional Development: Memberships in professional bodies.',
            'Community and Industry Engagement: Facilitate MoUs',
            'Community and Industry Engagement: Engage in consultancy',
            'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
            'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
            'Memberships in professional bodies.'
          ];
          generalIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
        }
        // Build table data
        let tableHeaders = ['Department', 'Faculty Name'];
        for (let idx of generalIdx) {
          let desc = scopes[idx-1] ? scopes[idx-1].trim() : '';
          if (key === 'AP' && idx === 22) {
            desc = scopes[21] || 'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.';
          }
          tableHeaders.push(desc ? desc : 'Status ' + idx);
        }
        let tableRows = [];
        for (const fac of group) {
          let tableName = '';
          let nameField = '';
          let deptField = '';
          if (key === 'AP') {
            tableName = 'AP';
            nameField = 'Portfolio Member Name';
            deptField = 'Department';
          } else if (key === 'ASP') {
            tableName = 'ASP';
            nameField = 'Portfolio Member Name';
            deptField = '"Department:"';
          } else if (key === 'Prof') {
            tableName = 'Prof';
            nameField = 'Portfolio Member Name';
            deptField = '"Department:"';
          }
          // Fetch latest row for this faculty in this dept
          let { data: rows, error: rowErr } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq(deptField, dept)
            .order('input_id', { ascending: false });
          // Debug: log how many rows fetched for this dept/designation
          if (!window._exportStatusDebug) window._exportStatusDebug = [];
          window._exportStatusDebug.push({ dept, designation: key, fetchedRows: rows ? rows.length : 0 });
          // Robust faculty name matching for ASP/Prof (and all designations)
          let facNamesToTry = [];
          if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
          if (fac.Name) facNamesToTry.push(fac.Name);
          if (fac.email) facNamesToTry.push(fac.email);
          // Remove duplicates, normalize
          facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
          let row = null;
          if (rows && rows.length > 0) {
            for (let r of rows) {
              // Try all possible name fields, normalize
              let possibleRowNames = [
                r['Portfolio Member Name'],
                r['Portfolio Member Name:'],
                r['Portfolio Memeber Name'],
                r['faculty_name'],
                r['Faculty Name'],
                r['Name'],
                r['email']
              ].map(x => (x || '').toString().trim().toLowerCase()).filter(Boolean);
              // Also normalize department field for matching
              let rowDept = (r['Department:'] || r['Department'] || '').toString().trim().toLowerCase();
              let matchDept = (dept || '').toString().trim().toLowerCase();
              if (rowDept === matchDept && facNamesToTry.some(n => possibleRowNames.includes(n))) {
                row = r;
                break;
              }
            }
          }
          // Calculate percentage for this faculty
          let percentage = 0;
          if (row) {
            let completedCount = 0;
            let applicableCount = 0;
            for (let idx of generalIdx) {
              let statusVal = row ? (row[`Status_${idx}`] || row[`Status_${idx}`] || '-') : '-';
              const val = (statusVal || '').toString().trim().toLowerCase();
              if (val === 'not applicable' || val === 'na') continue;
              applicableCount += 1;
              if (val === 'completed' || val === 'completed and updated') {
                completedCount += 1;
              }
            }
            if (applicableCount > 0) {
              percentage = Math.round((completedCount / applicableCount) * 100);
            } else {
              percentage = 0;
            }
          }
          // Add percentage in brackets to faculty name
          let facultyDisplayName = (fac.Name || fac['Portfolio Member Name'] || fac.email || '') + ` (${percentage}%)`;
          let rowArr = [dept, facultyDisplayName];
          for (let idx of generalIdx) {
            let statusVal = row ? (row[`Status_${idx}`] || row[`Status_${idx}`] || '-') : '-';
            let display = '-';
            if (statusVal && typeof statusVal === 'string') {
              const val = statusVal.trim().toLowerCase();
              if (val === 'completed') display = 'Completed';
              else if (val === 'in progress') display = 'In Progress';
              else if (val === 'not started') display = 'Not Started';
              else if (val === 'not applicable' || val === 'na') display = 'N/A';
              else if (val === 'no' || val === 'incomplete') display = 'Incomplete';
              else display = statusVal;
            }
            rowArr.push(display);
          }
          tableRows.push(rowArr);
        }
        allTables.push({
          dept,
          designation: key,
          headers: tableHeaders,
          rows: tableRows
        });
      }
    }
    // 3. Combine all tables stacked vertically (one long table)
    // Use a single set of headers: Department, Designation, Faculty Name, ...status columns...
    let allRows = [];
    let headersSet = false;
    let headers = [];
    for (const t of allTables) {
      // t.headers: [Department, Faculty Name, ...]
      // Add Designation column after Department
      let localHeaders = t.headers.slice();
      if (!headersSet) {
        headers = localHeaders.slice(0,1).concat(['Designation'], localHeaders.slice(1));
        headersSet = true;
      }
      for (const row of t.rows) {
        // Insert designation after department
        let newRow = row.slice(0,1).concat([t.designation], row.slice(1));
        allRows.push(newRow);
      }
    }
    const ws = XLSX.utils.aoa_to_sheet([headers, ...allRows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'StatusTable');
  XLSX.writeFile(wb, `FacultyStatusTable_AllDepartments.xlsx`);
  // Remove loading overlay
  const overlay = document.getElementById('exportLoadingOverlay');
  if (overlay) overlay.remove();
    // Remove loading overlay on error/exit
    const overlay2 = document.getElementById('exportLoadingOverlay');
    if (overlay2) overlay2.remove();
  });
}
// Attach export button listeners for status table
setTimeout(() => {
  const exportBtn = document.getElementById('exportStatusTableBtn');
  if (exportBtn) {
    exportBtn.onclick = () => openExportStatusModal();
    setTimeout(() => {
      const currentBtn = document.getElementById('exportStatusCurrentDeptBtn');
      const allBtn = document.getElementById('exportStatusAllDeptBtn');
      if (currentBtn && allBtn) {
        currentBtn.onclick = () => {
          closeExportStatusModal();
          exportStatusTableToExcel('current');
        };
        allBtn.onclick = () => {
          closeExportStatusModal();
          exportStatusTableToExcel('all');
        };
      }
    }, 600);
  }
}, 800);
</script>
<script>
// Export Scope Modal logic
function openExportScopeModal() {
  document.getElementById('exportScopeModal').classList.remove('hidden');
}
function closeExportScopeModal() {
  document.getElementById('exportScopeModal').classList.add('hidden');
}
// Export Yearly Dashboard to Excel - Current Department
async function exportYearlyCurrentDepartment() {
  closeExportScopeModal();
  
  // Show loading overlay
  let loadingDiv = document.createElement('div');
  loadingDiv.id = 'exportLoadingOverlay';
  loadingDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
  loadingDiv.innerHTML = `<div style="background:white;padding:32px 48px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;gap:16px;">
    <svg class='animate-spin' style='height:48px;width:48px;color:#7c3aed;' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'>
      <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
      <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z'></path>
    </svg>
    <div style='font-size:18px;color:#7c3aed;font-weight:600;'>Exporting current department, please wait...</div>
  </div>`;
  document.body.appendChild(loadingDiv);
  
  try {
    // Fetch faculty for current department AND their form submissions
    const [facultyRes, apRes, aspRes, profRes] = await Promise.all([
      supabaseClient.from('Faculty').select('*').eq('department', selectedDepartment),
      supabaseClient.from('AP(Yearly)').select('*').eq('Department', selectedDepartment),
      supabaseClient.from('ASP(Yearly)').select('*').eq('Department', selectedDepartment),
      supabaseClient.from('Prof(Yearly)').select('*').eq('Department', selectedDepartment)
    ]);
    
    const deptFaculty = facultyRes.data || [];
    
    // Particulars for each designation
    const particularsMap = {
      AP: [
        'Present at Conferences.',
        'Guide student research and final-year projects.',
        'Attend FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications 2/Sem',
        'Facilitate industry-institute interaction through guest lectures, internships.',
        'Engage in extension activities, and social outreach programs.',
        'Membership in professional body'
      ],
      ASP: [
        'Publish in peer-reviewed journals',
        'Apply for research grants',
        'Guide student research and final-year projects.',
        'Organize FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications',
        'Facilitate industry-institute interaction through guest lectures, internships.',
        'Engage in Consultancy.',
        'Membership in professional body'
      ],
      Prof: [
        'Publish in peer-reviewed journals',
        'Apply for research grants',
        'Guide student research and final-year projects.',
        'Organize FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications',
        'Facilitate MoU',
        'Engage in Consultancy.',
        'Membership in professional body'
      ]
    };
    
    // Build single combined sheet with all designations
    const headers = ['Department', 'Designation', 'Faculty Name', 'Percentage', ...particularsMap.AP];
    const allRows = [headers];
    
    // Create lookup maps for form submissions
    const formDataMaps = {
      AP: {},
      ASP: {},
      Prof: {}
    };
    
    // Build lookup maps: key = facultyName (lowercase), value = latest row
    [
      { designation: 'AP', data: apRes.data || [] },
      { designation: 'ASP', data: aspRes.data || [] },
      { designation: 'Prof', data: profRes.data || [] }
    ].forEach(({ designation, data }) => {
      const grouped = {};
      data.forEach(row => {
        const facultyName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        if (!facultyName) return;
        if (!grouped[facultyName]) grouped[facultyName] = [];
        grouped[facultyName].push(row);
      });
      
      // Get latest row for each faculty
      Object.keys(grouped).forEach(facultyName => {
        const rows = grouped[facultyName].sort((a, b) => (b.input_id || b.id || 0) - (a.input_id || a.id || 0));
        formDataMaps[designation][facultyName] = rows[0];
      });
    });
    
    // Process all faculty from current department
    deptFaculty.forEach(fac => {
      const dept = fac.department || selectedDepartment;
      const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
      const designation = (fac.Designation || '').toUpperCase();
      
      // Normalize designation
      let desig = '';
      if (designation === 'AP' || designation === 'ASSISTANT PROFESSOR') desig = 'AP';
      else if (designation === 'ASP' || designation === 'ASSOCIATE PROFESSOR') desig = 'ASP';
      else if (designation === 'PROF' || designation === 'PROFESSOR') desig = 'Prof';
      else return; // Skip if designation not recognized
      
      const statusCount = desig === 'AP' ? 7 : 8;
      const key = facultyName.trim().toLowerCase();
      const formRow = formDataMaps[desig][key];
      
      let percentage = 0;
      const rowData = [dept, desig, facultyName];
      
      if (formRow) {
        // Faculty has submitted form - calculate percentage
        let completedCount = 0;
        for (let i = 1; i <= statusCount; i++) {
          const status = (formRow[`Status_${i}`] || '').toString().toLowerCase();
          if (status === 'completed' || status === 'completed and updated') {
            completedCount++;
          }
        }
        percentage = statusCount > 0 ? Math.round((completedCount / statusCount) * 100) : 0;
        rowData.push(percentage + '%');
        
        // Add status columns
        for (let i = 1; i <= 8; i++) {
          if (i <= statusCount) {
            rowData.push(formRow[`Status_${i}`] || '-');
          } else {
            rowData.push('-');
          }
        }
      } else {
        // Faculty has NOT submitted form - show 0% and empty columns
        rowData.push('0%');
        for (let i = 1; i <= 8; i++) {
          rowData.push('-');
        }
      }
      
      allRows.push(rowData);
    });
    
    // Sort by designation, then faculty name
    const dataRows = allRows.slice(1);
    dataRows.sort((a, b) => {
      if (a[1] !== b[1]) return a[1].localeCompare(b[1]);
      return a[2].localeCompare(b[2]);
    });
    
    // Create workbook and export
    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, selectedDepartment);
    XLSX.writeFile(wb, `IQAC_Dashboard_Yearly_${selectedDepartment}.xlsx`);
    
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export data. Please try again.');
  } finally {
    // Remove loading overlay
    const overlay = document.getElementById('exportLoadingOverlay');
    if (overlay) overlay.remove();
  }
}

// Export Yearly Dashboard to Excel - All Departments
async function exportYearlyAllDepartments() {
  closeExportScopeModal();
  
  // Show loading overlay
  let loadingDiv = document.createElement('div');
  loadingDiv.id = 'exportLoadingOverlay';
  loadingDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
  loadingDiv.innerHTML = `<div style="background:white;padding:32px 48px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;gap:16px;">
    <svg class='animate-spin' style='height:48px;width:48px;color:#7c3aed;' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'>
      <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
      <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z'></path>
    </svg>
    <div style='font-size:18px;color:#7c3aed;font-weight:600;'>Exporting all departments, please wait...</div>
  </div>`;
  document.body.appendChild(loadingDiv);
  
  try {
    // Fetch ALL faculty from Faculty table AND yearly form submissions
    const [facultyRes, apRes, aspRes, profRes] = await Promise.all([
      supabaseClient.from('Faculty').select('*'),
      supabaseClient.from('AP(Yearly)').select('*'),
      supabaseClient.from('ASP(Yearly)').select('*'),
      supabaseClient.from('Prof(Yearly)').select('*')
    ]);
    
    const allFaculty = facultyRes.data || [];
    
    // Particulars for each designation
    const particularsMap = {
      AP: [
        'Present at Conferences.',
        'Guide student research and final-year projects.',
        'Attend FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications 2/Sem',
        'Facilitate industry-institute interaction through guest lectures, internships.',
        'Engage in extension activities, and social outreach programs.',
        'Membership in professional body'
      ],
      ASP: [
        'Publish in peer-reviewed journals',
        'Apply for research grants',
        'Guide student research and final-year projects.',
        'Organize FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications',
        'Facilitate industry-institute interaction through guest lectures, internships.',
        'Engage in Consultancy.',
        'Membership in professional body'
      ],
      Prof: [
        'Publish in peer-reviewed journals',
        'Apply for research grants',
        'Guide student research and final-year projects.',
        'Organize FDPs / workshop/Seminars',
        'NPTEL/ MOOC certifications',
        'Facilitate MoU',
        'Engage in Consultancy.',
        'Membership in professional body'
      ]
    };
    
    // Build single combined sheet with all designations and departments
    const headers = ['Department', 'Designation', 'Faculty Name', 'Percentage', ...particularsMap.AP];
    const allRows = [headers];
    
    // Create lookup maps for form submissions
    const formDataMaps = {
      AP: {},
      ASP: {},
      Prof: {}
    };
    
    // Build lookup maps: key = "dept|facultyName", value = latest row
    [
      { designation: 'AP', data: apRes.data || [] },
      { designation: 'ASP', data: aspRes.data || [] },
      { designation: 'Prof', data: profRes.data || [] }
    ].forEach(({ designation, data }) => {
      const grouped = {};
      data.forEach(row => {
        const dept = (row['Department'] || '').toString().trim();
        const facultyName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        if (!dept || !facultyName) return;
        const key = `${dept}|${facultyName}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
      });
      
      // Get latest row for each faculty
      Object.keys(grouped).forEach(key => {
        const rows = grouped[key].sort((a, b) => (b.input_id || b.id || 0) - (a.input_id || a.id || 0));
        formDataMaps[designation][key] = rows[0];
      });
    });
    
    // Process all faculty from Faculty table
    allFaculty.forEach(fac => {
      const dept = fac.department || 'Unknown';
      const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
      const designation = (fac.Designation || '').toUpperCase();
      
      // Normalize designation
      let desig = '';
      if (designation === 'AP' || designation === 'ASSISTANT PROFESSOR') desig = 'AP';
      else if (designation === 'ASP' || designation === 'ASSOCIATE PROFESSOR') desig = 'ASP';
      else if (designation === 'PROF' || designation === 'PROFESSOR') desig = 'Prof';
      else return; // Skip if designation not recognized
      
      const statusCount = desig === 'AP' ? 7 : 8;
      const key = `${dept}|${facultyName.trim().toLowerCase()}`;
      const formRow = formDataMaps[desig][key];
      
      let percentage = 0;
      const rowData = [dept, desig, facultyName];
      
      if (formRow) {
        // Faculty has submitted form - calculate percentage
        let completedCount = 0;
        for (let i = 1; i <= statusCount; i++) {
          const status = (formRow[`Status_${i}`] || '').toString().toLowerCase();
          if (status === 'completed' || status === 'completed and updated') {
            completedCount++;
          }
        }
        percentage = statusCount > 0 ? Math.round((completedCount / statusCount) * 100) : 0;
        rowData.push(percentage + '%');
        
        // Add status columns
        for (let i = 1; i <= 8; i++) {
          if (i <= statusCount) {
            rowData.push(formRow[`Status_${i}`] || '-');
          } else {
            rowData.push('-');
          }
        }
      } else {
        // Faculty has NOT submitted form - show 0% and empty columns
        rowData.push('0%');
        for (let i = 1; i <= 8; i++) {
          rowData.push('-');
        }
      }
      
      allRows.push(rowData);
    });
    
    // Sort by department, then designation, then faculty name
    const dataRows = allRows.slice(1);
    dataRows.sort((a, b) => {
      if (a[0] !== b[0]) return a[0].localeCompare(b[0]);
      if (a[1] !== b[1]) return a[1].localeCompare(b[1]);
      return a[2].localeCompare(b[2]);
    });
    
    // Create workbook and export
    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'All Departments');
    XLSX.writeFile(wb, `IQAC_Dashboard_Yearly_All_Departments.xlsx`);
    
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export data. Please try again.');
  } finally {
    // Remove loading overlay
    const overlay = document.getElementById('exportLoadingOverlay');
    if (overlay) overlay.remove();
  }
}

// Attach export button listeners after tables are rendered
function attachExportButtons() {
  setTimeout(() => {
    const dashboardTable = document.querySelector('#dashboardTableContainer table');
    if (dashboardTable) {
      document.getElementById('exportDashboardTableBtn').onclick = () => {
        openExportScopeModal();
      };
      
      // Attach modal button logic
      setTimeout(() => {
        const currentBtn = document.getElementById('exportCurrentDeptBtn');
        const allBtn = document.getElementById('exportAllDeptBtn');
        if (currentBtn && allBtn) {
          currentBtn.onclick = exportYearlyCurrentDepartment;
          allBtn.onclick = exportYearlyAllDepartments;
        }
      }, 600);
    }
    
    document.getElementById('exportDepartmentPortfoliosBtn').onclick = async () => {
      // Export based on current filter (only monthly tables now)
      const statusFilter = document.getElementById('portfolioStatusFilter');
      const selectedStatus = statusFilter ? statusFilter.value : 'All';
      const deptFilter = document.getElementById('portfolioDepartmentFilter');
      const selectedDept = deptFilter ? deptFilter.value : 'All';
      
      // Get month filter value
      const monthFilter = document.getElementById('portfolioMonthFilter');
      let selectedMonth = monthFilter ? monthFilter.value : 'Current';
      
      // If "Current" is selected, get current month name
      if (selectedMonth === 'Current') {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const currentDate = new Date();
        selectedMonth = monthNames[currentDate.getMonth()];
      }
      
      // Fetch all faculty data
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        alert('Failed to load department portfolios for export.');
        return;
      }
      // Get all unique departments
      let departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      if (selectedDept !== 'All') departments = [selectedDept];
      // Portfolio headers (only 8 monthly forms)
      const portfolioHeaders = [
        { label: "1. Training & Placement", table: 'form1-monthly' },
        { label: "2. Class Advisor", table: 'form2-monthly' },
        { label: "3. Info & Contribution", table: 'form3-monthly' },
        { label: "4. Outcome & Exam Cell", table: 'form4-monthly' },
        { label: "5. Continuous Improvement", table: 'form5-monthly' },
        { label: "6. T&L Process (IQAC)", table: 'form6-monthly' },
        { label: "7. Student Support", table: 'form7-monthly' },
        { label: "8. Facilities & Lab", table: 'form8-monthly' }
      ];
      const headers = ["Department", "Designation", "Faculty Name", "Portfolio Name", "Percentage"];
      // Fetch all relevant form data for each portfolio column
      const formTableNames = portfolioHeaders.map(h => h.table);
      const formTableData = {};
      for (const tableName of formTableNames) {
        let query = supabaseClient.from(tableName).select('*');
        const { data: tdata } = await query;
        formTableData[tableName] = tdata || [];
      }
      const exportRows = [];
      for (const dept of departments) {
        const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
        
        // Create one row per faculty per portfolio assignment
        for (const fac of facultyList) {
          const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
          const designation = fac.Designation || fac.designation || 'N/A';
          
          // Check which portfolios this faculty is assigned to
          for (const h of portfolioHeaders) {
            const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
            const isAssigned = fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes';
            
            if (isAssigned) {
              const tableName = h.table;
              // Robust percentage calculation (same as UI)
              let percentage = 0;
              let filled = false;
              const tdata = formTableData[tableName];
              let bestRow = null;
              if (tdata && tdata.length > 0) {
                // Robust faculty name matching with month filtering
                const filteredRows = tdata.filter(row => {
                  const rowName = row['Portfolio Member Name:'] || row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                  const rowMonth = row['Month'] || row['month'] || row['Month:'] || '';
                  const nameMatches = rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase();
                  const deptMatches = (row['Department'] || row['Department:'] || '').toString().trim().toLowerCase() === dept.toString().trim().toLowerCase();
                  const monthMatches = rowMonth.toString().trim().toLowerCase() === selectedMonth.toLowerCase();
                  return nameMatches && deptMatches && monthMatches;
                });
                if (filteredRows.length > 0) {
                  filled = true;
                  bestRow = filteredRows.sort((a, b) => (b.id || 0) - (a.id || 0))[0];
                }
              }
              if (bestRow) {
                let completedCount = 0;
                let applicableCount = 0;
                const statusKeys = Object.keys(bestRow).filter(k => k.startsWith('Status'));
                for (const key of statusKeys) {
                  const val = (bestRow[key] || '').toString().trim().toLowerCase();
                  if (val === 'not applicable' || val === 'na') continue;
                  applicableCount += 1;
                  if (val === 'completed' || val === 'completed and updated') {
                    completedCount += 1;
                  }
                }
                if (applicableCount > 0) {
                  percentage = Math.round((completedCount / applicableCount) * 100);
                } else {
                  percentage = 0;
                }
              } else {
                percentage = 0;
              }
              
              // Filter by status
              if (selectedStatus === 'Completed' && !filled) continue;
              if (selectedStatus === 'Pending' && filled) continue;
              
              // Create row: Department, Designation, Faculty Name, Portfolio Name, Percentage
              const percentageDisplay = filled ? `${percentage}%` : `0% (Not Submitted)`;
              exportRows.push([dept, designation, facultyName, h.label, percentageDisplay]);
            }
          }
        }
      }
      
      // Sort export rows: first by department, then by portfolio number (1-8)
      exportRows.sort((a, b) => {
        // First sort by department (index 0)
        if (a[0] !== b[0]) {
          return a[0].localeCompare(b[0]);
        }
        // Then sort by portfolio number (extract from index 3 - Portfolio Name)
        const aNum = parseInt(a[3].match(/^\d+/)?.[0] || '99');
        const bNum = parseInt(b[3].match(/^\d+/)?.[0] || '99');
        return aNum - bNum;
      });
      
      const ws = XLSX.utils.aoa_to_sheet([headers, ...exportRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Portfolios');
      XLSX.writeFile(wb, `IQAC_Portfolios_${selectedMonth}_${selectedDept}.xlsx`);
    };
  }, 500);
}
  // Fetch and render department portfolios table (IQAC)
    async function loadDepartmentPortfoliosIQAC() {
      // Fetch all faculty
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-red-500">Failed to load department portfolios.</div>';
        return;
      }
      // Get all unique departments
      const departments = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      // Setup department filter dropdown
      const deptFilter = document.getElementById('portfolioDepartmentFilter');
      if (!deptFilter.dataset.initialized) {
        deptFilter.innerHTML = '<option value="All">All Departments</option>' + departments.map(d => `<option value="${d}">${d}</option>`).join('');
        deptFilter.dataset.initialized = 'true';
      }
      // Setup status filter dropdown
      const statusFilter = document.getElementById('portfolioStatusFilter');
      // Get selected filter values (re-read each time for correct filtering)
      const selectedDept = deptFilter.options[deptFilter.selectedIndex]?.value || 'All';
      const selectedStatus = statusFilter.options[statusFilter.selectedIndex]?.value || 'All';
      
      // Get month filter value
      const monthFilter = document.getElementById('portfolioMonthFilter');
      let selectedMonth = monthFilter.options[monthFilter.selectedIndex]?.value || 'Current';
      
      // If "Current" is selected, get current month name
      if (selectedMonth === 'Current') {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const currentDate = new Date();
        selectedMonth = monthNames[currentDate.getMonth()];
      }

  // Portfolio headers and their corresponding monthly tables (only 8 monthly forms)
  const portfolioHeaders = [
    { label: "1. Training & Placement", table: 'form1-monthly' },
    { label: "2. Class Advisor", table: 'form2-monthly' },
    { label: "3. Info & Contribution", table: 'form3-monthly' },
    { label: "4. Outcome & Exam Cell", table: 'form4-monthly' },
    { label: "5. Continuous Improvement", table: 'form5-monthly' },
    { label: "6. T&L Process (IQAC)", table: 'form6-monthly' },
    { label: "7. Student Support", table: 'form7-monthly' },
    { label: "8. Facilities & Lab", table: 'form8-monthly' }
  ];
  let html = '';
  html += '<h3 class="text-xl font-bold text-orange-500 mb-2">Department Portfolios</h3>';
  html += '<div style="overflow-x:auto; max-height:600px; overflow-y:auto; border:1px solid #9ca3af; border-radius:8px;">';
  html += '<table class="w-full text-sm bg-white" style="border-collapse:collapse;">';
  html += '<thead class="bg-orange-100 text-orange-700" style="position:sticky; top:0; z-index:10;">';
  html += '<tr>';
  html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:120px;">Department</th>';
  html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:100px;">Designation</th>';
  html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:180px;">Faculty Name</th>';
  html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:200px;">Portfolio Name</th>';
  html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:150px;">Percentage</th>';
  html += '</tr></thead>';
  html += '<tbody>';
  
  // Build rows: one row per faculty per portfolio
  const tableRows = [];
  for (const dept of departments) {
    if (selectedDept !== 'All' && dept !== selectedDept) continue;
    const facultyList = data.filter(fac => (fac.department || 'Unknown') === dept);
    
    for (const fac of facultyList) {
      const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
      const designation = fac.Designation || fac.designation || 'N/A';
      
      // Check which portfolios this faculty is assigned to
      for (const h of portfolioHeaders) {
        const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
        const isAssigned = fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes';
        
        if (isAssigned) {
          const rowId = `${dept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
          tableRows.push({
            dept,
            designation,
            facultyName,
            portfolioName: h.label,
            tableName: h.table,
            formKey,
            rowId
          });
        }
      }
    }
  }
  
  // Sort rows: first by department, then by portfolio number (1-8)
  tableRows.sort((a, b) => {
    // First sort by department
    if (a.dept !== b.dept) {
      return a.dept.localeCompare(b.dept);
    }
    // Then sort by portfolio number (extract number from portfolioName like "1. Training & Placement")
    const aNum = parseInt(a.portfolioName.match(/^\d+/)?.[0] || '99');
    const bNum = parseInt(b.portfolioName.match(/^\d+/)?.[0] || '99');
    return aNum - bNum;
  });
  
  // Render rows
  for (const row of tableRows) {
    html += `<tr class="hover:bg-gray-50">`;
    html += `<td class="px-3 py-2 border border-gray-400" style="min-width:120px;">${row.dept}</td>`;
    html += `<td class="px-3 py-2 border border-gray-400" style="min-width:100px;">${row.designation}</td>`;
    html += `<td class="px-3 py-2 border border-gray-400" style="min-width:180px;">${row.facultyName}</td>`;
    html += `<td class="px-3 py-2 border border-gray-400" style="min-width:200px;">${row.portfolioName}</td>`;
    html += `<td class="px-3 py-2 border border-gray-400" style="min-width:150px;" id="percent-${row.rowId}">Loading...</td>`;
    html += `</tr>`;
  }
  
  html += '</tbody></table></div>';
  document.getElementById('departmentPortfoliosContainer').innerHTML = html;

      // Async percentage calculation for each faculty-portfolio combination
      for (const row of tableRows) {
        (async () => {
          let filled = false;
          let percentage = 0;
          let query = supabaseClient.from(row.tableName).select('*').eq('Department', row.dept);
          const { data: formData, error } = await query;
          let bestRow = null;
          if (!error && formData && formData.length > 0) {
            // Robust faculty name matching with month filtering
            const filteredRows = formData.filter(dataRow => {
              const rowName = dataRow['Portfolio Member Name:'] || dataRow['Portfolio Member Name'] || dataRow['Portfolio Memeber Name'] || dataRow['faculty_name'] || dataRow['Faculty Name'] || dataRow['Name'] || '';
              // Check month field (Month, month, or Month:)
              const rowMonth = dataRow['Month'] || dataRow['month'] || dataRow['Month:'] || '';
              const nameMatches = rowName.toString().trim().toLowerCase() === row.facultyName.toString().trim().toLowerCase();
              const monthMatches = rowMonth.toString().trim().toLowerCase() === selectedMonth.toLowerCase();
              return nameMatches && monthMatches;
            });
            if (filteredRows.length > 0) {
              filled = true;
              // Use the latest row (by id or timestamp)
              bestRow = filteredRows.sort((a, b) => (b.id || 0) - (a.id || 0))[0];
            }
          }
          // Calculate percentage if bestRow exists, using all keys starting with 'Status'
          if (bestRow) {
            let completedCount = 0;
            let applicableCount = 0;
            // Use all keys starting with 'Status' (case-sensitive)
            const statusKeys = Object.keys(bestRow).filter(k => k.startsWith('Status'));
            for (const key of statusKeys) {
              const val = (bestRow[key] || '').toString().trim().toLowerCase();
              if (val === 'not applicable' || val === 'na') continue;
              // Treat null, empty, or '-' as applicable (mark=0)
              applicableCount += 1;
              if (val === 'completed' || val === 'completed and updated') {
                completedCount += 1;
              }
            }
            if (applicableCount > 0) {
              percentage = Math.round((completedCount / applicableCount) * 100);
            } else {
              percentage = 0;
            }
          } else {
            percentage = 0;
          }
          
          // Update the percentage cell
          const percentCell = document.getElementById(`percent-${row.rowId}`);
          if (percentCell) {
            // Apply status filter
            if (selectedStatus === 'Completed' && !filled) {
              percentCell.parentElement.style.display = 'none';
              return;
            }
            if (selectedStatus === 'Pending' && filled) {
              percentCell.parentElement.style.display = 'none';
              return;
            }
            
            // Display percentage with color coding
            if (filled) {
              percentCell.innerHTML = `<span class="font-semibold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">${percentage}%</span>`;
            } else {
              percentCell.innerHTML = `<span class="text-red-600 font-semibold">0% (Not Submitted)</span>`;
            }
          }
        })();
      }

      // Add filter event listeners (department, month, and status filters)
  monthFilter.onchange = deptFilter.onchange = statusFilter.onchange = () => loadDepartmentPortfoliosIQAC();
  
  // Setup date filter event listeners
  if (!document.getElementById('applyWeekFilter').dataset.listenerAdded) {
    document.getElementById('applyWeekFilter').addEventListener('click', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('resetToCurrentWeek').addEventListener('click', () => {
      setCurrentWeekDates();
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('weekStartDate').addEventListener('change', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('weekEndDate').addEventListener('change', () => {
      loadDepartmentPortfoliosIQAC();
    });
    
    document.getElementById('applyWeekFilter').dataset.listenerAdded = 'true';
  }
    }
    
    // Helper function to set current week dates
    function setCurrentWeekDates() {
      const now = new Date();
      const currentDay = now.getDay();
      const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset);
      
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      
      document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
      document.getElementById('weekEndDate').value = sunday.toISOString().split('T')[0];
    }
  </script>
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cbhodgwaazmjszkujrti.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    // --- NEW: Faculty Status Table from AP, ASP, Prof tables ---
    let allStatusDepartments = [];
    let selectedStatusDepartment = '';
    let selectedStatusDesignation = 'All';
    async function loadStatusDepartments() {
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('department');
      if (error || !data) return;
      const depts = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      allStatusDepartments = depts;
      const select = document.getElementById('statusDepartmentFilter');
      select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
      selectedStatusDepartment = depts[0] || '';
      select.value = selectedStatusDepartment;
      select.addEventListener('change', () => {
        selectedStatusDepartment = select.value;
        loadFacultyStatusTable();
      });
    }
    document.getElementById('statusDesignationFilter').addEventListener('change', () => {
      selectedStatusDesignation = document.getElementById('statusDesignationFilter').value;
      loadFacultyStatusTable();
    });
    async function loadFacultyStatusTable() {
      if (!selectedStatusDepartment) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      // Fetch all faculty for the department
      const { data: facultyList, error: facErr } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', selectedStatusDepartment);
      if (facErr || !facultyList || facultyList.length === 0) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      // Fetch all AP/ASP/Prof rows for this department for aggregation
      const [apRows, aspRows, profRows] = await Promise.all([
        supabaseClient.from('AP').select('*').eq('Department', selectedStatusDepartment),
        supabaseClient.from('ASP').select('*').eq('"Department:"', selectedStatusDepartment),
        supabaseClient.from('Prof').select('*').eq('"Department:"', selectedStatusDepartment)
      ]);
      // Helper to aggregate all rows for a faculty and status index
      function getBestStatusForFaculty(fac, key, idx) {
        let rows = [];
        let facNamesToTry = [];
        if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
        if (fac.Name) facNamesToTry.push(fac.Name);
        if (fac.email) facNamesToTry.push(fac.email);
        facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
        if (key === 'AP') rows = apRows.data || [];
        else if (key === 'ASP') rows = aspRows.data || [];
        else if (key === 'Prof') rows = profRows.data || [];
        // Find all rows for this faculty
        let facRows = rows.filter(r => {
          let rowName = (r['Portfolio Member Name'] || r['Portfolio Member Name:'] || r['Portfolio Memeber Name'] || r['faculty_name'] || r['Faculty Name'] || r['Name'] || r['email'] || '').toString().trim().toLowerCase();
          return facNamesToTry.includes(rowName);
        });
        // If any row for this status is completed, return 'Completed'
        for (let r of facRows) {
          let statusVal = r[`Status_${idx}`] || '-';
          const val = (statusVal || '').trim().toLowerCase();
          if (val === 'completed') return 'Completed';
        }
        // Otherwise, return the latest row's value if exists
        if (facRows.length > 0) {
          let statusVal = facRows[0][`Status_${idx}`] || '-';
          return statusVal;
        }
        return '-';
      }
      let html = '';
      // Define scope/description arrays for headers
      // Only show General Section columns (not compliance/targeted)
      // AP: complianceRows = [10, 11, 15, 16, 17, 18, 19]
      // ASP/Prof: complianceRows = [10, 11, 12, 16, 17, 18, 19, 23]
      const apScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Present at conferences.',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Attend FDP/ workshops/ seminar.',
        'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.',
  '',
      ];
      const apGeneralIdx = [1,2,3,4,5,6,7,8,9,12,13,14,20,21,22];
      const aspScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const aspGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      const profScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate MoUs',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const profGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      for (const key of ['AP', 'ASP', 'Prof']) {
        if (selectedStatusDesignation !== 'All' && selectedStatusDesignation !== key) continue;
        const group = groups[key];
        if (group.length === 0) continue;
        html += `<h3 class="text-xl font-semibold text-blue-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
        // Table header
        html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-blue-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
        let scopes = [];
        let generalIdx = [];
        if (key === 'AP') { scopes = apScopes; generalIdx = apGeneralIdx; }
        else if (key === 'ASP') { scopes = aspScopes; generalIdx = aspGeneralIdx; }
        else if (key === 'Prof') { scopes = profScopes; generalIdx = profGeneralIdx; }
        for (let idx of generalIdx) {
          // Always include Status 22 (idx==22) even if description is blank, and use correct description from apScopes[21]
          let desc = scopes[idx-1] ? scopes[idx-1].trim() : '';
          if (key === 'AP' && idx === 22) {
            desc = scopes[21] || 'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.';
          }
          html += `<th class="px-4 py-2" title="${desc}">${desc ? desc : 'Status ' + idx}</th>`;
        }
        html += `</tr></thead><tbody>`;
        for (const fac of group) {
          let tableName = '';
          let nameField = '';
          let deptField = '';
          if (key === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
          else if (key === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          else if (key === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          // Fetch latest row for this faculty in this dept
          let { data: rows, error: rowErr } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq(deptField, selectedStatusDepartment)
            .order('input_id', { ascending: false });
          // Robust faculty name matching for ASP (and all designations)
          let facNamesToTry = [];
          if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
          if (fac.Name) facNamesToTry.push(fac.Name);
          if (fac.email) facNamesToTry.push(fac.email);
          facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
          let row = null;
          if (rows && rows.length > 0) {
            for (let r of rows) {
              let rowName = (r['Portfolio Member Name'] || r['Portfolio Member Name:'] || r['Portfolio Memeber Name'] || r['faculty_name'] || r['Faculty Name'] || r['Name'] || r['email'] || '').toString().trim().toLowerCase();
              if (facNamesToTry.includes(rowName)) {
                row = r;
                break;
              }
            }
          }
          // Percentage calculation: completed=1 if any row for that status is completed, not applicable/na=skip, any other=0
          let completedCount = 0;
          let applicableCount = 0;
          for (let idx of generalIdx) {
            // Use the new aggregation logic
            let statusVal = getBestStatusForFaculty(fac, key, idx);
            const val = (statusVal || '').trim().toLowerCase();
            if (val === 'not applicable' || val === 'na') continue;
            applicableCount += 1;
            if (val === 'completed') completedCount += 1;
          }
          const percentage = applicableCount > 0 ? Math.round((completedCount / applicableCount) * 100) : 0;
          html += `<tr><td class="px-2 py-2 font-medium text-blue-700 cursor-pointer underline" onclick="viewStatusFacultyForm('${key}','${(fac.Name || '').replace(/'/g, "\'")}', '${selectedStatusDepartment.replace(/'/g, "\'")})">${fac.Name || fac['Portfolio Member Name'] || fac.email || ''}<div class='text-sm ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'} font-semibold'>${percentage}%</div></td>`;
          for (let idx of generalIdx) {
            let statusVal = getBestStatusForFaculty(fac, key, idx);
            let display = '-';
            let statusClass = '';
            if (statusVal && typeof statusVal === 'string') {
              const val = statusVal.trim().toLowerCase();
              if (val === 'completed') {
                display = 'Completed';
                statusClass = 'text-green-600 font-semibold';
              } else if (val === 'in progress' || val === 'inprogress' || val === 'underprocess' || val === 'under process') {
                display = statusVal;
                statusClass = 'text-yellow-600 font-semibold';
              } else if (val === 'yet to be completed' || val === 'not started' || val === 'no' || val === 'incomplete') {
                display = statusVal;
                statusClass = 'text-red-600 font-semibold';
              } else if (val === '-' || val === '' || val === null) {
                display = '-';
                statusClass = 'text-gray-500';
              } else {
                display = statusVal;
                statusClass = 'text-blue-600 font-semibold';
              }
            } else {
              display = '-';
              statusClass = 'text-gray-500';
            }
            html += `<td class="px-2 py-2 ${statusClass}">${display}</td>`;
          }
          html += `</tr>`;
        }
        html += `</tbody></table></div>`;
      }
      document.getElementById('facultyStatusTableContainer').innerHTML = html || '<div class="text-gray-500">No status data found.</div>';
    }
    let allDepartments = [];
    let selectedDepartment = '';
    async function loadDepartments() {
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('department');
      if (error || !data) return;
      const depts = Array.from(new Set(data.map(row => row.department).filter(Boolean)));
      allDepartments = depts;
      const select = document.getElementById('departmentFilter');
      select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
      selectedDepartment = depts[0] || '';
      select.value = selectedDepartment;
      select.addEventListener('change', () => {
        selectedDepartment = select.value;
        loadDashboardTable();
      });
    }
    // --- END NEW ---
    async function loadDashboardTable() {
      if (!selectedDepartment) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', selectedDepartment);
      if (error || !data || data.length === 0) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      renderDashboardTable(data);
    }
    function renderDashboardTable(facultyList) {
      const designationFilter = document.getElementById('designationFilter').value;
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      const particularsMap = {
        AP: [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body'
        ],
        ASP: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in Consultancy.',
          'Membership in professional body'
        ],
        Prof: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate MoU',
          'Engage in Consultancy.',
          'Membership in professional body'
        ]
      };
      (async function renderDashboardAsync() {
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('AP(Yearly)').select('*').eq('Department', selectedDepartment),
          supabaseClient.from('ASP(Yearly)').select('*').eq('Department', selectedDepartment),
          supabaseClient.from('Prof(Yearly)').select('*').eq('Department', selectedDepartment)
        ]);
        function getBestYearlyRows(data) {
          const facultyData = {};
          
          // Group all rows by faculty name
          data.forEach(row => {
            const facultyName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
            if (!facultyName) return;
            if (!facultyData[facultyName]) facultyData[facultyName] = [];
            facultyData[facultyName].push(row);
          });
          
          // For each faculty, get the latest row by input_id or id
          const result = [];
          Object.keys(facultyData).forEach(facultyName => {
            const rows = facultyData[facultyName];
            rows.sort((a, b) => (b.input_id || b.id || 0) - (a.input_id || a.id || 0));
            result.push(rows[0]);
          });
          
          return result;
        }
        const apDataLatest = getBestYearlyRows(apRes.data || []);
        const aspDataLatest = getBestYearlyRows(aspRes.data || []);
        const profDataLatest = getBestYearlyRows(profRes.data || []);
        for (const key of ['AP', 'ASP', 'Prof']) {
          if (designationFilter !== 'All' && designationFilter !== key) continue;
          const group = groups[key];
          if (group.length === 0) continue;
          html += `<h3 class="text-xl font-semibold text-purple-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
          const particulars = particularsMap[key];
          html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-purple-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th><th class="px-4 py-2">Percentage</th>`;
          particulars.forEach(particular => {
            html += `<th class="px-4 py-2">${particular}</th>`;
          });
          html += `</tr></thead><tbody>`;
          for (const fac of group) {
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || '';
            const nameTrimmed = facultyName.toString().trim().toLowerCase();
            
            // Find matching yearly data for this faculty
            let yearlyData = null;
            if (key === 'AP') yearlyData = apDataLatest;
            else if (key === 'ASP') yearlyData = aspDataLatest;
            else if (key === 'Prof') yearlyData = profDataLatest;
            
            const row = yearlyData ? yearlyData.find(r => 
              (r['Portfolio Member Name'] || '').toString().trim().toLowerCase() === nameTrimmed
            ) : null;
            
            // Calculate percentage based on Status fields
            let completedCount = 0;
            let totalCount = key === 'AP' ? 7 : 8; // AP has 7 items, ASP/Prof have 8
            
            if (row) {
              for (let i = 1; i <= totalCount; i++) {
                const status = (row[`Status_${i}`] || '').toString().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount++;
                }
              }
            }
            
            const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            html += `<tr><td class="px-2 py-2 font-medium text-purple-700 cursor-pointer underline" onclick="viewYearlyFacultyForm('${key}','${facultyName.replace(/'/g, "\\'")}', '${selectedDepartment.replace(/'/g, "\\'")}')">
                ${facultyName}
            </td>`;
            
            // Percentage column with color coding
            html += `<td class="px-2 py-2 text-center font-bold ${percentage >= 70 ? 'bg-green-100 text-green-700' : percentage >= 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${percentage}%</td>`;
            
            // Display status for each particular
            for (let i = 1; i <= totalCount; i++) {
              const status = row ? (row[`Status_${i}`] || '-') : '-';
              const statusLower = status.toString().toLowerCase();
              let bgColor = 'bg-gray-100';
              let textColor = 'text-gray-600';
              
              if (statusLower === 'completed' || statusLower === 'completed and updated') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-700';
              } else if (statusLower === 'in progress') {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-700';
              } else if (statusLower === 'not applicable' || statusLower === 'na' || statusLower === 'n/a') {
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-500';
              } else if (statusLower !== '-') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-700';
              }
              
              html += `<td class="px-2 py-2 ${bgColor} ${textColor} text-center font-medium">${status}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }
        document.getElementById('dashboardTableContainer').innerHTML = html || '<div class="text-gray-500">No yearly data found.</div>';
        
        // Attach export buttons after table is rendered
        attachExportButtons();
        
        // Load department portfolios table
        loadDepartmentPortfoliosIQAC();
      })();
    }
    document.getElementById('designationFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    
    // Modal function for viewing yearly form details
    async function viewYearlyFacultyForm(designation, facultyName, department) {
      document.getElementById('viewFormModal').classList.remove('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      
      let tableName = '';
      if (designation === 'AP') tableName = 'AP(Yearly)';
      else if (designation === 'ASP') tableName = 'ASP(Yearly)';
      else if (designation === 'Prof') tableName = 'Prof(Yearly)';
      else {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq('Department', department)
        .order('input_id', { ascending: false });
      
      if (error || !data || data.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      
      const nameTrimmed = (facultyName || '').toString().trim().toLowerCase();
      let filtered = data.filter(row => {
        let rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        return rowName === nameTrimmed;
      });
      
      if (filtered.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">No form data found for this faculty name.</div>';
        return;
      }
      
      const row = filtered[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-purple-700">Department:</div>
        <div class="mb-2">${row['Department'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
        <div class="font-semibold text-purple-700">Month:</div>
        <div class="mb-2">${row['Month'] || ''}</div>
      </div>`;
      
      // Item descriptions for each designation
      let items = [];
      if (designation === 'AP') {
        items = [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body'
        ];
      } else if (designation === 'ASP') {
        items = [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in Consultancy.',
          'Membership in professional body'
        ];
      } else if (designation === 'Prof') {
        items = [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate MoU',
          'Engage in Consultancy.',
          'Membership in professional body'
        ];
      }
      
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= items.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          if (uploadVal.startsWith('http')) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="text-blue-600 underline">View File</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-purple-700">${i}. ${items[i-1]}</div>
          <div class="grid grid-cols-3 gap-2 mt-1 text-sm">
            <div><span class="font-medium">Status:</span> ${statusVal}</div>
            <div><span class="font-medium">Description:</span> ${descVal}</div>
            <div><span class="font-medium">File:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewFormModalContent').innerHTML = html;
      document.getElementById('viewFormModalTitle').textContent = `${designation} Yearly Form Details`;
    }
    
    function closeViewFormModal() {
      document.getElementById('viewFormModal').classList.add('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '';
      document.getElementById('viewFormModalTitle').textContent = 'Faculty Form Details';
    }

    // NEW: Modal for AP/ASP/Prof status table
    function closeViewStatusFormModal() {
      document.getElementById('viewStatusFormModal').classList.add('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '';
      document.getElementById('viewStatusFormModalTitle').textContent = 'Faculty Portfolio Form Details';
    }

    async function viewStatusFacultyForm(designation, facultyName, department) {
      document.getElementById('viewStatusFormModal').classList.remove('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      let nameField = '';
      let deptField = '';
      if (designation === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
      else if (designation === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else if (designation === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq(deptField, department)
        .eq(nameField, facultyName)
        .order('input_id', { ascending: false });
      if (error || !data || data.length === 0) {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const row = data[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-blue-700">Department:</div>
        <div class="mb-2">${row[deptField] || row['Department:'] || row['Department'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      // Use the same section titles as the first table
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-blue-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-blue-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-blue-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewStatusFormModalContent').innerHTML = html;
      document.getElementById('viewStatusFormModalTitle').textContent = `${designation} Portfolio Form Details`;
    }
    
  loadDepartments().then(loadDashboardTable);
  // NEW: Load status table departments and table
  loadStatusDepartments().then(loadFacultyStatusTable);
  </script>
  <footer class="text-center py-4 mt-8">
    <div class="flex flex-col items-center gap-1">
      <span class="text-gray-400 text-sm">&copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br></span>
      <span class="text-gray-400 text-xs">Powered by 
        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
          <img src="../static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
        </a>
      </span>
    </div>
  </footer>
</body>
</html>
