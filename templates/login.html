<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FWAPMS - PMC Tech Login</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    // Auto-redirect if already logged in as HR (check with server)
    document.addEventListener('DOMContentLoaded', async function() {
      const role = localStorage.getItem('role');
      if (role === 'HR') {
        // Check with server if session is valid for HR
        try {
          const resp = await fetch('/session-check', { credentials: 'include' });
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.authenticated && data.role === 'HR') {
              window.location.href = 'hr.html';
              return;
            }
          }
        } catch (e) {}
        // If not authenticated, clear localStorage and stay on login
        localStorage.removeItem('role');
        localStorage.removeItem('email');
      }
    });
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pmcPurple: '#6a2c91',
            pmcPurpleDark: '#501e73',
            pmcBg: '#1a0d2e',
            fwapmsBlue: '#00b4d8',
            fwapmsGreen: '#06ffa5',
          },
        },
      },
    }
  </script>

  <!-- Supabase JS SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .role-btn {
      transition: all 0.3s ease;
    }
    .role-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    }
    .responsive-logo {
      max-width: 100%;
      height: auto;
      width: clamp(150px, 40vw, 300px);
    }
    @media (max-width: 768px) {
      .responsive-logo {
        width: clamp(120px, 50vw, 200px);
      }
    }
    .compact-form {
      max-width: 350px;
    }
    @media (max-width: 640px) {
      .compact-form {
        max-width: 300px;
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col ">

  <!-- Main Content -->
  <div class="flex-1 flex items-center justify-center p-4">
    <!-- Main Container -->
    <div class="w-full max-w-6xl mx-auto px-2">
      <!-- Logo Section - Centered at top on mobile, left side on desktop -->
      <div class="logo-container lg:hidden mb-6">
        <img src="/static/img/login logo.png" alt="PMC Tech FWAPMS Logo" class="responsive-logo">
      </div>
      
      <div class="grid lg:grid-cols-2 gap-6 lg:gap-8 items-center">
        <!-- Left Side - Branding (Hidden on mobile, shown on desktop) -->
        <div class="hidden lg:block text-white space-y-6">
          <!-- Logo for Desktop -->
          <div class="flex justify-center lg:justify-start">
            <img src="/static/img/login logo.png" alt="PMC Tech FWAPMS Logo" class="w-full max-w-md">
          </div>
        </div>

        <!-- Right Side - Login Form -->
        <div class="glass-effect bg-gray-300 rounded-xl p-4 sm:p-6 w-full compact-form mx-auto">
          {% if already_logged_in %}
            <div class="text-center">
              <h2 class="text-xl font-bold text-white mb-4">You are already logged in.</h2>
              <a href="/logout" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 shadow text-sm">Logout</a>
            </div>
          {% else %}
            <h2 id="login-title" class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center">LOGIN</h2>
            
            <!-- Role buttons in responsive grid -->
            <div class="grid grid-cols-2 gap-1.5 sm:gap-2 mb-4 sm:mb-6">
              <button type="button" data-role="ADMIN"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700 transition shadow border-2 border-red-700 text-xs">
                <i class="fas fa-shield-alt mr-1"></i>Admin
              </button>
              <button type="button" data-role="MANAGEMENT"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs">Management</button>
              <button type="button" data-role="PRINCIPAL"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs">Principal</button>
              <button type="button" data-role="HR"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs">HR</button>
              <button type="button" data-role="IQAC"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs">IQAC</button>
              <button type="button" data-role="HOD"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs">HOD</button>
              <button type="button" data-role="FACULTY"
                class="role-btn px-2 sm:px-3 py-1.5 sm:py-2 rounded-md font-semibold bg-purple-600 text-white hover:bg-purple-700 transition shadow text-xs col-span-2">Faculty</button>
            </div>
            
            <!-- Login form -->
            <form id="login-form" class="space-y-3">
              <input
                type="email"
                id="email"
                placeholder="Enter your email"
                required
                class="w-full p-2.5 sm:p-3 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
              />
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  placeholder="Password"
                  required
                  class="w-full p-2.5 sm:p-3 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent pr-10 text-sm"
                />
                <span
                  id="toggle-password"
                  class="absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer text-white/60 hover:text-white text-base"
                  title="Show/Hide Password"
                >üëÅ</span>
              </div>
              
              <!-- Department select (only for HOD & FACULTY) -->
              <div id="department-select-container" style="display:none;">
                <select
                  id="department-select"
                  class="w-full p-2.5 sm:p-3 bg-white/10 border border-white/20 rounded-md text-black focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
                >
                  <option value="" disabled selected>Select Department</option>
                  <option value="AERO">AERO</option>
                  <option value="AIDS">AIDS</option>
                  <option value="AIML">AIML</option>
                  <option value="CHEM">CHEM</option>
                  <option value="CIVIL">CIVIL</option>
                  <option value="CSBS">CSBS</option>
                  <option value="CSE">CSE</option>
                  <option value="ECE">ECE</option>
                  <option value="EEE">EEE</option>
                  <option value="IT">IT</option>
                  <option value="MBA">MBA</option>
                  <option value="MCA">MCA</option>
                  <option value="MCO">MCO</option>
                  <option value="MECH">MECH</option>
                  <option value="S&H V1">S&H V1</option>
                  <option value="S&H V2">S&H V2</option>
                  <option value="S&H V3">S&H V3</option>
                  <option value="S&H V4">S&H V4</option>
                  <option value="S&H V5">S&H V5</option>
                  <option value="S&H V6">S&H V6</option>
                </select>
              </div>
              
              <button
                type="submit"
                id="login-btn"
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-2.5 sm:py-3 rounded-md transition-all duration-200 shadow-lg text-sm"
              >Login</button>
            </form>
            
            <!-- For queries link -->
            <div class="text-center mt-3 sm:mt-4">
              <a href="queries-form.html" target="_blank" class="text-black-300 hover:text-blue-200 font-medium transition-colors text-xs">For any queries</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://cbhodgwaazmjszkujrti.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU";

    // IMPORTANT: If your tables were created with quoted, CamelCase names ("Faculty","HOD"),
    // always reference them quoted in supabase-js: .from('"HOD"') / .from('"Faculty"')
    const TABLE_FACULTY = 'Faculty';
    const TABLE_HOD = 'HOD';
    const TABLE_ADMIN = 'Admin';

    // ====== STATE ======
    let selectedRole = null;

    // ====== INIT ======
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Role buttons
    document.querySelectorAll(".role-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const role = btn.getAttribute("data-role");
        setRole(role);
      });
    });

    function setRole(role) {
      selectedRole = role;
  document.getElementById('login-title').textContent = `LOGIN - ${role}`;
      const deptContainer = document.getElementById('department-select-container');
      if (role === 'HOD' || role === 'FACULTY') {
        deptContainer.style.display = '';
      } else {
        deptContainer.style.display = 'none';
      }
    }

    // Toggle password
    document.getElementById('toggle-password').addEventListener('click', () => {
      const pwd = document.getElementById('password');
      if (pwd) pwd.type = pwd.type === 'password' ? 'text' : 'password';
    });

    // ====== LOGIN HANDLER ======
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedRole) {
        alert('Please select a role before logging in.');
        return;
      }

      const email = (document.getElementById('email').value || '').trim();
      const password = (document.getElementById('password').value || '').trim();
      const departmentSelect = document.getElementById('department-select');
      const department = (departmentSelect && departmentSelect.value) ? departmentSelect.value : '';

      // HOD / FACULTY require department
      if ((selectedRole === 'HOD' || selectedRole === 'FACULTY') && !department) {
        alert('Please select a department.');
        return;
      }

      // Disable button during request
      const loginBtn = document.getElementById('login-btn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Checking...';

      try {
        if (selectedRole === 'HOD' || selectedRole === 'FACULTY') {
          const table = selectedRole === 'HOD' ? TABLE_HOD : TABLE_FACULTY;
          // For S&H V1-V4, match department exactly
          const { data, error } = await supabaseClient
            .from(table)
            .select('*')
            .eq('department', department)
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials or department.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              department: department,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('department', department);
          localStorage.setItem('email', email);
          if (selectedRole === 'HOD') {
            window.location.href = 'hod.html?as=hod';
          } else {
            window.location.href = 'faculty-profile.html?email=' + encodeURIComponent(email);
          }
          return;
        }

        // Management authentication
        if (selectedRole === 'MANAGEMENT') {
          const { data, error } = await supabaseClient
            .from('Management')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'management.html';
          return;
        }

        // Principal authentication
        if (selectedRole === 'PRINCIPAL') {
          const { data, error } = await supabaseClient
            .from('Principal')
            .select('*')
            .eq('Email', email)
            .eq('Password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'principal.html';
          return;
        }

        // HR authentication
        if (selectedRole === 'HR') {
          const { data, error } = await supabaseClient
            .from('HR')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          // Ensure session/cookie is set by waiting for the fetch to complete
          const resp = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          // If server responds with a redirect, follow it
          if (resp.redirected) {
            window.location.href = resp.url;
          } else {
            window.location.href = 'hr.html';
          }
          return;
        }
        
        // IQAC authentication
        if (selectedRole === 'IQAC') {
          const { data, error } = await supabaseClient
            .from('IQAC')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'iqac.html';
          return;
        }
        // Admin authentication
        if (selectedRole === 'ADMIN') {
          const { data, error } = await supabaseClient
            .from(TABLE_ADMIN)
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('is_active', true)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid admin credentials or account is inactive.');
            return;
          }
          // Update last_login timestamp
          await supabaseClient
            .from(TABLE_ADMIN)
            .update({ last_login: new Date().toISOString() })
            .eq('id', data.id);
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          localStorage.setItem('adminName', data.name || 'Administrator');
          localStorage.setItem('adminDepartment', data.department || 'ADMINISTRATION');
          // Check for ?next=admin-queries.html in URL
          const params = new URLSearchParams(window.location.search);
          if (params.get('next') === 'admin-queries.html') {
            window.location.href = '/admin-queries.html';
          } else {
            window.location.href = 'admin-dashboard.html';
          }
          return;
        }
      } catch (err) {
        console.error('[Login] Unexpected error:', err);
        alert('Unexpected error. Check the console for details.');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });
  </script>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-gray-100 to-gray-300 backdrop-blur-sm py-2">
    <div class="text-center px-4">
      <p class="text-xs text-gray-700">
        &copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline text-blue-600 hover:text-blue-800">PMC TECH</a>
      </p>
      <div class="flex items-center justify-center gap-1 mt-1">
        <span class="text-xs text-gray-600">Powered by</span>
        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
          <img src="/static/img/zeony logo.png" alt="Zeony Technologies" class="h-8 w-13 object-contain"/>
        </a>
      </div>
      <span class="text-xs text-gray-600 t">A Student driven Software!</span>
    </div>
  </footer>
</body>
</html>