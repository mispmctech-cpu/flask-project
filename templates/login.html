<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PMC Tech Login</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pmcPurple: '#6a2c91',
            pmcPurpleDark: '#501e73',
            pmcBg: '#f6f4f8',
          },
        },
      },
    }
  </script>

  <!-- Supabase JS SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body class="bg-pmcBg min-h-screen flex flex-col items-center justify-center">

  <!-- Logo -->
  <div class="flex flex-col items-center mt-8 mb-4">
    <img
      src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3"
      alt="PMC Tech Logo"
      class="h-16 md:h-20 mb-2 rounded shadow"
    />
    <h1 class="text-2xl md:text-3xl font-bold text-pmcPurple text-center leading-tight">
      Er. PERUMAL MANIMEKALAI<br/>COLLEGE OF ENGINEERING
    </h1>
    <h2 class="text-lg text-pmcPurpleDark font-semibold text-center">(An Autonomous Institution)</h2>
  </div>

  <!-- Login Card -->
  <div class="bg-white rounded-xl shadow-lg px-8 py-8 w-full max-w-md flex flex-col items-center">
    {% if already_logged_in %}
      <h2 class="text-2xl font-bold text-pmcPurple mb-6">You are already logged in.</h2>
      <a href="/logout" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow mt-4">Logout</a>
    {% else %}
      <h2 id="login-title" class="text-2xl font-bold text-pmcPurple mb-6">LOGIN</h2>
      <!-- Role buttons -->
      <div class="flex flex-row flex-wrap gap-4 justify-center mb-8 w-full">
        <button type="button" data-role="ADMIN"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 transition w-36 shadow border-2 border-red-700">
          <i class="fas fa-shield-alt mr-1"></i>Admin
        </button>
        <button type="button" data-role="MANAGEMENT"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-pmcPurple text-white hover:bg-orange-500 transition w-36 shadow">Management</button>
        <button type="button" data-role="PRINCIPAL"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-pmcPurple text-white hover:bg-orange-500 transition w-36 shadow">Principal</button>
        <button type="button" data-role="IQAC"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-pmcPurple text-white hover:bg-orange-500 transition w-36 shadow">IQAC/HR</button>
        <button type="button" data-role="HOD"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-pmcPurple text-white hover:bg-orange-500 transition w-36 shadow">HOD</button>
        <button type="button" data-role="FACULTY"
          class="role-btn px-6 py-3 rounded-lg font-semibold bg-pmcPurple text-white hover:bg-orange-500 transition w-36 shadow">Faculty</button>
      </div>
      <!-- Login form -->
      <form id="login-form" class="flex flex-col gap-4 w-full">
        <input
          type="email"
          id="email"
          placeholder="Enter your email"
          required
          class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pmcPurple"
        />
        <div class="relative">
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
            class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pmcPurple w-full pr-10"
          />
          <span
            id="toggle-password"
            class="absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer text-xl text-gray-400 hover:text-pmcPurple"
            title="Show/Hide Password"
          >üëÅ</span>
        </div>
        <!-- Department select (only for HOD & FACULTY) -->
        <div id="department-select-container" style="display:none;">
          <select
            id="department-select"
            class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pmcPurple w-full mt-2"
          >
            <option value="">Select Department</option>
            <option value="AERO">AERO</option>
            <option value="AIDS">AIDS</option>
            <option value="AIML">AIML</option>
            <option value="CHEM">CHEM</option>
            <option value="CIVIL">CIVIL</option>
            <option value="CSBS">CSBS</option>
            <option value="CSE">CSE</option>
            <option value="ECE">ECE</option>
            <option value="EEE">EEE</option>
            <option value="IT">IT</option>
            <option value="MBA">MBA</option>
            <option value="MCA">MCA</option>
            <option value="MCO">MCO</option>
            <option value="MECH">MECH</option>
            <option value="S&H V1">S&H V1</option>
            <option value="S&H V2">S&H V2</option>
            <option value="S&H V3">S&H V3</option>
            <option value="S&H V4">S&H V4</option>
          </select>
        </div>
        <button
          type="submit"
          id="login-btn"
          class="bg-pmcPurple hover:bg-green-500 text-white font-semibold py-3 rounded-lg transition-colors duration-200 shadow"
        >Login</button>
      </form>
    {% endif %}
  </div>

  <!-- Nav buttons -->
  <div class="fixed bottom-6 right-6 flex gap-3 z-50">
    <button onclick="history.back()" aria-label="Back"
      class="bg-pmcPurple hover:bg-pmcPurpleDark text-white rounded-full shadow-lg p-3 flex items-center justify-center text-2xl transition">
      &#8592;
    </button>
    <button onclick="history.forward()" aria-label="Forward"
      class="bg-pmcPurple hover:bg-pmcPurpleDark text-white rounded-full shadow-lg p-3 flex items-center justify-center text-2xl transition">
      &#8594;
    </button>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://cbhodgwaazmjszkujrti.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU";

    // IMPORTANT: If your tables were created with quoted, CamelCase names ("Faculty","HOD"),
    // always reference them *quoted* in supabase-js: .from('"HOD"') / .from('"Faculty"')
    const TABLE_FACULTY = 'Faculty';
    const TABLE_HOD = 'HOD';
    const TABLE_ADMIN = 'Admin';

    // ====== STATE ======
    let selectedRole = null;

    // ====== INIT ======
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Role buttons
    document.querySelectorAll(".role-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const role = btn.getAttribute("data-role");
        setRole(role);
      });
    });

    function setRole(role) {
      selectedRole = role;
      document.getElementById('login-title').textContent = `LOGIN - ${role}`;
      const deptContainer = document.getElementById('department-select-container');
      if (role === 'HOD' || role === 'FACULTY') {
        deptContainer.style.display = '';
      } else {
        deptContainer.style.display = 'none';
      }
    }

    // Toggle password
    document.getElementById('toggle-password').addEventListener('click', () => {
      const pwd = document.getElementById('password');
      if (pwd) pwd.type = pwd.type === 'password' ? 'text' : 'password';
    });

    // ====== LOGIN HANDLER ======
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedRole) {
        alert('Please select a role before logging in.');
        return;
      }

      const email = (document.getElementById('email').value || '').trim();
      const password = (document.getElementById('password').value || '').trim();
      const departmentSelect = document.getElementById('department-select');
      const department = (departmentSelect && departmentSelect.value) ? departmentSelect.value : '';

      // HOD / FACULTY require department
      if ((selectedRole === 'HOD' || selectedRole === 'FACULTY') && !department) {
        alert('Please select a department.');
        return;
      }

      // Disable button during request
      const loginBtn = document.getElementById('login-btn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Checking...';

      try {
        if (selectedRole === 'HOD' || selectedRole === 'FACULTY') {
          const table = selectedRole === 'HOD' ? TABLE_HOD : TABLE_FACULTY;
          // For S&H V1-V4, match department exactly
          const { data, error } = await supabaseClient
            .from(table)
            .select('*')
            .eq('department', department)
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials or department.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              department: department,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('department', department);
          localStorage.setItem('email', email);
          if (selectedRole === 'HOD') {
            window.location.href = 'hod.html?as=hod';
          } else {
            window.location.href = 'faculty-profile.html?email=' + encodeURIComponent(email);
          }
          return;
        }

        // Management authentication
        if (selectedRole === 'MANAGEMENT') {
          const { data, error } = await supabaseClient
            .from('Management')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'management.html';
          return;
        }

        // Principal authentication
        if (selectedRole === 'PRINCIPAL') {
          const { data, error } = await supabaseClient
            .from('Principal')
            .select('*')
            .eq('Email', email)
            .eq('Password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'principal.html';
          return;
        }

        // IQAC authentication
        if (selectedRole === 'IQAC') {
          const { data, error } = await supabaseClient
            .from('IQAC')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid credentials.');
            return;
          }
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          window.location.href = 'iqac.html';
          return;
        }

        // Admin authentication
        if (selectedRole === 'ADMIN') {
          const { data, error } = await supabaseClient
            .from(TABLE_ADMIN)
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('is_active', true)
            .maybeSingle();
          if (error) {
            alert('Login failed: ' + (error.message || 'Unknown error'));
            return;
          }
          if (!data) {
            alert('Invalid admin credentials or account is inactive.');
            return;
          }
          
          // Update last_login timestamp
          await supabaseClient
            .from(TABLE_ADMIN)
            .update({ last_login: new Date().toISOString() })
            .eq('id', data.id);
            
          await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              role: selectedRole,
              email: email
            })
          });
          localStorage.setItem('role', selectedRole);
          localStorage.setItem('email', email);
          localStorage.setItem('adminName', data.name || 'Administrator');
          localStorage.setItem('adminDepartment', data.department || 'ADMINISTRATION');
          window.location.href = 'admin-dashboard.html';
          return;
        }
      } catch (err) {
        console.error('[Login] Unexpected error:', err);
        alert('Unexpected error. Check the console for details.');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });
  </script>

  <!-- Footer -->
  <footer class="text-center py-4 mt-8">
    <p class="text-gray-400 text-sm">
      &copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="text-gray-400 hover:text-gray-600 underline">PMC TECH</a>, IV CSE 2022-2026.<br>

    </p>
  </footer>
</body>
</html>
