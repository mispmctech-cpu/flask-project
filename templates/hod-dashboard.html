<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOD Dashboard - Faculty Core Scope Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    .star-rating {
      font-size: 18px;
      color: #FFD700;
      white-space: nowrap;
    }
    .star-rating .shining {
      animation: shine 1.5s infinite;
      font-size: 20px;
      display: inline-block;
    }
    @keyframes shine {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
    .rating-excellent { color: #10b981; font-weight: 600; }
    .rating-good { color: #3b82f6; font-weight: 600; }
    .rating-average { color: #f59e0b; font-weight: 600; }
    .rating-poor { color: #ef4444; font-weight: 600; }
  </style>
</head>
<body class="bg-pmcBg min-h-screen">
  <header class="bg-purple-700 text-white w-full">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 rounded shadow bg-white p-1" />
        <span class="ml-4 text-xl font-bold">HOD Dashboard</span>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h2 class="text-2xl font-bold text-purple-700 mb-6">Faculty Mandatory Scope - Yearly</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="designationFilter" class="font-medium text-purple-700 mr-2">Filter by Designation:</label>
      <select id="designationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
      <label for="yearlyMonthFilter" class="font-medium text-purple-700 mr-2">Month:</label>
      <select id="yearlyMonthFilter" class="p-2 border rounded">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>
    </div>
    <div id="dashboardTableContainer" class="overflow-x-auto"></div>
    <!-- Modal for viewing Yearly form details from dashboard table -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>

    <!-- NEW: Faculty Core Scope - Monthly Table -->
    <h2 class="text-2xl font-bold text-green-700 mt-12 mb-6">Faculty Core Scope - Monthly</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="coreScopeDesignationFilter" class="font-medium text-green-700 mr-2">Filter by Designation:</label>
      <select id="coreScopeDesignationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">AP</option>
        <option value="ASP">ASP</option>
        <option value="Prof">Prof</option>
      </select>
      <label for="coreScopeMonthFilter" class="font-medium text-green-700 mr-2">Month:</label>
      <select id="coreScopeMonthFilter" class="p-2 border rounded">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>
    </div>
    <div id="coreScopeTableContainer" class="overflow-x-auto"></div>
  <!-- Department Portfolios Table -->
  <h2 class="text-2xl font-bold text-orange-700 mt-12 mb-6">Department Portfolios</h2>
  <div id="departmentPortfoliosStickyHeader" class="flex flex-wrap gap-4 items-center mb-4 bg-white z-20" style="position:sticky; top:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
    <label for="portfolioMonthFilter" class="font-medium text-orange-700 mr-2">Month:</label>
    <select id="portfolioMonthFilter" class="p-2 border rounded">
      <option value="January">January</option>
      <option value="February">February</option>
      <option value="March">March</option>
      <option value="April">April</option>
      <option value="May">May</option>
      <option value="June">June</option>
      <option value="July">July</option>
      <option value="August">August</option>
      <option value="September">September</option>
      <option value="October">October</option>
      <option value="November">November</option>
      <option value="December">December</option>
    </select>
    <label for="portfolioStatusFilter" class="font-medium text-orange-700 mr-2">Show:</label>
    <select id="portfolioStatusFilter" class="p-2 border rounded">
      <option value="All">All</option>
      <option value="Completed">Completed</option>
      <option value="Pending">Pending</option>
    </select>
  </div>
  <div id="departmentPortfoliosContainer" class="overflow-x-auto mt-2"></div>

  <!-- NEW: Consolidated Summary Table -->
  <h2 class="text-2xl font-bold text-blue-700 mt-12 mb-6">Consolidated Faculty Performance Summary</h2>
  <div class="mb-6 flex flex-wrap gap-4 items-center">
    <label for="summaryMonthFilter" class="font-medium text-blue-700 mr-2">Month:</label>
    <select id="summaryMonthFilter" class="p-2 border rounded">
      <option value="January">January</option>
      <option value="February">February</option>
      <option value="March">March</option>
      <option value="April">April</option>
      <option value="May">May</option>
      <option value="June">June</option>
      <option value="July">July</option>
      <option value="August">August</option>
      <option value="September">September</option>
      <option value="October">October</option>
      <option value="November">November</option>
      <option value="December">December</option>
    </select>
    <button id="exportSummaryTableBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export summary table to Excel">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
      Export Summary Table
    </button>
    <button id="exportSummaryTablePdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow flex items-center gap-2" title="Export summary table to PDF">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
      Export Summary PDF
    </button>
  </div>
  <div id="summaryTableContainer" class="overflow-x-auto"></div>

    <!-- Modal for viewing original form -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>

    <!-- Modal for selecting faculty for PDF export -->
    <div id="facultySelectionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeFacultySelectionModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 class="text-xl font-bold mb-4 text-blue-700">Select Faculty for PDF Export</h3>
        <div class="flex gap-2 mb-4">
          <button onclick="selectAllFacultyInModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
            Select All
          </button>
          <button onclick="deselectAllFacultyInModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
            Deselect All
          </button>
        </div>
        <div id="facultySelectionList" class="max-h-96 overflow-y-auto border border-gray-300 rounded p-4 mb-4"></div>
        <div class="flex justify-end gap-3">
          <button onclick="closeFacultySelectionModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded">
            Cancel
          </button>
          <button onclick="confirmFacultySelectionAndExport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
            Confirm & Export
          </button>
        </div>
      </div>
    </div>
  </main>
  <script src="/static/javascript/form-modal-mapper.js"></script>
  <script>
    // Initialize Supabase client first
    const supabaseClient = window.supabase.createClient(
      "https://cbhodgwaazmjszkujrti.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    
    // Get department from query param or localStorage
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const departmentParam = getQueryParam('department');
    const department = departmentParam || localStorage.getItem('department') || '';
    
    function closeViewStatusFormModal() {
      document.getElementById('viewStatusFormModal').classList.add('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '';
      document.getElementById('viewStatusFormModalTitle').textContent = 'Faculty Portfolio Form Details';
    }

    async function viewStatusFacultyForm(designation, facultyName, department) {
      document.getElementById('viewStatusFormModal').classList.remove('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      let nameField = '';
      let deptField = '';
      if (designation === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
      else if (designation === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else if (designation === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq(deptField, department)
        .eq(nameField, facultyName)
        .order('input_id', { ascending: false });
      if (error || !data || data.length === 0) {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const row = data[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-blue-700">Department:</div>
        <div class="mb-2">${row[deptField] || row['Department:'] || row['Department'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Board of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Board of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-blue-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-blue-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-blue-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewStatusFormModalContent').innerHTML = html;
      document.getElementById('viewStatusFormModalTitle').textContent = `${designation} Portfolio Form Details`;
    }
    // --- NEW: Faculty Core Scope - Monthly Table from Core_scope table ---
    let selectedCoreScopeDesignation = 'All';
    let selectedCoreScopeMonth = 'January';
    
    document.getElementById('coreScopeDesignationFilter').addEventListener('change', () => {
      selectedCoreScopeDesignation = document.getElementById('coreScopeDesignationFilter').value;
      loadCoreScopeTable();
    });
    
    document.getElementById('coreScopeMonthFilter').addEventListener('change', () => {
      selectedCoreScopeMonth = document.getElementById('coreScopeMonthFilter').value;
      loadCoreScopeTable();
    });
    
    async function loadCoreScopeTable() {
      if (!department) {
        document.getElementById('coreScopeTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      
      // Fetch faculty from Faculty table for current department
      let facultyQuery = supabaseClient.from('Faculty').select('*').eq('department', department);
      const { data: facultyList, error: facErr } = await facultyQuery;
      if (facErr || !facultyList || facultyList.length === 0) {
        document.getElementById('coreScopeTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      
      // Fetch Core_scope data - filter by department and month
      let coreScopeQuery = supabaseClient.from('Core_scope').select('*').eq('Month', selectedCoreScopeMonth).eq('Department', department);
      const { data: coreScopeData, error: csErr } = await coreScopeQuery;
      
      // Core Scope field labels (15 fields) - Full descriptions from faculty-core-scope.html
      const coreScopeLabels = [
        'Teaching & Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching & Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching & Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching & Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship & Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship & Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship & Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship & Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship & Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Present at conferences.',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Board of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.'
      ];
      
      // Shorter labels for table headers
      const coreScopeShortLabels = [
        'Design and deliver lectures and lab sessions',
            'Develop course materials, lesson plans and assessments ',
            'Incorporating innovative teaching methods including ICT tools ',
            'Prepare Product model and instructional Chart ',
            'Mentoring 30 students on coursework, projects and career planning.',
            'Monitoring student attendance, performance, and well-being.',
            'Provide remedial support and encourage participation in co-curricular and extra- curricular activities.',
            'Maintain the Mentor book for assigned mentee.',
            'Consolidate innovative course material & Lab manuals ',
            'Participate in curriculum development and revision through BOS',
            'Contribute to accreditation processes (NBA, NAAC) and quality Assurance initiatives.',
            'Serve on academic and administrative committees.',
            'Assist in exam duties, QP setting, Invigilation and evaluation.',
            'Submit the FPBA (Faculty performance Based Appraisal) with the documents',
            'Library Utilization'
   
      ];
      
      // Filter faculty by designation if needed
      let filteredFacultyList = facultyList;
      if (selectedCoreScopeDesignation !== 'All') {
        filteredFacultyList = facultyList.filter(fac => {
          const desig = (fac.Designation || '').toUpperCase();
          if (selectedCoreScopeDesignation === 'AP') return desig === 'AP' || desig === 'ASSISTANT PROFESSOR';
          if (selectedCoreScopeDesignation === 'ASP') return desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR';
          if (selectedCoreScopeDesignation === 'Prof') return desig === 'PROF' || desig === 'PROFESSOR';
          return false;
        });
      }
      
      let html = '';
      
      if (filteredFacultyList.length === 0) {
        document.getElementById('coreScopeTableContainer').innerHTML = '<div class="text-gray-500">No faculty data found.</div>';
        return;
      }
      
      // Single table header with Designation column - wrapped in scrolling container
      html += `<div class="overflow-auto mb-6 border rounded-lg shadow-sm" style="max-height: 600px;"><table class="min-w-full text-xs bg-white" style="table-layout: auto;"><thead class="bg-green-700 text-white sticky top-0 z-20"><tr>`;
      html += `<th class="px-3 py-2 sticky left-0 bg-green-700 z-30" style="min-width: 150px;">Department</th>`;
      html += `<th class="px-3 py-2 bg-green-700" style="min-width: 120px;">Designation</th>`;
      html += `<th class="px-3 py-2" style="min-width: 180px;">Faculty Name</th>`;
      html += `<th class="px-3 py-2" style="min-width: 100px;">Percentage</th>`;
      html += `<th class="px-3 py-2" style="min-width: 120px;">Verification</th>`;
      
      // Add columns for all 15 status fields with full descriptions as tooltips
      for (let i = 0; i < 15; i++) {
        html += `<th class="px-2 py-2" style="min-width: 120px;" title="${coreScopeLabels[i]}">${coreScopeShortLabels[i]}</th>`;
      }
      
      html += `</tr></thead><tbody>`;
      
      // Fetch both Hod-workdone and hod-workdone_reject data
      const [verifyRes, rejectRes] = await Promise.all([
        supabaseClient.from('Hod-workdone').select('*'),
        supabaseClient.from('hod-workdone_reject').select('*')
      ]);
      const verifyDataMap = verifyRes.data || [];
      const rejectDataMap = rejectRes.data || [];
      
      // Process each faculty
      let facultyIndex = 0;
      for (const fac of filteredFacultyList) {
        facultyIndex++;
        const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
        const dept = fac.department || department;
        const designation = fac.Designation || 'N/A';
        
        // Normalize designation for display - trim to remove whitespace and special characters
        let desigDisplay = designation;
        const desigUpper = designation.toString().trim().toUpperCase();
        if (desigUpper === 'ASSISTANT PROFESSOR') desigDisplay = 'AP';
        else if (desigUpper === 'ASSOCIATE PROFESSOR') desigDisplay = 'ASP';
        else if (desigUpper === 'PROFESSOR') desigDisplay = 'Prof';
        
        // Find matching Core_scope data for this faculty
        let facNamesToTry = [];
        if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
        if (fac.Name) facNamesToTry.push(fac.Name);
        if (fac.email) facNamesToTry.push(fac.email);
        facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
        
        let matchingRows = [];
        if (coreScopeData && coreScopeData.length > 0) {
          matchingRows = coreScopeData.filter(row => {
            const rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
            return facNamesToTry.includes(rowName);
          });
        }
        
        // Get the latest row (by input_id)
        let row = null;
        if (matchingRows.length > 0) {
          matchingRows.sort((a, b) => (b.input_id || 0) - (a.input_id || 0));
          row = matchingRows[0];
        }
        
        // Calculate percentage (fixed denominator: 15)
        let completedCount = 0;
        const totalCount = 15;
        
        if (row) {
          for (let i = 1; i <= 15; i++) {
            const statusVal = (row[`Status_${i}`] || '').toString().trim().toLowerCase();
            if (statusVal === 'completed' || statusVal === 'completed and updated') {
              completedCount++;
            }
            // All statuses (including 'Not Applicable') are included in denominator
          }
        }
        
        const percentage = Math.round((completedCount / totalCount) * 100);
        const percentageDisplay = row ? `${percentage}%` : '0% (Not Submitted)';
        const percentageClass = row ? (percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600') : 'text-red-600';
        
        // Check verification in Hod-workdone table
        const coreScopeRowId = `corescope-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
        const coreScopePercentageId = `percentage-${coreScopeRowId}`;
        let verificationMark = '<span class="text-gray-400">-</span>';
        if (row && row.input_id) {
          verificationMark = `<span id="verify-${coreScopeRowId}" class="text-gray-400">...</span>`;
          
          // Async verification check inline
          setTimeout(async () => {
            const { data: verifyData } = await supabaseClient
              .from('Hod-workdone')
              .select('*')
              .eq('department', dept)
              .ilike('portfolio_member_name', facultyName);
            
            const verifyCell = document.getElementById(`verify-${coreScopeRowId}`);
            const percentageCell = document.getElementById(`${coreScopePercentageId}`);
            if (verifyCell) {
              // Try exact match first
              let matchingVerify = verifyData?.find(v => {
                const inputIdMatch = v.input_id === row.input_id;
                const tableNameMatch = v.table_name && v.table_name.toLowerCase().includes('core');
                return inputIdMatch && tableNameMatch;
              });
              
              // If no exact match, try partial
              if (!matchingVerify) {
                matchingVerify = verifyData?.find(v => 
                  (v.table_name && v.table_name.toLowerCase().includes('core')) || 
                  v.input_id === row.input_id
                );
              }
              
              if (matchingVerify) {
                const verifyDate = new Date(matchingVerify.verified_at).toLocaleDateString();
                verifyCell.innerHTML = `<span class="text-green-600 font-bold text-lg" title="Verified by HOD on ${verifyDate}">✓</span>`;
                
                // Update percentage with validation score
                if (percentageCell && matchingVerify.validation_score != null && matchingVerify.validation_score !== '') {
                  const validationScore = parseFloat(matchingVerify.validation_score);
                  if (!isNaN(validationScore)) {
                    const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                    percentageCell.className = `px-3 py-2 border ${percentageClass} font-semibold`;
                    percentageCell.textContent = `${Math.round(validationScore)}%`;
                  }
                }
              } else {
                verifyCell.innerHTML = '<span class="text-red-600 font-bold text-lg" title="Not verified">✗</span>';
              }
            }
          }, 100);
        }
        
        html += `<tr class="hover:bg-gray-50">`;
        html += `<td class="px-3 py-2 border sticky left-0 bg-white z-10 font-medium">${dept}</td>`;
        html += `<td class="px-3 py-2 border font-medium">${desigDisplay}</td>`;
        html += `<td class="px-3 py-2 border font-medium text-green-700">${facultyName}</td>`;
        html += `<td id="${coreScopePercentageId}" class="px-3 py-2 border ${percentageClass} font-semibold">${percentageDisplay}</td>`;
        html += `<td class="px-3 py-2 border text-center">${verificationMark}</td>`;
        
        // Add status cells for all 15 fields
        for (let i = 1; i <= 15; i++) {
          const statusVal = row ? (row[`Status_${i}`] || '-') : '-';
          let display = '-';
          let statusClass = '';
          
          if (row && statusVal && typeof statusVal === 'string') {
            const val = statusVal.trim().toLowerCase();
            if (val === 'completed') {
              display = 'Completed';
              statusClass = 'text-green-600 font-semibold';
            } else if (val === 'in progress' || val === 'inprogress') {
              display = 'In Progress';
              statusClass = 'text-yellow-600 font-semibold';
            } else if (val === 'yet to be completed' || val === 'not started') {
              display = 'Yet to be Completed';
              statusClass = 'text-red-600 font-semibold';
            } else if (val === 'not applicable' || val === 'na') {
              display = 'N/A';
              statusClass = 'text-gray-400';
            } else if (val === '-' || val === '' || val === null) {
              display = '-';
              statusClass = 'text-gray-500';
            } else {
              display = statusVal;
              statusClass = 'text-blue-600 font-semibold';
            }
          } else {
            display = '-';
            statusClass = 'text-gray-500';
          }
          
          html += `<td class="px-2 py-2 border ${statusClass}">${display}</td>`;
        }
        
        html += `</tr>`;
      }
      
      html += `</tbody></table></div>`;
      
      document.getElementById('coreScopeTableContainer').innerHTML = html || '<div class="text-gray-500">No faculty data found.</div>';
    }
    // --- END NEW: Core Scope Table ---
  </script>
  <script>
    // Fetch and render department portfolios table (HOD) - IQAC style
    async function loadDepartmentPortfolios() {
      const currentDept = department;
      if (!currentDept) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      
      // Fetch faculty for current department only
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', currentDept);
      if (error || !data || data.length === 0) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data for this department.</div>';
        return;
      }
      
      // Get month and status filters
      const monthFilter = document.getElementById('portfolioMonthFilter');
      const selectedMonth = monthFilter ? monthFilter.value : 'January';
      const statusFilter = document.getElementById('portfolioStatusFilter');
      const selectedStatus = statusFilter ? statusFilter.value : 'All';
      
      // Portfolio headers (only monthly tables)
      const portfolioHeaders = [
        { label: "1. Training & Placement", table: 'form1-monthly' },
        { label: "2. Class Advisor", table: 'form2-monthly' },
        { label: "3. Info & Contribution", table: 'form3-monthly' },
        { label: "4. Outcome & Exam Cell", table: 'form4-monthly' },
        { label: "5. Continuous Improvement", table: 'form5-monthly' },
        { label: "6. T&L Process (IQAC)", table: 'form6_monthly' },
        { label: "7. Student Support", table: 'form7-monthly' },
        { label: "8. Facilities & Lab", table: 'form8-monthly' }
      ];
      
      // Build table: Department | Designation | Faculty Name | Portfolio Name | Percentage
      let html = '';
      html += '<h3 class="text-xl font-bold text-orange-500 mb-2">Department Portfolios</h3>';
      html += '<div style="overflow-x:auto; max-height:600px; overflow-y:auto; border:1px solid #9ca3af; border-radius:8px;">';
      html += '<table class="w-full text-sm bg-white" style="border-collapse:collapse;">';
      html += '<thead class="bg-orange-100 text-orange-700" style="position:sticky; top:0; z-index:10;">';
      html += '<tr>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:120px;">Department</th>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:100px;">Designation</th>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:180px;">Faculty Name</th>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:200px;">Portfolio Name</th>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:150px;">Percentage</th>';
      html += '<th class="px-3 py-2 border border-gray-400 text-left" style="background:#FEF3C7; min-width:120px;">Verification</th>';
      html += '</tr></thead>';
      html += '<tbody>';
      
      // Build rows: one row per faculty per portfolio
      const tableRows = [];
      for (const fac of data) {
        const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || 'Unknown';
        const designation = fac.Designation || fac.designation || 'N/A';
        
        // Check which portfolios this faculty is assigned to
        for (const h of portfolioHeaders) {
          const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
          const isAssigned = fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes';
          
          if (isAssigned) {
            const rowId = `${currentDept.replace(/[^a-zA-Z0-9]/g, '')}-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            tableRows.push({
              dept: currentDept,
              designation,
              facultyName,
              portfolioName: h.label,
              tableName: h.table,
              formKey,
              rowId
            });
          }
        }
      }
      
      // Sort rows by portfolio number (1-8)
      tableRows.sort((a, b) => {
        const aNum = parseInt(a.portfolioName.match(/^\d+/)?.[0] || '99');
        const bNum = parseInt(b.portfolioName.match(/^\d+/)?.[0] || '99');
        return aNum - bNum;
      });
      
      // Render rows
      for (const row of tableRows) {
        html += `<tr class="hover:bg-gray-50">`;
        html += `<td class="px-3 py-2 border border-gray-400" style="min-width:120px;">${row.dept}</td>`;
        html += `<td class="px-3 py-2 border border-gray-400" style="min-width:100px;">${row.designation}</td>`;
        html += `<td class="px-3 py-2 border border-gray-400" style="min-width:180px;">${row.facultyName}</td>`;
        html += `<td class="px-3 py-2 border border-gray-400" style="min-width:200px;">${row.portfolioName}</td>`;
        html += `<td class="px-3 py-2 border border-gray-400" style="min-width:150px;" id="percent-${row.rowId}">Loading...</td>`;
        html += `<td class="px-3 py-2 border border-gray-400 text-center" id="verify-${row.rowId}" style="min-width:120px;"><span class="text-gray-400">-</span></td>`;
        html += `</tr>`;
      }
      
      html += '</tbody></table></div>';
      document.getElementById('departmentPortfoliosContainer').innerHTML = html;
      
      // Async percentage calculation for each faculty-portfolio combination
      for (const row of tableRows) {
        (async () => {
          let filled = false;
          let percentage = 0;
          let query = supabaseClient.from(row.tableName).select('*').eq('Department', row.dept);
          const { data: formData, error } = await query;
          let bestRow = null;
          if (!error && formData && formData.length > 0) {
            // Robust faculty name matching with month filtering
            const filteredRows = formData.filter(dataRow => {
              const rowName = dataRow['Portfolio Member Name:'] || dataRow['Portfolio Member Name'] || dataRow['Portfolio Memeber Name'] || dataRow['faculty_name'] || dataRow['Faculty Name'] || dataRow['Name'] || '';
              // Check month field (Month, month, or Month:)
              const rowMonth = dataRow['Month'] || dataRow['month'] || dataRow['Month:'] || '';
              const nameMatches = rowName.toString().trim().toLowerCase() === row.facultyName.toString().trim().toLowerCase();
              const monthMatches = rowMonth.toString().trim().toLowerCase() === selectedMonth.toLowerCase();
              return nameMatches && monthMatches;
            });
            if (filteredRows.length > 0) {
              filled = true;
              // Use the latest row (by id or timestamp)
              bestRow = filteredRows.sort((a, b) => (b.id || 0) - (a.id || 0))[0];
            }
          }
          // Calculate percentage if bestRow exists (fixed denominator: 8)
          if (bestRow) {
            let completedCount = 0;
            const totalCount = 8;
            for (let i = 1; i <= totalCount; i++) {
              const val = (bestRow[`Status_${i}`] || '').toString().trim().toLowerCase();
              if (val === 'completed' || val === 'completed and updated') {
                completedCount++;
              }
              // All statuses (including 'Not Applicable') are included in denominator
            }
            percentage = Math.round((completedCount / totalCount) * 100);
          } else {
            percentage = 0;
          }
          
          // Update the percentage cell
          const percentCell = document.getElementById(`percent-${row.rowId}`);
          if (percentCell) {
            // Apply status filter
            if (selectedStatus === 'Completed' && !filled) {
              percentCell.parentElement.style.display = 'none';
              return;
            }
            if (selectedStatus === 'Pending' && filled) {
              percentCell.parentElement.style.display = 'none';
              return;
            }
            
            // Display percentage with color coding
            if (filled) {
              percentCell.innerHTML = `<span class="font-semibold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">${percentage}%</span>`;
            } else {
              percentCell.innerHTML = `<span class="text-red-600 font-semibold">0% (Not Submitted)</span>`;
            }
          }
        
        // Check verification status by matching input_id (most reliable method)
        const verifyCell = document.getElementById(`verify-${row.rowId}`);
        if (verifyCell && bestRow) {
          // Extract form number from table name (e.g., "form2-monthly" -> "form2")
          const formNumber = row.tableName.match(/form\d+/)?.[0] || row.tableName;
          
          // Query Hod-workdone by input_id (most reliable - this field is indexed and never empty)
          try {
            const { data: verifyData, error: verifyErr } = await supabaseClient
              .from('Hod-workdone')
              .select('*')
              .eq('input_id', bestRow.input_id)
              .eq('department', row.dept);
            
            console.log('[Department Portfolios] Query input_id:', bestRow.input_id, 'Found:', verifyData?.length || 0, 'records. Error:', verifyErr?.message || 'none');
            
            if (verifyErr) {
              console.error('[Department Portfolios] Verification query error:', verifyErr);
              verifyCell.innerHTML = '<span class="text-gray-400" title="Query error">-</span>';
              return;
            }
            
            // Find matching validation by input_id and table_name
            const matchingVerify = verifyData?.find(v => {
              const tableNameMatch = v.table_name && v.table_name.toLowerCase().includes(formNumber.toLowerCase());
              const inputIdMatch = v.input_id === bestRow.input_id;
              console.log('[Department Portfolios] Checking record - input_id:', v.input_id, 'table:', v.table_name, 'matches:', inputIdMatch && tableNameMatch);
              return inputIdMatch && tableNameMatch;
            });
            
            if (matchingVerify) {
              console.log('[Department Portfolios] ✓ Validation found for', row.facultyName, 'score:', matchingVerify.validation_score, 'status:', matchingVerify.validation_status);
              const verifyDate = new Date(matchingVerify.verified_at).toLocaleDateString();
              verifyCell.innerHTML = `<span class="text-green-600 font-bold text-lg" title="Verified by HOD on ${verifyDate}">✓</span>`;
              
              // Update percentage with validation score from Hod-workdone if verified
              if (percentCell && matchingVerify.validation_score != null && matchingVerify.validation_score !== '') {
                const validationScore = parseFloat(matchingVerify.validation_score);
                if (!isNaN(validationScore)) {
                  console.log('[Department Portfolios] Updating', formNumber, 'score to:', validationScore + '%');
                  const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                  percentCell.innerHTML = `<span class="font-semibold ${percentageClass}">${Math.round(validationScore)}%</span>`;
                }
              }
            } else {
              console.log('[Department Portfolios] ✗ No validation found for input_id:', bestRow.input_id);
              verifyCell.innerHTML = '<span class="text-red-600 font-bold text-lg" title="Not verified">✗</span>';
            }
          } catch (err) {
            console.error('[Department Portfolios] Error querying Hod-workdone:', err);
            verifyCell.innerHTML = '<span class="text-gray-400" title="Error">-</span>';
          }
        } else if (verifyCell) {
          verifyCell.innerHTML = '<span class="text-gray-400" title="No data submitted">-</span>';
        }
        })();
      }
      
      // Add filter event listeners
      const monthFilterEl = document.getElementById('portfolioMonthFilter');
      const statusFilterEl = document.getElementById('portfolioStatusFilter');
      if (monthFilterEl) monthFilterEl.onchange = () => loadDepartmentPortfolios();
      if (statusFilterEl) statusFilterEl.onchange = () => loadDepartmentPortfolios();
    }
    
    // Fetch all faculty for department
    async function loadDashboardTable() {
      if (!department) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', department);
      if (error || !data || data.length === 0) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      renderDashboardTable(data);
    }
    // Render table for all faculty, grouped by designation
  function renderDashboardTable(facultyList) {
      const designationFilter = document.getElementById('designationFilter').value;
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      // Map particulars for each designation
      const particularsMap = {
        AP: [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body',
          'No of Proposals submitted in Manthan Portal'
        ],
        ASP: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in Consultancy.',
          'Membership in professional body',
          'No of Proposals submitted in Manthan Portal'
        ],
        Prof: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate MoU',
          'Engage in Consultancy.',
          'Membership in professional body',
          'No of Proposals submitted in Manthan Portal'
        ]
      };

      (async function renderDashboardAsync() {
        // Get selected month
        let monthFilter = document.getElementById('yearlyMonthFilter');
        let selectedMonth = monthFilter ? monthFilter.value : 'January';
        
        // Preload all yearly form data for department filtered by month
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('AP(Yearly)').select('*').eq('Department', department).eq('Month', selectedMonth),
          supabaseClient.from('ASP(Yearly)').select('*').eq('Department', department).eq('Month', selectedMonth),
          supabaseClient.from('Prof(Yearly)').select('*').eq('Department', department).eq('Month', selectedMonth)
        ]);
        
        // Create lookup maps for form submissions
        const formDataMaps = {
          AP: {},
          ASP: {},
          Prof: {}
        };
        
        // Build lookup maps: key = facultyName (lowercase), value = latest row
        [
          { designation: 'AP', data: apRes.data || [] },
          { designation: 'ASP', data: aspRes.data || [] },
          { designation: 'Prof', data: profRes.data || [] }
        ].forEach(({ designation, data }) => {
          const grouped = {};
          data.forEach(row => {
            const facultyName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
            if (!grouped[facultyName]) grouped[facultyName] = [];
            grouped[facultyName].push(row);
          });
          
          // Get latest row for each faculty
          Object.keys(grouped).forEach(facultyName => {
            const rows = grouped[facultyName];
            rows.sort((a, b) => (b.input_id || 0) - (a.input_id || 0));
            formDataMaps[designation][facultyName] = rows[0];
          });
        });
        for (const key of ['AP', 'ASP', 'Prof']) {
          if (designationFilter !== 'All' && designationFilter !== key) continue;
          const group = groups[key];
          if (group.length === 0) continue;
          html += `<h3 class="text-xl font-semibold text-purple-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
          const particulars = particularsMap[key];
          html += `<div class="overflow-auto mb-6 border rounded-lg shadow-sm" style="max-height: 600px;"><table class="min-w-full text-sm bg-white"><thead class="bg-purple-700 text-white sticky top-0 z-20"><tr><th class="px-4 py-2 sticky left-0 bg-purple-700 z-30">Department</th><th class="px-4 py-2 bg-purple-700">Designation</th><th class="px-4 py-2 bg-purple-700">Faculty Name</th><th class="px-4 py-2 bg-purple-700">Percentage</th><th class="px-4 py-2 bg-purple-700">Verification</th>`;
          particulars.forEach(particular => {
            html += `<th class="px-4 py-2 bg-purple-700">${particular}</th>`;
          });
          html += `</tr></thead><tbody>`;
          let yearlyRowIndex = 0;
          for (const fac of group) {
            yearlyRowIndex++;
            const yearlyRowId = `yearly-${key}-${yearlyRowIndex}`;
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || '';
            const nameTrimmed = facultyName.toString().trim().toLowerCase();
            const dept = fac.department || department;
            const designation = fac.Designation || key;
            
            // Normalize designation for display - trim to remove whitespace and special characters
            let desigDisplay = designation;
            const desigUpper = designation.toString().trim().toUpperCase();
            if (desigUpper === 'ASSISTANT PROFESSOR') desigDisplay = 'AP';
            else if (desigUpper === 'ASSOCIATE PROFESSOR') desigDisplay = 'ASP';
            else if (desigUpper === 'PROFESSOR') desigDisplay = 'Prof';
            else desigDisplay = key; // fallback to key if not recognized
            
            // Find matching yearly data for this faculty
            const row = formDataMaps[key][nameTrimmed] || null;
            
            // Calculate percentage based on Status fields
            let completedCount = 0;
            let totalCount = key === 'AP' ? 7 : 8; // AP has 7 items, ASP/Prof have 8
            
            if (row) {
              for (let i = 1; i <= totalCount; i++) {
                const status = (row[`Status_${i}`] || '').toString().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount++;
                }
              }
            }
            
            const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            // Check verification in Hod-workdone table
            const rowId = `yearly-${key}-${dept.replace(/[^a-zA-Z0-9]/g, '')}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const percentageId = `percentage-${rowId}`;
            let verificationMark = '<span class="text-gray-400">-</span>';
            if (row && row.input_id) {
              verificationMark = `<span id="verify-${rowId}" class="text-gray-400">...</span>`;
              
              // Async verification check inline
              setTimeout(async () => {
                const { data: verifyData } = await supabaseClient
                  .from('Hod-workdone')
                  .select('*')
                  .eq('department', dept)
                  .ilike('portfolio_member_name', facultyName);
                
                const verifyCell = document.getElementById(`verify-${rowId}`);
                const percentageCell = document.getElementById(`${percentageId}`);
                if (verifyCell) {
                  // Try exact match first
                  let matchingVerify = verifyData?.find(v => {
                    const inputIdMatch = v.input_id === row.input_id;
                    const tableNameMatch = v.table_name && v.table_name.includes(key) && v.table_name.toLowerCase().includes('yearly');
                    return inputIdMatch && tableNameMatch;
                  });
                  
                  // If no exact match, try partial
                  if (!matchingVerify) {
                    matchingVerify = verifyData?.find(v => 
                      (v.table_name && v.table_name.includes(key) && v.table_name.toLowerCase().includes('yearly')) || 
                      v.input_id === row.input_id
                    );
                  }
                  
                  if (matchingVerify) {
                    const verifyDate = new Date(matchingVerify.verified_at).toLocaleDateString();
                    verifyCell.innerHTML = `<span class="text-green-600 font-bold text-lg" title="Verified by HOD on ${verifyDate}">✓</span>`;
                    
                    // Update percentage with validation score
                    if (percentageCell && matchingVerify.validation_score != null && matchingVerify.validation_score !== '') {
                      const validationScore = parseFloat(matchingVerify.validation_score);
                      if (!isNaN(validationScore)) {
                        const bgClass = validationScore >= 70 ? 'bg-green-100 text-green-700' : validationScore >= 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
                        percentageCell.className = `px-2 py-2 border text-center font-bold ${bgClass}`;
                        percentageCell.textContent = `${Math.round(validationScore)}%`;
                      }
                    }
                  } else {
                    verifyCell.innerHTML = '<span class="text-red-600 font-bold text-lg" title="Not verified">✗</span>';
                  }
                }
              }, 100);
            }
            
            html += `<tr class="hover:bg-gray-50"><td class="px-2 py-2 border font-medium sticky left-0 bg-white z-10">${dept}</td>`;
            html += `<td class="px-2 py-2 border font-medium">${desigDisplay}</td>`;
            html += `<td class="px-2 py-2 border font-medium text-purple-700 cursor-pointer underline" onclick="viewYearlyFacultyForm('${key}','${facultyName.replace(/'/g, "\\'")}', '${department.replace(/'/g, "\\'")}')">
                ${facultyName}
            </td>`;
            
            // Percentage column with color coding and ID for validation score updates
            html += `<td id="${percentageId}" class="px-2 py-2 border text-center font-bold ${percentage >= 70 ? 'bg-green-100 text-green-700' : percentage >= 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${percentage}%</td>`;
            
            // Verification column
            html += `<td class="px-2 py-2 border text-center">${verificationMark}</td>`;
            
            // Display each particular's value in order, matching the header
            particulars.forEach((particular, idx) => {
              let value = '-';
              let bgColor = 'bg-gray-100';
              let textColor = 'text-gray-600';
              if (particular === 'No of Proposals submitted in Manthan Portal') {
                // For AP: Status_8, for ASP/Prof: Status_9
                if (row) {
                  if (key === 'AP') {
                    value = row['Status_8'] || '-';
                  } else if (key === 'ASP' || key === 'Prof') {
                    value = row['Status_9'] || '-';
                  }
                }
                const statusLower = value.toString().toLowerCase();
                if (statusLower === 'completed' || statusLower === 'completed and updated') {
                  bgColor = 'bg-green-100';
                  textColor = 'text-green-700';
                } else if (statusLower === 'in progress') {
                  bgColor = 'bg-yellow-100';
                  textColor = 'text-yellow-700';
                } else if (statusLower === 'not applicable' || statusLower === 'na' || statusLower === 'n/a') {
                  bgColor = 'bg-gray-100';
                  textColor = 'text-gray-500';
                } else if (statusLower !== '-') {
                  bgColor = 'bg-red-100';
                  textColor = 'text-red-700';
                }
                html += `<td class="px-2 py-2 ${bgColor} ${textColor} text-center font-medium">${value}</td>`;
              } else {
                // Status columns
                const statusIdx = idx + 1; // Status_1 ... Status_N
                value = row ? (row[`Status_${statusIdx}`] || '-') : '-';
                const statusLower = value.toString().toLowerCase();
                if (statusLower === 'completed' || statusLower === 'completed and updated') {
                  bgColor = 'bg-green-100';
                  textColor = 'text-green-700';
                } else if (statusLower === 'in progress') {
                  bgColor = 'bg-yellow-100';
                  textColor = 'text-yellow-700';
                } else if (statusLower === 'not applicable' || statusLower === 'na' || statusLower === 'n/a') {
                  bgColor = 'bg-gray-100';
                  textColor = 'text-gray-500';
                } else if (statusLower !== '-') {
                  bgColor = 'bg-red-100';
                  textColor = 'text-red-700';
                }
                html += `<td class="px-2 py-2 ${bgColor} ${textColor} text-center font-medium">${value}</td>`;
              }
            });
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }
        document.getElementById('dashboardTableContainer').innerHTML = html || '<div class="text-gray-500">No compliance data found.</div>';
      })();
    }
    
    document.getElementById('designationFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    
    document.getElementById('yearlyMonthFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    
    // Consolidated Summary Table Logic
    let selectedSummaryMonth = 'January';

    // Rating calculation function
    function calculateFacultyRating(coreScopePercent, yearlyPercent, deptPortfolio1, deptPortfolio2, instPortfolio1, instPortfolio2) {
      let validScores = [];
      
      // Helper function to parse percentage
      const parsePercent = (val, isMandatory = false) => {
        // If mandatory and not filled, treat as 0
        if (isMandatory && (!val || val === '-' || val === 'N/A')) return 0;
        // If not allocated (shown as '-'), return null to skip
        if (!val || val === '-' || val === 'N/A') return null;
        const num = parseFloat(val.toString().replace('%', ''));
        return isNaN(num) ? (isMandatory ? 0 : null) : num;
      };
      
      // Mandatory scopes - always include (0 if not filled)
      validScores.push(parsePercent(coreScopePercent, true));
      validScores.push(parsePercent(yearlyPercent, true));
      
      // Optional portfolios - only include if allocated (0 if allocated but not filled)
      [deptPortfolio1, deptPortfolio2, instPortfolio1, instPortfolio2].forEach(score => {
        const parsed = parsePercent(score, false);
        if (parsed !== null) validScores.push(parsed);
      });
      
      // Calculate average
      let average = validScores.length > 0 
        ? validScores.reduce((a, b) => a + b, 0) / validScores.length 
        : 0;
      
      // Determine stars and color
      let stars = '';
      let starCount = 0;
      let colorClass = '';
      
      if (average >= 91) {
        starCount = 5;
        stars = '★★★★★ <span class="shining">✨</span>';
        colorClass = 'rating-excellent';
      } else if (average >= 81) {
        starCount = 5;
        stars = '★★★★★';
        colorClass = 'rating-excellent';
      } else if (average >= 61) {
        starCount = 4;
        stars = '★★★★☆';
        colorClass = 'rating-good';
      } else if (average >= 41) {
        starCount = 3;
        stars = '★★★☆☆';
        colorClass = 'rating-average';
      } else if (average >= 21) {
        starCount = 2;
        stars = '★★☆☆☆';
        colorClass = 'rating-average';
      } else if (average >= 1) {
        starCount = 1;
        stars = '★☆☆☆☆';
        colorClass = 'rating-poor';
      } else {
        starCount = 0;
        stars = '☆☆☆☆☆';
        colorClass = 'rating-poor';
      }
      
      return {
        average: average.toFixed(1),
        stars: stars,
        starCount: starCount,
        colorClass: colorClass
      };
    }

    // Institution portfolio form mappings
    const institutionFormTableMap = [
      { name: "Director – Students welfare & Admission", table: "Institution-form1-monthly" },
      { name: "Head - HR", table: "Institution-form2" },
      { name: "Principal", table: "Institution-form3-monthly" },
      { name: "Dean - IQAC", table: "Institution-form4-monthly" },
      { name: "Director - Academics", table: "Institution-form5" },
      { name: "Controller of Examinations", table: "Institution-form6-monthly" },
      { name: "Executive Dean – International Affairs", table: "Institution-form7-monthly" },
      { name: "Head - Placements", table: "Institution-form8" },
      { name: "Placement Officer", table: "Institution-form9" },
      { name: "Head – Training", table: "Institution-form10" },
      { name: "Training Officer", table: "Institution-form11" },
      { name: "Head - RISE", table: "Institution-form12" },
      { name: "IT Infra – Coordinator", table: "Institution-form13-monthly" },
      { name: "Website – Coordinator", table: "Institution-form14-monthly" },
      { name: "ERP Coordinator", table: "Institution-form15" },
      { name: "Public Relations Officer", table: "Institution-form16" },
      { name: "Logistics Coordinator", table: "Institution-form17" }
    ];

    // Department portfolio form mappings (8 forms)
    const deptPortfolioFormMap = [
      { label: "1. Training & Placement", table: 'form1-monthly', formKey: 'form1' },
      { label: "2. Class Advisor", table: 'form2-monthly', formKey: 'form2' },
      { label: "3. Info & Contribution", table: 'form3-monthly', formKey: 'form3' },
      { label: "4. Outcome & Exam Cell", table: 'form4-monthly', formKey: 'form4' },
      { label: "5. Continuous Improvement", table: 'form5-monthly', formKey: 'form5' },
      { label: "6. T&L Process (IQAC)", table: 'form6_monthly', formKey: 'form6' },
      { label: "7. Student Support", table: 'form7-monthly', formKey: 'form7' },
      { label: "8. Facilities & Lab", table: 'form8-monthly', formKey: 'form8' }
    ];

    async function loadConsolidatedSummaryTable() {
      document.getElementById('summaryMonthFilter').addEventListener('change', () => {
        selectedSummaryMonth = document.getElementById('summaryMonthFilter').value;
        renderConsolidatedSummaryTable();
      });
      
      // Export buttons
      document.getElementById('exportSummaryTableBtn').onclick = exportSummaryTableToExcel;
      const pdfBtn = document.getElementById('exportSummaryTablePdfBtn');
      if (pdfBtn) pdfBtn.onclick = showFacultySelectionModal;
      
      await renderConsolidatedSummaryTable();
    }

    async function renderConsolidatedSummaryTable() {
      if (!department) {
        document.getElementById('summaryTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      
      const container = document.getElementById('summaryTableContainer');
      container.innerHTML = '<div class="text-center text-gray-500 py-4">Loading summary data...</div>';
      
      try {
        // Fetch faculty for current department
        const { data: allFaculty, error: facErr } = await supabaseClient
          .from('Faculty')
          .select('*')
          .eq('department', department);
        
        if (facErr) throw facErr;
        
        console.log('[HOD Consolidated] Fetched', allFaculty?.length || 0, 'total faculty from Faculty table');
        
        // Check if S&H department (use different table names)
        const shDepartments = ['S&H V1', 'S&H V2', 'S&H V3', 'S&H V4', 'S&H V5', 'S&H V6'];
        const isSHDept = shDepartments.includes(department);
        
        console.log('[HOD Consolidated] Department:', department, 'isSH:', isSHDept, 'Month:', selectedSummaryMonth);
        
        // Fetch Core Scope Monthly data (use Core_scope_SH for S&H)
        const coreScopeTableName = isSHDept ? 'Core_scope_SH' : 'Core_scope';
        const { data: coreScopeData, error: coreErr } = await supabaseClient
          .from(coreScopeTableName)
          .select('*')
          .eq('Month', selectedSummaryMonth)
          .eq('Department', department);
        
        console.log('[HOD Consolidated] Core Scope table:', coreScopeTableName, 'Fetched:', coreScopeData?.length || 0, 'rows. Error:', coreErr?.message || 'none');
        
        // Fetch Yearly Mandatory Scope data (AP, ASP, Prof)
        // S&H tables have _SH suffix
        const apTableName = isSHDept ? 'AP_SH_Yearly' : 'AP(Yearly)';
        const aspTableName = isSHDept ? 'ASP_SH_Yearly' : 'ASP(Yearly)';
        const profTableName = isSHDept ? 'Prof_SH_Yearly' : 'Prof(Yearly)';
        
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from(apTableName).select('*').eq('Month', selectedSummaryMonth).eq('Department', department),
          supabaseClient.from(aspTableName).select('*').eq('Month', selectedSummaryMonth).eq('Department', department),
          supabaseClient.from(profTableName).select('*').eq('Month', selectedSummaryMonth).eq('Department', department)
        ]);
        
        console.log('[HOD Consolidated] Yearly tables - AP:', apRes.data?.length || 0, 'ASP:', aspRes.data?.length || 0, 'Prof:', profRes.data?.length || 0);
        
        // Fetch department portfolio data for all 8 forms
        const deptPortfolioPromises = deptPortfolioFormMap.map(form => 
          supabaseClient.from(form.table).select('*').eq('Month', selectedSummaryMonth)
        );
        const deptPortfolioResults = await Promise.all(deptPortfolioPromises);
        
        // Fetch institution portfolio data for all 17 forms
        const instPortfolioPromises = institutionFormTableMap.map(form => 
          supabaseClient.from(form.table).select('*')
        );
        const instPortfolioResults = await Promise.all(instPortfolioPromises);
        
        // Build summary data
        const summaryRows = [];
        let filteredByDesigCount = 0;
        
        for (const fac of allFaculty) {
          const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || '';
          const nameTrimmed = facultyName.toString().trim().toLowerCase();
          const dept = fac.department || 'Unknown';
          const designation = fac.Designation || 'N/A';
          
          // Normalize designation - trim to remove whitespace and special characters like \r\n
          const desig = designation.toString().trim().toUpperCase();
          if (desig !== 'AP' && desig !== 'ASSISTANT PROFESSOR' && 
              desig !== 'ASP' && desig !== 'ASSOCIATE PROFESSOR' && 
              desig !== 'PROF' && desig !== 'PROFESSOR') {
            continue; // Skip non-teaching staff
          }
          
          filteredByDesigCount++;
          let desigDisplay = '';
          if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') desigDisplay = 'AP';
          else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') desigDisplay = 'ASP';
          else if (desig === 'PROF' || desig === 'PROFESSOR') desigDisplay = 'Prof';
          
          // Calculate Core Scope Monthly %
          let coreScopePercent = '-';
          if (coreScopeData && coreScopeData.length > 0) {
            const matchingRows = coreScopeData.filter(r => 
              (r['Portfolio Member Name'] || '').toString().trim().toLowerCase() === nameTrimmed
            );
            if (matchingRows.length > 0) {
              // Get the latest row by input_id
              matchingRows.sort((a, b) => (b.input_id || 0) - (a.input_id || 0));
              const coreScopeRow = matchingRows[0];
              
              let completedCount = 0;
              const totalCount = 15; // Fixed denominator for Core Scope
              for (let i = 1; i <= 15; i++) {
                const status = (coreScopeRow[`Status_${i}`] || '').toString().trim().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount += 1;
                }
                // All statuses (including 'Not Applicable', null, empty) are included in denominator
              }
              coreScopePercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
            }
          }
          
          // Calculate Mandatory Scope Yearly %
          let yearlyPercent = '-';
          let yearlyData = desigDisplay === 'AP' ? apRes.data : desigDisplay === 'ASP' ? aspRes.data : profRes.data;
          if (yearlyData && yearlyData.length > 0) {
            const yearlyRow = yearlyData.find(r => 
              (r['Portfolio Member Name'] || '').toString().trim().toLowerCase() === nameTrimmed
            );
            if (yearlyRow) {
              let completedCount = 0;
              // Designation-specific field counts: AP=8, ASP=9, Prof=9
              let totalCount = desigDisplay === 'AP' ? 8 : 9;
              for (let i = 1; i <= totalCount; i++) {
                const status = (yearlyRow[`Status_${i}`] || '').toString().trim().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount++;
                }
              }
              yearlyPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
            }
          }
          
          // Calculate Department Portfolio Scope percentages
          let deptPortfolio1Percent = '-';
          let deptPortfolio2Percent = '-';
          let deptPortfolio1Data = null;
          let deptPortfolio2Data = null;
          let deptPortfolioCount = 0;
          
          for (let i = 0; i < deptPortfolioFormMap.length; i++) {
            const formMapping = deptPortfolioFormMap[i];
            const isAssigned = fac[formMapping.formKey] && fac[formMapping.formKey].toString().trim().toLowerCase() === 'yes';
            
            if (isAssigned) {
              // Initialize to 0% for assigned forms (will be updated if form data exists)
              let percent = '0%';
              
              const formData = deptPortfolioResults[i].data || [];
              const formRow = formData.find(r => {
                const rowName = r['Portfolio Member Name:'] || r['Portfolio Member Name'] || r['Portfolio Memeber Name'] || r['faculty_name'] || r['Faculty Name'] || r['Name'] || '';
                const rowMonth = r['Month'] || r['month'] || r['Month:'] || '';
                const deptMatches = (r['Department'] || r['Department:'] || '').toString().trim().toLowerCase() === dept.toString().trim().toLowerCase();
                return rowName.toString().trim().toLowerCase() === nameTrimmed && rowMonth === selectedSummaryMonth && deptMatches;
              });
              
              if (formRow) {
                let completedCount = 0;
                const totalCount = 8;
                for (let i = 1; i <= 8; i++) {
                  // Check both Status_i and Status-i formats (some tables use hyphens, others use underscores)
                  const val = (formRow[`Status_${i}`] || formRow[`Status-${i}`] || '').toString().trim().toLowerCase();
                  if (val === 'completed' || val === 'completed and updated') {
                    completedCount++;
                  }
                  // All statuses (including 'Not Applicable') are included in denominator
                }
                percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
              }
              
              // Assign percent and store data for validation score updates
              if (deptPortfolioCount === 0) {
                deptPortfolio1Percent = percent;
                deptPortfolio1Data = formRow ? { input_id: formRow.input_id, table_name: formMapping.table } : null;
              } else if (deptPortfolioCount === 1) {
                deptPortfolio2Percent = percent;
                deptPortfolio2Data = formRow ? { input_id: formRow.input_id, table_name: formMapping.table } : null;
              }
              deptPortfolioCount++;
            }
          }
          
          // Calculate Institution Portfolio percentages
          let instPortfolio1Percent = '-';
          let instPortfolio2Percent = '-';
          let instPortfolioCount = 0;
          
          for (let i = 0; i < institutionFormTableMap.length; i++) {
            const formMapping = institutionFormTableMap[i];
            const formData = instPortfolioResults[i].data || [];
            const isMonthlyForm = formMapping.table.includes('-monthly');
            
            // Search for faculty in this form's data - get all matching rows
            const matchingRows = formData.filter(r => {
              const rowName = r['Portfolio Member Name:'] || r['Portfolio Member Name'] || '';
              const rowMonth = r['Month:'] || r['Month'] || r['month'] || '';
              // Normalize both names by removing extra spaces
              const normalizedRowName = rowName.toString().trim().replace(/\s+/g, ' ').toLowerCase();
              const normalizedFacultyName = nameTrimmed.replace(/\s+/g, ' ');
              const nameMatches = normalizedRowName === normalizedFacultyName;
              const monthMatches = !isMonthlyForm || rowMonth.toString().trim().toLowerCase() === selectedSummaryMonth.toLowerCase();
              return nameMatches && monthMatches;
            });
            
            // Get the row with the highest input_id (most recent submission)
            const formRow = matchingRows.length > 0 
              ? matchingRows.reduce((latest, current) => 
                  (current.input_id || 0) > (latest.input_id || 0) ? current : latest
                )
              : null;
            
            // If faculty found, calculate percentage
            if (formRow) {
              let percent = '0%';
              let completedCount = 0;
              // Dynamically count actual Status fields (Institution forms have varying counts)
              const statusKeys = Object.keys(formRow).filter(k => k.startsWith('Status_'));
              const totalCount = statusKeys.length;
              
              for (const key of statusKeys) {
                const value = (formRow[key] || '').toString().trim().toLowerCase();
                if (value === 'completed' || value === 'completed and updated') {
                  completedCount++;
                }
                // All statuses (including 'Not Applicable', null, empty) are included in denominator
              }
              
              percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
              
              // Assign percent
              if (instPortfolioCount === 0) {
                instPortfolio1Percent = percent;
              } else if (instPortfolioCount === 1) {
                instPortfolio2Percent = percent;
              }
              instPortfolioCount++;
            }
          }
          
          summaryRows.push({
            dept,
            designation: desigDisplay,
            facultyName,
            coreScopePercent,
            yearlyPercent,
            deptPortfolio1Percent,
            deptPortfolio2Percent,
            instPortfolio1Percent,
            instPortfolio2Percent,
            deptPortfolio1Data,
            deptPortfolio2Data
          });
        }
        
        console.log('[HOD Consolidated] Faculty filtered by designation:', filteredByDesigCount, 'Summary rows created:', summaryRows.length);
        if (summaryRows.length > 0) {
          console.log('[HOD Consolidated] First faculty:', summaryRows[0].facultyName, 'Dept:', summaryRows[0].dept);
        }
        
        // Sort by designation, then by faculty name
        summaryRows.sort((a, b) => {
          const desigOrder = { 'Prof': 1, 'ASP': 2, 'AP': 3 };
          const desigCompare = (desigOrder[a.designation] || 99) - (desigOrder[b.designation] || 99);
          if (desigCompare !== 0) return desigCompare;
          return a.facultyName.localeCompare(b.facultyName);
        });
        
        // Render table
        let html = '<div class="overflow-auto border rounded-lg shadow-sm" style="max-height: 600px;">';
        html += '<table class="min-w-full text-sm bg-white" id="summaryTable"><thead class="bg-blue-700 text-white sticky top-0 z-20"><tr>';
        html += '<th class="px-3 py-2 sticky left-0 bg-blue-700 z-30">Dept</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Desig</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Faculty Name</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Faculty Core Scope Monthly</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Faculty Mandatory Scope (Yearly)</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Department Portfolio Scope-1</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Department Portfolio Scope-2</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Institution Portfolio-1</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Institution Portfolio-2</th>';
        html += '<th class="px-3 py-2 bg-blue-700">Overall Rating</th>';
        html += '</tr></thead><tbody>';
        
        // Render rows with unique IDs for async validation score updates
        let rowIndex = 0;
        for (const row of summaryRows) {
          // Calculate faculty rating
          const rating = calculateFacultyRating(
            row.coreScopePercent,
            row.yearlyPercent,
            row.deptPortfolio1Percent,
            row.deptPortfolio2Percent,
            row.instPortfolio1Percent,
            row.instPortfolio2Percent
          );
          
          const summaryRowId = `summary-row-${rowIndex}`;
          html += '<tr class="hover:bg-gray-50 faculty-row" data-faculty-name="' + row.facultyName + '" data-dept="' + row.dept + '" data-designation="' + row.designation + '">';
          html += `<td class="px-2 py-2 border sticky left-0 bg-white z-10">${row.dept}</td>`;
          html += `<td class="px-2 py-2 border text-center">${row.designation}</td>`;
          html += `<td class="px-2 py-2 border">${row.facultyName}</td>`;
          html += `<td id="summary-core-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.coreScopePercent}</td>`;
          html += `<td id="summary-yearly-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.yearlyPercent}</td>`;
          html += `<td id="summary-dept1-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.deptPortfolio1Percent}</td>`;
          html += `<td id="summary-dept2-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.deptPortfolio2Percent}</td>`;
          html += `<td id="summary-inst1-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.instPortfolio1Percent}</td>`;
          html += `<td id="summary-inst2-${summaryRowId}" class="px-2 py-2 border text-center font-semibold">${row.instPortfolio2Percent}</td>`;
          html += `<td id="summary-rating-${summaryRowId}" class="px-2 py-2 border text-center">`;
          html += `<div class="star-rating ${rating.colorClass}">${rating.stars}</div>`;
          html += `<div class="text-xs mt-1 ${rating.colorClass}">${rating.average}%</div>`;
          html += `</td>`;
          html += '</tr>';
          
          // Store row data for async validation score updates
          row.summaryRowId = summaryRowId;
          row.rowIndex = rowIndex;
          rowIndex++;
        }
        
        html += '</tbody></table></div>';
        container.innerHTML = html || '<div class="text-gray-500 text-center py-4">No summary data found.</div>';
        console.log('[HOD Dashboard Consolidated] Rendered', summaryRows.length, 'faculty rows - now fetching HOD validation scores...');
        
        // Async update validation scores from Hod-workdone table
        for (const row of summaryRows) {
          setTimeout(async () => {
            try {
              // Query Hod-workdone with MONTH filter first
              let { data: verifyData, error: monthErr } = await supabaseClient
                .from('Hod-workdone')
                .select('*')
                .eq('department', row.dept)
                .eq('month', selectedSummaryMonth)
                .ilike('portfolio_member_name', row.facultyName);
              
              // If month filter fails (column doesn't exist), try without month filter
              if (monthErr && monthErr.code === 'PGRST116') {
                console.log('[HOD Consolidated] Month column not found, querying without month filter for', row.facultyName);
                const { data: allData } = await supabaseClient
                  .from('Hod-workdone')
                  .select('*')
                  .eq('department', row.dept)
                  .ilike('portfolio_member_name', row.facultyName);
                verifyData = allData;
              }
              
              console.log('[HOD Consolidated] Validation data for', row.facultyName, 'month', selectedSummaryMonth, ':', verifyData?.length || 0, 'records');
              
              if (!verifyData || verifyData.length === 0) {
                console.log('[HOD Consolidated] No validation found for', row.facultyName, '- keeping raw scores');
                return;
              }
              
              // Update Faculty Core Scope Monthly if verified
              const coreCell = document.getElementById(`summary-core-${row.summaryRowId}`);
              if (coreCell) {
                // Look for Core Scope validation by faculty name and month
                const coreValidation = verifyData.find(v => 
                  v.table_name && v.table_name.toLowerCase().includes('core')
                );
                
                if (coreValidation && coreValidation.validation_score != null && coreValidation.validation_score !== '') {
                  const validationScore = parseFloat(coreValidation.validation_score);
                  if (!isNaN(validationScore)) {
                    console.log('[HOD Consolidated] Updating Core Scope for', row.facultyName, 'to', validationScore + '%');
                    const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                    coreCell.innerHTML = `<span class="${percentageClass}">${Math.round(validationScore)}%</span>`;
                    row.coreScopePercent = `${Math.round(validationScore)}%`;
                  }
                }
              }
              
              // Update Faculty Mandatory Scope Yearly if verified
              const yearlyCell = document.getElementById(`summary-yearly-${row.summaryRowId}`);
              if (yearlyCell) {
                const desigDisplay = row.designation;
                // Look for Yearly validation by faculty name, month, and designation
                const yearlyValidation = verifyData.find(v => 
                  v.table_name && v.table_name.includes(desigDisplay) && v.table_name.toLowerCase().includes('yearly')
                );
                
                if (yearlyValidation && yearlyValidation.validation_score != null && yearlyValidation.validation_score !== '') {
                  const validationScore = parseFloat(yearlyValidation.validation_score);
                  if (!isNaN(validationScore)) {
                    console.log('[HOD Consolidated] Updating Yearly for', row.facultyName, 'to', validationScore + '%');
                    const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                    yearlyCell.innerHTML = `<span class="${percentageClass}">${Math.round(validationScore)}%</span>`;
                    row.yearlyPercent = `${Math.round(validationScore)}%`;
                  }
                }
              }
              
              // Get ALL portfolio validations for this faculty (not just one)
              const portfolioValidations = verifyData.filter(v => 
                v.table_name && (v.table_name.toLowerCase().includes('form1') || 
                                v.table_name.toLowerCase().includes('form2') ||
                                v.table_name.toLowerCase().includes('form3') || 
                                v.table_name.toLowerCase().includes('form4') ||
                                v.table_name.toLowerCase().includes('form5') ||
                                v.table_name.toLowerCase().includes('form6') ||
                                v.table_name.toLowerCase().includes('form7') ||
                                v.table_name.toLowerCase().includes('form8'))
              );
              
              console.log('[HOD Consolidated] Portfolio validations found for', row.facultyName, ':', portfolioValidations.map(v => v.table_name + '=' + v.validation_score));
              
              // Update Department Portfolio Scope-1 if verified
              const dept1Cell = document.getElementById(`summary-dept1-${row.summaryRowId}`);
              if (dept1Cell) {
                // First try exact match, then use first available portfolio validation
                let dept1Validation = null;
                
                if (row.deptPortfolio1Data && row.deptPortfolio1Data.table_name) {
                  dept1Validation = portfolioValidations.find(v => 
                    v.table_name.toLowerCase() === row.deptPortfolio1Data.table_name.toLowerCase()
                  );
                }
                
                // Fallback: use first portfolio validation if no exact match
                if (!dept1Validation && portfolioValidations.length > 0) {
                  dept1Validation = portfolioValidations[0];
                }
                
                console.log('[HOD Consolidated] Dept Portfolio 1 - stored:', row.deptPortfolio1Data?.table_name, 'matched:', dept1Validation?.table_name, 'score:', dept1Validation?.validation_score);
                
                if (dept1Validation && dept1Validation.validation_score != null && dept1Validation.validation_score !== '') {
                  const validationScore = parseFloat(dept1Validation.validation_score);
                  if (!isNaN(validationScore)) {
                    console.log('[HOD Consolidated] Updating Dept Portfolio 1 for', row.facultyName, 'to', validationScore + '%');
                    const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                    dept1Cell.innerHTML = `<span class="${percentageClass}">${Math.round(validationScore)}%</span>`;
                    row.deptPortfolio1Percent = `${Math.round(validationScore)}%`;
                  }
                }
              }
              
              // Update Department Portfolio Scope-2 if verified
              const dept2Cell = document.getElementById(`summary-dept2-${row.summaryRowId}`);
              if (dept2Cell) {
                // First try exact match, then use second available portfolio validation
                let dept2Validation = null;
                
                if (row.deptPortfolio2Data && row.deptPortfolio2Data.table_name) {
                  dept2Validation = portfolioValidations.find(v => 
                    v.table_name.toLowerCase() === row.deptPortfolio2Data.table_name.toLowerCase()
                  );
                }
                
                // Fallback: use second portfolio validation if no exact match
                if (!dept2Validation && portfolioValidations.length > 1) {
                  dept2Validation = portfolioValidations[1];
                }
                
                console.log('[HOD Consolidated] Dept Portfolio 2 - stored:', row.deptPortfolio2Data?.table_name, 'matched:', dept2Validation?.table_name, 'score:', dept2Validation?.validation_score);
                
                if (dept2Validation && dept2Validation.validation_score != null && dept2Validation.validation_score !== '') {
                  const validationScore = parseFloat(dept2Validation.validation_score);
                  if (!isNaN(validationScore)) {
                    console.log('[HOD Consolidated] Updating Dept Portfolio 2 for', row.facultyName, 'to', validationScore + '%');
                    const percentageClass = validationScore >= 70 ? 'text-green-600' : validationScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                    dept2Cell.innerHTML = `<span class="${percentageClass}">${Math.round(validationScore)}%</span>`;
                    row.deptPortfolio2Percent = `${Math.round(validationScore)}%`;
                  }
                }
              }
              
              // Recalculate overall rating based on updated validation scores
              const ratingCell = document.getElementById(`summary-rating-${row.summaryRowId}`);
              if (ratingCell) {
                const updatedRating = calculateFacultyRating(
                  row.coreScopePercent,
                  row.yearlyPercent,
                  row.deptPortfolio1Percent,
                  row.deptPortfolio2Percent,
                  row.instPortfolio1Percent,
                  row.instPortfolio2Percent
                );
                ratingCell.innerHTML = `<div class="star-rating ${updatedRating.colorClass}">${updatedRating.stars}</div><div class="text-xs mt-1 ${updatedRating.colorClass}">${updatedRating.average}%</div>`;
              }
              
            } catch (err) {
              console.error('[HOD Dashboard Consolidated] Error updating validation scores:', err);
            }
          }, 100);
        }
        
      } catch (error) {
        console.error('[HOD Dashboard Consolidated] Summary table error:', error);
        container.innerHTML = '<div class="text-red-500 text-center py-4">Failed to load summary data. Check console for errors.</div>';
      }
    }

    async function exportSummaryTableToExcel() {
      if (!department) {
        alert('No department selected.');
        return;
      }
      
      try {
        // Fetch faculty for current department
        const { data: allFaculty, error: facErr } = await supabaseClient
          .from('Faculty')
          .select('*')
          .eq('department', department);
        
        if (facErr) throw facErr;
        
        // Fetch Core Scope Monthly data
        const { data: coreScopeData } = await supabaseClient
          .from('Core_scope')
          .select('*')
          .eq('Month', selectedSummaryMonth)
          .eq('Department', department);
        
        // Fetch Yearly Mandatory Scope data (AP, ASP, Prof)
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('AP(Yearly)').select('*').eq('Month', selectedSummaryMonth).eq('Department', department),
          supabaseClient.from('ASP(Yearly)').select('*').eq('Month', selectedSummaryMonth).eq('Department', department),
          supabaseClient.from('Prof(Yearly)').select('*').eq('Month', selectedSummaryMonth).eq('Department', department)
        ]);
        
        // Fetch department portfolio data for all 8 forms
        const deptPortfolioPromises = deptPortfolioFormMap.map(form => 
          supabaseClient.from(form.table).select('*').eq('Month', selectedSummaryMonth)
        );
        const deptPortfolioResults = await Promise.all(deptPortfolioPromises);
        
        // Fetch institution portfolio data for all 17 forms
        const instPortfolioPromises = institutionFormTableMap.map(form => 
          supabaseClient.from(form.table).select('*')
        );
        const instPortfolioResults = await Promise.all(instPortfolioPromises);
        
        // Build summary data for Excel
        const excelData = [];
        
        for (const fac of allFaculty) {
          const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email || '';
          const nameTrimmed = facultyName.toString().trim().toLowerCase();
          const dept = fac.department || 'Unknown';
          const designation = fac.Designation || 'N/A';
          
          // Normalize designation - trim to remove whitespace and special characters like \r\n
          const desig = designation.toString().trim().toUpperCase();
          if (desig !== 'AP' && desig !== 'ASSISTANT PROFESSOR' && 
              desig !== 'ASP' && desig !== 'ASSOCIATE PROFESSOR' && 
              desig !== 'PROF' && desig !== 'PROFESSOR') {
            continue; // Skip non-teaching staff
          }
          
          let desigDisplay = '';
          if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') desigDisplay = 'AP';
          else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') desigDisplay = 'ASP';
          else if (desig === 'PROF' || desig === 'PROFESSOR') desigDisplay = 'Prof';
          
          // Calculate Core Scope Monthly % (same logic as IQAC)
          let coreScopePercent = '-';
          if (coreScopeData && coreScopeData.length > 0) {
            const matchingRows = coreScopeData.filter(r => 
              (r['Portfolio Member Name'] || '').toString().trim().toLowerCase() === nameTrimmed
            );
            if (matchingRows.length > 0) {
              matchingRows.sort((a, b) => (b.input_id || 0) - (a.input_id || 0));
              const coreScopeRow = matchingRows[0];
              
              let completedCount = 0;
              const totalCount = 15;
              for (let i = 1; i <= 15; i++) {
                const status = (coreScopeRow[`Status_${i}`] || '').toString().trim().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount++;
                }
              }
              coreScopePercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
            }
          }
          
          // Calculate Mandatory Scope Yearly %
          let yearlyPercent = '-';
          let yearlyData = desigDisplay === 'AP' ? apRes.data : desigDisplay === 'ASP' ? aspRes.data : profRes.data;
          if (yearlyData && yearlyData.length > 0) {
            const yearlyRow = yearlyData.find(r => 
              (r['Portfolio Member Name'] || '').toString().trim().toLowerCase() === nameTrimmed
            );
            if (yearlyRow) {
              let completedCount = 0;
              // Designation-specific field counts: AP=8, ASP=9, Prof=9
              let totalCount = desigDisplay === 'AP' ? 8 : 9;
              for (let i = 1; i <= totalCount; i++) {
                const status = (yearlyRow[`Status_${i}`] || '').toString().trim().toLowerCase();
                if (status === 'completed' || status === 'completed and updated') {
                  completedCount++;
                }
              }
              yearlyPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
            }
          }
          
          // Calculate Department Portfolio Scope percentages
          let deptPortfolio1Percent = '-';
          let deptPortfolio2Percent = '-';
          let deptPortfolio1Data = null;
          let deptPortfolio2Data = null;
          let deptPortfolioCount = 0;
          
          for (let i = 0; i < deptPortfolioFormMap.length; i++) {
            const formMapping = deptPortfolioFormMap[i];
            const isAssigned = fac[formMapping.formKey] && fac[formMapping.formKey].toString().trim().toLowerCase() === 'yes';
            
            if (isAssigned) {
              let percent = '0%';
              
              const formData = deptPortfolioResults[i].data || [];
              const formRow = formData.find(r => {
                const rowName = r['Portfolio Member Name:'] || r['Portfolio Member Name'] || r['Portfolio Memeber Name'] || r['faculty_name'] || r['Faculty Name'] || r['Name'] || '';
                const rowMonth = r['Month'] || r['month'] || r['Month:'] || '';
                const deptMatches = (r['Department'] || r['Department:'] || '').toString().trim().toLowerCase() === dept.toString().trim().toLowerCase();
                return rowName.toString().trim().toLowerCase() === nameTrimmed && rowMonth === selectedSummaryMonth && deptMatches;
              });
              
              if (formRow) {
                let completedCount = 0;
                const totalCount = 8;
                for (let i = 1; i <= 8; i++) {
                  const val = (formRow[`Status_${i}`] || formRow[`Status-${i}`] || '').toString().trim().toLowerCase();
                  if (val === 'completed' || val === 'completed and updated') {
                    completedCount++;
                  }
                }
                percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
              }
              
              if (deptPortfolioCount === 0) {
                deptPortfolio1Percent = percent;
              } else if (deptPortfolioCount === 1) {
                deptPortfolio2Percent = percent;
              }
              deptPortfolioCount++;
            }
          }
          
          // Calculate Institution Portfolio percentages
          let instPortfolio1Percent = '-';
          let instPortfolio2Percent = '-';
          let instPortfolioCount = 0;
          
          for (let i = 0; i < institutionFormTableMap.length; i++) {
            const formMapping = institutionFormTableMap[i];
            const formData = instPortfolioResults[i].data || [];
            const isMonthlyForm = formMapping.table.includes('-monthly');
            
            const matchingRows = formData.filter(r => {
              const rowName = r['Portfolio Member Name:'] || r['Portfolio Member Name'] || '';
              const rowMonth = r['Month:'] || r['Month'] || r['month'] || '';
              const normalizedRowName = rowName.toString().trim().replace(/\s+/g, ' ').toLowerCase();
              const normalizedFacultyName = nameTrimmed.replace(/\s+/g, ' ');
              const nameMatches = normalizedRowName === normalizedFacultyName;
              const monthMatches = !isMonthlyForm || rowMonth.toString().trim().toLowerCase() === selectedSummaryMonth.toLowerCase();
              return nameMatches && monthMatches;
            });
            
            const formRow = matchingRows.length > 0 
              ? matchingRows.reduce((latest, current) => 
                  (current.input_id || 0) > (latest.input_id || 0) ? current : latest
                )
              : null;
            
            if (formRow) {
              let percent = '0%';
              let completedCount = 0;
              const statusKeys = Object.keys(formRow).filter(k => k.startsWith('Status_'));
              const totalCount = statusKeys.length;
              for (const key of statusKeys) {
                const value = (formRow[key] || '').toString().trim().toLowerCase();
                if (value === 'completed' || value === 'completed and updated') {
                  completedCount++;
                }
              }
              percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) + '%' : '0%';
              
              if (instPortfolioCount === 0) {
                instPortfolio1Percent = percent;
              } else if (instPortfolioCount === 1) {
                instPortfolio2Percent = percent;
              }
              instPortfolioCount++;
            }
          }
          
          // Calculate rating
          const rating = calculateFacultyRating(
            coreScopePercent,
            yearlyPercent,
            deptPortfolio1Percent,
            deptPortfolio2Percent,
            instPortfolio1Percent,
            instPortfolio2Percent
          );
          
          excelData.push({
            'Department': dept,
            'Designation': desigDisplay,
            'Faculty Name': facultyName,
            'Faculty Core Scope Monthly': coreScopePercent,
            'Faculty Mandatory Scope (Yearly)': yearlyPercent,
            'Department Portfolio Scope-1': deptPortfolio1Percent,
            'Department Portfolio Scope-2': deptPortfolio2Percent,
            'Institution Portfolio-1': instPortfolio1Percent,
            'Institution Portfolio-2': instPortfolio2Percent,
            'Overall Rating (%)': rating.average + '%',
            'Star Rating': rating.starCount
          });
        }
        
        // Create workbook
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Summary');
        XLSX.writeFile(wb, `Consolidated_Summary_${department}_${selectedSummaryMonth}_${new Date().toISOString().split('T')[0]}.xlsx`);
        
      } catch (error) {
        console.error('Excel export error:', error);
        alert('Failed to export Excel file.');
      }
    }

    // Modal functions for faculty selection
    function showFacultySelectionModal() {
      if (!department) {
        alert('No department selected.');
        return;
      }
      
      const container = document.getElementById('summaryTableContainer');
      if (!container) { alert('No summary table found to export.'); return; }
      const table = container.querySelector('table');
      if (!table) { alert('No summary table found to export.'); return; }
      
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      if (rows.length === 0) {
        alert('No faculty data to export.');
        return;
      }
      
      // Group faculty by designation
      const designationGroups = {};
      rows.forEach((row, idx) => {
        const facultyName = row.dataset.facultyName || '';
        const dept = row.dataset.dept || '';
        const designation = row.dataset.designation || '';
        
        if (!designationGroups[designation]) {
          designationGroups[designation] = [];
        }
        designationGroups[designation].push({ facultyName, dept, designation, idx });
      });
      
      // Build expandable list grouped by designation
      let listHTML = '<div class="space-y-3">';
      const designationOrder = ['Prof', 'ASP', 'AP'];
      
      designationOrder.forEach(desig => {
        if (!designationGroups[desig]) return;
        
        const facultyList = designationGroups[desig];
        const groupId = `group-${desig}`;
        
        listHTML += `<div class="border border-gray-300 rounded-lg overflow-hidden">`;
        
        // Designation header with checkbox and expand/collapse
        listHTML += `<div class="bg-blue-50 p-3 flex items-center gap-3 cursor-pointer hover:bg-blue-100" onclick="toggleDesignationGroup('${groupId}')">`;
        listHTML += `<input type="checkbox" checked class="designation-checkbox w-5 h-5 cursor-pointer" data-designation="${desig}" onclick="event.stopPropagation(); toggleDesignation(this, '${desig}')">`;
        listHTML += `<svg class="w-5 h-5 text-gray-600 expand-icon" id="icon-${groupId}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
        listHTML += `<span class="font-bold text-blue-900">${desig} (${facultyList.length} faculty)</span>`;
        listHTML += `</div>`;
        
        // Faculty list (initially visible)
        listHTML += `<div id="${groupId}" class="designation-group">`;
        facultyList.forEach(({ facultyName, dept, designation, idx }) => {
          listHTML += `<div class="flex items-center gap-3 p-3 hover:bg-gray-50 border-t border-gray-200">`;
          listHTML += `<div class="w-5"></div>`; // Indent
          listHTML += `<input type="checkbox" checked class="modal-faculty-checkbox w-5 h-5 cursor-pointer" data-row-index="${idx}" data-designation="${desig}" id="faculty-cb-${idx}">`;
          listHTML += `<label for="faculty-cb-${idx}" class="cursor-pointer flex-1">`;
          listHTML += `<span class="font-semibold text-gray-800">${facultyName}</span>`;
          listHTML += `<span class="text-sm text-gray-600 ml-2">(${designation} - ${dept})</span>`;
          listHTML += `</label>`;
          listHTML += `</div>`;
        });
        listHTML += `</div>`;
        
        listHTML += `</div>`;
      });
      
      listHTML += '</div>';
      
      document.getElementById('facultySelectionList').innerHTML = listHTML;
      document.getElementById('facultySelectionModal').classList.remove('hidden');
    }
    
    function toggleDesignationGroup(groupId) {
      const group = document.getElementById(groupId);
      const icon = document.getElementById(`icon-${groupId}`);
      if (group.style.display === 'none') {
        group.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        group.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }
    
    function toggleDesignation(checkbox, designation) {
      const checkboxes = document.querySelectorAll(`.modal-faculty-checkbox[data-designation="${designation}"]`);
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }
    
    function closeFacultySelectionModal() {
      document.getElementById('facultySelectionModal').classList.add('hidden');
    }
    
    function selectAllFacultyInModal() {
      const checkboxes = document.querySelectorAll('.modal-faculty-checkbox');
      checkboxes.forEach(cb => cb.checked = true);
      const designationCheckboxes = document.querySelectorAll('.designation-checkbox');
      designationCheckboxes.forEach(cb => cb.checked = true);
    }
    
    function deselectAllFacultyInModal() {
      const checkboxes = document.querySelectorAll('.modal-faculty-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      const designationCheckboxes = document.querySelectorAll('.designation-checkbox');
      designationCheckboxes.forEach(cb => cb.checked = false);
    }
    
    function confirmFacultySelectionAndExport() {
      const checkboxes = document.querySelectorAll('.modal-faculty-checkbox');
      const selectedIndices = [];
      checkboxes.forEach(cb => {
        if (cb.checked) {
          selectedIndices.push(parseInt(cb.dataset.rowIndex));
        }
      });
      
      if (selectedIndices.length === 0) {
        alert('Please select at least one faculty member to export.');
        return;
      }
      
      closeFacultySelectionModal();
      exportSummaryTableToPDF(selectedIndices);
    }
    
    // Export summary table to PDF (landscape format with logo and signatures)
    async function exportSummaryTableToPDF(selectedIndices) {
      if (!department) {
        alert('No department selected.');
        return;
      }
      
      try {
        const container = document.getElementById('summaryTableContainer');
        if (!container) { alert('No summary table found to export.'); return; }
        const table = container.querySelector('table');
        if (!table) { alert('No summary table found to export.'); return; }

        const deptLabel = department || '';
        const monthLabel = selectedSummaryMonth || '';
        const currentYear = new Date().getFullYear();
        const nextYear = currentYear + 1;
        
        // Format current date as DD/MM/YYYY
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;

        const allRows = Array.from(table.querySelectorAll('tbody tr'));
        
        // Filter only selected rows based on indices
        const selectedRows = allRows.filter((row, idx) => selectedIndices.includes(idx));
        
        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'width:297mm;padding:8mm;background:#fff;font-family:Arial,sans-serif;';

        let html = '';
        
        // Header with logo and title (only on first page)
        html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid #ccc;padding-bottom:8px;">`;
        html += `<div style="width:80px;"><img src="/static/img/pmc.jpg" style="width:80px;height:auto;" /></div>`;
        html += `<div style="flex:1;text-align:center;">`;
        html += `<h1 style="margin:0;color:#1e40af;font-size:18px;font-weight:700;text-transform:uppercase;">CONSOLIDATED PERFORMANCE SUMMARY</h1>`;
        html += `<div style="margin-top:4px;font-size:13px;font-weight:600;color:#374151;">DEPARTMENT: ${deptLabel} | ${currentYear}-${nextYear} | MONTH: ${monthLabel.toUpperCase()} ${currentYear}</div>`;
        html += `</div>`;
        html += `</div>`;
        
        // Date field with actual export date
        html += `<div style="margin-bottom:6px;font-size:11px;font-weight:600;">DATE: ${formattedDate}</div>`;

        // Build table header with FACULTY SIGNATURE column added (without checkbox column)
        const colWidths = ['3%', '5%', '8%', '12%', '7%', '8%', '8%', '8%', '8%', '8%', '10%', '10%', '5%'];
        let theadHTML = '<tr style="background:#1e40af;color:#fff;">';
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[0]};">SNO</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[1]};">DEPT</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[2]};">DESIGNATION</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[3]};">FACULTY NAME</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[4]};">FACULTY CORE SCOPE MONTHLY</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[5]};">FACULTY MANDATORY SCOPE (YEARLY)</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[6]};">DEPARTMENT PORTFOLIO SCOPE-1</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[7]};">DEPARTMENT PORTFOLIO SCOPE-2</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[8]};">INSTITUTION PORTFOLIO-1</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:8px;font-weight:600;text-align:center;width:${colWidths[9]};">INSTITUTION PORTFOLIO-2</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[10]};">OVERALL RATING</th>`;
        theadHTML += `<th style="border:1px solid #999;padding:4px;font-size:9px;font-weight:600;text-align:center;width:${colWidths[11]};">FACULTY SIGNATURE</th>`;
        theadHTML += '</tr>';

        // Start table
        html += `<table style="width:100%;border-collapse:collapse;font-size:9px;margin-bottom:10px;">`;
        html += `<thead>${theadHTML}</thead>`;
        html += '<tbody>';

        // Add selected rows with sequential numbering and page break after every 8 rows
        selectedRows.forEach((r, idx) => {
          const cells = Array.from(r.children);
          html += '<tr>';
          // SNO (sequential numbering starting from 1)
          html += `<td style="border:1px solid #999;padding:3px;text-align:center;width:${colWidths[0]};">${idx + 1}.</td>`;
          // Original cells (DEPT, DESIGNATION, FACULTY NAME, percentages, rating - no checkbox to skip)
          for (let i = 0; i < cells.length; i++) {
            html += `<td style="border:1px solid #999;padding:3px;text-align:center;width:${colWidths[i + 1]};">${cells[i].innerHTML}</td>`;
          }
          // Empty FACULTY SIGNATURE column (no line)
          html += `<td style="border:1px solid #999;padding:8px 3px;text-align:center;width:${colWidths[11]};height:30px;"></td>`;
          html += '</tr>';
          
          // Add page break after every 8 rows (except the last row)
          if ((idx + 1) % 8 === 0 && idx < selectedRows.length - 1) {
            html += `</tbody></table>`;
            html += `<div style="page-break-after:always;"></div>`;
            // Repeat header on new page
            html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid #ccc;padding-bottom:8px;">`;
            html += `<div style="width:80px;"><img src="/static/img/pmc.jpg" style="width:80px;height:auto;" /></div>`;
            html += `<div style="flex:1;text-align:center;">`;
            html += `<h1 style="margin:0;color:#1e40af;font-size:18px;font-weight:700;text-transform:uppercase;">CONSOLIDATED PERFORMANCE SUMMARY</h1>`;
            html += `<div style="margin-top:4px;font-size:13px;font-weight:600;color:#374151;">DEPARTMENT: ${deptLabel} | ${currentYear}-${nextYear} | MONTH: ${monthLabel.toUpperCase()} ${currentYear}</div>`;
            html += `</div></div>`;
            html += `<div style="margin-bottom:6px;font-size:11px;font-weight:600;">DATE: ${formattedDate}</div>`;
            html += `<table style="width:100%;border-collapse:collapse;font-size:9px;margin-bottom:10px;">`;
            html += `<thead>${theadHTML}</thead>`;
            html += '<tbody>';
          }
        });

        html += '</tbody></table>';
        
        // Signature section at the bottom
        html += `<div style="margin-top:40px;display:flex;justify-content:space-around;align-items:flex-end;">`;
        html += `<div style="text-align:center;"><div style="font-size:14px;font-weight:700;padding-top:5px;width:180px;">HOD</div></div>`;
        html += `<div style="text-align:center;"><div style="font-size:14px;font-weight:700;padding-top:5px;width:180px;">PRINCIPAL</div></div>`;
        html += `</div>`;

        wrapper.innerHTML = html;
        document.body.appendChild(wrapper);

        const opt = {
          margin: [5, 5, 5, 5],
          filename: `Consolidated_Summary_${deptLabel}_${monthLabel}_${new Date().toISOString().split('T')[0]}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, allowTaint: true, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
          pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        await html2pdf().set(opt).from(wrapper).save();
        wrapper.remove();
      } catch (err) {
        console.error('PDF export error:', err);
        alert('Failed to export PDF.');
      }
    }

    // Initialize tables
    loadDashboardTable();
    loadCoreScopeTable();
    loadDepartmentPortfolios();
    loadConsolidatedSummaryTable();
    
    // Modal logic
    function closeViewFormModal() {
      document.getElementById('viewFormModal').classList.add('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '';
      document.getElementById('viewFormModalTitle').textContent = 'Faculty Form Details';
    }

    // View yearly faculty form logic
    async function viewYearlyFacultyForm(designation, facultyName, dept) {
      document.getElementById('viewFormModal').classList.remove('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      
      let tableName = '';
      let deptField = '';
      if (designation === 'AP') { 
        tableName = 'AP(Yearly)'; 
        deptField = 'Department';
      } else if (designation === 'ASP') { 
        tableName = 'ASP(Yearly)'; 
        deptField = 'Department';
      } else if (designation === 'Prof') { 
        tableName = 'Prof(Yearly)'; 
        deptField = 'Department';
      } else {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      
      // Fetch all entries for this department from yearly table
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq(deptField, dept);
        
      if (error || !data || data.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      
      // Find latest entry by faculty name
      const nameTrimmed = (facultyName || '').toString().trim().toLowerCase();
      let filtered = data.filter(row => {
        let rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        return rowName === nameTrimmed;
      });
      
      if (filtered.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">No form data found for this faculty name.</div>';
        return;
      }
      
      // Get latest by input_id
      filtered.sort((a, b) => (b.input_id || 0) - (a.input_id || 0));
      const row = filtered[0];
      // Render modal with section headers from form HTML
      let html = '';
      // Top info
      html += `<div class="mb-4">
        <div class="font-semibold text-purple-700">Department:</div>
        <div class="mb-2">${row['Department'] || row['Department:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      // Section headings and fields
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Board of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        // For ASP and Prof, you can add their respective section headings here
        // For brevity, using AP headings as placeholder
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Board of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      // Render each section with heading
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        let fileUrl = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '';
        let fileHtml = '-';
        if (fileUrl && typeof fileUrl === 'string' && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {
          fileHtml = `<a href="${fileUrl}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-xs font-semibold">View</a>`;
        } else if (fileUrl) {
          fileHtml = fileUrl;
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-purple-700">Status:</span> ${row[`Status_${i}`] || '-'}</div>
            <div><span class="font-medium text-purple-700">Description:</span> ${row[`Description_${i}`] || '-'}</div>
            <div><span class="font-medium text-purple-700">Upload:</span> ${fileHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewFormModalContent').innerHTML = html;
      document.getElementById('viewFormModalTitle').textContent = `${designation} Form Details`;
    }
  </script>
  <footer class="text-center py-4 mt-8">
    <p class="text-sm">
      &copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br>
      <p class="text-xs opacity-80 flex items-center justify-center gap-2">
                        Powered by 
                        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
                            <img src="../static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
                        </a><p class="text-xs opacity-80">A Student driven Software!</p>
    </p>
  </footer>
</body>
</html>
