<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOD Dashboard - Faculty Core Scope Compliance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-pmcBg min-h-screen">
  <header class="bg-purple-700 text-white w-full">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center">
        <img src="https://tse1.mm.bing.net/th/id/OIP.paY-ha-IpNQJrH2Lz_JZEgHaDG?w=2560&h=1070&rs=1&pid=ImgDetMain&o=7&rm=3" alt="PMC Logo" class="h-12 rounded shadow bg-white p-1" />
        <span class="ml-4 text-xl font-bold">HOD Dashboard</span>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Faculty Portfolio Status Table -->
    <h2 class="text-2xl font-bold text-blue-700 mt-12 mb-6">Faculty Portfolio Status Table</h2>
    <div class="mb-6 flex flex-wrap gap-4 items-center">
      <label for="statusDesignationFilter" class="font-medium text-blue-700 mr-2">Filter by Designation:</label>
      <select id="statusDesignationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
    </div>
    <div id="facultyStatusTableContainer" class="overflow-x-auto"></div>
    <!-- Modal for viewing AP/ASP/Prof form details from status table -->
    <div id="viewStatusFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewStatusFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewStatusFormModalTitle" class="text-xl font-bold mb-4 text-blue-700">Faculty Portfolio Form Details</h3>
        <div id="viewStatusFormModalContent"></div>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-purple-700 mb-6">Faculty Core Scope Compliance Table</h2>
    <div class="mb-6">
      <label for="designationFilter" class="font-medium text-purple-700 mr-2">Filter by Designation:</label>
      <select id="designationFilter" class="p-2 border rounded">
        <option value="All">All</option>
        <option value="AP">Assistant Professor (AP)</option>
        <option value="ASP">Associate Professor (ASP)</option>
        <option value="Prof">Professor (Prof)</option>
      </select>
    </div>
    <div id="dashboardTableContainer" class="overflow-x-auto"></div>
  <!-- Department Portfolios Table -->
  <div id="departmentPortfoliosStickyHeader" class="flex flex-wrap gap-4 items-center mb-4 bg-white z-20 mt-10" style="position:sticky; top:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
    <h3 class="text-xl font-bold text-orange-500">Department Portfolios</h3>
    <label for="portfolioFrequencyFilter" class="font-medium text-orange-700 mr-2">Frequency:</label>
    <select id="portfolioFrequencyFilter" class="p-2 border rounded">
      <option value="Weekly">Weekly (Current Week)</option>
      <option value="Monthly">Monthly</option>
      <option value="OnceIn3Months">Once in 3 Months</option>
      <option value="OnceIn2Months">Once in 2 Months</option>
      <option value="OnceIn15Days">Once in 15 Days</option>
      <option value="Semester">Once in a Semester</option>
      <option value="Year">Once in a Year</option>
      <option value="All">All</option>
    </select>
    <div id="weeklyDateFilters" class="flex gap-2 items-center" style="display: none;">
      <label for="weekStartDate" class="font-medium text-orange-700">Week Start:</label>
      <input type="date" id="weekStartDate" class="p-2 border rounded text-sm">
      <label for="weekEndDate" class="font-medium text-orange-700">Week End:</label>
      <input type="date" id="weekEndDate" class="p-2 border rounded text-sm">
      <button id="applyWeekFilter" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm">Apply</button>
      <button id="resetToCurrentWeek" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">Current Week</button>
    </div>
    <label for="portfolioStatusFilter" class="font-medium text-orange-700 mr-2">Show:</label>
    <select id="portfolioStatusFilter" class="p-2 border rounded">
      <option value="All">All</option>
      <option value="Completed">Completed</option>
      <option value="Pending">Pending</option>
    </select>
  </div>
  <div id="departmentPortfoliosContainer" class="overflow-x-auto mt-2"></div>
    <!-- Modal for viewing original form -->
    <div id="viewFormModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewFormModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
        <h3 id="viewFormModalTitle" class="text-xl font-bold mb-4 text-purple-700">Faculty Form Details</h3>
        <div id="viewFormModalContent"></div>
      </div>
    </div>
  </main>
  <script src="/static/javascript/form-modal-mapper.js"></script>
  <script>
    function closeViewStatusFormModal() {
      document.getElementById('viewStatusFormModal').classList.add('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '';
      document.getElementById('viewStatusFormModalTitle').textContent = 'Faculty Portfolio Form Details';
    }

    async function viewStatusFacultyForm(designation, facultyName, department) {
      document.getElementById('viewStatusFormModal').classList.remove('hidden');
      document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      let nameField = '';
      let deptField = '';
      if (designation === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
      else if (designation === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else if (designation === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = 'Department:'; }
      else {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq(deptField, department)
        .eq(nameField, facultyName)
        .order('input_id', { ascending: false });
      if (error || !data || data.length === 0) {
        document.getElementById('viewStatusFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      const row = data[0];
      let html = '';
      html += `<div class="mb-4">
        <div class="font-semibold text-blue-700">Department:</div>
        <div class="mb-2">${row[deptField] || row['Department:'] || row['Department'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-blue-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        const statusVal = row[`Status_${i}`] || '-';
        const descVal = row[`Description_${i}`] || '-';
        let uploadVal = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '-';
        let uploadHtml = '-';
        if (uploadVal && uploadVal !== '-' && typeof uploadVal === 'string') {
          const isUrl = uploadVal.startsWith('http://') || uploadVal.startsWith('https://');
          const isFile = uploadVal.match(/\.(pdf|docx?|xlsx?|jpg|jpeg|png)$/i);
          if (isUrl || isFile) {
            uploadHtml = `<a href="${uploadVal}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-sm font-semibold inline-block">View</a>`;
          } else {
            uploadHtml = uploadVal;
          }
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-blue-700">Status:</span> ${statusVal}</div>
            <div><span class="font-medium text-blue-700">Description:</span> ${descVal}</div>
            <div><span class="font-medium text-blue-700">Upload:</span> ${uploadHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewStatusFormModalContent').innerHTML = html;
      document.getElementById('viewStatusFormModalTitle').textContent = `${designation} Portfolio Form Details`;
    }
    let selectedStatusDesignation = 'All';
    document.addEventListener('DOMContentLoaded', function() {
      const statusDesigSel = document.getElementById('statusDesignationFilter');
      if (statusDesigSel) {
        statusDesigSel.addEventListener('change', () => {
          selectedStatusDesignation = statusDesigSel.value;
          loadFacultyStatusTableHOD();
        });
      }
      loadFacultyStatusTableHOD();
    });
    async function loadFacultyStatusTableHOD() {
      const department = (function() {
        const url = new URL(window.location.href);
        return url.searchParams.get('department') || localStorage.getItem('department') || '';
      })();
      if (!department) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data: facultyList, error: facErr } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', department);
      if (facErr || !facultyList || facultyList.length === 0) {
        document.getElementById('facultyStatusTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      const apScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Present at conferences.',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Attend FDP/ workshops/ seminar.',
        'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
      ];
      const apGeneralIdx = [1,2,3,4,5,6,7,8,9,12,13,14,20,21,22];
      const aspScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const aspGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      const profScopes = [
        'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
        'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
        'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
        'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
        'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
        'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
        'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
        'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
        'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
        'Research and Development: Publish in peer-reviewed journals',
        'Research and Development: Apply for research grants',
        'Research and Development: Guide student research and final-year projects',
        'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
        'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
        'Institutional Development: Serve on academic and administrative committees.',
        'Professional Development: Organize FDP/ workshops/ seminar.',
        'Professional Development: NPTEL/MOOC and certifications.',
        'Professional Development: Memberships in professional bodies.',
        'Community and Industry Engagement: Facilitate MoUs',
        'Community and Industry Engagement: Engage in consultancy',
        'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
        'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
        'Memberships in professional bodies.'
      ];
      const profGeneralIdx = [1,2,3,4,5,6,7,8,9,13,14,15,20,21];
      for (const key of ['AP', 'ASP', 'Prof']) {
        if (selectedStatusDesignation !== 'All' && selectedStatusDesignation !== key) continue;
        const group = groups[key];
        if (group.length === 0) continue;
        html += `<h3 class="text-xl font-semibold text-blue-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
        // Table header
        html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-blue-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
        let scopes = [];
        let generalIdx = [];
        if (key === 'AP') { scopes = apScopes; generalIdx = apGeneralIdx; }
        else if (key === 'ASP') { scopes = aspScopes; generalIdx = aspGeneralIdx; }
        else if (key === 'Prof') { scopes = profScopes; generalIdx = profGeneralIdx; }
        for (let idx of generalIdx) {
          let desc = scopes[idx-1] ? scopes[idx-1].trim() : '';
          if (key === 'AP' && idx === 22) {
            desc = scopes[21] || 'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.';
          }
          html += `<th class="px-4 py-2" title="${desc}">${desc ? desc : 'Status ' + idx}</th>`;
        }
        html += `</tr></thead><tbody>`;
        for (const fac of group) {
          let tableName = '';
          let nameField = '';
          let deptField = '';
          if (key === 'AP') { tableName = 'AP'; nameField = 'Portfolio Member Name'; deptField = 'Department'; }
          else if (key === 'ASP') { tableName = 'ASP'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          else if (key === 'Prof') { tableName = 'Prof'; nameField = 'Portfolio Member Name'; deptField = '"Department:"'; }
          let { data: rows, error: rowErr } = await supabaseClient
            .from(tableName)
            .select('*')
            .eq(deptField, department)
            .order('input_id', { ascending: false });
          let facNamesToTry = [];
          if (fac['Portfolio Member Name']) facNamesToTry.push(fac['Portfolio Member Name']);
          if (fac.Name) facNamesToTry.push(fac.Name);
          if (fac.email) facNamesToTry.push(fac.email);
          facNamesToTry = Array.from(new Set(facNamesToTry.map(n => (n || '').toString().trim().toLowerCase()).filter(Boolean)));
          let row = null;
          if (rows && rows.length > 0) {
            for (let r of rows) {
              let possibleRowNames = [
                r['Portfolio Member Name'],
                r['Portfolio Member Name:'],
                r['Portfolio Memeber Name'],
                r['faculty_name'],
                r['Faculty Name'],
                r['Name'],
                r['email']
              ].map(x => (x || '').toString().trim().toLowerCase()).filter(Boolean);
              let rowDept = (r['Department:'] || r['Department'] || '').toString().trim().toLowerCase();
              let matchDept = (department || '').toString().trim().toLowerCase();
              if (rowDept === matchDept && facNamesToTry.some(n => possibleRowNames.includes(n))) {
                row = r;
                break;
              }
            }
          }
          html += `<tr><td class="px-2 py-2 font-medium text-blue-700 cursor-pointer underline" onclick="viewStatusFacultyForm('${key}','${(fac.Name || '').replace(/'/g, "\'")}', '${department.replace(/'/g, "\'")}')">${fac.Name || fac['Portfolio Member Name'] || fac.email || ''}</td>`;
          for (let idx of generalIdx) {
            let statusVal = row ? (row[`Status_${idx}`] || row[`Status_${idx}`] || '-') : '-';
            let display = '-';
            let statusClass = '';
            if (statusVal && typeof statusVal === 'string') {
              const val = statusVal.trim().toLowerCase();
              if (val === 'completed') {
                display = 'Completed';
                statusClass = 'text-green-600 font-semibold';
              } else if (val === 'in progress' || val === 'inprogress' || val === 'underprocess' || val === 'under process') {
                display = statusVal;
                statusClass = 'text-yellow-600 font-semibold';
              } else if (val === 'yet to be completed' || val === 'not started' || val === 'no' || val === 'incomplete') {
                display = statusVal;
                statusClass = 'text-red-600 font-semibold';
              } else if (val === '-' || val === '' || val === null) {
                display = '-';
                statusClass = 'text-gray-500';
              } else {
                display = statusVal;
                statusClass = 'text-blue-600 font-semibold';
              }
            } else {
              display = '-';
              statusClass = 'text-gray-500';
            }
            html += `<td class="px-2 py-2 ${statusClass}">${display}</td>`;
          }
          html += `</tr>`;
        }
        html += `</tbody></table></div>`;
      }
      document.getElementById('facultyStatusTableContainer').innerHTML = html || '<div class="text-gray-500">No status data found.</div>';
    }
  </script>
  <script>
    // Fetch and render department portfolios table (HOD)
    async function loadDepartmentPortfolios() {
      // Fetch all faculty
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*');
      if (error || !data || data.length === 0) {
        document.getElementById('departmentPortfoliosContainer').innerHTML = '<div class="text-red-500">Failed to load department portfolios.</div>';
        return;
      }
      
      // Filter for current department only
      const currentDept = department;
      
      // Get frequency and status filters
      const frequencyFilter = document.getElementById('portfolioFrequencyFilter');
      const selectedFrequency = frequencyFilter ? frequencyFilter.value : 'Weekly';
      const statusFilter = document.getElementById('portfolioStatusFilter');
      const selectedStatus = statusFilter ? statusFilter.value : 'All';
      
      // Show/hide date filters based on frequency
      const weeklyDateFilters = document.getElementById('weeklyDateFilters');
      if (selectedFrequency === 'Weekly') {
        weeklyDateFilters.style.display = 'flex';
        // Set default current week dates if not already set
        const weekStartInput = document.getElementById('weekStartDate');
        const weekEndInput = document.getElementById('weekEndDate');
        if (!weekStartInput.value || !weekEndInput.value) {
          setCurrentWeekDates();
        }
      } else {
        weeklyDateFilters.style.display = 'none';
      }
      
      // Table mapping for each frequency
      if (!window._hodTableMap) {
        window._hodTableMap = {
          Weekly: [
            'form1-Weekly', 'form2-weekly', 'form3-Weekly', 'form4-Weekly', 'form5-weekly', 'form6_weekly', 'form7-Weekly', 'form8-weekly'
          ],
          Monthly: [
            'form2-once in a month', 'form4-once in a month'
          ],
          OnceIn3Months: [
            'form5-Once in a 3 Months', 'form8-once in 3 Months'
          ],
          OnceIn2Months: [
            'form6-once in 2 month', 'form7-Once in 2 Months'
          ],
          OnceIn15Days: [
            'form1-once in 15 days', 'form3- once in 15 days'
          ],
          Semester: [
            'form1-once in a semester', 'form2-once in a semester', 'form3-once in a semester', 'form4-once in a semester', 'form5-once in a semester', 'form6-once in a semester', 'form7-Once in a Semester', 'form8-Once in Semester'
          ],
          Year: [
            'form1-once in a year'
          ],
          All: [
            'form1-Weekly', 'form2-weekly', 'form3-Weekly', 'form4-Weekly', 'form5-weekly', 'form6_weekly', 'form7-Weekly', 'form8-weekly',
            'form2-once in a month', 'form4-once in a month',
            'form5-Once in a 3 Months', 'form8-once in 3 Months',
            'form6-once in 2 month', 'form7-Once in 2 Months',
            'form1-once in 15 days', 'form3- once in 15 days',
            'form1-once in a semester', 'form2-once in a semester', 'form3-once in a semester', 'form4-once in a semester', 'form5-once in a semester', 'form6-once in a semester', 'form7-Once in a Semester', 'form8-Once in Semester',
            'form1-once in a year'
          ]
        };
      }
      
      // Portfolio headers mapping
      if (!window._hodPortfolioHeadersMap) {
        window._hodPortfolioHeadersMap = {
          Weekly: [
            { label: "1. Training & Placement", table: 'form1-Weekly' },
            { label: "2. Class Advisor", table: 'form2-weekly' },
            { label: "3. Info & Contribution", table: 'form3-Weekly' },
            { label: "4. Outcome & Exam Cell", table: 'form4-Weekly' },
            { label: "5. Continuous Improvement", table: 'form5-weekly' },
            { label: "6. T&L Process (IQAC)", table: 'form6_weekly' },
            { label: "7. Student Support", table: 'form7-Weekly' },
            { label: "8. Facilities & Lab", table: 'form8-weekly' }
          ],
          Monthly: [
            { label: "2. Class Advisor", table: 'form2-once in a month' },
            { label: "4. Outcome & Exam Cell", table: 'form4-once in a month' }
          ],
          OnceIn3Months: [
            { label: "5. Continuous Improvement", table: 'form5-Once in a 3 Months' },
            { label: "8. Facilities & Lab", table: 'form8-once in 3 Months' }
          ],
          OnceIn2Months: [
            { label: "6. T&L Process (IQAC)", table: 'form6-once in 2 month' },
            { label: "7. Student Support", table: 'form7-Once in 2 Months' }
          ],
          OnceIn15Days: [
            { label: "1. Training & Placement", table: 'form1-once in 15 days' },
            { label: "3. Info & Contribution", table: 'form3- once in 15 days' }
          ],
          Semester: [
            { label: "1. Training & Placement", table: 'form1-once in a semester' },
            { label: "2. Class Advisor", table: 'form2-once in a semester' },
            { label: "3. Info & Contribution", table: 'form3-once in a semester' },
            { label: "4. Outcome & Exam Cell", table: 'form4-once in a semester' },
            { label: "5. Continuous Improvement", table: 'form5-once in a semester' },
            { label: "6. T&L Process (IQAC)", table: 'form6-once in a semester' },
            { label: "7. Student Support", table: 'form7-Once in a Semester' },
            { label: "8. Facilities & Lab", table: 'form8-Once in Semester' }
          ],
          Year: [
            { label: "1. Training & Placement", table: 'form1-once in a year' }
          ],
          All: [
            { label: "1. Training & Placement", table: 'form1-Weekly' },
            { label: "2. Class Advisor", table: 'form2-weekly' },
            { label: "3. Info & Contribution", table: 'form3-Weekly' },
            { label: "4. Outcome & Exam Cell", table: 'form4-Weekly' },
            { label: "5. Continuous Improvement", table: 'form5-weekly' },
            { label: "6. T&L Process (IQAC)", table: 'form6_weekly' },
            { label: "7. Student Support", table: 'form7-Weekly' },
            { label: "8. Facilities & Lab", table: 'form8-weekly' },
            { label: "2. Class Advisor", table: 'form2-once in a month' },
            { label: "4. Outcome & Exam Cell", table: 'form4-once in a month' },
            { label: "5. Continuous Improvement", table: 'form5-Once in a 3 Months' },
            { label: "8. Facilities & Lab", table: 'form8-once in 3 Months' },
            { label: "6. T&L Process (IQAC)", table: 'form6-once in 2 month' },
            { label: "7. Student Support", table: 'form7-Once in 2 Months' },
            { label: "1. Training & Placement", table: 'form1-once in 15 days' },
            { label: "3. Info & Contribution", table: 'form3- once in 15 days' },
            { label: "1. Training & Placement", table: 'form1-once in a semester' },
            { label: "2. Class Advisor", table: 'form2-once in a semester' },
            { label: "3. Info & Contribution", table: 'form3-once in a semester' },
            { label: "4. Outcome & Exam Cell", table: 'form4-once in a semester' },
            { label: "5. Continuous Improvement", table: 'form5-once in a semester' },
            { label: "6. T&L Process (IQAC)", table: 'form6-once in a semester' },
            { label: "7. Student Support", table: 'form7-Once in a Semester' },
            { label: "8. Facilities & Lab", table: 'form8-Once in Semester' },
            { label: "1. Training & Placement", table: 'form1-once in a year' }
          ]
        };
      }
      
      const portfolioHeadersMap = window._hodPortfolioHeadersMap;
      const headers = portfolioHeadersMap[selectedFrequency] || [];
      const facultyList = data.filter(fac => (fac.department || 'Unknown') === currentDept);
      
      let html = '';
      html += '<div style="position:sticky; top:0; z-index:30; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.04);">';
      html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px;">';
      html += '<thead class="bg-orange-100 text-orange-700">';
      html += '<tr style="position:sticky; top:56px; background:#FEF3C7; z-index:20;">';
      html += '<th class="px-1 py-1 border border-gray-400" style="width:90px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">Department</th>';
      for (const h of headers) html += `<th class="px-1 py-1 border border-gray-400" style="width:120px; position:sticky; top:56px; background:#FEF3C7; z-index:21;">${h.label}</th>`;
      html += '</tr></thead></table>';
      html += '</div>';
      html += '<div style="overflow-x:auto; max-height:500px; overflow-y:auto;">';
      html += '<table class="w-full text-xs border border-gray-400 rounded-lg overflow-hidden shadow-sm bg-white" style="table-layout:fixed; font-size:12px; margin-top:-1px;">';
      html += '<tbody>';
      html += `<tr>`;
      html += `<td class="px-1 py-1 font-semibold text-purple-700 border border-gray-400" style="word-break:break-word;">${currentDept}</td>`;
      for (const h of headers) {
        const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
        html += `<td class="px-1 py-1 border border-gray-400" style="word-break:break-word;">`;
        const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
        if (assignedList.length > 0) {
          for (const fac of assignedList) {
            const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
            html += `<div class="flex items-center gap-1" style="font-size:11px;">
              <span id="portfolio-status-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}" class="inline-block"></span>
              ${facultyName}
            </div>`;
          }
        } else {
          html += '-';
        }
        html += `</td>`;
      }
      html += '</tr>';
      html += '</tbody></table></div>';
      document.getElementById('departmentPortfoliosContainer').innerHTML = html;

      // Async tick/cross logic for assigned faculty
      for (const h of headers) {
        const formKey = h.label.match(/\d+/) ? `form${h.label.match(/\d+/)[0]}` : '';
        const tableName = h.table;
        const assignedList = facultyList.filter(fac => (fac[formKey] && fac[formKey].trim().toLowerCase() === 'yes'));
        for (const fac of assignedList) {
          const facultyName = fac.Name || fac['Portfolio Member Name'] || fac.email;
          const statusSpanId = `portfolio-status-${formKey}-${facultyName.replace(/[^a-zA-Z0-9]/g, '')}`;
          (async () => {
            let filled = false;
            let query = supabaseClient.from(tableName).select('*').eq('Department', currentDept);
            
            // If frequency is Weekly, filter by date range
            if (selectedFrequency === 'Weekly') {
              const weekStartInput = document.getElementById('weekStartDate');
              const weekEndInput = document.getElementById('weekEndDate');
              
              if (weekStartInput.value && weekEndInput.value) {
                // Use custom date range
                const startDate = new Date(weekStartInput.value);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(weekEndInput.value);
                endDate.setHours(23, 59, 59, 999);
                
                const startStr = startDate.toISOString();
                const endStr = endDate.toISOString();
                
                query = query
                  .gte('submitted_at', startStr)
                  .lte('submitted_at', endStr);
              } else {
                // Fallback to current week
                const now = new Date();
                const currentDay = now.getDay();
                const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
                const monday = new Date(now);
                monday.setDate(now.getDate() + mondayOffset);
                monday.setHours(0, 0, 0, 0);
                
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                
                const mondayStr = monday.toISOString();
                const sundayStr = sunday.toISOString();
                
                query = query
                  .gte('submitted_at', mondayStr)
                  .lte('submitted_at', sundayStr);
              }
            }
            
            const { data: formData, error } = await query;
            if (!error && formData && formData.length > 0) {
              filled = formData.some(row => {
                const rowName = row['Portfolio Member Name'] || row['Portfolio Memeber Name'] || row['faculty_name'] || row['Faculty Name'] || row['Name'] || '';
                return rowName.toString().trim().toLowerCase() === facultyName.toString().trim().toLowerCase();
              });
            }
            const statusSpan = document.getElementById(statusSpanId);
            if (statusSpan) {
              // Filter by status
              if (selectedStatus === 'Completed' && !filled) {
                statusSpan.parentElement.style.display = 'none';
                return;
              }
              if (selectedStatus === 'Pending' && filled) {
                statusSpan.parentElement.style.display = 'none';
                return;
              }
              statusSpan.innerHTML = filled
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
            }
          })();
        }
      }

      // Add filter event listeners
      const frequencyFilterEl = document.getElementById('portfolioFrequencyFilter');
      const statusFilterEl = document.getElementById('portfolioStatusFilter');
      frequencyFilterEl.onchange = statusFilterEl.onchange = () => loadDepartmentPortfolios();
      
      // Setup date filter event listeners
      if (!document.getElementById('applyWeekFilter').dataset.listenerAdded) {
        document.getElementById('applyWeekFilter').addEventListener('click', () => {
          loadDepartmentPortfolios();
        });
        
        document.getElementById('resetToCurrentWeek').addEventListener('click', () => {
          setCurrentWeekDates();
          loadDepartmentPortfolios();
        });
        
        document.getElementById('weekStartDate').addEventListener('change', () => {
          loadDepartmentPortfolios();
        });
        
        document.getElementById('weekEndDate').addEventListener('change', () => {
          loadDepartmentPortfolios();
        });
        
        document.getElementById('applyWeekFilter').dataset.listenerAdded = 'true';
      }
    }
    
    // Helper function to set current week dates
    function setCurrentWeekDates() {
      const now = new Date();
      const currentDay = now.getDay();
      const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset);
      
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      
      document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
      document.getElementById('weekEndDate').value = sunday.toISOString().split('T')[0];
    }
    const supabaseClient = window.supabase.createClient(
      "https://cbhodgwaazmjszkujrti.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    // Get department from query param or localStorage
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const departmentParam = getQueryParam('department');
    const department = departmentParam || localStorage.getItem('department') || '';
    // Fetch all faculty for department
    async function loadDashboardTable() {
      if (!department) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-gray-500">No department selected.</div>';
        return;
      }
      const { data, error } = await supabaseClient
        .from('Faculty')
        .select('*')
        .eq('department', department);
      if (error || !data || data.length === 0) {
        document.getElementById('dashboardTableContainer').innerHTML = '<div class="text-red-500">Failed to load faculty data.</div>';
        return;
      }
      renderDashboardTable(data);
    }
    // Render table for all faculty, grouped by designation
  function renderDashboardTable(facultyList) {
      const designationFilter = document.getElementById('designationFilter').value;
      // Group by designation
      const groups = { AP: [], ASP: [], Prof: [] };
      facultyList.forEach(fac => {
        const desig = (fac.Designation || '').toUpperCase();
        if (desig === 'AP' || desig === 'ASSISTANT PROFESSOR') groups.AP.push(fac);
        else if (desig === 'ASP' || desig === 'ASSOCIATE PROFESSOR') groups.ASP.push(fac);
        else if (desig === 'PROF' || desig === 'PROFESSOR') groups.Prof.push(fac);
      });
      let html = '';
      // Map particulars for each designation
      const particularsMap = {
        AP: [
          'Present at Conferences.',
          'Guide student research and final-year projects.',
          'Attend FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications 2/Sem',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in extension activities, and social outreach programs.',
          'Membership in professional body'
        ],
        ASP: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate industry-institute interaction through guest lectures, internships.',
          'Engage in Consultancy.',
          'Membership in professional body'
        ],
        Prof: [
          'Publish in peer-reviewed journals',
          'Apply for research grants',
          'Guide student research and final-year projects.',
          'Organize FDPs / workshop/Seminars',
          'NPTEL/ MOOC certifications',
          'Facilitate MoU',
          'Engage in Consultancy.',
          'Membership in professional body'
        ]
      };

      (async function renderDashboardAsync() {
        // Preload all compliance data for department
        const [apRes, aspRes, profRes] = await Promise.all([
          supabaseClient.from('ap_compliance').select('*').eq('department', department),
          supabaseClient.from('asp_compliance').select('*').eq('department', department),
          supabaseClient.from('prof_compliance').select('*').eq('department', department)
        ]);
        // For each faculty, keep only the latest entry (highest id) per email
        function getLatestRows(data) {
          const latest = {};
          data.forEach(row => {
            const email = row.faculty_email;
            if (!latest[email] || row.id > latest[email].id) {
              latest[email] = row;
            }
          });
          return Object.values(latest);
        }
        
        // New function: Get best compliance rows (completed if any, otherwise latest)
        function getBestComplianceRows(data) {
          const grouped = {};
          data.forEach(row => {
            const email = row.faculty_email;
            if (!grouped[email]) grouped[email] = [];
            grouped[email].push(row);
          });
          
          const result = [];
          Object.values(grouped).forEach(rows => {
            if (rows.length === 0) return;
            
            // Sort by ID (newest first)
            rows.sort((a, b) => (b.id || 0) - (a.id || 0));
            const latest = rows[0];
            
            // Create best compliance record
            const bestRecord = { ...latest };
            
            // For each compliance field, check if any record shows "completed"
            for (let i = 1; i <= 8; i++) { // Assuming max 8 compliance fields
              const fieldName = `compliance_${i}`;
              let hasCompleted = false;
              
              for (const row of rows) {
                const val = row[fieldName];
                if (val && val.trim().toLowerCase() === 'completed') {
                  hasCompleted = true;
                  break;
                }
              }
              
              if (hasCompleted) {
                bestRecord[fieldName] = 'completed';
              }
              // If no completed found, keep the latest record's value (already in bestRecord)
            }
            
            result.push(bestRecord);
          });
          
          return result;
        }
        const apDataLatest = getBestComplianceRows(apRes.data || []);
        const aspDataLatest = getBestComplianceRows(aspRes.data || []);
        const profDataLatest = getBestComplianceRows(profRes.data || []);
        for (const key of ['AP', 'ASP', 'Prof']) {
          if (designationFilter !== 'All' && designationFilter !== key) continue;
          const group = groups[key];
          if (group.length === 0) continue;
          html += `<h3 class="text-xl font-semibold text-purple-700 mt-8 mb-2">${key === 'AP' ? 'Assistant Professor (AP)' : key === 'ASP' ? 'Associate Professor (ASP)' : 'Professor (Prof)'}</h3>`;
          const particulars = particularsMap[key];
          // Table header: first column is 'Faculty Name', then particulars
          html += `<div class="overflow-x-auto mb-6"><table class="min-w-full text-sm border rounded-lg overflow-hidden shadow-sm bg-white"><thead class="bg-purple-700 text-white"><tr><th class="px-4 py-2">Faculty Name</th>`;
          particulars.forEach(particular => {
            html += `<th class="px-4 py-2">${particular}</th>`;
          });
          html += `</tr></thead><tbody>`;
          // For each faculty, show compliance for each particular
          for (const fac of group) {
            let complianceRow = null;
            if (key === 'AP') complianceRow = apDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'ASP') complianceRow = aspDataLatest.find(r => r.faculty_email === fac.email);
            else if (key === 'Prof') complianceRow = profDataLatest.find(r => r.faculty_email === fac.email);
            
            // Calculate percentage
            let totalMarks = 0;
            let obtainedMarks = 0;
            for (let i = 0; i < particulars.length; i++) {
              let compliance = complianceRow ? complianceRow[`compliance_${i+1}`] : null;
              if (compliance) {
                const val = compliance.trim().toLowerCase();
                if (val === 'completed') {
                  obtainedMarks += 3;
                } else if (val === 'in progress' || val === 'inprogress') {
                  obtainedMarks += 1;
                } else if (val === 'not started' || val === 'no' || val === 'incomplete') {
                  obtainedMarks += 0;
                }
              }
              totalMarks += 3; // Each field has max 3 marks
            }
            const percentage = totalMarks > 0 ? Math.round((obtainedMarks / totalMarks) * 100) : 0;
            
            html += `<tr><td class="px-2 py-2">
              <div class="font-medium text-purple-700 cursor-pointer underline" onclick="viewFacultyForm('${fac.email}','${key}','${fac.Name ? fac.Name.replace(/'/g, "\'") : ''}')">${fac.Name || ''}</div>
              <div class="text-sm ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'} font-semibold">${percentage}%</div>
            </td>`;
            
            for (let i = 0; i < particulars.length; i++) {
              let compliance = complianceRow ? complianceRow[`compliance_${i+1}`] : null;
              let complianceClass = '';
              let display = '-';
              if (compliance) {
                const val = compliance.trim().toLowerCase();
                if (val === 'completed') {
                  complianceClass = 'text-green-600 font-bold';
                  display = 'Completed';
                } else if (val === 'in progress' || val === 'inprogress') {
                  complianceClass = 'text-blue-600 font-bold';
                  display = 'In Progress';
                } else if (val === 'not started') {
                  complianceClass = 'text-orange-600 font-bold';
                  display = 'Not Started';
                } else if (val === 'no' || val === 'incomplete') {
                  complianceClass = 'text-red-600 font-bold';
                  display = 'Incomplete';
                } else {
                  complianceClass = 'text-gray-500';
                  display = val;
                }
              } else {
                complianceClass = 'text-gray-500';
              }
              html += `<td class="px-2 py-2 ${complianceClass}">${display}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table></div>`;
        }
        document.getElementById('dashboardTableContainer').innerHTML = html || '<div class="text-gray-500">No compliance data found.</div>';
      })();
    }
    document.getElementById('designationFilter').addEventListener('change', () => {
      loadDashboardTable();
    });
    loadDashboardTable();
  loadDepartmentPortfolios();
  loadDepartmentPortfolios();
    // Modal logic
    function closeViewFormModal() {
      document.getElementById('viewFormModal').classList.add('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '';
      document.getElementById('viewFormModalTitle').textContent = 'Faculty Form Details';
    }

    // View faculty form logic
    async function viewFacultyForm(email, designation, facultyName) {
      document.getElementById('viewFormModal').classList.remove('hidden');
      document.getElementById('viewFormModalContent').innerHTML = '<div class="text-center text-gray-500">Loading form data...</div>';
      let tableName = '';
      if (designation === 'AP') tableName = 'AP';
      else if (designation === 'ASP') tableName = 'ASP';
      else if (designation === 'Prof') tableName = 'Prof';
      else {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Unknown designation.</div>';
        return;
      }
      // Fetch all entries for this department from AP/ASP/Prof table
      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq('Department', department);
      if (error || !data || data.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">Form data not found.</div>';
        return;
      }
      // Find latest entry by faculty name
      const nameTrimmed = (facultyName || '').toString().trim().toLowerCase();
      let filtered = data.filter(row => {
        let rowName = (row['Portfolio Member Name'] || '').toString().trim().toLowerCase();
        return rowName === nameTrimmed;
      });
      if (filtered.length === 0) {
        document.getElementById('viewFormModalContent').innerHTML = '<div class="text-red-500">No form data found for this faculty name.</div>';
        return;
      }
      // Get latest by id
      filtered.sort((a, b) => (b.id || 0) - (a.id || 0));
      const row = filtered[0];
      // Render modal with section headers from form HTML
      let html = '';
      // Top info
      html += `<div class="mb-4">
        <div class="font-semibold text-purple-700">Department:</div>
        <div class="mb-2">${row['Department'] || row['Department:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Name:</div>
        <div class="mb-2">${row['Portfolio Name'] || row['Portfolio Name:'] || ''}</div>
        <div class="font-semibold text-purple-700">Portfolio Member Name:</div>
        <div class="mb-2">${row['Portfolio Member Name'] || ''}</div>
      </div>`;
      // Section headings and fields
      let sections = [];
      if (designation === 'AP') {
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      } else if (designation === 'ASP' || designation === 'Prof') {
        // For ASP and Prof, you can add their respective section headings here
        // For brevity, using AP headings as placeholder
        sections = [
          'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
          'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
          'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
          'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
          'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
          'Student Mentorship and Support: Monitor student attendance, performance, and well-being.',
          'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
          'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.',
          'Student Mentorship and Support: Consolidate innovative course material, Lab manuals',
          'Research and Development: Present at conferences.',
          'Research and Development: Guide student research and final-year projects',
          'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
          'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
          'Institutional Development: Serve on academic and administrative committees.',
          'Professional Development: Attend FDP/ workshops/ seminar.',
          'Professional Development: Pursue higher qualifications, NPTEL/MOOC and certifications, and memberships in professional bodies.',
          'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.',
          'Community and Industry Engagement: Engage in extension activities, and social outreach Programs.',
          'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
          'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
          'Administrative Duties: Submit the FPBA (Faculty performance Based Appraisal) along with the support documents on time.'
        ];
      }
      // Render each section with heading
      html += `<div class="space-y-4">`;
      for (let i = 1; i <= sections.length; i++) {
        let fileUrl = row[`Upload The Scanned File_${i}`] || row[`Upload the scanned file_${i}`] || '';
        let fileHtml = '-';
        if (fileUrl && typeof fileUrl === 'string' && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {
          fileHtml = `<a href="${fileUrl}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow text-xs font-semibold">View</a>`;
        } else if (fileUrl) {
          fileHtml = fileUrl;
        }
        html += `<div class="border-b pb-2 mb-2">
          <div class="font-semibold text-orange-500 mb-1">${i}. ${sections[i-1]}</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div><span class="font-medium text-purple-700">Status:</span> ${row[`Status_${i}`] || '-'}</div>
            <div><span class="font-medium text-purple-700">Description:</span> ${row[`Description_${i}`] || '-'}</div>
            <div><span class="font-medium text-purple-700">Upload:</span> ${fileHtml}</div>
          </div>
        </div>`;
      }
      html += `</div>`;
      document.getElementById('viewFormModalContent').innerHTML = html;
      document.getElementById('viewFormModalTitle').textContent = `${designation} Form Details`;
    }
  </script>
  <footer class="text-center py-4 mt-8">
    <div class="flex flex-col items-center gap-1">
      <span class="text-gray-400 text-sm">&copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br></span>
      <span class="text-gray-400 text-xs">Powered by 
        <a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
          <img src="static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
        </a>
      </span>
    </div>
  </footer>
</body>
</html>
