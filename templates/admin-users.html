<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="../static/img/pmc.jpg" alt="PMC Tech" class="h-10 w-auto rounded-lg">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-gray-900">User Management</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="admin-dashboard.html" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Users</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalUsers">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-user-tie text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Faculty</p>
                        <p class="text-2xl font-bold text-gray-900" id="facultyCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-user-graduate text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">HODs</p>
                        <p class="text-2xl font-bold text-gray-900" id="hodCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-crown text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Principals</p>
                        <p class="text-2xl font-bold text-gray-900" id="principalCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white p-6 rounded-lg shadow border mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Users</label>
                    <input type="text" id="searchInput" placeholder="Search by name or email..." 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Role</label>
                    <select id="roleFilter" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Roles</option>
                        <option value="faculty">Faculty</option>
                        <option value="hod">HOD</option>
                        <option value="principal">Principal</option>
                        <option value="iqac">IQAC</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <select id="deptFilter" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Departments</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow border">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">All Users</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportUsers()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button onclick="refreshUsers()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t">
                <div class="text-sm text-gray-700">
                    Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalCount">0</span> results
                </div>
                <div class="flex space-x-2">
                    <button id="prevBtn" onclick="previousPage()" class="px-3 py-2 border rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                        Previous
                    </button>
                    <span id="pageInfo" class="px-3 py-2">Page 1</span>
                    <button id="nextBtn" onclick="nextPage()" class="px-3 py-2 border rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">User Details</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="userModalContent">
                        <!-- User details will be populated here -->
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeModal()" class="px-4 py-2 border rounded-md hover:bg-gray-50">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseClient = window.supabase.createClient(
            "https://cbhodgwaazmjszkujrti.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
        );

        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        const pageSize = 10;

        // Load all users (adapted for your database structure)
        async function loadUsers() {
            try {
                // Load faculty using your actual column structure
                const { data: faculty, error: facultyError } = await supabaseClient
                    .from('Faculty')
                    .select('department, "Name", email, "Username", "Designation", "EmployeeID"');

                // Load HODs using your actual column structure
                const { data: hods, error: hodError } = await supabaseClient
                    .from('HOD')
                    .select('department, "Name", email, "Username", "Designation"');

                // Load Principals using your actual column structure
                const { data: principals, error: principalError } = await supabaseClient
                    .from('Principal')
                    .select('"Name", email, "Username"');

                // Load IQAC users
                const { data: iqac, error: iqacError } = await supabaseClient
                    .from('IQAC')
                    .select('*');

                // Load Management users
                const { data: management, error: managementError } = await supabaseClient
                    .from('Management')
                    .select('*');

                // Load Admin users
                const { data: admin, error: adminError } = await supabaseClient
                    .from('Admin')
                    .select('*');

                if (facultyError) console.log('Faculty error:', facultyError);
                if (hodError) console.log('HOD error:', hodError);
                if (principalError) console.log('Principal error:', principalError);

                // Combine all users with proper column access from schema
                allUsers = [
                    ...(faculty || []).map(u => ({
                        ...u,
                        role: 'Faculty',
                        displayName: u["Name"] || 'Unknown',
                        displayEmail: u.email || 'No email',
                        displayDepartment: u.department || 'Not specified',
                        displayDesignation: u["Designation"] || 'Faculty',
                        displayEmployeeID: u["EmployeeID"] || 'Not provided',
                        displayStatus: u.Status || 'Active'
                    })),
                    ...(hods || []).map(u => ({
                        ...u,
                        role: 'HOD',
                        displayName: u["Name"] || 'Unknown',
                        displayEmail: u.email || 'No email',
                        displayDepartment: u.department || 'Not specified',
                        displayDesignation: u["Designation"] || 'HOD',
                        displayEmployeeID: u["EmployeeID"] || 'Not provided',
                        displayStatus: u.Status || 'Active'
                    })),
                    ...(principals || []).map(u => ({
                        ...u,
                        role: 'Principal',
                        displayName: u["Name"] || 'Unknown',
                        displayEmail: u.email || 'No email',
                        displayDepartment: 'Administration',
                        displayDesignation: 'Principal',
                        displayEmployeeID: u["EmployeeID"] || 'Not provided',
                        displayStatus: u.Status || 'Active'
                    })),
                    ...(iqac || []).map(u => ({
                        ...u,
                        role: 'IQAC',
                        Name: u.Name || u.name || 'Unknown',
                        email: u.email || u.Email || 'No email',
                        Department: u.department || u.Department || 'IQAC',
                        Mobile: u.Mobile || u.mobile || u.phone || 'Not provided',
                        Status: u.Status || u.status || 'Active'
                    })),
                    ...(management || []).map(u => ({
                        ...u,
                        role: 'Management',
                        Name: u.Name || u.name || 'Unknown',
                        email: u.email || u.Email || 'No email',
                        Department: u.department || u.Department || 'Management',
                        Mobile: u.Mobile || u.mobile || u.phone || 'Not provided',
                        Status: u.Status || u.status || 'Active'
                    })),
                    ...(admin || []).map(u => ({
                        ...u,
                        role: 'Admin',
                        Name: u.Name || u.name || 'Administrator',
                        email: u.email || u.Email || 'No email',
                        Department: u.department || u.Department || 'Administration',
                        Mobile: u.Mobile || u.mobile || u.phone || 'Not provided',
                        Status: u.Status || u.status || 'Active'
                    }))
                ];

                // Update stats
                document.getElementById('totalUsers').textContent = allUsers.length;
                document.getElementById('facultyCount').textContent = faculty?.length || 0;
                document.getElementById('hodCount').textContent = hods?.length || 0;
                document.getElementById('principalCount').textContent = (principals?.length || 0) + (iqac?.length || 0) + (management?.length || 0) + (admin?.length || 0);

                // Load departments for filter
                loadDepartments();

                // Display users
                filteredUsers = [...allUsers];
                displayUsers();

            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users');
            }
        }

        // Load departments for filter
        function loadDepartments() {
            const departments = [...new Set(allUsers.map(u => u.Department).filter(d => d))];
            const deptFilter = document.getElementById('deptFilter');
            
            // Clear existing options except "All Departments"
            deptFilter.innerHTML = '<option value="all">All Departments</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
        }

        // Display users in table
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredUsers.length);
            const pageUsers = filteredUsers.slice(startIndex, endIndex);

            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            const usersHtml = pageUsers.map(user => {
                const statusClass = user.Status === 'Active' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 bg-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.displayName || 'N/A'}</div>
                                    <div class="text-sm text-gray-500">${user.displayEmail || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${user.displayDepartment || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>${user.Mobile || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${user.Status || 'Unknown'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewUser('${user.email}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = usersHtml;
            updatePagination();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredUsers.length);

            document.getElementById('showingFrom').textContent = filteredUsers.length > 0 ? startIndex : 0;
            document.getElementById('showingTo').textContent = endIndex;
            document.getElementById('totalCount').textContent = filteredUsers.length;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const deptFilter = document.getElementById('deptFilter').value;

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm));
                
                const matchesRole = roleFilter === 'all' || 
                    user.role.toLowerCase() === roleFilter.toLowerCase();
                
                const matchesDept = deptFilter === 'all' || 
                    user.displayDepartment === deptFilter;

                return matchesSearch && matchesRole && matchesDept;
            });

            currentPage = 1;
            displayUsers();
        }

        // View user details
        function viewUser(email) {
            const user = allUsers.find(u => u.email === email);
            if (!user) return;

            const modalContent = document.getElementById('userModalContent');
            modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <p class="mt-1 text-sm text-gray-900">${user.displayName || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <p class="mt-1 text-sm text-gray-900">${user.email || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role</label>
                        <p class="mt-1 text-sm text-gray-900">${user.role}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Department</label>
                        <p class="mt-1 text-sm text-gray-900">${user.displayDepartment || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mobile</label>
                        <p class="mt-1 text-sm text-gray-900">${user.Mobile || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <p class="mt-1 text-sm text-gray-900">${user.Status || 'Unknown'}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Employee ID</label>
                        <p class="mt-1 text-sm text-gray-900">${user.EmpId || user.employee_id || 'N/A'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayUsers();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredUsers.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayUsers();
            }
        }

        // Export users
        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Name,Email,Role,Department,Mobile,Status\n" +
                filteredUsers.map(user => 
                    `"${user.displayName || ''}","${user.displayEmail || ''}","${user.role}","${user.displayDepartment || ''}","${user.displayEmployeeID || ''}","${user.displayStatus || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `users_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh users
        function refreshUsers() {
            loadUsers();
        }

        // Show error
        function showError(message) {
            document.getElementById('usersTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    </td>
                </tr>
            `;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(applyFilters, 300);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadUsers);

        // Close modal when clicking outside
        document.getElementById('userModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <!-- Footer -->
    <footer class="text-center py-4 mt-8">
        <p class="text-gray-400 text-sm">
            ©&copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="text-gray-400 hover:text-gray-600 underline">PMC TECH</a>.<br>
            Developed by <a href="https://zeonytechnologies.netlify.app" target="_blank" class="text-gray-400 hover:text-gray-600 underline">Zeony Technologies</a>
        </p>
    </footer>
</body>
</html>
