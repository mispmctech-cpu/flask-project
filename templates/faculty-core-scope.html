<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Faculty Core Scope (Monthly)</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- Font Awesome for icons -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<!-- Prevent Double Submit Protection -->
	<script src="../static/javascript/prevent-double-submit.js"></script>
	<script src="../static/javascript/month-filter.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
	<style>
		th, td {
			font-size: 1rem;    
		}
		input:focus, select:focus {
			outline: none;
			box-shadow: 0 0 0 2px #a78bfa33;
			border-color: #a78bfa;
		}
		.bg-orange-400 {
			background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%);
		}
		.bg-purple-800 {
			background: linear-gradient(90deg, #6d28d9 0%, #7c3a    ed 100%);
		}
		input[type="file"]::-webkit-file-upload-button {
			background: #ede9fe;
			color: #6d28d9;
			border: 1px solid #a78bfa;
			border-radius: 0.5rem;
			padding: 0.25rem 1rem;
			font-weight: 500;
			transition: background 0.2s;
		}
		input[type="file"]::-webkit-file-upload-button:hover {
			background: #c4b5fd;
			color: #fff;
		}
		input[type="file"]::file-selector-button {
			background: #ede9fe;
			color: #6d28d9;
			border: 1px solid #a78bfa;
			border-radius: 0.5rem;
			padding: 0.25rem 1rem;
			font-weight: 500;
			transition: background 0.2s;
		}
		input[type="file"]::file-selector-button:hover {
			background: #c4b5fd;
			color: #fff;
		}
		select {
			background: #ffffff;
			cursor: pointer;
		}
		select option {
			padding: 8px;
		}
		/* Draft Popup Modal */
		.draft-modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 9999;
			align-items: center;
			justify-content: center;
		}
		.draft-modal.show {
			display: flex;
		}
		.draft-modal-content {
			background: white;
			padding: 2rem;
			border-radius: 1rem;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
			max-width: 500px;
			width: 90%;
			animation: slideIn 0.3s ease-out;
		}
		@keyframes slideIn {
			from {
				transform: translateY(-50px);
				opacity: 0;
			}
			to {
				transform: translateY(0);
				opacity: 1;
			}
		}
		label {
			letter-spacing: 0.05em;
		}
		.table-section-title {
			font-size: 1.1rem;
			font-weight: 700;
			letter-spacing: 0.04em;
			color: #fff;
			background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%);
			padding-left: 1rem;
		}
		@media (max-width: 900px) {
			th, td { font-size: 0.95rem; }
		}
		@media (max-width: 600px) {
			th, td { font-size: 0.9rem; }
		}
		/* File upload preview styles */
		.file-upload-container { position: relative; }
		.file-preview { 
			display: flex; 
			flex-direction: column;
			align-items: flex-start;
			gap: 6px; 
			margin-top: 8px; 
			padding: 10px 12px; 
			background: #f0fdf4; 
			border: 2px solid #86efac; 
			border-radius: 10px; 
			font-size: 0.85rem; 
		}
		.file-preview .file-name { 
			color: #166534; 
			font-weight: 500;
			word-break: break-all; 
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.file-preview .file-actions { display: flex; gap: 8px; margin-top: 4px; }
		.file-preview .btn-view, .file-preview .btn-replace, .file-preview .btn-remove { 
			padding: 5px 14px; 
			border-radius: 6px; 
			font-size: 0.8rem; 
			font-weight: 600;
			cursor: pointer; 
			border: none; 
			transition: all 0.2s; 
		}
		.file-preview .btn-view { background: #3b82f6; color: white; }
		.file-preview .btn-view:hover { background: #2563eb; }
		.file-preview .btn-replace { background: #f59e0b; color: white; }
		.file-preview .btn-replace:hover { background: #d97706; }
		.file-preview .btn-remove { background: #ef4444; color: white; }
		.file-preview .btn-remove:hover { background: #dc2626; }
	</style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
	<div class="flex-1 flex items-center justify-center py-8 px-2">
		<div class="w-full max-w-6xl mx-auto bg-white rounded-2xl card-shadow border border-purple-300 overflow-x-auto p-0">
			<div class="bg-purple-800 py-8 px-6 text-white text-center w-full rounded-t-2xl">
				<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT2R7bHsdVlhJda1oUOZ1NPc7lvacTuGPvHgg&s" alt="" class="h-16 mb-2" style="max-height:64px; float: left;" />
				<h1 class="text-2xl md:text-4xl font-extrabold tracking-wide mb-2 drop-shadow">Faculty Core Scope(Monthly) </h1>
			</div>
			<form id="facultyCoreScope" class="p-6 md:p-10 space-y-10 w-full">
				<div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-8 shadow-lg border-2 border-purple-200 mb-8">
					<!-- First Row: 3 Fields -->
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">DEPARTMENT</label>
							<input type="text" name="Department" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">PORTFOLIO NAME</label>
							<input type="text" name="Portfolio Name" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">PORTFOLIO MEMBER NAME</label>
							<input type="text" name="Portfolio Member Name" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
					</div>
					
					<!-- Second Row: 2 Fields -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">DESIGNATION</label>
							<select name="Designation" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium appearance-none cursor-pointer">
								<option value="">-- Select Designation --</option>
								<option>AP</option>
								<option>ASP</option>
								<option>PROF</option>
							</select>
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">MONTH</label>
							<select name="Month" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium appearance-none cursor-pointer">
								<option value="">-- Select Month --</option>
								<option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
							</select>
						</div>
					</div>
				</div>
				<div class="overflow-x-auto rounded-xl card-shadow border border-purple-100 bg-white w-full p-4">
					<table class="w-full min-w-[1200px] text-xs md:text-sm table-fixed">
						<colgroup>
							<col style="width: 4%">
							<col style="width: 32%">
							<col style="width: 12%">
							<col style="width: 12%">
							<col style="width: 28%">
							<col style="width: 12%">
						</colgroup>
						<thead class="bg-orange-400">
							<tr>
								<th class="border px-2 py-2 font-bold text-white">S.No</th>
								<th class="border px-2 py-2 font-bold text-white"> SCOPE</th>
								<th class="border px-2 py-2 font-bold text-white">TAT</th>
								<th class="border px-2 py-2 font-bold text-white">Status</th>
								<th class="border px-2 py-2 font-bold text-white">Description</th>
								<th class="border px-2 py-2 font-bold text-white">Upload</th>
							</tr>
						</thead>
						<tbody id="core-scope-table-body">
							<!-- JS will render 15 rows here -->
						</tbody>
					</table>
				</div>
				<div class="flex justify-center gap-4 mt-10">
					<button type="button" id="saveDraftBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200">
						<i class="fas fa-save mr-2"></i>Save as Draft
					</button>
					<button type="submit" class="bg-purple-800 hover:bg-purple-700 text-white font-bold py-3 px-12 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200">Submit</button>
				</div>
			</form>
			<!-- Draft loaded banner -->
			<div id="draftBanner" class="hidden fixed top-4 right-4 bg-blue-100 border-2 border-blue-500 text-blue-800 px-6 py-3 rounded-lg shadow-lg z-50">
				<i class="fas fa-info-circle mr-2"></i>Draft loaded - Continue editing or submit when ready
			</div>
			
			<!-- Draft Popup Modal -->
			<div id="draftModal" class="draft-modal">
				<div class="draft-modal-content">
					<h2 class="text-2xl font-bold text-purple-900 mb-4">
						<i class="fas fa-file-alt text-blue-600 mr-2"></i>Draft Found!
					</h2>
					<p class="text-gray-700 mb-2">You have a saved draft for this form.</p>
					<p class="text-sm text-gray-600 mb-6">
						<span class="font-semibold">Saved Month:</span> <span id="draftMonthInfo" class="text-blue-600"></span>
					</p>
					<p class="text-gray-700 mb-6">Would you like to load it and continue where you left off?</p>
					<div class="flex gap-4 justify-end">
						<button id="draftDeclineBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg transition-all">
							<i class="fas fa-times mr-2"></i>Start Fresh
						</button>
						<button id="draftAcceptBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-all">
							<i class="fas fa-check mr-2"></i>Load Draft
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Supabase JS CDN (load before using it) -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
	<script>
	// Global object to store draft file URLs
	window.draftFileUrls = {};
	
	// Store uploaded file URLs for preview
	const uploadedFiles = {};
	
	// File preview and management functions
	function viewFile(taskNum) {
		const fileUrl = uploadedFiles[taskNum];
		if (fileUrl) {
			window.open(fileUrl, '_blank');
		} else {
			alert('No file uploaded yet.');
		}
	}
	
	function replaceFile(taskNum) {
		const fileInput = document.querySelector(`.file-input-row[data-row="${taskNum}"]`);
		if (fileInput) {
			fileInput.value = '';
			fileInput.click();
		}
	}
	
	function removeFile(taskNum) {
		const preview = document.getElementById(`file-preview-${taskNum}`);
		const uploadBtn = document.querySelector(`.upload-btn[data-row="${taskNum}"]`);
		const fileInput = document.querySelector(`.file-input-row[data-row="${taskNum}"]`);
		
		if (preview) {
			preview.style.display = 'none';
		}
		if (uploadBtn) {
			uploadBtn.textContent = 'Upload';
			uploadBtn.className = 'upload-btn bg-purple-200 hover:bg-purple-300 text-purple-800 font-semibold px-3 py-1 rounded w-full transition';
			uploadBtn.disabled = false;
		}
		if (fileInput) {
			fileInput.value = '';
		}
		uploadedFiles[taskNum] = null;
		delete window.draftFileUrls[taskNum];
	}
	
	function updateFilePreview(taskNum, fileName, fileUrl) {
		const preview = document.getElementById(`file-preview-${taskNum}`);
		if (preview) {
			const nameSpan = preview.querySelector('.file-name span');
			if (nameSpan) {
				nameSpan.textContent = fileName;
			}
			preview.style.display = 'flex';
			uploadedFiles[taskNum] = fileUrl;
		}
	}
	
	// Autofetch using localStorage
	document.addEventListener('DOMContentLoaded', function() {
		var dept = localStorage.getItem('selectedDepartment') || '';
		var portfolio = localStorage.getItem('selectedPortfolio') || '';
		var member = localStorage.getItem('selectedMemberName') || '';
		var designation = localStorage.getItem('selectedDesignation') || '';
		var month = localStorage.getItem('selectedMonth') || '';
		const form = document.getElementById('facultyCoreScope');
		if (form) {
			const deptField = form.querySelector('input[name="Department"]');
			if (deptField && dept) {
				deptField.value = dept;
			}
			const portfolioField = form.querySelector('input[name="Portfolio Name"]');
			if (portfolioField && portfolio) {
				portfolioField.value = portfolio;
			}
			const memberField = form.querySelector('input[name="Portfolio Member Name"]');
			if (memberField && member) {
				memberField.value = member;
			}
			const designationField = form.querySelector('select[name="Designation"]');
			if (designationField && designation) {
				for (var i = 0; i < designationField.options.length; i++) {
					if (designationField.options[i].value === designation) {
						designationField.selectedIndex = i;
						break;
					}
				}
			}
			const monthField = form.querySelector('select[name="Month"]');
			if (monthField && month) {
				for (var i = 0; i < monthField.options.length; i++) {
					if (monthField.options[i].value === month) {
						monthField.selectedIndex = i;
						break;
					}
				}
			}
		}
	});

	// Table data from image (15 rows for Core Scope)
	const tableData = [
		{ 
			scope: 'Teaching & Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
			tat: 'END OF THE DAY',
			proof: 'Logbook record or Class work for the particular session (Write self Copy & Combine taking a snap along with the Timetable for the current day)',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
			tat: 'BEFORE 15 DAY OF START OF SEM',
			proof: 'ERP Lesson Plan pdf (Combined snap pdf merger for Theory and Lab upload)',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
			tat: 'END OF THE DAY',
			proof: 'Google Class Room (Updated), Sample PPT, Pdf, experiential learning methods used in the particular room. (Object or sample along with Timetable for the month (Combine Upload))',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
			tat: '25th OF MONTH',
			proof: 'Model snap with each and product photo in the month (Combine Upload)',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Act as academic mentor and guide 30 students on coursework, projects, and career planning.',
			tat: 'END OF THE DAY',
			proof: 'Updated individual student record of 30 students with marks and attendance in mentoring format per month. (Take snap of selected mentees class in Lms sample students snap) (Combined Snap as PDF)',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Monitor student attendance, performance, and well-being.',
			tat: 'END OF THE DAY',
			proof: 'Monthly Attendance % & Slow learners support classes attended and communication Mentor File 2 Proof with Parents',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
			tat: 'END OF FRIDAY',
			proof: 'Take the photos of students participated (Remedial) and Index page of Mentee Students Participation in Co&Ex Curricular activities of the Month',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Maintain the Mentor book for assigned mentee.',
			tat: 'END OF FRIDAY',
			proof: 'Consolidated snap of Mentor Book as PDF',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Consolidate innovative course material, Lab manuals',
			tat: '31ST DECEMBER',
			proof: 'Innovative Teaching Tool+ report, Innovative Lab Manual+ Proof, Use of Virtual lab (Combined pdf for Theory and Lab)',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Instution Developement: Participate in curriculum developement and revision through board of Studies',
			tat: 'BEFORE 45 DAY OF START OF SEM',
			proof: 'PAC, DAAC, BOS Attendance Page',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Contribute to accreditation processes (NBA),(NAAC) and quality Assurance initiatives.',
			tat: 'END OF FRIDAY',
			proof: 'Mentor note with date wise mentoring details of the Month',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Serve on academic and administrative committees. ',
			tat: 'AS PER SCHEDULE',
			proof: 'Type the List of other works allotted by HOD and Completed',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'ADMINISTRATIVE DUTIES : MAINTAIN ACADEMIC RECORDS, COURSE FILES, LOG BOOK AND STUDENT EVALUATIONS',
			tat: 'END OF THE DAY',
			proof: 'Write the Completed works Description related to Quality, ISO, NBA, NAAC File Maintenance. Upload with support documents in PDF',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.',
			tat: 'AS PER SCHEDULE',
			proof: 'Type the List of other works allotted by HOD and Completed as of the Month',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		},
		{ 
			scope: 'Library Utilization',
			tat: '25th of MONTH',
			proof: 'No of hours utilized in Library',
			statusOptions: ['Completed', 'In Progress', 'Yet to be Completed ', 'Not Applicable']
		}
	];

	// Render table rows
	const tbody = document.getElementById('core-scope-table-body');
	tableData.forEach((row, i) => {
		const idx = i + 1;
		const tr = document.createElement('tr');
		
		// Build status dropdown options
		let statusOptionsHTML = '<option value="">Select</option>';
		row.statusOptions.forEach(opt => {
			statusOptionsHTML += `<option>${opt}</option>`;
		});
		
		tr.innerHTML = `
			<td class="border px-2 py-1 text-center">${idx}</td>
			<td class="border px-2 py-1">${row.scope}</td>
			<td class="border px-2 py-1">${row.tat}</td>
			<td class="border px-2 py-1">
				<select name="Status_${idx}" class="w-full border rounded px-1 py-1">
					${statusOptionsHTML}
				</select>
			</td>
			<td class="border px-2 py-1">
				<input type="text" name="Description_${idx}" maxlength="500" class="w-full border rounded px-1 py-1" placeholder="${row.proof}" />
			</td>
		<td class="border px-2 py-1 file-upload-container">
			<button type="button" class="upload-btn bg-purple-200 hover:bg-purple-300 text-purple-900 font-semibold px-3 py-1 rounded w-full" data-row="${idx}">Upload</button>
			<input type="file" name="Upload The Scanned File_${idx}" accept=".pdf,.jpg,.jpeg,.png" class="hidden file-input-row" data-row="${idx}" />
			<div class="file-preview" id="file-preview-${idx}" style="display: none;">
				<div class="file-name">
					<i class="fas fa-file-alt"></i>
					<span id="file-name-${idx}">No file selected</span>
				</div>
				<div class="file-actions">
					<button type="button" class="btn-view" onclick="viewFile(${idx})">View</button>
					<button type="button" class="btn-replace" onclick="replaceFile(${idx})">Replace</button>
					<button type="button" class="btn-remove" onclick="removeFile(${idx})">Remove</button>
				</div>
			</div>
			</td>
		`;
		tbody.appendChild(tr);
	});

	// Supabase setup
	const supabase = window.supabase.createClient(
		"https://cbhodgwaazmjszkujrti.supabase.co",
		"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
	);

	async function uploadFileToStorage(file, path, bucket, uploadBtn) {
		if (!file) return null;
		const { data, error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true });
		if (error) throw error;
		// Get public URL
		const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(path);
		// Change the upload button to 'Uploaded' after successful upload
		if (uploadBtn) {
			const row = uploadBtn.getAttribute('data-row');
			const checkMark = document.querySelector(`.file-check[data-row="${row}"]`);
			
			uploadBtn.textContent = 'Uploaded';
			uploadBtn.className = 'bg-green-200 text-green-800 font-semibold px-3 py-1 rounded w-full';
			uploadBtn.disabled = true;
			
			// Store the uploaded file URL for later use during submission
			if (row) {
				window.draftFileUrls[row] = urlData.publicUrl;
			}
			
			// Show checkmark
			if (checkMark) {
				checkMark.classList.remove('hidden');
			}
		}
		return urlData.publicUrl;
	}

	// Handle upload button click
	document.addEventListener('click', function(e) {
		if (e.target && e.target.classList.contains('upload-btn')) {
			const row = e.target.getAttribute('data-row');
			const fileInput = document.querySelector(`input.file-input-row[data-row='${row}']`);
			if (fileInput) fileInput.click();
		}
	});

	// Handle file selection and upload
	document.addEventListener('change', async function(e) {
		if (e.target && e.target.classList.contains('file-input-row')) {
			const row = e.target.getAttribute('data-row');
			const file = e.target.files[0];
			if (!file) return;
			
			// Show preview immediately
			const tempUrl = URL.createObjectURL(file);
			updateFilePreview(row, file.name, tempUrl);
			
			const uploadBtn = document.querySelector(`button.upload-btn[data-row='${row}']`);
			const bucket = 'form1-files';
			const path = `corescope_${row}_${Date.now()}_${file.name}`;
			try {
				const publicUrl = await uploadFileToStorage(file, path, bucket, uploadBtn);
				// Update preview with actual URL after upload
				if (publicUrl) {
					uploadedFiles[row] = publicUrl;
				}
			} catch (err) {
				alert('Upload failed: ' + err.message);
				removeFile(row);
			}
		}
	});

	// Check for draft and show popup
	async function checkForDraft() {
		const form = document.getElementById('facultyCoreScope');
		const dept = form.querySelector('input[name="Department"]').value;
		const member = form.querySelector('input[name="Portfolio Member Name"]').value;
		
		if (!dept || !member) return;
		
		// Check for draft in Core_scope_drafts table
		const { data: drafts, error } = await supabase
			.from('Core_scope_drafts')
			.select('*')
			.eq('Department', dept)
			.eq('Portfolio Member Name', member)
			.order('created_at', { ascending: false })
			.limit(1);
		
		if (error || !drafts || drafts.length === 0) return;
		
		// Show popup asking if user wants to use draft
		showDraftPopup(drafts[0]);
	}

	function showDraftPopup(draft) {
		const modal = document.getElementById('draftModal');
		const draftMonth = draft.Month || 'Unknown';
		document.getElementById('draftMonthInfo').textContent = draftMonth;
		modal.classList.add('show');
		
		// Store draft for later use
		window.pendingDraft = draft;
	}

	// Load draft data into form
	function loadDraftData(draft) {
		const form = document.getElementById('facultyCoreScope');
		
		// Populate month if saved
		if (draft.Month) {
			const monthSelect = form.querySelector('select[name="Month"]');
			if (monthSelect) monthSelect.value = draft.Month;
		}
		
		// Populate designation if saved
		if (draft.Designation) {
			const designationSelect = form.querySelector('select[name="Designation"]');
			if (designationSelect) designationSelect.value = draft.Designation;
		}
		
		// Fill in all form fields from draft
		for (let i = 1; i <= 15; i++) {
			const statusSelect = form.querySelector(`select[name="Status_${i}"]`);
			const descInput = form.querySelector(`input[name="Description_${i}"]`);
			
			if (statusSelect && draft[`Status_${i}`]) {
				statusSelect.value = draft[`Status_${i}`];
			}
			if (descInput && draft[`Description_${i}`]) {
				descInput.value = draft[`Description_${i}`];
			}
			
			// If there's a file URL, show uploaded state
			if (draft[`Upload The Scanned File_${i}`]) {
				// Store draft file URL for later use during submission
				window.draftFileUrls[i] = draft[`Upload The Scanned File_${i}`];
				
				const uploadBtn = document.querySelector(`button.upload-btn[data-row="${i}"]`);
				const checkMark = document.querySelector(`.file-check[data-row="${i}"]`);
				if (uploadBtn) {
					uploadBtn.textContent = 'Uploaded';
					uploadBtn.className = 'bg-green-200 text-green-800 font-semibold px-3 py-1 rounded w-full';
					uploadBtn.disabled = true;
				}
				if (checkMark) {
					checkMark.classList.remove('hidden');
				}
			}
		}
		
		// Show draft banner
		const banner = document.getElementById('draftBanner');
		if (banner) {
			banner.classList.remove('hidden');
			setTimeout(() => banner.classList.add('hidden'), 5000);
		}
	}
	
	// Save as Draft function
	async function saveAsDraft() {
		const form = document.getElementById('facultyCoreScope');
		const formData = new FormData(form);
		
		const dept = formData.get('Department');
		const portfolio = formData.get('Portfolio Name');
		const member = formData.get('Portfolio Member Name');
		const designation = formData.get('Designation');
		const month = formData.get('Month');
		
		if (!dept || !member || !month) {
			alert('Please fill in Department, Portfolio Member Name, and Month to save as draft');
			return;
		}
		
		const saveDraftBtn = document.getElementById('saveDraftBtn');
		const originalText = saveDraftBtn.innerHTML;
		saveDraftBtn.disabled = true;
		saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
		
		try {
			const draftData = {
				"Department": dept,
				"Portfolio Name": portfolio,
				"Portfolio Member Name": member,
				"Designation": designation,
				"Month": month
			};
			
			// Process all 15 rows
			for (let i = 1; i <= 15; i++) {
				draftData[`Status_${i}`] = formData.get(`Status_${i}`);
				draftData[`Description_${i}`] = formData.get(`Description_${i}`);
				
				// Check if file was already uploaded
				const uploadBtn = document.querySelector(`button.upload-btn[data-row='${i}']`);
				const isAlreadyUploaded = uploadBtn && uploadBtn.textContent.trim() === 'Uploaded';
				
				if (isAlreadyUploaded) {
					// File already uploaded, keep existing URL from previous draft or skip
					draftData[`Upload The Scanned File_${i}`] = null; // Will be preserved if updating existing draft
				} else {
					// Get the file input for this row
					const fileInput = document.querySelector(`input.file-input-row[data-row='${i}']`);
					const file = fileInput && fileInput.files[0];
					if (file && file.size > 0) {
						const ts = Date.now();
						const path = `corescope_draft_${i}_${ts}_${file.name}`;
						try {
							draftData[`Upload The Scanned File_${i}`] = await uploadFileToStorage(file, path, 'form1-files', uploadBtn);
						} catch (err) {
							console.error(`File upload error for row ${i}:`, err);
							// Don't throw error, just skip this file and continue
							draftData[`Upload The Scanned File_${i}`] = null;
						}
					} else {
						draftData[`Upload The Scanned File_${i}`] = null;
					}
				}
			}
			
			// Check if draft already exists for this combination
			const { data: existing, error: selectError } = await supabase
				.from('Core_scope_drafts')
				.select('*')
				.eq('Department', dept)
				.eq('Portfolio Member Name', member)
				.order('created_at', { ascending: false })
				.limit(1)
				.single();
			
			if (existing) {
				// Update existing draft - preserve existing file URLs if new file is null
				for (let i = 1; i <= 15; i++) {
					const fileKey = `Upload The Scanned File_${i}`;
					if (!draftData[fileKey] && existing[fileKey]) {
						draftData[fileKey] = existing[fileKey]; // Keep existing file URL
					}
				}
				
				const { error } = await supabase
					.from('Core_scope_drafts')
					.update(draftData)
					.eq('id', existing.id);
				if (error) throw error;
			} else {
				// Insert new draft
				const { error } = await supabase
					.from('Core_scope_drafts')
					.insert([draftData]);
				if (error) throw error;
			}
			
			// Show success message
			saveDraftBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Draft Saved!';
			saveDraftBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200';
			
			setTimeout(() => {
				saveDraftBtn.innerHTML = originalText;
				saveDraftBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200';
				saveDraftBtn.disabled = false;
			}, 2000);
			
		} catch (err) {
			alert('Failed to save draft: ' + err.message);
			saveDraftBtn.innerHTML = originalText;
			saveDraftBtn.disabled = false;
		}
	}
	
	// Add event listener for Save as Draft button
	document.getElementById('saveDraftBtn').addEventListener('click', saveAsDraft);
	
	// Draft popup button handlers
	document.getElementById('draftAcceptBtn').addEventListener('click', function() {
		document.getElementById('draftModal').classList.remove('show');
		if (window.pendingDraft) {
			loadDraftData(window.pendingDraft);
			window.pendingDraft = null;
		}
	});
	
	document.getElementById('draftDeclineBtn').addEventListener('click', function() {
		document.getElementById('draftModal').classList.remove('show');
		window.pendingDraft = null;
	});
	
	// Check for draft after form fields are auto-filled
	setTimeout(() => {
		const form = document.getElementById('facultyCoreScope');
		const dept = form.querySelector('input[name="Department"]').value;
		const member = form.querySelector('input[name="Portfolio Member Name"]').value;
		if (dept && member) {
			checkForDraft();
		}
	}, 500);

	// Form submission with double-submit prevention
	let isSubmitting = false;
	document.getElementById('facultyCoreScope').addEventListener('submit', async function(e) {
		e.preventDefault();
		
		// Prevent double submission
		if (isSubmitting) {
			console.log('Form is already submitting, ignoring duplicate submission');
			return;
		}
		isSubmitting = true;
		
		// Disable submit button
		const submitBtn = e.target.querySelector('button[type="submit"]');
		const originalText = submitBtn.textContent;
		submitBtn.disabled = true;
		submitBtn.textContent = 'Submitting...';
		submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
		
		// Save autofetch values to localStorage for next time
		try {
			var autofetchForm = e.target;
			var dept = autofetchForm.querySelector('input[name="Department"]').value || '';
			var portfolio = autofetchForm.querySelector('input[name="Portfolio Name"]').value || '';
			var member = autofetchForm.querySelector('input[name="Portfolio Member Name"]').value || '';
			var designation = autofetchForm.querySelector('select[name="Designation"]').value || '';
			var month = autofetchForm.querySelector('select[name="Month"]').value || '';
			localStorage.setItem('selectedDepartment', dept);
			localStorage.setItem('selectedPortfolio', portfolio);
			localStorage.setItem('selectedMemberName', member);
			localStorage.setItem('selectedDesignation', designation);
			localStorage.setItem('selectedMonth', month);
		} catch (err) { /* ignore */ }

		const form = e.target;
		const formData = new FormData(form);
		
		// Build the data object matching the Core_scope schema
		const dataRow = {
			"Department": formData.get('Department'),
			"Portfolio Name": formData.get('Portfolio Name'),
			"Portfolio Member Name": formData.get('Portfolio Member Name'),
			"Designation": formData.get('Designation'),
			"Month": formData.get('Month')
		};

		// Process all 15 rows
		for (let i = 1; i <= 15; i++) {
			dataRow[`Status_${i}`] = formData.get(`Status_${i}`);
			dataRow[`Description_${i}`] = formData.get(`Description_${i}`);
			
			// Get the file input for this row
			const fileInput = document.querySelector(`input.file-input-row[data-row='${i}']`);
			const file = fileInput && fileInput.files[0];
			if (file && file.size > 0) {
				const ts = Date.now();
				const path = `corescope_${i}_${ts}_${file.name}`;
				try {
					dataRow[`Upload The Scanned File_${i}`] = await uploadFileToStorage(file, path, 'form1-files');
				} catch (err) {
					isSubmitting = false;
					submitBtn.disabled = false;
					submitBtn.textContent = originalText;
					submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
					window.location.href = `notification.html?status=error&msg=${encodeURIComponent('File upload failed for row ' + i + ': ' + err.message)}`;
					return;
				}
			} else {
				// Check if there's a draft file URL for this row
				dataRow[`Upload The Scanned File_${i}`] = window.draftFileUrls[i] || null;
			}
		}

		// Submit to Supabase
		const { data, error } = await supabase.from('Core_scope').insert([dataRow]);
		if (error) {
			isSubmitting = false;
			submitBtn.disabled = false;
			submitBtn.textContent = originalText;
			submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
			window.location.href = `notification.html?status=error&msg=${encodeURIComponent(error.message)}`;
			return;
		}

		// Delete draft after successful submission
		try {
			await supabase
				.from('Core_scope_drafts')
				.delete()
				.eq('Department', dataRow.Department)
				.eq('Portfolio Member Name', dataRow['Portfolio Member Name']);
		} catch (err) {
			// Ignore draft deletion errors
			console.log('Draft deletion failed:', err);
		}

		// Don't reset isSubmitting - let the page redirect happen
		window.location.href = 'notification.html?status=success';
	});
	</script>
	<!-- Footer -->
	<footer class="text-center py-4 mt-8">
		<p class="text-sm">
			&copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br>
			<p class="text-xs opacity-80 flex items-center justify-center gap-2">
				Powered by 
				<a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
					<img src="../static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
				</a>
			</p>
			<p class="text-xs opacity-80">A Student driven Software!</p>
		</p>
	</footer>

    <!-- Month filter script for admin-controlled month disabling -->
    <script src="../static/javascript/month-filter.js"></script>
</body>
</html>
