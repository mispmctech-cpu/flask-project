<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Faculty Core Scope (Monthly)</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- Font Awesome for icons -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<!-- Prevent Double Submit Protection -->
	<script src="../static/javascript/prevent-double-submit.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
	<style>
		th, td {
			font-size: 1rem;    
		}
		input:focus, select:focus {
			outline: none;
			box-shadow: 0 0 0 2px #a78bfa33;
			border-color: #a78bfa;
		}
		.bg-orange-400 {
			background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%);
		}
		.bg-purple-800 {
			background: linear-gradient(90deg, #6d28d9 0%, #7c3a    ed 100%);
		}
		input[type="file"]::-webkit-file-upload-button {
			background: #ede9fe;
			color: #6d28d9;
			border: 1px solid #a78bfa;
			border-radius: 0.5rem;
			padding: 0.25rem 1rem;
			font-weight: 500;
			transition: background 0.2s;
		}
		input[type="file"]::-webkit-file-upload-button:hover {
			background: #c4b5fd;
			color: #fff;
		}
		input[type="file"]::file-selector-button {
			background: #ede9fe;
			color: #6d28d9;
			border: 1px solid #a78bfa;
			border-radius: 0.5rem;
			padding: 0.25rem 1rem;
			font-weight: 500;
			transition: background 0.2s;
		}
		input[type="file"]::file-selector-button:hover {
			background: #c4b5fd;
			color: #fff;
		}
		select {
			background: #ffffff;
			cursor: pointer;
		}
		select option {
			padding: 8px;
		}
		label {
			letter-spacing: 0.05em;
		}
		.table-section-title {
			font-size: 1.1rem;
			font-weight: 700;
			letter-spacing: 0.04em;
			color: #fff;
			background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%);
			padding-left: 1rem;
		}
		@media (max-width: 900px) {
			th, td { font-size: 0.95rem; }
		}
		@media (max-width: 600px) {
			th, td { font-size: 0.9rem; }
		}
	</style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
	<div class="flex-1 flex items-center justify-center py-8 px-2">
		<div class="w-full max-w-6xl mx-auto bg-white rounded-2xl card-shadow border border-purple-300 overflow-x-auto p-0">
			<div class="bg-purple-800 py-8 px-6 text-white text-center w-full rounded-t-2xl">
				<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT2R7bHsdVlhJda1oUOZ1NPc7lvacTuGPvHgg&s" alt="" class="h-16 mb-2" style="max-height:64px; float: left;" />
				<h1 class="text-2xl md:text-4xl font-extrabold tracking-wide mb-2 drop-shadow">Faculty Core Scope(Monthly) </h1>
			</div>
			<form id="facultyCoreScope" class="p-6 md:p-10 space-y-10 w-full">
				<div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-8 shadow-lg border-2 border-purple-200 mb-8">
					<!-- First Row: 3 Fields -->
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">DEPARTMENT</label>
							<input type="text" name="Department" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">PORTFOLIO NAME</label>
							<input type="text" name="Portfolio Name" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">PORTFOLIO MEMBER NAME</label>
							<input type="text" name="Portfolio Member Name" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium" />
						</div>
					</div>
					
					<!-- Second Row: 2 Fields -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">DESIGNATION</label>
							<select name="Designation" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium appearance-none cursor-pointer">
								<option value="">-- Select Designation --</option>
								<option>AP</option>
								<option>ASP</option>
								<option>PROF</option>
								<option>Professor</option>
							</select>
						</div>
						<div>
							<label class="block font-bold text-purple-900 mb-2 text-sm tracking-wide">MONTH</label>
							<select name="Month" required class="w-full border-2 border-purple-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm text-gray-800 font-medium appearance-none cursor-pointer">
								<option value="">-- Select Month --</option>
								<option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
							</select>
						</div>
					</div>
				</div>
				<div class="overflow-x-auto rounded-xl card-shadow border border-purple-100 bg-white w-full p-4">
					<table class="w-full min-w-[1200px] text-xs md:text-sm table-fixed">
						<colgroup>
							<col style="width: 4%">
							<col style="width: 32%">
							<col style="width: 12%">
							<col style="width: 12%">
							<col style="width: 28%">
							<col style="width: 12%">
						</colgroup>
						<thead class="bg-orange-400">
							<tr>
								<th class="border px-2 py-2 font-bold text-white">S.No</th>
								<th class="border px-2 py-2 font-bold text-white">ASSISTANT PROFESSOR SCOPE</th>
								<th class="border px-2 py-2 font-bold text-white">TAT</th>
								<th class="border px-2 py-2 font-bold text-white">Status</th>
								<th class="border px-2 py-2 font-bold text-white">Description</th>
								<th class="border px-2 py-2 font-bold text-white">Upload</th>
							</tr>
						</thead>
						<tbody id="core-scope-table-body">
							<!-- JS will render 15 rows here -->
						</tbody>
					</table>
				</div>
				<div class="flex justify-center mt-10">
					<button type="submit" class="bg-purple-800 hover:bg-purple-700 text-white font-bold py-3 px-12 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200">Submit</button>
				</div>
			</form>
		</div>
	</div>
	<script src="https://unpkg.com/@supabase/supabase-js"></script>
	<script>
	// Autofetch using localStorage
	document.addEventListener('DOMContentLoaded', function() {
		var dept = localStorage.getItem('selectedDepartment') || '';
		var portfolio = localStorage.getItem('selectedPortfolio') || '';
		var member = localStorage.getItem('selectedMemberName') || '';
		var designation = localStorage.getItem('selectedDesignation') || '';
		var month = localStorage.getItem('selectedMonth') || '';
		const form = document.getElementById('facultyCoreScope');
		if (form) {
			const deptField = form.querySelector('input[name="Department"]');
			if (deptField && dept) {
				deptField.value = dept;
			}
			const portfolioField = form.querySelector('input[name="Portfolio Name"]');
			if (portfolioField && portfolio) {
				portfolioField.value = portfolio;
			}
			const memberField = form.querySelector('input[name="Portfolio Member Name"]');
			if (memberField && member) {
				memberField.value = member;
			}
			const designationField = form.querySelector('select[name="Designation"]');
			if (designationField && designation) {
				for (var i = 0; i < designationField.options.length; i++) {
					if (designationField.options[i].value === designation) {
						designationField.selectedIndex = i;
						break;
					}
				}
			}
			const monthField = form.querySelector('select[name="Month"]');
			if (monthField && month) {
				for (var i = 0; i < monthField.options.length; i++) {
					if (monthField.options[i].value === month) {
						monthField.selectedIndex = i;
						break;
					}
				}
			}
		}
	});

	// Table data from image (15 rows for Core Scope)
	const tableData = [
		{ 
			scope: 'Teaching & Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.',
			tat: 'END OF THE DAY',
			proof: 'Logbook record or Class work for the particular session (Write self Copy & Combine taking a snap along with the Timetable for the current day)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.',
			tat: 'START OF SEM',
			proof: 'ERP Lesson Plan pdf (Combined snap pdf merger for Theory and Lab upload)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.',
			tat: 'END OF THE DAY',
			proof: 'Google Class Room (Updated), Sample PPT, Pdf, experiential learning methods used in the particular room. (Object or sample along with Timetable for the month (Combine Upload))',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Teaching & Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.',
			tat: 'MONTH END/START OF SEM',
			proof: 'Model snap with each and product photo in the month (Combine Upload)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.',
			tat: 'END OF THE DAY',
			proof: 'Updated individual student record of 30 students with marks and attendance in mentoring format per month. (Take snap of selected mentees class in Lms sample students snap) (Combined Snap as PDF)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Monitor student attendance, performance, and well-being.',
			tat: 'END OF THE DAY',
			proof: 'Monthly Report of 3 x 5 x allotted support classes attended and communication (Face to face/Teams in the mentor room)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.',
			tat: 'DAILY/ MONTH END',
			proof: 'Take the photos of students participated (Remedial) and Index page of Mentee Students Participation in Co&Ex Curricular activities of the Month',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Maintain the Mentor book for assigned mentee.',
			tat: 'MONTH END',
			proof: 'Consolidated snap of Mentor Book as PDF',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Student Mentorship & Support: Consolidate innovative course material, Lab manuals',
			tat: 'AT MAY',
			proof: 'Innovative Teaching Tool+ report, Innovative Lab Manual+ Proof, Use of Virtual lab (Combined pdf for Theory and Lab)',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Research and Development: Present at conferences.',
			tat: 'ENTER WEEKLY',
			proof: 'PAC, DAAC, BOS Attendance Page',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Research and Development: Guide student research and final-year projects',
			tat: 'ENTER WEEKLY',
			proof: 'Mentor note with date wise mentoring details of the Month',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Institutional Development: Participate in curriculum development and revision through Boards of Studies.',
			tat: 'NEXT MAY',
			proof: 'Audit Report Check list With Yes/No & logbook internal audit page & Result Analysis Page',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.',
			tat: 'ONCE A WEEK',
			proof: 'Write the Completed works Description related to Quality, ISO, NBA, NAAC File Maintenance. Upload with support documents in PDF',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Institutional Development: Serve on academic and administrative committees.',
			tat: 'AFTER A WHILE',
			proof: 'Type the List of other works allotted by HOD and Completed as of the Month',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		},
		{ 
			scope: 'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.',
			tat: 'NEXT MAY',
			proof: 'FPBA With Proof in Single PDF',
			statusOptions: ['Completed', 'Completed and Updated', 'Not Applicable']
		}
	];

	// Render table rows
	const tbody = document.getElementById('core-scope-table-body');
	tableData.forEach((row, i) => {
		const idx = i + 1;
		const tr = document.createElement('tr');
		
		// Build status dropdown options
		let statusOptionsHTML = '<option value="">Select</option>';
		row.statusOptions.forEach(opt => {
			statusOptionsHTML += `<option>${opt}</option>`;
		});
		
		tr.innerHTML = `
			<td class="border px-2 py-1 text-center">${idx}</td>
			<td class="border px-2 py-1">${row.scope}</td>
			<td class="border px-2 py-1">${row.tat}</td>
			<td class="border px-2 py-1">
				<select name="Status_${idx}" class="w-full border rounded px-1 py-1">
					${statusOptionsHTML}
				</select>
			</td>
			<td class="border px-2 py-1">
				<input type="text" name="Description_${idx}" maxlength="500" class="w-full border rounded px-1 py-1" placeholder="${row.proof}" />
			</td>
			<td class="border px-2 py-1">
				<button type="button" class="upload-btn bg-purple-200 hover:bg-purple-300 text-purple-900 font-semibold px-3 py-1 rounded w-full" data-row="${idx}">Upload</button>
				<span class="file-check hidden text-green-600 font-bold ml-2" data-row="${idx}">âœ“</span>
				<input type="file" name="Upload The Scanned File_${idx}" accept=".pdf,.jpg,.jpeg,.png" class="hidden file-input-row" data-row="${idx}" />
			</td>
		`;
		tbody.appendChild(tr);
	});

	// Supabase setup
	const supabase = window.supabase.createClient(
		"https://cbhodgwaazmjszkujrti.supabase.co",
		"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
	);

	async function uploadFileToStorage(file, path, bucket, uploadBtn) {
		if (!file) return null;
		const { data, error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true });
		if (error) throw error;
		// Get public URL
		const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(path);
		// Change the upload button to 'Uploaded' after successful upload
		if (uploadBtn) {
			const row = uploadBtn.getAttribute('data-row');
			const checkMark = document.querySelector(`.file-check[data-row="${row}"]`);
			
			uploadBtn.textContent = 'Uploaded';
			uploadBtn.className = 'bg-green-200 text-green-800 font-semibold px-3 py-1 rounded w-full';
			uploadBtn.disabled = true;
			
			// Show checkmark
			if (checkMark) {
				checkMark.classList.remove('hidden');
			}
		}
		return urlData.publicUrl;
	}

	// Handle upload button click
	document.addEventListener('click', function(e) {
		if (e.target && e.target.classList.contains('upload-btn')) {
			const row = e.target.getAttribute('data-row');
			const fileInput = document.querySelector(`input.file-input-row[data-row='${row}']`);
			if (fileInput) fileInput.click();
		}
	});

	// Handle file selection and upload
	document.addEventListener('change', async function(e) {
		if (e.target && e.target.classList.contains('file-input-row')) {
			const row = e.target.getAttribute('data-row');
			const file = e.target.files[0];
			if (!file) return;
			const uploadBtn = document.querySelector(`button.upload-btn[data-row='${row}']`);
			const bucket = 'core-scope-files';
			const path = `corescope_${row}_${Date.now()}_${file.name}`;
			try {
				await uploadFileToStorage(file, path, bucket, uploadBtn);
			} catch (err) {
				alert('File upload failed for row ' + row + ': ' + err.message);
			}
		}
	});

	// Form submission
	document.getElementById('facultyCoreScope').addEventListener('submit', async function(e) {
		e.preventDefault();
		
		// Save autofetch values to localStorage for next time
		try {
			var autofetchForm = e.target;
			var dept = autofetchForm.querySelector('input[name="Department"]').value || '';
			var portfolio = autofetchForm.querySelector('input[name="Portfolio Name"]').value || '';
			var member = autofetchForm.querySelector('input[name="Portfolio Member Name"]').value || '';
			var designation = autofetchForm.querySelector('select[name="Designation"]').value || '';
			var month = autofetchForm.querySelector('select[name="Month"]').value || '';
			localStorage.setItem('selectedDepartment', dept);
			localStorage.setItem('selectedPortfolio', portfolio);
			localStorage.setItem('selectedMemberName', member);
			localStorage.setItem('selectedDesignation', designation);
			localStorage.setItem('selectedMonth', month);
		} catch (err) { /* ignore */ }

		const form = e.target;
		const formData = new FormData(form);
		
		// Build the data object matching the Core_scope schema
		const dataRow = {
			"Department": formData.get('Department'),
			"Portfolio Name": formData.get('Portfolio Name'),
			"Portfolio Member Name": formData.get('Portfolio Member Name'),
			"Designation": formData.get('Designation'),
			"Month": formData.get('Month')
		};

		// Process all 15 rows
		for (let i = 1; i <= 15; i++) {
			dataRow[`Status_${i}`] = formData.get(`Status_${i}`);
			dataRow[`Description_${i}`] = formData.get(`Description_${i}`);
			
			// Get the file input for this row
			const fileInput = document.querySelector(`input.file-input-row[data-row='${i}']`);
			const file = fileInput && fileInput.files[0];
			if (file && file.size > 0) {
				const ts = Date.now();
				const path = `corescope_${i}_${ts}_${file.name}`;
				try {
					dataRow[`Upload The Scanned File_${i}`] = await uploadFileToStorage(file, path, 'core-scope-files');
				} catch (err) {
					window.location.href = `notification.html?status=error&msg=${encodeURIComponent('File upload failed for row ' + i + ': ' + err.message)}`;
					return;
				}
			} else {
				dataRow[`Upload The Scanned File_${i}`] = null;
			}
		}

		// Submit to Supabase
		const { data, error } = await supabase.from('Core_scope').insert([dataRow]);
		if (error) {
			window.location.href = `notification.html?status=error&msg=${encodeURIComponent(error.message)}`;
			return;
		}

		window.location.href = 'notification.html?status=success';
	});
	</script>
	<!-- Footer -->
	<footer class="text-center py-4 mt-8">
		<p class="text-sm">
			&copy; All Rights Reserved <a href="https://pmctech.org" target="_blank" class="underline">PMC TECH</a><br>
			<p class="text-xs opacity-80 flex items-center justify-center gap-2">
				Powered by 
				<a href="https://zeonytechnologies.com" target="_blank" rel="noopener noreferrer" class="inline-block hover:opacity-100 transition-all duration-300 hover:scale-105">
					<img src="../static/img/zeony logo.png" alt="Zeony Technologies" class="h-12 w-22 py-2 object-contain"/>
				</a>
			</p>
			<p class="text-xs opacity-80">A Student driven Software!</p>
		</p>
	</footer>
</body>
</html>
