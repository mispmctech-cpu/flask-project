<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deleted Faculty Records </title>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <style>
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="bg-blue-800 text-white w-64 space-y-6 py-7 px-2">
            <div class="text-2xl font-semibold text-center">Admin Panel</div>
            <nav class="space-y-2">
                <a href="admin-dashboard.html" class="block py-2 px-4 rounded hover:bg-blue-700">Dashboard</a>
                <a href="admin-users.html" class="block py-2 px-4 rounded hover:bg-blue-700">Manage Users</a>
                <a href="admin-departments.html" class="block py-2 px-4 rounded hover:bg-blue-700">Departments</a>
                <a href="admin-deleted-faculty.html" class="block py-2 px-4 rounded bg-blue-900">Deleted Faculty</a>
                <a href="admin-reports.html" class="block py-2 px-4 rounded hover:bg-blue-700">Reports</a>
                <a href="admin-forms.html" class="block py-2 px-4 rounded hover:bg-blue-700">Forms</a>
                <a href="admin-audit.html" class="block py-2 px-4 rounded hover:bg-blue-700">Audit Trail</a>
                <a href="admin-notifications.html" class="block py-2 px-4 rounded hover:bg-blue-700">Notifications</a>
            </nav>
        </div>

        <!-- Main content -->
        <div class="flex-1 p-10">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Deleted Faculty Records</h1>
                <p class="text-gray-600 mt-2">View and manage deleted faculty records for audit and recovery purposes</p>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-64">
                        <input type="text" id="searchInput" placeholder="Search by name, email, or employee ID..." 
                               class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <select id="departmentFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Departments</option>
                            <option value="AERO">AERO</option>
                            <option value="AIDS">AIDS</option>
                            <option value="AIML">AIML</option>
                            <option value="CHEM">CHEM</option>
                            <option value="CIVIL">CIVIL</option>
                            <option value="CSBS">CSBS</option>
                            <option value="CSE">CSE</option>
                            <option value="ECE">ECE</option>
                            <option value="EEE">EEE</option>
                            <option value="IT">IT</option>
                            <option value="MBA">MBA</option>
                            <option value="MCA">MCA</option>
                            <option value="MCO">MCO</option>
                            <option value="MECH">MECH</option>
                            <option value="S&H">S&H</option>
                        </select>
                    </div>
                    <div>
                        <input type="date" id="dateFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="refreshDeletedFaculty()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-red-100 border border-red-300 rounded-lg p-6">
                    <div class="text-red-800">
                        <h3 class="text-lg font-semibold">Total Deleted</h3>
                        <p class="text-3xl font-bold" id="totalDeleted">0</p>
                    </div>
                </div>
                <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-6">
                    <div class="text-yellow-800">
                        <h3 class="text-lg font-semibold">This Month</h3>
                        <p class="text-3xl font-bold" id="deletedThisMonth">0</p>
                    </div>
                </div>
                <div class="bg-orange-100 border border-orange-300 rounded-lg p-6">
                    <div class="text-orange-800">
                        <h3 class="text-lg font-semibold">Recoverable</h3>
                        <p class="text-3xl font-bold" id="recoverableCount">0</p>
                    </div>
                </div>
            </div>

            <!-- Deleted Faculty Table -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Deleted Faculty Records</h2>
                </div>
                <div class="table-container">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deleted Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deleted By</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deletedFacultyTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-6">
                <div class="text-sm text-gray-700">
                    Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> records
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" id="prevBtn">Previous</button>
                    <button onclick="nextPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" id="nextBtn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Confirmation Modal -->
    <div id="restoreModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900">Restore Faculty Member</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="restoreMessage">
                        Are you sure you want to restore this faculty member?
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="confirmRestore()" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 mr-3">
                        Restore
                    </button>
                    <button onclick="closeRestoreModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase client
        const supabaseClient = window.supabase.createClient(
            "https://cbhodgwaazmjszkujrti.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
        );

        let deletedFaculty = [];
        let filteredDeletedFaculty = [];
        let currentPage = 1;
        const pageSize = 10;
        let recordToRestore = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshDeletedFaculty();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterDeletedFaculty);
            document.getElementById('departmentFilter').addEventListener('change', filterDeletedFaculty);
            document.getElementById('dateFilter').addEventListener('change', filterDeletedFaculty);
        }

        async function refreshDeletedFaculty() {
            try {
                const { data, error } = await supabaseClient
                    .from('deleted_faculty_backup')
                    .select('*')
                    .order('deleted_at', { ascending: false });

                if (error) throw error;

                deletedFaculty = data || [];
                filteredDeletedFaculty = [...deletedFaculty];
                
                updateStats();
                displayDeletedFaculty();

            } catch (error) {
                console.error('Error fetching deleted faculty:', error);
                alert('Failed to load deleted faculty records: ' + (error.message || 'Unknown error'));
            }
        }

        function filterDeletedFaculty() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const department = document.getElementById('departmentFilter').value;
            const date = document.getElementById('dateFilter').value;

            filteredDeletedFaculty = deletedFaculty.filter(record => {
                const matchesSearch = !search || 
                    (record["Name"] || '').toLowerCase().includes(search) ||
                    (record.email || '').toLowerCase().includes(search) ||
                    (record["EmployeeID"] || '').toLowerCase().includes(search);
                
                const matchesDepartment = !department || record.department === department;
                
                const matchesDate = !date || 
                    new Date(record.deleted_at).toDateString() === new Date(date).toDateString();

                return matchesSearch && matchesDepartment && matchesDate;
            });

            currentPage = 1;
            displayDeletedFaculty();
        }

        function displayDeletedFaculty() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredDeletedFaculty.length);
            const currentRecords = filteredDeletedFaculty.slice(startIndex, endIndex);

            const tbody = document.getElementById('deletedFacultyTableBody');
            tbody.innerHTML = '';

            currentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${record["Name"] || 'Unknown'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record["EmployeeID"] || 'Not provided'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.email || 'No email'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.department || 'Not specified'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record["Designation"] || 'Faculty'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(record.deleted_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.deleted_by || 'Unknown'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.deletion_reason || 'No reason provided'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="showRestoreModal(${record.id}, '${record["Name"]}', '${record.email}')" 
                                class="text-green-600 hover:text-green-900">
                            <i class="fas fa-undo mr-1"></i>Restore
                        </button>
                        <button onclick="viewDetails(${record.id})" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        function updateStats() {
            document.getElementById('totalDeleted').textContent = deletedFaculty.length;

            // Calculate this month's deletions
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            
            const thisMonthCount = deletedFaculty.filter(record => 
                new Date(record.deleted_at) >= thisMonth
            ).length;
            
            document.getElementById('deletedThisMonth').textContent = thisMonthCount;
            document.getElementById('recoverableCount').textContent = deletedFaculty.length;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredDeletedFaculty.length / pageSize);
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, filteredDeletedFaculty.length);

            document.getElementById('startRecord').textContent = filteredDeletedFaculty.length > 0 ? startRecord : 0;
            document.getElementById('endRecord').textContent = endRecord;
            document.getElementById('totalRecords').textContent = filteredDeletedFaculty.length;

            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayDeletedFaculty();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredDeletedFaculty.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayDeletedFaculty();
            }
        }

        function showRestoreModal(id, name, email) {
            recordToRestore = deletedFaculty.find(record => record.id === id);
            document.getElementById('restoreMessage').textContent = 
                `Are you sure you want to restore "${name}" (${email}) back to the Faculty table?`;
            document.getElementById('restoreModal').classList.remove('hidden');
        }

        function closeRestoreModal() {
            document.getElementById('restoreModal').classList.add('hidden');
            recordToRestore = null;
        }

        async function confirmRestore() {
            if (!recordToRestore) return;

            try {
                // Create new faculty record from deleted record
                const facultyRecord = {
                    department: recordToRestore.department,
                    email: recordToRestore.email,
                    "Name": recordToRestore["Name"],
                    "Username": recordToRestore["Username"],
                    password: recordToRestore.password,
                    "Upload Image": recordToRestore["Upload Image"],
                    "Designation": recordToRestore["Designation"],
                    "EmployeeID": recordToRestore["EmployeeID"],
                    "Salary": recordToRestore["Salary"],
                    "Experience": recordToRestore["Experience"],
                    "Qualification": recordToRestore["Qualification"]
                };

                // Insert back into Faculty table
                const { error: insertError } = await supabaseClient
                    .from('Faculty')
                    .insert([facultyRecord]);

                if (insertError) throw new Error('Failed to restore faculty: ' + insertError.message);

                // Remove from deleted_faculty_backup table
                const { error: deleteError } = await supabaseClient
                    .from('deleted_faculty_backup')
                    .delete()
                    .eq('id', recordToRestore.id);

                if (deleteError) throw new Error('Failed to remove from deleted records: ' + deleteError.message);

                alert(`Faculty "${recordToRestore["Name"]}" has been restored successfully.`);
                closeRestoreModal();
                refreshDeletedFaculty();

            } catch (error) {
                console.error('Error restoring faculty:', error);
                alert('Failed to restore faculty: ' + (error.message || 'Unknown error'));
            }
        }

        function viewDetails(id) {
            const record = deletedFaculty.find(r => r.id === id);
            if (!record) return;

            const details = `
Faculty Details:
Name: ${record["Name"] || 'Unknown'}
Employee ID: ${record["EmployeeID"] || 'Not provided'}
Email: ${record.email || 'No email'}
Department: ${record.department || 'Not specified'}
Designation: ${record["Designation"] || 'Faculty'}
Qualification: ${record["Qualification"] || 'Not provided'}
Experience: ${record["Experience"] || 'Not provided'}
Salary: ${record["Salary"] || 'Not provided'}

Deletion Details:
Deleted on: ${new Date(record.deleted_at).toLocaleString()}
Deleted by: ${record.deleted_by || 'Unknown'}
Reason: ${record.deletion_reason || 'No reason provided'}
Original Faculty ID: ${record.original_faculty_id || 'Unknown'}
            `;

            alert(details);
        }
    </script>
</body>
</html>
