</script>
<script>
// Auto-fill Department, Portfolio Name, and Portfolio Member Name from localStorage
document.addEventListener('DOMContentLoaded', function() {
    let deptFromQuery = new URLSearchParams(window.location.search).get('department');
    if (deptFromQuery) {
        localStorage.setItem('selectedDepartment', deptFromQuery);
    }
    let dept = deptFromQuery || localStorage.getItem('selectedDepartment') || '';
    let deptFields = document.querySelectorAll("input[name='Department'], input[name='Department:'], select[name='Department'], select[name='Department:']");
    deptFields.forEach(function(field) {
        if (dept) field.value = dept;
        field.required = true;
        field.readOnly = false;
        field.disabled = false;
        if (field.tagName === 'SELECT') {
            field.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
    let portfolio = localStorage.getItem('selectedPortfolio') || new URLSearchParams(window.location.search).get('portfolio') || '';
    let portfolioFields = document.querySelectorAll("input[name='Portfolio Name'], input[name='Portfolio Name:']");
    portfolioFields.forEach(function(field) {
        if (portfolio) field.value = portfolio;
        field.required = true;
        field.readOnly = false;
        field.disabled = false;
    });
    let member = localStorage.getItem('selectedMemberName') || new URLSearchParams(window.location.search).get('name') || '';
    let memberFields = document.querySelectorAll("input[name='Portfolio Member Name'], input[name='Portfolio Memeber Name']");
    memberFields.forEach(function(field) {
        if (member) field.value = member;
        field.required = true;
        field.readOnly = false;
        field.disabled = false;
    });
    // On submit, forcibly set these values in the form data (never null)
    let form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            deptFields.forEach(function(field) { if (!field.value) field.value = dept; });
            portfolioFields.forEach(function(field) { if (!field.value) field.value = portfolio; });
            memberFields.forEach(function(field) { if (!field.value) field.value = member; });
        });
    }
});
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Core Scope - ASP Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="w-full max-w-[98vw] mx-auto my-10 bg-white rounded-2xl shadow-2xl p-0 border border-purple-300 overflow-x-auto">
        <div class="bg-purple-800 py-8 px-6 text-white text-center w-full">
            <h1 class="text-4xl font-extrabold tracking-wide mb-2 drop-shadow">FACULTY CORE SCOPE - ASP FORM</h1>
            <p class="text-lg font-medium opacity-90">Academic Year: <span class="font-bold">2025-2026</span></p>
        </div>
    <form id="aspForm" class="p-4 md:p-8 space-y-8 w-full">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 bg-purple-50 rounded-xl p-6 shadow mb-4">
                <div>
                    <label class="block font-semibold text-purple-900 mb-1">Department:</label>
                    <input type="text" name="Department:" required class="w-full border-2 border-purple-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-400" />
                </div>
                <div>
                    <label class="block font-semibold text-purple-900 mb-1">Portfolio Name:</label>
                    <input type="text" name="Portfolio Name:" required class="w-full border-2 border-purple-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-400" />
                </div>
                <div>
                    <label class="block font-semibold text-purple-900 mb-1">Portfolio Member Name:</label>
                    <input type="text" name="Portfolio Member Name" class="w-full border-2 border-purple-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-400" />
                </div>
            </div>
            <!-- Section 1: Compliance (S. No 10,11,12,16,17,18,19,22) -->
            <div class="overflow-x-auto rounded-xl shadow border border-green-200 bg-white w-full mb-8">
                <h2 class="text-lg font-bold text-green-700 px-4 pt-4">Targeted Section</h2>
                <table class="w-full min-w-[1200px] text-xs md:text-sm table-fixed mt-2">
                    <colgroup>
                        <col style="width: 3%">
                        <col style="width: 36%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 18%">
                        <col style="width: 13%">
                    </colgroup>
                    <thead class="bg-green-400">
                        <tr>
                            <th class="border px-2 py-2 font-bold text-white">S. NO</th>
                            <th class="border px-2 py-2 font-bold text-white">SCOPE</th>
                            <th class="border px-2 py-2 font-bold text-white">TARGET</th>
                            <th class="border px-2 py-2 font-bold text-white">TAT</th>
                            <th class="border px-2 py-2 font-bold text-white">Status</th>
                            <th class="border px-2 py-2 font-bold text-white">Description</th>
                            <th class="border px-2 py-2 font-bold text-white">Upload File</th>
                        </tr>
                    </thead>
                    <tbody id="asp-compliance-body">
                        <!-- JS will render compliance rows here -->
                    </tbody>
                </table>
                <div class="flex justify-center mt-6 mb-4">
                    <button id="complianceSubmitBtn" type="button" class="bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-8 rounded-2xl shadow-xl text-lg tracking-wide transition-all duration-200">Submit Compliance</button>
                    <span id="complianceLoadingSpinner" class="ml-4 hidden"><svg class="animate-spin h-8 w-8 text-green-700 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg></span>
                </div>
            </div>
            <!-- Section 2: Remaining rows -->
            <div class="overflow-x-auto rounded-xl shadow border border-purple-100 bg-white w-full">
                <h2 class="text-lg font-bold text-purple-700 px-4 pt-4">General Section</h2>
                <table class="w-full min-w-[1200px] text-xs md:text-sm table-fixed mt-2">
                    <colgroup>
                        <col style="width: 3%">
                        <col style="width: 36%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 18%">
                        <col style="width: 13%">
                    </colgroup>
                    <thead class="bg-orange-400">
                        <tr>
                            <th class="border px-2 py-2 font-bold text-white">S. NO</th>
                            <th class="border px-2 py-2 font-bold text-white">SCOPE</th>
                            <th class="border px-2 py-2 font-bold text-white">TARGET</th>
                            <th class="border px-2 py-2 font-bold text-white">TAT</th>
                            <th class="border px-2 py-2 font-bold text-white">Status</th>
                            <th class="border px-2 py-2 font-bold text-white">Description</th>
                            <th class="border px-2 py-2 font-bold text-white">Upload File</th>
                        </tr>
                    </thead>
                    <tbody id="asp-general-body">
                        <!-- JS will render general rows here -->
                    </tbody>
                </table>
                <div class="flex justify-center mt-6 mb-4">
                    <button id="aspSubmitBtn" type="button" class="bg-purple-800 hover:bg-purple-700 text-white font-bold py-3 px-12 rounded-2xl shadow-xl text-xl tracking-wide transition-all duration-200">Submit General</button>
                    <span id="aspLoadingSpinner" class="ml-4 hidden"><svg class="animate-spin h-8 w-8 text-purple-800 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg></span>
                </div>
            </div>
        </form>
    <!-- Notification messages are now handled by notification.html redirect -->
    </div>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script>
    // SCOPE/TARGET/TAT data for 22 rows (from image)
    const aspRows = [
        { scope: 'Teaching and Curriculum Delivery: Design and deliver lectures, tutorials, and lab sessions as per the academic calendar and subjects assigned.', target: '', tat: 'END OF THE DAY' },
        { scope: 'Teaching and Curriculum Delivery: Develop course materials, lesson plans, and assessments aligned with OBE for the subjects assigned.', target: '', tat: 'BEFORE 15 DAYS OF START OF SEM' },
        { scope: 'Teaching and Curriculum Delivery: Incorporate innovative teaching methods, including ICT tools and experiential learning.', target: '', tat: 'END OF THE DAY' },
        { scope: 'Teaching and Curriculum Delivery: Prepare Product model and instructional Chart for the assigned subject.', target: '', tat: '25TH OF MONTH' },
        { scope: 'Student Mentorship and Support: Act as academic mentors and guide 30 students on coursework, projects, and career planning.', target: '', tat: '' },
        { scope: 'Student Mentorship and Support: Monitor student attendance, performance, and well-being.', target: '', tat: 'END OF THE DAY' },
        { scope: 'Student Mentorship and Support: Provide remedial support and encourage participation in co-curricular and extra-curricular activities.', target: '', tat: 'END OF FRIDAY' },
        { scope: 'Student Mentorship and Support: Maintain the Mentor book for assigned mentee.', target: '', tat: 'END OF FRIDAY' },
        { scope: 'Student Mentorship and Support: Consolidate innovative course material, Lab manuals', target: '2 Theory 1 Lab', tat: '31ST DEC' },
        { scope: 'Research and Development: Publish in peer-reviewed journals', target: '1/Year', tat: '31ST MAY' },
        { scope: 'Research and Development: Apply for research grants', target: '', tat: '' },
        { scope: 'Research and Development: Guide student research and final-year projects', target: '1/Year 2 Batch', tat: '31ST MAY' },
        { scope: 'Institutional Development: Participate in curriculum development and revision through Boards of Studies.', target: '2', tat: 'BEFORE 45 DAY OF START OF SEM' },
        { scope: 'Institutional Development: Contribute to accreditation processes (NBA, NAAC) and quality assurance initiatives.', target: '', tat: 'END OF FRIDAY' },
        { scope: 'Institutional Development: Serve on academic and administrative committees.', target: '1', tat: 'AS PER SCHEDULE' },
        { scope: 'Professional Development: Organize FDP/ workshops/ seminar.', target: '1 PER YEAR', tat: '31ST MAY' },
        { scope: 'Professional Development: NPTEL/MOOC and certifications.', target: '1 PER SEM', tat: '31ST MAY' },
        { scope: 'Professional Development: Memberships in professional bodies.', target: '1 MEMBERSHIP', tat: '31ST MAY' },
        { scope: 'Community and Industry Engagement: Facilitate industry-institute interaction through guest lectures, Internships.', target: '1/SEM', tat: '31ST DEC' },
        { scope: 'Community and Industry Engagement: Engage in consultancy', target: '1/Year', tat: '31ST DEC' },
        { scope: 'Administrative Duties: Maintain academic records, course files, Log Book and student evaluations.', target: '', tat: 'END OF THE DAY' },
        { scope: 'Administrative Duties: Assist in examination duties, including question paper setting, invigilation, and evaluation.', target: '', tat: 'AS PER SCHEDULE' },
    { scope: 'Memberships in professional bodies.', target: '1 PER SEM', tat: '31ST MAY' },
    ];
    // Render compliance and general rows separately
    const complianceRows = [10, 11, 12, 16, 17, 18, 19, 23];
    const generalRows = Array.from({length: 23}, (_, i) => i + 1).filter(idx => !complianceRows.includes(idx));
    const complianceTbody = document.getElementById('asp-compliance-body');
    const generalTbody = document.getElementById('asp-general-body');
    complianceRows.forEach(idx => {
        const row = aspRows[idx - 1];
        const tr = document.createElement('tr');
        tr.innerHTML =
            '<td class="border px-2 py-1 text-center">' + idx + '</td>' +
            '<td class="border px-2 py-1">' + row.scope + '</td>' +
            '<td class="border px-2 py-1 text-center">' + row.target + '</td>' +
            '<td class="border px-2 py-1 text-center">' + row.tat + '</td>' +
            '<td class="border px-2 py-1"><select name="Status_' + idx + '" class="w-full border rounded px-1 py-1"><option value="">Select</option><option>Completed</option><option>In Progress</option><option>Not Started</option><option>Not Applicable</option></select></td>' +
            '<td class="border px-2 py-1"><input type="text" name="Description_' + idx + '" maxlength="200" class="w-full border rounded px-1 py-1" placeholder="0-200 chars" /></td>' +
            '<td class="border px-2 py-1">' +
                '<input type="file" name="Upload the scanned file_' + idx + '" accept=".pdf,.jpg,.jpeg,.png" class="w-full file-input" data-row="' + idx + '" />' +
                '<span class="file-check hidden text-green-600 font-bold" data-row="' + idx + '">✓ Uploaded</span>' +
            '</td>';
        complianceTbody.appendChild(tr);
    });
    generalRows.forEach(idx => {
        const row = aspRows[idx - 1];
        const tr = document.createElement('tr');
        tr.innerHTML =
            '<td class="border px-2 py-1 text-center">' + idx + '</td>' +
            '<td class="border px-2 py-1">' + row.scope + '</td>' +
            '<td class="border px-2 py-1 text-center">' + row.target + '</td>' +
            '<td class="border px-2 py-1 text-center">' + row.tat + '</td>' +
            '<td class="border px-2 py-1"><select name="Status_' + idx + '" class="w-full border rounded px-1 py-1"><option value="">Select</option><option>Completed</option><option>In Progress</option><option>Not Started</option><option>Not Applicable</option></select></td>' +
            '<td class="border px-2 py-1"><input type="text" name="Description_' + idx + '" maxlength="200" class="w-full border rounded px-1 py-1" placeholder="0-200 chars" /></td>' +
            '<td class="border px-2 py-1">' +
                '<input type="file" name="Upload the scanned file_' + idx + '" accept=".pdf,.jpg,.jpeg,.png" class="w-full file-input" data-row="' + idx + '" />' +
                '<span class="file-check hidden text-green-600 font-bold" data-row="' + idx + '">✓ Uploaded</span>' +
            '</td>';
        generalTbody.appendChild(tr);
    });
    
    // Simple file upload indicator
    document.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('file-input')) {
            const row = e.target.getAttribute('data-row');
            const checkMark = document.querySelector(`.file-check[data-row="${row}"]`);
            if (e.target.files && e.target.files.length > 0 && checkMark) {
                checkMark.classList.remove('hidden');
            } else if (checkMark) {
                checkMark.classList.add('hidden');
            }
        }
    });
    
    // Supabase setup
    const supabase = window.supabase.createClient(
        "https://cbhodgwaazmjszkujrti.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiaG9kZ3dhYXptanN6a3VqcnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY4NzEsImV4cCI6MjA3MTI1Mjg3MX0.sBRdfiWJJmZtLWsHCcNyxm1VcwkGwZWsIeeMlS49XTU"
    );
    async function uploadFileToStorage(file, path) {
        if (!file) return null;
        const { data, error } = await supabase.storage.from('Asp files').upload(path, file, { upsert: true });
        if (error) throw error;
        // Get public URL
        const { data: urlData } = supabase.storage.from('Asp files').getPublicUrl(path);
        return urlData.publicUrl;
    }
    // --- Compliance Section Submission ---
    document.getElementById('complianceSubmitBtn').addEventListener('click', async function(e) {
        // Show loading spinner and disable submit button
        const submitBtn = document.getElementById('complianceSubmitBtn');
        const spinner = document.getElementById('complianceLoadingSpinner');
        if (submitBtn) submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        try {
            const form = document.getElementById('aspForm');
            const formData = new FormData(form);
            // Only collect compliance rows
            const complianceMap = [10, 11, 12, 16, 17, 18, 19, 23];
            let faculty_email = '';
            // Get faculty email
            try {
                const { data: facultyRows } = await supabase
                    .from('Faculty')
                    .select('email')
                    .eq('department', formData.get('Department:'))
                    .eq('Name', formData.get('Portfolio Member Name'))
                    .limit(1)
                    .single();
                if (facultyRows && facultyRows.email) faculty_email = facultyRows.email;
            } catch (e) {}
            // Upload files for compliance rows
            let complianceRow = {
                department: formData.get('Department:'),
                faculty_email: faculty_email,
                faculty_name: formData.get('Portfolio Member Name'),
            };
            // Prepare ASP row with only compliance fields filled
            let aspRow = {
                "Department:": formData.get('Department:'),
                "Portfolio Name:": formData.get('Portfolio Name:'),
                "Portfolio Member Name": formData.get('Portfolio Member Name'),
            };
            for (let i = 1; i <= 23; i++) {
                if (complianceMap.includes(i)) {
                    aspRow[`Status_${i}`] = formData.get(`Status_${i}`);
                    aspRow[`Description_${i}`] = formData.get(`Description_${i}`);
                    aspRow[`Upload the scanned file_${i}`] = null; // Not uploading files for compliance section
                } else {
                    aspRow[`Status_${i}`] = null;
                    aspRow[`Description_${i}`] = null;
                    aspRow[`Upload the scanned file_${i}`] = null;
                }
            }
            for (let j = 0; j < complianceMap.length; j++) {
                let idx = complianceMap[j];
                complianceRow[`compliance_${j+1}`] = formData.get(`Status_${idx}`) || '';
            }
            await supabase.from('asp_compliance').insert([complianceRow]);
            await supabase.from('ASP').insert([aspRow]);
            window.location.href = 'notification.html?status=success';
        } catch (err) {
            window.location.href = `notification.html?status=error&msg=${encodeURIComponent(err.message)}`;
        } finally {
            if (submitBtn) submitBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
        }
    });

    // --- General Section Submission ---
    document.getElementById('aspSubmitBtn').addEventListener('click', async function(e) {
        // Show loading spinner and disable submit button
        const submitBtn = document.getElementById('aspSubmitBtn');
        const spinner = document.getElementById('aspLoadingSpinner');
        if (submitBtn) submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        try {
            const form = document.getElementById('aspForm');
            const formData = new FormData(form);
            // Prepare row object for 23 rows, but only fill general rows
            const generalRows = Array.from({length: 23}, (_, i) => i + 1).filter(idx => ![10,11,12,16,17,18,19,23].includes(idx));
            const row = {
                "Department:": formData.get('Department:'),
                "Portfolio Name:": formData.get('Portfolio Name:'),
                "Portfolio Member Name": formData.get('Portfolio Member Name'),
            };
            for (let i = 1; i <= 23; i++) {
                if (generalRows.includes(i)) {
                    row[`Status_${i}`] = formData.get(`Status_${i}`);
                    row[`Description_${i}`] = formData.get(`Description_${i}`);
                    const file = formData.get(`Upload the scanned file_${i}`);
                    if (file && file.size > 0) {
                        const ts = Date.now();
                        const path = `aspfile${i}_${ts}_${file.name}`;
                        try {
                            row[`Upload the scanned file_${i}`] = await uploadFileToStorage(file, path);
                        } catch (err) {
                            window.location.href = `notification.html?status=error&msg=${encodeURIComponent('File upload failed for row ' + i + ': ' + err.message)}`;
                            return;
                        }
                    } else {
                        row[`Upload the scanned file_${i}`] = null;
                    }
                } else {
                    row[`Status_${i}`] = null;
                    row[`Description_${i}`] = null;
                    row[`Upload the scanned file_${i}`] = null;
                }
            }
            // Insert into ASP table
            const { data, error } = await supabase.from('ASP').insert([row]);
            if (!error) {
                window.location.href = 'notification.html?status=success';
            } else {
                window.location.href = `notification.html?status=error&msg=${encodeURIComponent(error.message)}`;
            }
        } finally {
            if (submitBtn) submitBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
        }
    });
    </script>  <!-- Footer -->
  <footer class="text-center py-4 mt-8">
    <p class="text-gray-400 text-sm"> © All Rights Reserved <a href="https://pmctech.org" target="_blank" class="text-gray-400 hover:text-gray-600 underline">PMC TECH</a>, IV CSE 2022-2026.<br/> 
    </p>
  </footer>

</body>
</html>
